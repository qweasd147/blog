---
title: 'AWS - Cloud Front'
date: '2020-07-21T02:10:43.331Z'
template: 'post'
draft: false
category: 'etc'
tags:
  - 'aws'
  - 'cloudfront'
  - 'cdn'
  - 'web server'
  - 'infra'
description: 'CDN 서버 구축 & 쉽게 웹서버를 구축하고 싶을 떄'
---

# CloudFront

정적 리소스들을 전 세계를 대상으로 빠르게 제공해주는 CDN 서버

일반적으로 정적 리소드들을 `S3`에 올려놓고 `CloudFront`를 `S3`에 연결하여 사용을 한다. 순수 정적 컨텐츠를 위한 CDN 서버 셋팅은 `S3`랑 연동하는 하면 끝이라 여기서 +@로 웹서버까지 구현하는게 목표

---

## 정적 웹서버 구현 feat. CRA

기술 스택

- S3
- CloudFront
  1. OAI
- CRA

`route53`도 사용하고 싶지만, 보유한 도메인도 없고 돈도 없어서 생략

선행 작업으로 `s3`에 `bucket`을 만들고, `퍼블릭 엑세스 차단` **활성화**, `CRA`로 만든 빌드 파일을 해당 `bucket`에 업로드

### 1. Cloud Front 주요 설정값

- Origin Domain Name

  Domain 주소값을 입력 할 수 있으나 s3를 통해 Resource를 제공 해줄 것이므로 dropDown에 나타나는 bucket중, 원하는 버켓을 선택한다. **주의!** 이때, `{버킷명}.s3.{리전}.amazonaws.com`형태로 리전 값을 넣어야 한다. 안넣고 최초 배포 시, DNS에서 실제 주소 값을 찾아가 리소스를 활성화 하는데 오래 걸릴 수가 있다. 시간이 지나면 해결 되지만 리전값 넣는게 어려운것도 아니므로 왠만하면 그냥 넣어준다.

- Restrict Bucket Access(버킷 access 제한)

  CloudFront를 통해서만 버킷 접근을 허용 할지 여부. `예`를 선택하면 `OAI` 선택 창이 보이는데, 경우에 따라 새로운 `OAI` 생성 또는 기존 `OAI`를 사용 선택

- Grant Read Permissions on Bucket

  CloudFront가 원본(s3)에 접근 권한을 자동으로 부여 할지 여부. 그냥 yes

- Viewer Protocol Policy

  접근 허용할 프로토콜을 선택하는건데 http는 속도 느리고 보안적으로도 안좋으니까 https를 통해서만 접근하는게 좋다. 경우에 따라(보통 다른 앱) http로 접근 할 수도 있으므로 http로 접근 시 https로 Redirect 되도록 설정(`Redirect Http to Https`)

- Allowed HTTP Methods

  정적 웹서버를 만드는게 목표니까 `GET, HEAD`로만 설정해도 충분. 필요 시, 다른걸로 설정해도 상관없다.

- TTL

  캐싱 기간을 무한히 가져가면 만약 s3에 기존 파일을 업데이트 해도 업데이트 된 파일을 확인이 불가능하다. 그래서 캐싱된 기간을 제어하려고 만든건데 개인적으로 그냥 디폴트 값으로 쓰다가 필요 시 CloudFront의 캐싱을 날려버리는 기능을 많이 쓴다.

- Restrict Viewer Access

  서명된 URL만 접근을 허용할지 여부. 접근 제한이 필요하다면 `Yes` 아니면 `No`로 하면 되고, 현재는 접근 제한없이 public하게 만드는게 목적이니까 `NO`. 당연히 yes를 선택하면 추가적인 정보가 있어야 하고, 요청 URL에 파라미터를 많이 셋팅해서 사용해야한다.

- Compress Objects Automatically

  압축이 가능한 형태의 리소스라면 압축해서 제공할지 여부 선택. 그냥 yes로 하는게 좋다고 한다.

- Price Class

  사용할 엣지 로케이션을 선택하는건데 뭐 전세계를 대상으로 서비스 할꺼면 모든 곳에 배포하면 좋지만 그러면 배포 시간도 오래걸리고 돈도 많이 나간다고 한다. 국내만 서비스 할것이냐 아니냐에 따라 선택하면 된다.

- Supported HTTP Versions

  그냥 HTTP/2 선택. 만약 3버전도 서비스 해준다면 그때 3으로 선택할지를 고려

- Default Root Object

  기본 접근 파일. cra로 만들어져 모든 접근 파일인 `index.html`로 입력

필요한 설정을 완료 하고 `Create Distribution` 클릭 하면 완료된다.

### 2. 라우팅 설정(에러페이지 셋팅)

위 내용까지 셋팅하면 `CloudFront`에서 제공해주는 도메인으로 `S3`에 존재하는 하위 디렉토리 및 파일들을 찾아가도록 셋팅한 것이다. 근데 우리는 `React App`이니까 `URL`의 주소가 어찌되어 있던 `index.html`로 접근하여 `React`레벨에서 라우팅 처리가 되도록 셋팅해야 한다.

생성된 `Cloud Front`를 선택 -> `Error Pages`를 클릭하면 에러 페이지 셋팅이 가능하고, `403`, `404`일때 `/index.html`로 보내 어플리케이션 레벨에서 모든 처리가 이루어 지도록 셋팅하면 된다.

| HTTP Error Code | Response Page Path | Http Response Code |
| --------------- | ------------------ | ------------------ |
| 403             | /index.html        | 200                |
| 404             | /index.html        | 200                |

이런식으로 셋팅하면 어플리케이션 레벨(`React`)에서 모든 라우팅 처리를 맡기게 셋팅된다.
캐싱 기간은 디폴트값으로 사용해도 충분할꺼라 생각된다.

### 3. 정리

이렇게 까지 셋팅해야 보다 안전하고 빠른 웹서버 구축이 된다. 중요한 부분을 몇가지 다시 생각해보면

#### 3.1 외부에서 S3 접근 불가

처음 `S3`를 만들 때 `퍼블릭 엑세스 차단`을 체크하였고, `S3`에서 `정적 웹 사이트 호스팅` 또한 하지 않았다. 따라서 외부에서 `S3`에 직접 접근 할 수도, 버킷명도 알아낼 방법이 없어 보안적으로 좋아진다.

#### 3.2 SSL 적용이 쉽다

`Cloud Front`를 사용함으로써 기본적으로 SSL 사용이 쉽게 셋팅이 된다
정적 웹서버 호스팅은 aws 내에서도 여러가지 방법이 존재하긴 한다.

1. S3에서 `정적 웹 사이트 호스팅`
2. `route53`에서 S3로 직접 연결

이런 방법들이 있긴 하지만 SSL 적용을 이보다 편하게 할 수는 없는걸로 알고 있다.

#### 3.3 모든 라우팅 처리는 어플리케이션 레벨

CDN 서버 입장해선 접근 시 무조건 index.html로 보내게 된다(`/`, `403`, `404` 한정).

#### 3.4 웹서버 관리가 필요없다.

내가 직접 웹서버를 구축하고 관리하는게 아니라 다 aws에서 관리해주니까 성능, 관리 측면에서 엄청난 이득이다.
