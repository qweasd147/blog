{"data":{"allMarkdownRemark":{"edges":[{"node":{"fields":{"slug":"/posts/aws/aws-cf-basic/","__typename":"MarkdownRemarkFields","categorySlug":"/category/aws/"},"frontmatter":{"template":"post","title":"AWS - Cloud Front - 기본","date":"2020-08-10T05:58:14.024Z","tags":["aws","cloudfront","cdn","web server","infra"],"socialImage":null,"draft":false,"description":"Cloud Front를 사용해서 CDN 서버 구축","category":"aws"},"id":"659d4206-83f0-5b8a-8188-c939d27cca22","html":"<h1 id=\"cloudfront\" style=\"position:relative;\"><a href=\"#cloudfront\" aria-label=\"cloudfront permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CloudFront</h1>\n<p>정적 리소스들을 전 세계를 대상으로 빠르게 제공해주는 CDN 서버</p>\n<p>일반적으로 정적 리소드들을 <code class=\"language-text\">S3</code>에 올려놓고 <code class=\"language-text\">Cloud Front</code>를 <code class=\"language-text\">S3</code>에 연결하여 사용을 한다. 그 외에도 다른 도메인에서 사용하는 리소스, 기타 <code class=\"language-text\">Cloud Front</code>에서 제공해주는 서비스를 정리</p>\n<h3 id=\"목차\" style=\"position:relative;\"><a href=\"#%EB%AA%A9%EC%B0%A8\" aria-label=\"목차 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>목차</h3>\n<ol>\n<li><code class=\"language-text\">Cloud Front</code> 생성 시 옵션</li>\n<li>Origins &#x26; Origin Group</li>\n<li>Behaviors</li>\n<li>Error Pages</li>\n<li>캐시 초기화(Invalidations)</li>\n</ol>\n<hr>\n<h2 id=\"1-cloud-front-생성-시-옵션\" style=\"position:relative;\"><a href=\"#1-cloud-front-%EC%83%9D%EC%84%B1-%EC%8B%9C-%EC%98%B5%EC%85%98\" aria-label=\"1 cloud front 생성 시 옵션 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. <code class=\"language-text\">Cloud Front</code> 생성 시 옵션</h2>\n<ul>\n<li>\n<p>Origin Domain Name</p>\n<ul>\n<li>다른 도메인 주소 입력\n<blockquote>\n<p>다른곳에서 제공해주는 특정 리소스들을 CDN 서버에 캐싱해놓고 제공하고 싶으면 원하는 도메인을 입력한다. 예를 들어 다른 nginx 서버에서 제공해주는 정적 리소스들을 CDN으로 제공하고 싶으면 nginx 주소값을 넣으면 된다.</p>\n</blockquote>\n</li>\n</ul>\n<ol start=\"2\">\n<li>Bucket 지정\n<blockquote>\n<p>s3를 통해 Resource를 제공하고 싶으면 dropDown에 나타나는 bucket중, 원하는 버켓을 선택한다. <strong>주의!</strong> 이때, <code class=\"language-text\">{버킷명}.s3.{리전}.amazonaws.com</code>형태로 리전 값을 넣어야 한다. 안넣고 최초 배포 시, DNS에서 실제 주소 값을 찾아가 리소스를 활성화 하는데 오래 걸릴 수가 있다. 시간이 지나면 해결 되지만 리전값 넣는게 어려운것도 아니므로 왠만하면 그냥 넣어준다.</p>\n</blockquote>\n</li>\n</ol>\n</li>\n</ul>\n<ul>\n<li>\n<p>Restrict Bucket Access(버킷 access 제한)</p>\n<p>CloudFront를 통해서만 버킷 접근을 허용 할지 여부. <code class=\"language-text\">예</code>를 선택하면 <code class=\"language-text\">OAI</code> 선택 창이 보이는데, 경우에 따라 새로운 <code class=\"language-text\">OAI</code> 생성 또는 기존 <code class=\"language-text\">OAI</code>를 사용 선택</p>\n</li>\n<li>\n<p>Grant Read Permissions on Bucket</p>\n<p>CloudFront가 원본(s3)에 접근 권한을 자동으로 부여 할지 여부. 그냥 yes</p>\n</li>\n<li>\n<p>Viewer Protocol Policy</p>\n<p>접근 허용할 프로토콜을 선택하는건데 http는 속도 느리고 보안적으로도 안좋으니까 https를 통해서만 접근하는게 좋다. 경우에 따라(보통 다른 앱) http로 접근 할 수도 있으므로 http로 접근 시 https로 Redirect 되도록 설정(<code class=\"language-text\">Redirect Http to Https</code>)</p>\n</li>\n<li>\n<p>Allowed HTTP Methods</p>\n<p>정적 웹서버를 만드는게 목표니까 <code class=\"language-text\">GET, HEAD</code>로만 설정해도 충분. 필요 시, 다른걸로 설정해도 상관없다.</p>\n</li>\n<li>\n<p>TTL</p>\n<p>캐싱 기간을 무한히 가져가면 만약 s3에 기존 파일을 업데이트 해도 업데이트 된 파일을 확인이 불가능하다. 그래서 캐싱된 기간을 제어하려고 만든건데 개인적으로 그냥 디폴트 값으로 쓰다가 필요 시 CloudFront의 캐싱을 날려버리는 기능을 많이 쓴다.</p>\n</li>\n<li>\n<p>Restrict Viewer Access</p>\n<p>서명된 URL만 접근을 허용할지 여부. 접근 제한이 필요하다면 <code class=\"language-text\">Yes</code> 아니면 <code class=\"language-text\">No</code>로 하면 되고, 현재는 접근 제한없이 public하게 만드는게 목적이니까 <code class=\"language-text\">NO</code>. 당연히 yes를 선택하면 추가적인 정보가 있어야 하고, 요청 URL에 파라미터를 많이 셋팅해서 사용해야한다.</p>\n</li>\n<li>\n<p>Compress Objects Automatically</p>\n<p>압축이 가능한 형태의 리소스라면 압축해서 제공할지 여부 선택. 그냥 yes로 하는게 좋다고 한다.</p>\n</li>\n<li>\n<p>Price Class</p>\n<p>사용할 엣지 로케이션을 선택하는건데 뭐 전세계를 대상으로 서비스 할꺼면 모든 곳에 배포하면 좋지만 그러면 배포 시간도 오래걸리고 돈도 많이 나간다고 한다. 국내만 서비스 할것이냐 아니냐에 따라 선택하면 된다.</p>\n</li>\n<li>\n<p>Supported HTTP Versions</p>\n<p>그냥 HTTP/2 선택. 만약 3버전도 서비스 해준다면 그때 3으로 선택할지를 고려</p>\n</li>\n<li>\n<p>Default Root Object</p>\n<p>기본 접근 파일. cra로 만들어져 모든 접근 파일인 <code class=\"language-text\">index.html</code>로 입력</p>\n</li>\n</ul>\n<p>필요한 설정을 완료 하고 <code class=\"language-text\">Create Distribution</code> 클릭 하면 완료된다.</p>\n<h2 id=\"2-origins--origin-group\" style=\"position:relative;\"><a href=\"#2-origins--origin-group\" aria-label=\"2 origins  origin group permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Origins &#x26; Origin Group</h2>\n<h3 id=\"21-origins\" style=\"position:relative;\"><a href=\"#21-origins\" aria-label=\"21 origins permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 Origins</h3>\n<p>리소스들이 존재하는 위치를 정의한다. 맨 처음 <code class=\"language-text\">Cloud Front</code> 생성 시 기본 하나를 등록하니 최소 한개 이상이 존재하고, 추가로 <code class=\"language-text\">Bucket</code>, 도메인 등을 계속해서 등록 가능하다.</p>\n<h3 id=\"22-origin-groups\" style=\"position:relative;\"><a href=\"#22-origin-groups\" aria-label=\"22 origin groups permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 Origin Groups</h3>\n<p>말 그대로 <code class=\"language-text\">Origins</code>의 그룹이다.\n<img src=\"/blog/media/aws/cf/cf_origin1.png\" alt=\"cognito_app\"></p>\n<p>예를 들면 특정 <code class=\"language-text\">Origin A</code>에 리소스가 없거나 에러 발생 시 <code class=\"language-text\">Origin B</code>에서 찾도록 하고 싶을 때 사용한다. 우선순위별 <code class=\"language-text\">Origin</code>을 등록 해놓고 아래 <code class=\"language-text\">Failover criteria</code>를 선택 해놓으면 각 <code class=\"language-text\">Origin</code>을 방문하면서 체크 된 에러가 발생 시 하위 <code class=\"language-text\">Origin</code>에서 리소스를 찾는다.</p>\n<h2 id=\"3-behaviors\" style=\"position:relative;\"><a href=\"#3-behaviors\" aria-label=\"3 behaviors permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Behaviors</h2>\n<p>요청 주소에 따라 어느 <code class=\"language-text\">Origin</code> 또는 <code class=\"language-text\">Origin Group</code>으로 보낼지 설정한다.\n<img src=\"/blog/media/aws/cf/cf_behaviors1.png\" alt=\"cognito_app\"></p>\n<p>위와 같이 설정 했다고 가정하면</p>\n<p><code class=\"language-text\">/path_a/*</code>로 요청 시 연결 된 <code class=\"language-text\">Origin</code> or <code class=\"language-text\">Origin Group</code>으로, <code class=\"language-text\">/path_b/*</code>로 요청 시 연결 된 <code class=\"language-text\">Origin</code> or <code class=\"language-text\">Origin Group</code>으로 보내고, 그게 아니라면 <code class=\"language-text\">Default(*)</code>에 연결된 <code class=\"language-text\">Origin</code> or <code class=\"language-text\">Origin Group</code>으로 보낸다. (<code class=\"language-text\">precedence</code>는 우선 순위)</p>\n<p>이것 말고도 TTL, private 요청 설정이 가능하다(모두 생성 시 옵션과 중복 되므로 생략).</p>\n<h2 id=\"4-error-pages\" style=\"position:relative;\"><a href=\"#4-error-pages\" aria-label=\"4 error pages permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Error Pages</h2>\n<p>에러 발생 시 결과값을 선택하여 보내준다.</p>\n<p><img src=\"/blog/media/aws/cf/cf_errorPages1.png\" alt=\"cognito_app\"></p>\n<p>이런식으로 <code class=\"language-text\">Cloud Front</code>에서 최종 응답 코드가 <code class=\"language-text\">403</code>, <code class=\"language-text\">404</code>일 때, 지정된 리소스를 반환하도록 셋팅이 가능하다. 물론 캐싱 기간은 짧게 주는게 좋다.</p>\n<h2 id=\"5-캐시-초기화invalidations\" style=\"position:relative;\"><a href=\"#5-%EC%BA%90%EC%8B%9C-%EC%B4%88%EA%B8%B0%ED%99%94invalidations\" aria-label=\"5 캐시 초기화invalidations permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 캐시 초기화(Invalidations)</h2>\n<p><code class=\"language-text\">Invalidations</code>탭에서 <code class=\"language-text\">Create Invalidation</code>을 선택 후 캐시를 지우고 싶은 경로를 입력하면 된다.</p>\n<p>예를 들면 <code class=\"language-text\">/*</code> or <code class=\"language-text\">/path/img*</code></p>\n<hr>\n<h4 id=\"todo\" style=\"position:relative;\"><a href=\"#todo\" aria-label=\"todo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TODO</h4>\n<ol>\n<li>Restrictions\n<blockquote>\n<p><code class=\"language-text\">Cloud Front</code>의 접근 권한을 체크 하고 싶을때 설정한다. 나중에 쓸 일 있으면 추가 예정.</p>\n</blockquote>\n</li>\n</ol>"}},{"node":{"fields":{"slug":"/posts/aws/aws-cf-webserver/","__typename":"MarkdownRemarkFields","categorySlug":"/category/aws/"},"frontmatter":{"template":"post","title":"AWS - Cloud Front - WebServer","date":"2020-08-12T07:52:44.005Z","tags":["aws","cloudfront","cdn","web server","infra"],"socialImage":null,"draft":false,"description":"Cloud Front를 써서 React로 만들어진 어플리케이션 배포","category":"aws"},"id":"62dd0441-d0d0-575a-957d-0ac453f270c0","html":"<h1 id=\"웹서버-구축\" style=\"position:relative;\"><a href=\"#%EC%9B%B9%EC%84%9C%EB%B2%84-%EA%B5%AC%EC%B6%95\" aria-label=\"웹서버 구축 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>웹서버 구축</h1>\n<p>웹서버를 구축하기 위해선 생각 해봐야 할 것들이 있는데, 보통 물리적 공간에 웹서버(보통 <code class=\"language-text\">apache</code> or <code class=\"language-text\">nginx</code>)를 설치하고 정적 파일들을 올려놓은 후 해당 위치를 바라보도록 웹서버 셋팅을 하면 된다.</p>\n<p>딱히 어려운건 없지만 인프라 구축 자체가 귀찮은게 많으니 이러한 작업을 AWS를 사용해서 구축하면 엄청 편하고 빠르게 배포가 가능하다.</p>\n<p>기술 스택</p>\n<ul>\n<li>S3</li>\n<li>CloudFront\n<ol>\n<li>OAI</li>\n</ol>\n</li>\n<li>CRA</li>\n</ul>\n<p><code class=\"language-text\">route53</code>도 사용하고 싶지만, 보유한 도메인도 없고 돈도 없어서 생략</p>\n<p>기술 스택을 보면 아는 사람은 짐작하겠지만 CRA(<code class=\"language-text\">React</code>)로 만들어진 소스를 빌드해서 <code class=\"language-text\">S3</code>에 올려놓고 <code class=\"language-text\">Cloud Front</code>에서 빌드된 파일을 접근하여 서비스 하는 형태로 구축한다.</p>\n<hr>\n<h2 id=\"버킷-생성\" style=\"position:relative;\"><a href=\"#%EB%B2%84%ED%82%B7-%EC%83%9D%EC%84%B1\" aria-label=\"버킷 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>버킷 생성</h2>\n<p>버킷은 원하는 이름 및 리전만 선택해서 디폴트 옵션으로 생성해도 충분하다. 주의할 것은 <code class=\"language-text\">모든 퍼블릭 엑세스 차단</code>을 체크 해서 생성한다(아마도 디폴트 옵션이 차단 활성화).</p>\n<h2 id=\"소스파일-빌드-및-s3에-업로드\" style=\"position:relative;\"><a href=\"#%EC%86%8C%EC%8A%A4%ED%8C%8C%EC%9D%BC-%EB%B9%8C%EB%93%9C-%EB%B0%8F-s3%EC%97%90-%EC%97%85%EB%A1%9C%EB%93%9C\" aria-label=\"소스파일 빌드 및 s3에 업로드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>소스파일 빌드 및 S3에 업로드</h2>\n<p>먼저 서비스하고 싶은 <code class=\"language-text\">CRA</code>소스 파일을 빌드해서 <code class=\"language-text\">S3</code>에 업로드 해놓는다. 밑에 내용은 샘플 소스를 <code class=\"language-text\">git clone</code>해서 사용한 것이다.</p>\n<ul>\n<li>샘플 소스 다운로드 및 빌드</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ git clone https://github.com/qweasd147/AwsStudy.git\n$ cd ./AwsStudy/cloudfront/webserver/\n\n$ yarn install\n$ yarn build</code></pre></div>\n<ul>\n<li>S3로 파일 업로드</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ aws s3 sync ./build s3://버킷명 --delete --output text</code></pre></div>\n<p><code class=\"language-text\">aws-cli</code>를 설치하면 cli로도 가능한데 웹에서 직접 올려도 상관없다.</p>\n<h2 id=\"cloud-front-설정\" style=\"position:relative;\"><a href=\"#cloud-front-%EC%84%A4%EC%A0%95\" aria-label=\"cloud front 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cloud Front 설정</h2>\n<p>다른 항목은 이전 <code class=\"language-text\">Cloud Front</code> 설명을 참조해서 만들면 되지만 주의해서 셋팅해야하는 부분이 있다.</p>\n<h3 id=\"cloud-front-생성-시-옵션\" style=\"position:relative;\"><a href=\"#cloud-front-%EC%83%9D%EC%84%B1-%EC%8B%9C-%EC%98%B5%EC%85%98\" aria-label=\"cloud front 생성 시 옵션 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cloud Front 생성 시 옵션</h3>\n<ul>\n<li>\n<p>Restrict Bucket Access(버킷 access 제한)</p>\n<p>CloudFront를 통해서만 버킷 접근을 허용 할지 여부. <code class=\"language-text\">예</code>를 선택하면 <code class=\"language-text\">OAI</code> 선택 창이 보이는데 필요에 따라 새로운 <code class=\"language-text\">OAI</code> 생성 또는 기존 <code class=\"language-text\">OAI</code>를 사용 선택</p>\n</li>\n<li>\n<p>Grant Read Permissions on Bucket</p>\n<p>CloudFront가 원본(s3)에 접근 권한을 자동으로 부여 할지 여부. 그냥 yes</p>\n</li>\n<li>\n<p>Default Root Object</p>\n<p>기본 접근 파일. cra로 만들어져 모든 접근 파일인 <code class=\"language-text\">index.html</code>로 입력</p>\n</li>\n</ul>\n<p>이렇게 3개만 주의해서 생성하면 된다.</p>\n<h3 id=\"라우팅-설정에러페이지-셋팅\" style=\"position:relative;\"><a href=\"#%EB%9D%BC%EC%9A%B0%ED%8C%85-%EC%84%A4%EC%A0%95%EC%97%90%EB%9F%AC%ED%8E%98%EC%9D%B4%EC%A7%80-%EC%85%8B%ED%8C%85\" aria-label=\"라우팅 설정에러페이지 셋팅 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>라우팅 설정(에러페이지 셋팅)</h3>\n<p>위 내용까지 셋팅하면 <code class=\"language-text\">CloudFront</code>에서 제공해주는 도메인으로 <code class=\"language-text\">S3</code>에 존재하는 하위 디렉토리 및 파일들을 찾아가도록 셋팅한 것이다. 근데 우리는 <code class=\"language-text\">React App</code>이니까 <code class=\"language-text\">URL</code>의 주소가 어찌되어 있던 <code class=\"language-text\">index.html</code>로 접근하여 <code class=\"language-text\">React</code> 소스 레벨에서 라우팅 처리가 되도록 셋팅해야 한다.</p>\n<p>생성된 <code class=\"language-text\">Cloud Front</code>를 선택 -> <code class=\"language-text\">Error Pages</code>를 클릭하면 에러 페이지 셋팅이 가능하고, <code class=\"language-text\">403</code>, <code class=\"language-text\">404</code>일때 <code class=\"language-text\">/index.html</code>로 보내 어플리케이션 레벨에서 모든 처리가 이루어 지도록 셋팅하면 된다.</p>\n<table>\n<thead>\n<tr>\n<th>HTTP Error Code</th>\n<th>Response Page Path</th>\n<th>Http Response Code</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>403</td>\n<td>/index.html</td>\n<td>200</td>\n</tr>\n<tr>\n<td>404</td>\n<td>/index.html</td>\n<td>200</td>\n</tr>\n</tbody>\n</table>\n<p>이런식으로 셋팅하면 어플리케이션 레벨(<code class=\"language-text\">React</code>)에서 모든 라우팅 처리를 맡기게 셋팅된다.\n캐싱 기간은 디폴트값으로 사용해도 충분할꺼라 생각된다.</p>\n<h2 id=\"정리\" style=\"position:relative;\"><a href=\"#%EC%A0%95%EB%A6%AC\" aria-label=\"정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>정리</h2>\n<p>이렇게 까지 셋팅해야 보다 안전하고 빠른 웹서버 구축이 된다. 중요한 부분을 몇가지 다시 생각해보면</p>\n<h4 id=\"1-외부에서-s3-접근-불가\" style=\"position:relative;\"><a href=\"#1-%EC%99%B8%EB%B6%80%EC%97%90%EC%84%9C-s3-%EC%A0%91%EA%B7%BC-%EB%B6%88%EA%B0%80\" aria-label=\"1 외부에서 s3 접근 불가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 외부에서 S3 접근 불가</h4>\n<p>처음 <code class=\"language-text\">S3</code>를 만들 때 <code class=\"language-text\">퍼블릭 엑세스 차단</code>을 체크하였고, <code class=\"language-text\">S3</code>에서 <code class=\"language-text\">정적 웹 사이트 호스팅</code> 또한 하지 않았다. 따라서 외부에서 <code class=\"language-text\">S3</code>에 직접 접근 할 수도, 버킷명도 알아낼 방법이 없어 보안적으로 좋아진다.</p>\n<h4 id=\"2-ssl-적용이-쉽다\" style=\"position:relative;\"><a href=\"#2-ssl-%EC%A0%81%EC%9A%A9%EC%9D%B4-%EC%89%BD%EB%8B%A4\" aria-label=\"2 ssl 적용이 쉽다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. SSL 적용이 쉽다</h4>\n<p><code class=\"language-text\">Cloud Front</code>를 사용함으로써 기본적으로 SSL 사용이 쉽게 셋팅이 된다\n정적 웹서버 호스팅은 aws 내에서도 여러가지 방법이 존재하긴 한다.</p>\n<ol>\n<li>S3에서 <code class=\"language-text\">정적 웹 사이트 호스팅</code></li>\n<li><code class=\"language-text\">route53</code>에서 S3로 직접 연결</li>\n</ol>\n<p>이런 방법들이 있긴 하지만 SSL 적용을 이보다 편하게 할 수는 없는걸로 알고 있다.</p>\n<h4 id=\"3-모든-라우팅-처리는-어플리케이션-레벨\" style=\"position:relative;\"><a href=\"#3-%EB%AA%A8%EB%93%A0-%EB%9D%BC%EC%9A%B0%ED%8C%85-%EC%B2%98%EB%A6%AC%EB%8A%94-%EC%96%B4%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EB%A0%88%EB%B2%A8\" aria-label=\"3 모든 라우팅 처리는 어플리케이션 레벨 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 모든 라우팅 처리는 어플리케이션 레벨</h4>\n<p>CDN 서버 입장해선 접근 시 무조건 index.html로 보내게 된다(<code class=\"language-text\">/</code>, <code class=\"language-text\">403</code>, <code class=\"language-text\">404</code> 한정).</p>\n<h4 id=\"4-웹서버-관리가-필요없다\" style=\"position:relative;\"><a href=\"#4-%EC%9B%B9%EC%84%9C%EB%B2%84-%EA%B4%80%EB%A6%AC%EA%B0%80-%ED%95%84%EC%9A%94%EC%97%86%EB%8B%A4\" aria-label=\"4 웹서버 관리가 필요없다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 웹서버 관리가 필요없다.</h4>\n<p>내가 직접 웹서버를 구축하고 관리하는게 아니라 다 aws에서 관리해주니까 성능, 관리 측면에서 엄청난 이득이다.</p>\n<hr>\n<h2 id=\"안될-시-점검-사항\" style=\"position:relative;\"><a href=\"#%EC%95%88%EB%90%A0-%EC%8B%9C-%EC%A0%90%EA%B2%80-%EC%82%AC%ED%95%AD\" aria-label=\"안될 시 점검 사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>안될 시 점검 사항</h2>\n<ul>\n<li>cloudfront를 통해 S3 접근이 안될 때(403)</li>\n</ul>\n<p><code class=\"language-text\">Grant Read Permissions on Bucket</code> 이 옵션은 <code class=\"language-text\">S3</code>에 해당 <code class=\"language-text\">CloudFront</code>의 읽기 권한을 자동으로 추가 해준다고 하였다. 근데 최근에 <code class=\"language-text\">AWS</code>쪽 버그인지 해당 옵션을 주고 생성하여도 접근을 못한 적이 있었다. 혹시나 셋팅을 다 끝냈는데 막상 요청해보면 <code class=\"language-text\">403</code>이 뜬다면 <code class=\"language-text\">S3</code>에 접근 권한이 추가 되어있는지 확인 먼저 해보는게 좋다.</p>\n<p><code class=\"language-text\">S3</code> 이동 -> <code class=\"language-text\">버킷 선택</code> -> 권한 탭 이동\n순서대로 이동 하면 중간에 <code class=\"language-text\">버킷 정책</code>이라고 있는데 여기에 <code class=\"language-text\">CloudFront</code>의 OAI가 잘 붙어 있는지 확인한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2008-10-17\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PolicyForCloudFrontPrivateContent\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Sid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Principal\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"AWS\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity CF의_OAI_ID\"</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"s3:GetObject\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"arn:aws:s3:::버킷명/*\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이런식으로 잘 등록 되어있나 눈으로 확인이 가능하고, 추가로 버킷에 특정 디렉토리 하위만 접근 가능하도록 수정 가능하다(<code class=\"language-text\">Resource</code>에서 수정)</p>"}},{"node":{"fields":{"slug":"/posts/aws/aws-cognito/","__typename":"MarkdownRemarkFields","categorySlug":"/category/aws/"},"frontmatter":{"template":"post","title":"AWS - Cognito","date":"2020-08-03T02:09:50.508Z","tags":["aws","cognito","oauth"],"socialImage":null,"draft":false,"description":"cognito를 써서 독립적인 인증서버 구축 & user pool로 data 마이그레이션 구현","category":"aws"},"id":"aee406e7-27cb-589f-8df1-657c2427e666","html":"<h1 id=\"cognito\" style=\"position:relative;\"><a href=\"#cognito\" aria-label=\"cognito permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Cognito</h1>\n<p>각 어플리케이션(웹 &#x26; 모바일 앱)에서 사용 가능하도록 인증, 권한 부여, 사용자 관리 등을 제공해준다.</p>\n<p>일반적으로 이러한 기능을 구현하려면 인증 정보를 확인하고 세션 등에 저장 또는 <code class=\"language-text\">token</code>발급을 해주는 기능과 해당 데이터 관리 및 <code class=\"language-text\">DB</code>도 구축해야만 하지만 이러한 작업을 하나로 묶어 제공한다.</p>\n<p>Cognito를 사용함으로써 생각하는 장점</p>\n<ol>\n<li>일단 사용자 정보 저장소(<code class=\"language-text\">user pool</code>)에 사용자 정보를 저장 한 뒤, 사용 용도에 맞게 그룹화하여 각 용도에 맞게 분류해서 사용가능</li>\n<li>단순 인증 처리(로그인) 기능만 구현해서 써도 돼고, 추가로 <code class=\"language-text\">identity pool</code>을 구축하여 aws 여러 resources들을 사용 가능한 임시 권한(<code class=\"language-text\">IAM</code>)을 발급하여 사용 가능하다.</li>\n<li>사용자 마이그레이션이 쉽다. 사용자 데이터를 일괄 넣어서 사용해도 돼고, <code class=\"language-text\">cognitor</code>에 사용자 조회 중, 사용자 정보가 없을때 <code class=\"language-text\">trigger</code>를 발생 시켜 사용자 데이터를 넣도록 구성 가능하다.</li>\n</ol>\n<p>단점으로는 가격이 비싸다(월별 활성 <code class=\"language-text\">MAU</code>를 기준으로 가격 책정, <a href=\"https://aws.amazon.com/ko/cognito/pricing/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cognito 요금표</a>). 이게 소규모에선 가격이 정말 저렴하지만 일정 수준 넘어가면 그냥 직접 구축하는게 훨씬 저렴하므로, 소규모의 이벤트용 프로젝트로 빠르게 오픈하고 다시 내리는 형태로 쓰는게 베스트인거 같다.</p>\n<p>사용해본 내용 중, <code class=\"language-text\">Cognito</code>를 통해서 인증 서버와 리소스 서버를 구현해 설명할 것이고 해당 소스는 <a href=\"https://github.com/qweasd147/serverless-boilerplate/tree/master/cognito\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">cognito with lambda</a>에서 확인 가능</p>\n<hr>\n<h2 id=\"어플리케이션-전체-구성도\" style=\"position:relative;\"><a href=\"#%EC%96%B4%ED%94%8C%EB%A6%AC%EC%BC%80%EC%9D%B4%EC%85%98-%EC%A0%84%EC%B2%B4-%EA%B5%AC%EC%84%B1%EB%8F%84\" aria-label=\"어플리케이션 전체 구성도 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>어플리케이션 전체 구성도</h2>\n<p><img src=\"/blog/media/aws/cognito-diagram.jpg\" alt=\"cognito_app\"></p>\n<p>어플리케이션은 총 2개(<code class=\"language-text\">auth-server</code>, <code class=\"language-text\">resource-server</code>)로 나누어 구현하였다.</p>\n<h3 id=\"auth-server\" style=\"position:relative;\"><a href=\"#auth-server\" aria-label=\"auth server permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>auth-server</h3>\n<p>사실 이 앱(<code class=\"language-text\">auth-server</code>)가 필요 없기도 하다. 그냥 설정값과 <code class=\"language-text\">trigger</code> 정도만 관리하고 다른 앱(<code class=\"language-text\">front쪽</code>)에서 cognito에서 제공해주는 api를 직접 써도 된다. 하지만 backend 개발자이기도 하고 backend에서 한번 가공한 형태로 하는게 더 커스터마이징이 편할테니까 추가하였다.</p>\n<p><code class=\"language-text\">Auth-Server App Lambda</code>는 <code class=\"language-text\">aws lambda</code>로 구현한 nodejs 서버 이고, <code class=\"language-text\">Cognito</code>는 위에서 설명한것과 같이 일단 <code class=\"language-text\">User DB</code> + 인증 관리 해주는 모듈 정보로 생각해도 충분하다.</p>\n<p>아무튼 중요한건 Cognito에서 특정 조건일때 발생하는 <code class=\"language-text\">Lambda Trigger</code>를 구현해서 추가 할 수도 있는데 프로젝트에선 <code class=\"language-text\">사용자 마이그레이션</code> 항목에 트리거를 추가하였다. 그래서 만약 로그인 시도 중 <code class=\"language-text\">Cognito User Pool</code>에 접근하였는데 해당 사용자 정보가 <code class=\"language-text\">User pool</code>에 없으면 <code class=\"language-text\">Lambda Trigger</code>가 실행된다. 여기서 그냥 사용자 정보가 없다고 처리할지, 아니면 다른곳에 존재하는 사용자 정보를 <code class=\"language-text\">User pool</code>에 추가 후, 원래부터 존재하던 사용자로 처리할지 분기처리가 가능하다.</p>\n<p>구현한 소스는 기존 <code class=\"language-text\">data source</code>가 따로 없으므로, 그냥 요청 이메일 도메인이 <code class=\"language-text\">google</code>이면 사용자 정보를 추가하도록 구성하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>email<span class=\"token operator\">?.</span><span class=\"token function\">endsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"gmail.com\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//이메일 도메인이 google인 것들만 마이그레이션 허용</span>\nevent<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>userAttributes <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">email</span><span class=\"token operator\">:</span> event<span class=\"token punctuation\">.</span>userName<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">email_verified</span><span class=\"token operator\">:</span> <span class=\"token string\">\"true\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">name</span><span class=\"token operator\">:</span> <span class=\"token string\">\"temp_name\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\nevent<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>finalUserStatus <span class=\"token operator\">=</span> <span class=\"token string\">\"CONFIRMED\"</span><span class=\"token punctuation\">;</span>\nevent<span class=\"token punctuation\">.</span>response<span class=\"token punctuation\">.</span>messageAction <span class=\"token operator\">=</span> <span class=\"token string\">\"SUPPRESS\"</span><span class=\"token punctuation\">;</span>\n\ncontext<span class=\"token punctuation\">.</span><span class=\"token function\">succeed</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>보통 요청한 <code class=\"language-text\">id</code>, <code class=\"language-text\">password</code> 정보를 event 객체에서 꺼내 다른곳에 존재 여부를 확인 후, 마이그레이션을 허용할지 판별한다.</p>\n<h4 id=\"api\" style=\"position:relative;\"><a href=\"#api\" aria-label=\"api permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>API</h4>\n<ul>\n<li>POST /{stage}/api/user -> 회원가입\n<ul>\n<li>email, name, password 필수</li>\n</ul>\n</li>\n<li>POST /{stage}/api/user/signin -> 로그인(<code class=\"language-text\">token</code>값 반환)\n<ul>\n<li>email, password 필수</li>\n</ul>\n</li>\n<li>GET /{stage}/api/user/signout -> 로그아웃\n<ul>\n<li>요청 해더에 <code class=\"language-text\">access token</code>이 존재해야함</li>\n</ul>\n</li>\n<li>GET /{stage}/api/user/me -> 내 정보 보기(<code class=\"language-text\">jwt 토큰 기반</code>)\n<ul>\n<li>요청 해더에 <code class=\"language-text\">access token</code>이 존재해야함</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"resource-server\" style=\"position:relative;\"><a href=\"#resource-server\" aria-label=\"resource server permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Resource-Server</h3>\n<p>리소스 서버는 <code class=\"language-text\">Auth-Server</code>에서 발급 받은 토큰으로 resource를 사용하는 목적의 서버이다.</p>\n<p>전체 흐름은 <code class=\"language-text\">user request</code>-><code class=\"language-text\">API Gateway</code>-><code class=\"language-text\">Lambda</code>순서로 진행되지만 인증이 확인 안된 <code class=\"language-text\">request</code>는 모두 <code class=\"language-text\">API Gateway</code>에서 차단해 버린다. <code class=\"language-text\">API Gateway Authorizer</code>를 추가하여 연결된 API는 인증되지 않은 Request를 전부 차단하므로 <code class=\"language-text\">Lambda</code>에 도달한 Request는 모두 인증된 Request를 보장하게 된다.</p>\n<p>이떄 중요한 점은 요청 해더에 <code class=\"language-text\">Authorization : Bearer {token}</code>형태로 요청 해야하고, 이때 토큰값은 <code class=\"language-text\">access token</code>이 아니라 <code class=\"language-text\">id token</code>이어야 한다. 이 부분은 커스터 마이징이 가능할것 같지만 일단 기본 셋팅은 <code class=\"language-text\">id token</code>을 사용해야 한다.</p>\n<p>당장 <code class=\"language-text\">id token</code>을 사용해도 <code class=\"language-text\">API Gateway</code>로 가니까 별 상관 없을꺼 같지만 <code class=\"language-text\">access token</code>을 사용 하도록 변경하는건 필요하긴 할꺼 같다.</p>\n<h4 id=\"api-1\" style=\"position:relative;\"><a href=\"#api-1\" aria-label=\"api 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>API</h4>\n<ul>\n<li>GET /{stage}/api/users/me -> 토큰값으로 요청한 사용자 정보를 파싱하여 반환\n<ul>\n<li>요청 헤더에 <code class=\"language-text\">id token</code>값이 존재해야함</li>\n</ul>\n</li>\n</ul>\n<p>일단 람다 어플리케이션에선 인증된 <code class=\"language-text\">Request</code>라고 보장해주는거 까진 좋은데 토큰 파싱은 아무래도 직접 해야하는거 같다. 그래서 리소스 서버엔 <a href=\"https://docs.aws.amazon.com/ko_kr/cognito/latest/developerguide/amazon-cognito-user-pools-using-tokens-verifying-a-jwt.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">AWS JWT 토큰 검증 가이드</a>에서 설명한 방법으로 토큰값을 검증 &#x26; 파싱해주는 내용이 포함되어 있다.</p>"}},{"node":{"fields":{"slug":"/posts/aws/aws-dynamodb/","__typename":"MarkdownRemarkFields","categorySlug":"/category/aws/"},"frontmatter":{"template":"post","title":"Dynamo DB","date":"2016-02-07T22:40:32.169Z","tags":["aws","nosql","db"],"socialImage":null,"draft":false,"description":"aws의 No SQL 완전관리형 DB","category":"aws"},"id":"486844d0-3619-5eec-a647-a55be65225b5","html":"<h1 id=\"dynamodb\" style=\"position:relative;\"><a href=\"#dynamodb\" aria-label=\"dynamodb permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Dynamodb</h1>\n<p>DynamoDB 공부하면서 배운 기본 사항 정리.</p>\n<h2 id=\"1-기본은-key--value-형태의-db\" style=\"position:relative;\"><a href=\"#1-%EA%B8%B0%EB%B3%B8%EC%9D%80-key--value-%ED%98%95%ED%83%9C%EC%9D%98-db\" aria-label=\"1 기본은 key  value 형태의 db permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 기본은 Key &#x26; Value 형태의 DB</h2>\n<p>기본은 key value 형태의 <code class=\"language-text\">nosql</code> 형태의 DB 이다.</p>\n<p>또한 데이터의 유일한 식별키인 <code class=\"language-text\">Primary key</code>가 <strong>반드시</strong> 존재한다.</p>\n<h2 id=\"2-primary-key-partition-key-range-key\" style=\"position:relative;\"><a href=\"#2-primary-key-partition-key-range-key\" aria-label=\"2 primary key partition key range key permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Primary key, Partition key, Range key</h2>\n<h3 id=\"21-primary-key\" style=\"position:relative;\"><a href=\"#21-primary-key\" aria-label=\"21 primary key permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 Primary key</h3>\n<p>딱 부러지게 내가 지정한다기 보다는 유도를 하는 느낌. 기본적으로 테이블을 만들 시 <code class=\"language-text\">Partition Key</code>는 필수로 지정을 해야하는데 <code class=\"language-text\">Partition Key</code>만 지정하게 되면 일단 <code class=\"language-text\">Primary key</code>는 <code class=\"language-text\">Partition Key</code>가 된다. <code class=\"language-text\">Range key</code>도 함께 설정을 하게 된다면 <code class=\"language-text\">Primary key</code>는 <code class=\"language-text\">Partition key</code> + <code class=\"language-text\">Range key</code>를 조합한 혼합키 형태가 된다.</p>\n<h3 id=\"22-partition-key\" style=\"position:relative;\"><a href=\"#22-partition-key\" aria-label=\"22 partition key permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 Partition key</h3>\n<p><code class=\"language-text\">Range key</code>를 지정하지 않았다면 식별키(<code class=\"language-text\">PK</code>)가 된다. 하지만 식별키라고 그대로 이해하기 보단 이름 그대로 해당 Partition에 key값이라고 이해해야 한다. 만약 <code class=\"language-text\">GSI</code>를 따로 지정하지 않았다면 하나의 파티션(<code class=\"language-text\">Table</code>)안에 있는 key값이라 생각하고 <code class=\"language-text\">GSI</code>를 지정하게 된다면 여러 파티션(<code class=\"language-text\">Table</code>)안에 각각의 key 값들이라고 생각하면 된다. 이해가 어렵다면 우선 <code class=\"language-text\">Secondary Index</code>(<code class=\"language-text\">LSI</code>, <code class=\"language-text\">GSI</code>) 먼저 보는걸 추천.</p>\n<h3 id=\"23-range-key\" style=\"position:relative;\"><a href=\"#23-range-key\" aria-label=\"23 range key permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 Range key</h3>\n<p>DynamoDB는 별다른 설정을 안했다면 데이터를 추출 시 정렬이 불가능하다. 정렬된 형태로 값을 원할 시 <code class=\"language-text\">Range Key</code>또는 <code class=\"language-text\">범위 키</code>라고도 하는 옵션을 설정하면 그때서야 정렬이 가능하다. 하지만 <code class=\"language-text\">2.1</code>에서 설명한 대로 <code class=\"language-text\">Range key</code>를 설정하게 되면 하나의 레코드의 고유한 <code class=\"language-text\">Primary key</code>(RDB의 pk)는 <code class=\"language-text\">Partition Key</code> + <code class=\"language-text\">Range Key</code>가 되므로 이점을 주의해야 한다.</p>\n<h2 id=\"3-query-scan\" style=\"position:relative;\"><a href=\"#3-query-scan\" aria-label=\"3 query scan permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Query, Scan</h2>\n<h3 id=\"31-scan\" style=\"position:relative;\"><a href=\"#31-scan\" aria-label=\"31 scan permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 scan</h3>\n<p>scan은 테이블의 모든 데이터를 찾는 형태고 지정된 표현식으로 필터링 하여 값을 가져올 수가 있다. 구지 <code class=\"language-text\">Primary key</code>값을 조건으로 검색을 안해도 값을 구할 수가 있다. 이때 가져오는 값은 정렬은 불가능한걸로 알고 있다.</p>\n<h3 id=\"32-query\" style=\"position:relative;\"><a href=\"#32-query\" aria-label=\"32 query permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 query</h3>\n<p>주어진 범위(partition) 내에서 해당 데이터만 찾기 때문에 검색이 빠르다. 인덱스를 지정해서 해당 범위만 찾게 할 수도 있어서 여러모로 유용하지만 단점으로는 당연히 <code class=\"language-text\">주어진 범위</code>값을 줘야하는데 이 값이 <code class=\"language-text\">Partition Key</code>이다. 만약 <code class=\"language-text\">Partition key</code>값을 일반 RDB의 <code class=\"language-text\">PK</code>값(고유한 값)을 사용한다면 꽤나 난감한 상황이 발생된다. 조건에 맞는 데이터를 검색하는데 <code class=\"language-text\">PK</code>를 알아야하는 상황이 발생한다.</p>\n<h2 id=\"4-lsi-gsi\" style=\"position:relative;\"><a href=\"#4-lsi-gsi\" aria-label=\"4 lsi gsi permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. LSI, GSI</h2>\n<h3 id=\"41-lsi\" style=\"position:relative;\"><a href=\"#41-lsi\" aria-label=\"41 lsi permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 LSI</h3>\n<p>기본 테이블의 <code class=\"language-text\">Partition Key</code>값을 유지하고, <code class=\"language-text\">Range Key</code>만 바꿔서 인덱싱을 하는 형태. 읽기, 쓰기 비용이 추가로 발생하진 않지만 활용도 면은 썩 좋진 않은거 같다.</p>\n<h3 id=\"42-gsi\" style=\"position:relative;\"><a href=\"#42-gsi\" aria-label=\"42 gsi permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2 GSI</h3>\n<p>테이블 안에 테이블을 만든다고 생각하는게 편하다. 새롭게 <code class=\"language-text\">Partition key</code>를 지정하고, 옵션으로 <code class=\"language-text\">Range Key</code> 지정이 가능하다. 테이블 안에 테이블을 만든다고 했는데 진짜로 내부적으로 그렇게 사용해서 GSI를 지정하면 쓰기 비용이 훨씬 증가한다. 데이터를 삽입할 때 ‘테이블 안에 테이블’에 어떤값을 저장할지 지정해 줄 수 있다. partition &#x26; range key만 저장(<code class=\"language-text\">KEYS_ONLY</code>)하거나 특정 attribute만 저장(INCLUDE), 아니면 저장되는 모든 데이터를 지정(<code class=\"language-text\">ALL</code>)할 수도 있는데 물론 저장하는 데이터를 많이 지정할 수록 쓰기비용이 더욱 늘어나고 이러한 옵션을 <code class=\"language-text\">Projection</code> 또는 <code class=\"language-text\">Projection type</code>이라고 한다.</p>\n<p>장점으로는 <code class=\"language-text\">Query</code>를 요청 시 <code class=\"language-text\">Partition key</code>값을 필수로 요구하는데 테이블의 공통된 값 아무거나 <code class=\"language-text\">Partition Key</code>로 묶어 <code class=\"language-text\">GSI</code>를 지정하면 내가 지정한 <code class=\"language-text\">Range Key</code>값에 따라 정렬이 보장된 조회할 수가 있다(쿼리 요청 시 <code class=\"language-text\">GSI</code> index name을 넘겨주기만 하면 된다.)</p>"}},{"node":{"fields":{"slug":"/posts/aws/aws-lambda-edge-resize/","__typename":"MarkdownRemarkFields","categorySlug":"/category/aws/"},"frontmatter":{"template":"post","title":"AWS - Lambda@Edge - 이미지 리사이징","date":"2021-01-22T02:48:08.854Z","tags":["aws","cloudfront","cdn","lambda"],"socialImage":null,"draft":false,"description":"Cloud Front, Lambda를 활용해서 이미지 실시간 리사이징","category":"aws"},"id":"91fe7b0c-98c7-581e-8746-5688ca20b0a6","html":"<h2 id=\"lambdaedge-활용한-이미지-리사이징\" style=\"position:relative;\"><a href=\"#lambdaedge-%ED%99%9C%EC%9A%A9%ED%95%9C-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95\" aria-label=\"lambdaedge 활용한 이미지 리사이징 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lambda@Edge 활용한 이미지 리사이징</h2>\n<p>서비스를 운영할 때 이미지 리소스 관리는 귀찮은 일이 많다. 하나의 이미지라도 여러 서비스에서 각각 최적화된 형태의 포맷, 사이즈 등을 적용 시키고 싶을때가 많기 때문이다. 예를들어 하나의 이미지를 pc에서 볼 땐 원본 그대로 표출하고, 모바일에서 볼땐 <code class=\"language-text\">100x100</code> 사이즈로 표출하려고 한다면 이에 따라 이미지를 어떻게 관리 해야할지 고민이 많을수도 있기 떄문이다.</p>\n<p>가장 일반적인 방법으로는 사이즈별 or 포맷별로 전부 이미지 파일을 업로드 하는 방법이 있다. 하지만 이러한 방법은 저장공간도 많이 필요하고 더욱 큰 문제는 업로드 할때도 많은 이미지를 일일이 업로드하기엔 엄청 귀찮고 관리포인트도 많이 늘어나게된다.\n두번째 방법으로는 <code class=\"language-text\">S3</code>에 파일이 업로드 되면 여러 형태의 이미지가 생성되도록 람다 트리거를 거는 방법도 있다. 하지만 이 방법은 저장공간은 더욱 많이 들고, 이미지도 언제 생성될지 알 수 없다(생성은 빠르긴 하겠지만 그래도 업로드 직후 확인하면 <code class=\"language-text\">404</code>가 뜨는 케이스가 많을 것이라고 생각된다.)</p>\n<p>이런 경우 많이 쓰는게 <code class=\"language-text\">Lambda@Edge</code>를 통해 실시간 이미지 리사이징이다.\n<code class=\"language-text\">Cloud Front</code>로 이미지 요청이 오면 <code class=\"language-text\">Origin Response</code>를 조작해서 최적화된 형태의 이미지를 생성 후 응답해주면 된다. 이렇게 구성하면 이미지 저장 공간도 많이 절약되고, 각 플랫폼 별로 최적화 된 이미지를 원본 이미지 변경이나 추가 없이 제공해 줄수 있어 매우 유용하다. 이미지를 매번 생성하여 응답하면 응답시간이 너무 길어 질꺼라는 불안감이 생길 수 있지만 최초 응답 시엔 이미지를 생성하여 응답해주니까 응답시간이 약간 길어 질수 있지만 이후엔 똑같은 요청이라면 <code class=\"language-text\">Cloud front</code>에서 이미지가 캐싱되어 응답하므로 응답시간은 훨씬 단축된다.</p>\n<hr>\n<h2 id=\"이미지-리사이징-cloud-front에-적용\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95-cloud-front%EC%97%90-%EC%A0%81%EC%9A%A9\" aria-label=\"이미지 리사이징 cloud front에 적용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>이미지 리사이징 Cloud Front에 적용</h2>\n<p>사실 이러한 방법은 다른곳에서도 많이 사용하고 있고, 조금만 찾아보면 소스코드도 쉽게 구할 수가 있다. 하지만 뭔가 다 조금씩 아쉬운것들이 많아 조금 더 개선해 보았다. 구현한 소스코드는 <a href=\"https://github.com/qweasd147/serverless-boilerplate/tree/master/lambda-edge\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">이미지 리사이징</a> 여기서 확인이 가능하다.</p>\n<h3 id=\"중요-포인트--개선한-것\" style=\"position:relative;\"><a href=\"#%EC%A4%91%EC%9A%94-%ED%8F%AC%EC%9D%B8%ED%8A%B8--%EA%B0%9C%EC%84%A0%ED%95%9C-%EA%B2%83\" aria-label=\"중요 포인트  개선한 것 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>중요 포인트 &#x26; 개선한 것</h3>\n<ol>\n<li><code class=\"language-text\">AWS IAM</code> 생성 및 관리를 <code class=\"language-text\">serverless framework</code>로 옮겨 관리를 쉽게 할 수 있도록 변경. <code class=\"language-text\">aws</code>를 해본 사람이라면 이거 코드로 관리하는게 얼마나 유용한 지 알 것이라 생각된다.</li>\n<li>역시 <code class=\"language-text\">serverless framework</code>를 써서 배포를 매우 간단하게 바꿧다.</li>\n<li>환경변수 관리를 파일(<code class=\"language-text\">config.js</code>) 및 <code class=\"language-text\">header</code>값을 통해 관리 가능하도록 개선. 기본적으로 <code class=\"language-text\">Lambda@Edge</code>는 환경변수를 사용 못해 <code class=\"language-text\">빌드 환경</code> or <code class=\"language-text\">헤더값</code>을 통해서만 설정값을 사용 할 수가 있다.</li>\n<li>만든 소스는 <code class=\"language-text\">Lambda@Edge</code>를 제외한 <code class=\"language-text\">cloud front</code> 및 연관 <code class=\"language-text\">behaviors</code>가 셋팅 된 상태에서 적용 시키는게 목적으로, 기본적인 <code class=\"language-text\">CDN</code> 기능에서 이미지 리사이징 기능을 추가한 일종의 데코레이터라고 생각하며 만들었다(<code class=\"language-text\">CF</code> &#x26; <code class=\"language-text\">behaviors</code>세부 셋팅 및 초기화는 <code class=\"language-text\">Cloud formation</code>으로 관리하지 않는다).</li>\n</ol>\n<h3 id=\"적용-방법mac-환경-기준\" style=\"position:relative;\"><a href=\"#%EC%A0%81%EC%9A%A9-%EB%B0%A9%EB%B2%95mac-%ED%99%98%EA%B2%BD-%EA%B8%B0%EC%A4%80\" aria-label=\"적용 방법mac 환경 기준 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>적용 방법(mac 환경 기준)</h3>\n<ol>\n<li>S3, Cloud Front &#x26; behaviors 셋팅</li>\n</ol>\n<p>셋팅 방법은 이전 <a href=\"/blog/tag/cloudfront/\">cloud front 글 리스트</a>를 참고한다. 추가로 s3는 public이 아닌 private하게 구성하는걸 추천하고, <code class=\"language-text\">behaviors</code> 구성 시 <code class=\"language-text\">Query String white list</code>를 <code class=\"language-text\">d w h</code>이렇게 3개 추가해준다(소스 코드상에서 3개의 값만 사용하기 때문에).</p>\n<p><strong>주의!</strong></p>\n<p><code class=\"language-text\">behaviors</code>의 <code class=\"language-text\">path pattern</code>과 <code class=\"language-text\">S3</code>의 디렉토리 시작은 같은걸로 맞춰준다. 소스 코드에선 <code class=\"language-text\">/images</code>로 똑같이 맞춰져 있다.\nex) <code class=\"language-text\">behaviors</code>의 패턴은 <code class=\"language-text\">/images/*</code>로 셋팅, <code class=\"language-text\">S3</code>는 /images 하위에 이미지 파일 업로드</p>\n<ol start=\"2\">\n<li>소스코드 다운로드 &#x26; 설정값 변경</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ git clone https://github.com/qweasd147/serverless-boilerplate.git\n$ cd ./lambda-edge\n$ npm install</code></pre></div>\n<p>다운 받은 파일에서 <code class=\"language-text\">config.js</code>파일을 수정한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  <span class=\"token literal-property property\">development</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token constant\">BUCKET_NAME</span><span class=\"token operator\">:</span> <span class=\"token string\">\"버킷명\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token constant\">BUCKET_REGION</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ap-northeast-2\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//버킷이 있는 리전</span>\n    <span class=\"token constant\">BUCKET_PATH</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/images/*\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//behaviors path, cf->bucket 접근 경로 제한 설정 위해서(role)</span>\n    <span class=\"token constant\">DISTRIBUTION_ID</span><span class=\"token operator\">:</span> <span class=\"token string\">\"xxxxxxx\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>위에 값을 바꿔준다. 참고 사항으로 <code class=\"language-text\">development</code>라는 키는 <code class=\"language-text\">stage</code>를 정의하는 값이다. 만약 다른 <code class=\"language-text\">stage</code>도 추가하고 싶으면 키값 &#x26; 설정값을 적당히 변경 및 추가 한 후, <code class=\"language-text\">Cloud Front</code> -> <code class=\"language-text\">Origins</code>으로 접근 한 다음 <code class=\"language-text\">Origin Custom Headers</code>값에 <code class=\"language-text\">x-lambda-stage</code> : stage 값을 추가 해주고, 배포 시 해당 <code class=\"language-text\">stage</code>로 셋팅해서 배포 하면 된다.</p>\n<ol start=\"3\">\n<li>배포</li>\n</ol>\n<h4 id=\"stagedevelopment-변경-없이-그냥-배포\" style=\"position:relative;\"><a href=\"#stagedevelopment-%EB%B3%80%EA%B2%BD-%EC%97%86%EC%9D%B4-%EA%B7%B8%EB%83%A5-%EB%B0%B0%ED%8F%AC\" aria-label=\"stagedevelopment 변경 없이 그냥 배포 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>stage(<code class=\"language-text\">development</code>) 변경 없이 그냥 배포</h4>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ npm deploy.dev</code></pre></div>\n<h4 id=\"stagedevelopment-변경-했을-시-sls-문법-그대로-써서-배포\" style=\"position:relative;\"><a href=\"#stagedevelopment-%EB%B3%80%EA%B2%BD-%ED%96%88%EC%9D%84-%EC%8B%9C-sls-%EB%AC%B8%EB%B2%95-%EA%B7%B8%EB%8C%80%EB%A1%9C-%EC%8D%A8%EC%84%9C-%EB%B0%B0%ED%8F%AC\" aria-label=\"stagedevelopment 변경 했을 시 sls 문법 그대로 써서 배포 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>stage(<code class=\"language-text\">development</code>) 변경 했을 시, sls 문법 그대로 써서 배포</h4>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ sls deploy --stage 셋팅한_stage_값</code></pre></div>\n<p>ex) production 환경 셋팅</p>\n<p>config.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  <span class=\"token literal-property property\">development</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token constant\">BUCKET_NAME</span><span class=\"token operator\">:</span> <span class=\"token string\">\"버킷명\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token constant\">BUCKET_REGION</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ap-northeast-2\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//버킷이 있는 리전</span>\n    <span class=\"token constant\">BUCKET_PATH</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/images/*\"</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">//behaviors path, cf->bucket 접근 경로 제한 설정 위해서(role)</span>\n    <span class=\"token constant\">DISTRIBUTION_ID</span><span class=\"token operator\">:</span> <span class=\"token string\">\"xxxxxxx\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">production</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token constant\">BUCKET_NAME</span><span class=\"token operator\">:</span> <span class=\"token string\">\"product-bucket\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token constant\">BUCKET_REGION</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ap-northeast-2\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token constant\">BUCKET_PATH</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/images/*\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token constant\">DISTRIBUTION_ID</span><span class=\"token operator\">:</span> <span class=\"token string\">\"PRODUCT_CF_ID\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>deploy command</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ sls deploy --stage production</code></pre></div>\n<p>추가로 <code class=\"language-text\">x-lambda-stage</code>값 <code class=\"language-text\">production</code> 추가</p>\n<h3 id=\"주의점--커스텀-요소\" style=\"position:relative;\"><a href=\"#%EC%A3%BC%EC%9D%98%EC%A0%90--%EC%BB%A4%EC%8A%A4%ED%85%80-%EC%9A%94%EC%86%8C\" aria-label=\"주의점  커스텀 요소 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>주의점 &#x26; 커스텀 요소</h3>\n<ol>\n<li>삭제 어려움</li>\n</ol>\n<p>먼저 배포는 쉬운데 <code class=\"language-text\">Lambda@Edge</code> 적용을 취소하는게 어렵다. 보통 배포 된 것을 취소 하려면 <code class=\"language-text\">Serverless framework</code>에서 제공해주는 <code class=\"language-text\">sls remove</code> 명령을 통해 쉽게 없앨 수가 있지만 <code class=\"language-text\">Lambda@Edge</code> 특성 상 각 리전별로 함수 복제가 일어난다. 이러한 복제된 함수를 먼저 다 없어진 다음에야 버지니아 북부 리전에 배포된 함수 삭제가 가능한데, 복제된 함수가 언제 삭제 될 지는 알수 없다(상황에 따라 많이 다르지만 보통 10분 ~ 30분). 차라리 다시 업데이트 하는거면 일단 배포 한 뒤 적용 되기까지 그냥 무작정 기다릴 수도 있지만 없애는건 아무래도 개발자가 직접 개입해서 <code class=\"language-text\">cloud front</code>에서 연동된 람다 함수를 끊고 복제된 함수가 전부 없어지면 <code class=\"language-text\">cloud formation</code>에서 직접 삭제해야 할 듯 싶다.</p>\n<ol start=\"2\">\n<li>에러 발생 시 처리 방법</li>\n</ol>\n<p>올려놓은 소스에선 에러 발생 시, 그냥 에러를 리턴하게 해놓았다. 만약 에러 발생 시 원본 이미지를 그대로 전달해주고 싶으면 약간의 수정이 필요하다.</p>\n<p>또한 <code class=\"language-text\">Lambda@Edge</code> 특성상 <code class=\"language-text\">body</code>를 수정하면 <code class=\"language-text\">body</code>에 최대 1MB까지 담을 수 있다. 만약 리사이징 한 이미지가 1MB가 넘는다면 문제가 생기는데 이거 또한 고민이 필요하다. <a href=\"https://medium.com/daangn/lambda-edge%EB%A1%9C-%EA%B5%AC%ED%98%84%ED%95%98%EB%8A%94-on-the-fly-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95-f4e5052d49f3\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">당근 마켓에서 하는 이미지 리사이징</a>을 참고하면 1MB가 넘으면 퀄리티를 조금씩 내리면서 계속 이미지 생성을 하고 있다. 이것도 하나의 방법이긴 하지만 사용하는 곳에 따라 약간의 커스터 마이징이 필요할까 같다.</p>\n<ol start=\"3\">\n<li>배포 환경에 따라 스크립트 수정</li>\n</ol>\n<p>먼저 간단하게 serverless에서 내부적으로 하는 배포 과정</p>\n<ul>\n<li>로컬에서 build (<code class=\"language-text\">npm install</code> 및 <code class=\"language-text\">webpack</code>설정이 있으면 번들링)</li>\n<li>cloud formation에 따라 배포</li>\n</ul>\n<p>현재 소스에서 이미지 리사이징 하는데 사용하는 <code class=\"language-text\">sharp</code>모듈은 os에 따라 내부적으로 설치되는게 다른데 위의 설명한대로 빌드는 로컬 환경에서, 실행은 컨테이너(아마도 리눅스) 환경에서 실행 되다 보니 os 차이가 발생 되어 오류가 발생된다. 이러한 문제를 해결하려면 빌드 환경을 실행하는 환경과 동일하게 구성하거나 아니면 강제로 특정 os에 맞게 모듈을 설치해야한다. 코드 상에서도 강제로 람다 환경에 필요한 모듈을 설치하도록 셋팅 되어 있는데, os에 따라 람다에 맞는 모듈을 설치하려면 <a href=\"https://sharp.pixelplumbing.com/install#aws-lambda\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">sharp install</a>을 참고하면 된다. 참고로 소스 상에서 이러한 문제는 <code class=\"language-text\">npm install</code>하면 자동으로 인스톨 이후에 실행되는 <code class=\"language-text\">postinstall</code>을 사용해서 해결하였다.</p>\n<p>package.json</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"postinstall\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"rm -rf node_modules/sharp &amp;&amp; SHARP_IGNORE_GLOBAL_LIBVIPS=1 npm install --arch=x64 --platform=linux sharp\"</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>위에 내용은 설명한대로 mac 환경에서 셋팅한 <code class=\"language-text\">package.json</code>파일이다. 만약 mac이 아니라면 위 스크립트 내용 수정이 필요하다.</p>"}},{"node":{"fields":{"slug":"/posts/aws/aws-lambda-edge/","__typename":"MarkdownRemarkFields","categorySlug":"/category/aws/"},"frontmatter":{"template":"post","title":"AWS - Lambda@Edge - 기본","date":"2021-01-14T02:31:18.369Z","tags":["aws","cloudfront","cdn","lambda"],"socialImage":null,"draft":false,"description":"Cloud Front, Origin Server 서버 요청 전후로 Lambda 함수 실행","category":"aws"},"id":"17240bb1-3862-505b-ae32-d1f7d6df8fed","html":"<h2 id=\"lambdaedge\" style=\"position:relative;\"><a href=\"#lambdaedge\" aria-label=\"lambdaedge permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lambda@Edge</h2>\n<p><code class=\"language-text\">CloudFront</code>는 CDN역할만 해도 좋은 퍼포먼스를 보여주지만 추가로 Lambda와 함께 사용이 가능하다.</p>\n<p><code class=\"language-text\">CloudFront</code>로 요청 전후를 가로채 <code class=\"language-text\">Lambda</code>함수 내에서 <code class=\"language-text\">Request</code>&#x26;<code class=\"language-text\">Response</code> 객체, 상태코드 등을 바꾸거나 아니면 다른곳으로 redirect도 가능하다.</p>\n<p><img src=\"/blog/media/aws/cf/edge/lamda_edge_trigger.png\" alt=\"img1\">\n<a href=\"https://docs.aws.amazon.com/ko_kr/lambda/latest/dg/lambda-edge.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">aws 공식문서 설명</a></p>\n<p>위 이미지 및 문서에 보이는데로 총 4곳에 <code class=\"language-text\">Lambda</code> 함수 연결이 가능하다.</p>\n<ul>\n<li>CloudFront가 최종 사용자로부터 요청을 수신한 후(최종 사용자 요청)</li>\n<li>CloudFront가 오리진에 요청을 전달하기 전(오리진 요청)</li>\n<li>CloudFront가 오리진으로부터 응답을 수신한 후(오리진 응답)</li>\n<li>CloudFront가 최종 사용자에게 응답을 전달하기 전(최종 사용자 응답)</li>\n</ul>\n<p>이런식으로 단순 cdn, 라우팅 역할만 하다가 Lambda로 전후처리가 가능하면서 활용도가 많이 높아졌다.</p>\n<h2 id=\"주의점\" style=\"position:relative;\"><a href=\"#%EC%A3%BC%EC%9D%98%EC%A0%90\" aria-label=\"주의점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>주의점</h2>\n<ol>\n<li>\n<p>연결 할 함수는 버지니아 북부 리전에 배포</p>\n<blockquote>\n<p><code class=\"language-text\">CloudFront</code>에 적용할 Lambda 함수는 <code class=\"language-text\">us-east-1(버지니아 북부)</code> 리전에 배포된 함수만 가능하다. 그럼 추가 의문사항으로 <code class=\"language-text\">CF</code>는 각 엣지로케이션에서 데이터를 가져오는데 정작 Lambda 함수는 특정 리전에서만 실행되면 느려지지 않을까 생각 할수도 있지만, 요청이 들어오면 가장 가까운 리전으로 함수가 복사된 후 실행되므로 물리적 거리로 인해 느려지는건 고민 안해도 된다. 또한 <code class=\"language-text\">CloudWatch</code>에 쌓이는 로그도 역시 각 함수가 실행된 리전에 쌓이게 된다. 만약 복제되는 걸 직접 확인하고 싶으면 AWS 홈페이지에서 Lambda -> 옵션 창에 <code class=\"language-text\">복제된 함수 표시</code>옵션을 키면 배포는 버지니아 북부에 배포되었지만 다른 리전에도 <code class=\"language-text\">(Replica)</code>표기와 함께 배포되어 있는걸 확인 할 수가 있다.</p>\n</blockquote>\n</li>\n<li>\n<p>항상 실행되는 함수, 결과 값을 캐싱하여 필요할 때만 실행되는 함수</p>\n<blockquote>\n<p>위 이미지를 보면 <code class=\"language-text\">viewer-request</code>, <code class=\"language-text\">viewer-response</code>는 각각 캐싱서버 도착 전, 캐싱서버 응답 후 실행되는 함수이다. 이런건 request마다 매번 실행되는 함수이니까 조심해야한다.(Lambda 함수 비용 폭탄을 맞을 수가 있다). 반대로 <code class=\"language-text\">origin-request</code>, <code class=\"language-text\">origin-response</code>는 캐싱 적중 여부에 따라 실행 될 수도, 안될 수도 있다.</p>\n</blockquote>\n</li>\n<li>\n<p>캐싱</p>\n<blockquote>\n<p><code class=\"language-text\">Lambda@Edge</code>를 구성해도 CDN 기능이 없어지는게 아니다. 위에서 설명한 대로 요청에 따라 결과값을 캐싱하고 응답하게 된다. 여기서 캐싱 키값은 어떤값들을 기준으로 생성되나 생각할 수 있는데, <code class=\"language-text\">uri</code>는 필수도 들어가고 여기에 <code class=\"language-text\">querystring</code>, <code class=\"language-text\">header</code>값을 섞어서 키가 만들어지게 설정 할 수도 있다. 일반적으로 해더값을 추가하면 요청 기기에 따라 다 각각 캐시가 될 수도 있으므로 <code class=\"language-text\">querystring</code>만 사용하여 키가 만들어지도록 설정하다. (<code class=\"language-text\">CF</code>에서 <code class=\"language-text\">Behavior</code> 탭에서 설정이 가능하다.)</p>\n</blockquote>\n</li>\n<li>\n<p>환경 변수</p>\n<blockquote>\n<p><code class=\"language-text\">Lambda@Edge</code>는 기본적으로 환경변수 사용이 안된다.</p>\n</blockquote>\n</li>\n</ol>\n<p>추가로 제한사항이 쫌 많은데 자세한건 역시 <a href=\"https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/lambda-requirements-limits.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">공식 문서</a>를 한번 읽어보는걸 추천</p>"}},{"node":{"fields":{"slug":"/posts/aws/aws-serverless/","__typename":"MarkdownRemarkFields","categorySlug":"/category/aws/"},"frontmatter":{"template":"post","title":"Serverless","date":"2016-02-08T22:40:32.169Z","tags":["serverless","aws","lambda","nodejs"],"socialImage":null,"draft":false,"description":"서버 리소스 관리가 귀찮을때","category":"aws"},"id":"d2981cff-7ea5-5f08-9877-ac19e5b0d9ae","html":"<h1 id=\"serverless\" style=\"position:relative;\"><a href=\"#serverless\" aria-label=\"serverless permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>serverless</h1>\n<p>serverless-boilerplate</p>\n<p>샘플 코드는 <a href=\"https://github.com/qweasd147/serverless-boilerplate\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">serverless-boilerplate</a> 여기서 확인 가능</p>\n<p>서버 자원을 전혀 고려하지 않아도 된다는 취지로 만들어 졌지만 aws를 기준으로 성능을 위해서라면 memory용량을 늘리고 memory 용량을 늘려야 cpu 성능이 좋아져, 이러한 점도 신경써야 한다는 안타까운 점이 존재.\n(aws만 그런지 다른 서비스도 그런지는 모르겠음)</p>\n<p>안타까운점이 있지만 일정시간 이상 람다 트리거가 발동하지 않으면 <code class=\"language-text\">idle</code>상태로 빠지고 이러한 점 때문인지 일반적으로 <code class=\"language-text\">ec2</code>로 인스턴스를 올리는것보다 비용이 싸게 먹힌다고 한다.\n단, 람다는 요청 단위로 과금이 결정되서 비교가 힘들긴 하지만 요청이 많으면 <code class=\"language-text\">ec2</code>보다 훨씬 비싸다고 한다.</p>\n<h2 id=\"1-연관-플러그인\" style=\"position:relative;\"><a href=\"#1-%EC%97%B0%EA%B4%80-%ED%94%8C%EB%9F%AC%EA%B7%B8%EC%9D%B8\" aria-label=\"1 연관 플러그인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 연관 플러그인</h2>\n<p>개발하면서 발견한 유용한 플러그인 등을 소개</p>\n<h3 id=\"11-환경변수를-관리하고-싶을때\" style=\"position:relative;\"><a href=\"#11-%ED%99%98%EA%B2%BD%EB%B3%80%EC%88%98%EB%A5%BC-%EA%B4%80%EB%A6%AC%ED%95%98%EA%B3%A0-%EC%8B%B6%EC%9D%84%EB%95%8C\" aria-label=\"11 환경변수를 관리하고 싶을때 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 환경변수를 관리하고 싶을때</h3>\n<p>-> <code class=\"language-text\">serverless-dotenv-plugin</code>을 사용한다.\n각 서비스 환경(dev, staging, product 등)별 환경변수를 관리하고 사용하고 싶을때 매우 유용하게 써먹을수 있다.</p>\n<h3 id=\"12-요청에-대한-전처리-등이-필요할때\" style=\"position:relative;\"><a href=\"#12-%EC%9A%94%EC%B2%AD%EC%97%90-%EB%8C%80%ED%95%9C-%EC%A0%84%EC%B2%98%EB%A6%AC-%EB%93%B1%EC%9D%B4-%ED%95%84%EC%9A%94%ED%95%A0%EB%95%8C\" aria-label=\"12 요청에 대한 전처리 등이 필요할때 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 요청에 대한 전처리 등이 필요할때</h3>\n<p>-> <code class=\"language-text\">aws-serverless-koa</code>또는 <code class=\"language-text\">aws-serverless-express</code>를 사용한다.</p>\n<p>처음엔 그냥 람다 만들고 <code class=\"language-text\">API Gateway</code>로 연결해서 쓰면 됬지 뭐하라 사용하나 싶었는데 일단 이런 프레임워크를 쓰니까 <code class=\"language-text\">middleware</code>처리나 <code class=\"language-text\">router</code>를 활용할 수 있어서 편하다. 또 프레임 워크(<code class=\"language-text\">koa</code> or <code class=\"language-text\">express</code>)를 사용하지 않고 개발하다보면 파라미터 파싱하기도 귀찮고 lambda에 의존되는 코드(파라미터 가져오기, 응답값 내보내기 등)가 생기는데 이러한 부분을 프레임워크를 써서 처리해주니까 순수 nodejs만 개발한 사람은 lambda 레퍼런스 보는 시간이 줄어 든거 같다.</p>\n<h3 id=\"13-로그를-남기고-싶을때\" style=\"position:relative;\"><a href=\"#13-%EB%A1%9C%EA%B7%B8%EB%A5%BC-%EB%82%A8%EA%B8%B0%EA%B3%A0-%EC%8B%B6%EC%9D%84%EB%95%8C\" aria-label=\"13 로그를 남기고 싶을때 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3 로그를 남기고 싶을때</h3>\n<p>일반적으로 <code class=\"language-text\">Lambda</code>는 <code class=\"language-text\">console.log</code>같은걸 쓰면 알아서 <code class=\"language-text\">cloudwatch logs</code>에 남긴다. 근데 이게 개발하면서 디버깅용 로그를 사용할때가 분명 많을 것이다. 하지만 일단 <code class=\"language-text\">console.log</code>를 사용하면 무조건 <code class=\"language-text\">cloudwatch logs</code>에 남는다. 그렇다고 개발 이후에 로그를 남긴 소스를 주석처리하기도 쫌 그렇다… 테스트는 안해봤지만 info, warn, error 등도 남을 것이고, debug는 모르겠다. 아무튼 각 로그 레벨 설정에 따른 로그를 남기고 싶을땐 예전 nodejs로 개발할때는 <code class=\"language-text\">winston</code>을 사용했었는데 <code class=\"language-text\">serverless</code> 플러그인 중에도 <code class=\"language-text\">winston-cloudwatch</code>가 있었다.</p>\n<p>하지만 뭔가 셋팅이 점점 늘어나, serverless framework를 쓰면서 특정 모듈별 간편하게 개발하는 기분이 들지 않아서 사용해보진 않았다. 규모가 쫌 커지면 그때 사용을 고려해볼 예정이다.</p>\n<h3 id=\"14-이진-데이터-지원파일\" style=\"position:relative;\"><a href=\"#14-%EC%9D%B4%EC%A7%84-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%A7%80%EC%9B%90%ED%8C%8C%EC%9D%BC\" aria-label=\"14 이진 데이터 지원파일 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.4 이진 데이터 지원(파일)</h3>\n<p>기본적으로 multipart로 파일을 보내면 <code class=\"language-text\">API Gateway</code>에서 지원을 하지 않아서 처리가 불가능하다. 별도로 <code class=\"language-text\">API Gateway</code>에 들어가서 파일을 이진 데이터 형태로 지원하게끔 설정할 수도 있지만 이를 plugin을 설치 &#x26; 셋팅해서 배포하면서 그냥 한번에 셋팅 되도록 할 수도 있다. <code class=\"language-text\">serverless-apigw-binary</code> 검색</p>\n<h3 id=\"15-include-modules\" style=\"position:relative;\"><a href=\"#15-include-modules\" aria-label=\"15 include modules permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.5 include modules</h3>\n<p>작업하면서 로컬환경에서는 잘 작동하는데 aws에 배포하기만 하면 <code class=\"language-text\">mysql2</code> 모듈을 찾을 수 없다고 나온다. 이는 아마도 배포되면서 <code class=\"language-text\">Code-Splitting</code>이 이루어지고, <code class=\"language-text\">mysql2</code> 모듈은 사용하지 않아서 함께 배포가 되지 않는듯 싶다(<code class=\"language-text\">mysql2</code> 모듈은 설정값에 따라 동적으로 불러온다). 이러한 버그를 방지하기 위해서 강제적으로 배포 되도록 설정이 필요하다.</p>\n<p><code class=\"language-text\">serverless.yml</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">custom:\n  webpack:\n    webpackConfig: ./webpack.config.js\n    includeModules:\n      forceInclude:\n        - mysql2</code></pre></div>\n<h2 id=\"2-주의사항\" style=\"position:relative;\"><a href=\"#2-%EC%A3%BC%EC%9D%98%EC%82%AC%ED%95%AD\" aria-label=\"2 주의사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 주의사항</h2>\n<h3 id=\"21-cold-star--warm-start\" style=\"position:relative;\"><a href=\"#21-cold-star--warm-start\" aria-label=\"21 cold star  warm start permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 cold star &#x26; warm start</h3>\n<p>앞서 설명한대로 일정시간 함수가 실행되지 않으면 컨테이너가 종료된 상태로 유지된다. 그러면서 생긴 문제점은 이렇게 종료된 상태에서 함수 트리거가 발동되면 다시 컨테이너를 올리는것부터 시작된다. 이떄의 start를 <code class=\"language-text\">cold start</code>라고 한다. 반대로 주기적으로 실행되면서 컨테이너 시작부터가 아닌 그냥 함수를 바로 시행하는 start를 <code class=\"language-text\">warm start</code>라고 한다.</p>\n<p>만약 <code class=\"language-text\">cold start</code>를 하게되면 당연히 시간이 오래걸리게 된다. 프로그램마다 다 다르겠지만 그래도 1~3초 정도 더 추가적으로 걸린다고 한다. 이러한 시간을 낭비하려면 어쩔수없이 주기적으로 함수를 실행시켜 컨테이너가 종료되는 것을 막는것 밖에 없다고 한다(<code class=\"language-text\">aws</code>에서도 따로 가이드가 없다고 함). health check api를 만들어 주기적으로 만들던가 <code class=\"language-text\">cloud watch</code>를 통해 이벤트 트리거를 주기적으로 발동 시키는게 그나마 최선이라고 한다. <code class=\"language-text\">2019 kakao developer</code> 세미나에서 자신들이 테스트해본 결과 300초 이하로 주기적으로 발동시키면 <code class=\"language-text\">warm start</code>가 발동 되지 않는다고 하고, 혹시 몰라서 60초정도로 주기적으로 함수를 발동시킨다고 하였다.</p>\n<h3 id=\"22-concurrency\" style=\"position:relative;\"><a href=\"#22-concurrency\" aria-label=\"22 concurrency permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 Concurrency</h3>\n<h4 id=\"reserved-concurrency\" style=\"position:relative;\"><a href=\"#reserved-concurrency\" aria-label=\"reserved concurrency permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reserved Concurrency</h4>\n<p>함수가 실행되는 동시 개수를 제한한다. 이는 계정 &#x26; 리전별로 제한이 있으니까, 중요한 함수와 널널한 함수를 나누어서 각각 따로 제한을 두는게 좋다. 말이 좋아 서버리스지 알면 알수록 성능 튜닝 요소 &#x26; 제한이 은근히 있다(물론 서버를 직접 구축하는것 보단 훨씬 적지만).</p>\n<p>아무튼 <code class=\"language-text\">capacity</code>값을 셋팅하여 해당 리전의 함수를 동시 실행 개수를 제한해서 다른 함수 실행을 보장 할 수있다.</p>\n<p><strong>2019년에 추가된 사항</strong></p>\n<h4 id=\"provisioned-concurrency\" style=\"position:relative;\"><a href=\"#provisioned-concurrency\" aria-label=\"provisioned concurrency permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Provisioned Concurrency</h4>\n<p><code class=\"language-text\">cold start</code>와 <code class=\"language-text\">Concurrency</code>문제를 해결하기 위해 <code class=\"language-text\">Provisioned Concurrency</code>가 나왔다(<code class=\"language-text\">Concurrency</code>는 해결이라기보다는 한곳에서 관리가 가능하다). lambda에 보면\n셋팅이 직관적으로 나와있어서 쉽게 셋팅이 가능하고 해놓으면 항상 대기상태인 vm만들어 놓는다. 근데 이 셋팅을 하면 과금 정책이 <code class=\"language-text\">요청 &amp; 처리 시간</code>이 아니라\nec2처럼 그냥 돈이 계속 나가기 때문에 좋은건지 모르겠다(이쯤 되면 ec2도 한번쯤 생각해봐야 한다고 생각) 물론 <code class=\"language-text\">auto scaling</code> 엄청 좋긴하지만</p>\n<p><strong>TODO</strong>\nservlerless로 Provisioned Concurrency 핸들링</p>\n<h3 id=\"23-api-gateway를-통한-제한\" style=\"position:relative;\"><a href=\"#23-api-gateway%EB%A5%BC-%ED%86%B5%ED%95%9C-%EC%A0%9C%ED%95%9C\" aria-label=\"23 api gateway를 통한 제한 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 API Gateway를 통한 제한</h3>\n<p>트리거를 API Gateway를 통해 제한 할 수도 있다. cors를 제한해서 허용된 host만 처리한다던지, API를 발급 &#x26; import해서 인증된 request만 함수를 발동하도록 실행 제한이 가능하다.\n사용계획도 한번에 셋팅하여 일별 or 월별 사용량도 제한할 수 있긴 하다.</p>\n<h3 id=\"24-함수-실행시간\" style=\"position:relative;\"><a href=\"#24-%ED%95%A8%EC%88%98-%EC%8B%A4%ED%96%89%EC%8B%9C%EA%B0%84\" aria-label=\"24 함수 실행시간 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.4 함수 실행시간</h3>\n<p>람다 실행당 최대 15분 까지만 실행된다. 오래된 문서나 <code class=\"language-text\">overflow</code> 보면 3분? 5분?이라고 나와있는데 늘어났다. 아무튼 그 이상 걸리는 작업은 다른 서비스(<code class=\"language-text\">aws batch</code>)등을 써야한다.</p>\n<h3 id=\"25-remove\" style=\"position:relative;\"><a href=\"#25-remove\" aria-label=\"25 remove permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5 remove</h3>\n<p><code class=\"language-text\">$ sls remove</code> 옵션을 사용하여 원격 배포된 <code class=\"language-text\">serverless</code> 내용을 없앨수 있다. 하지만 이는 매우매우 위험하다. 만약 db등의 리소스가 <code class=\"language-text\">serverless</code>에 등록되어 있다면 <code class=\"language-text\">remove</code>시에 함께 테이블 정보도 싹다 날라간다. 당연히 <code class=\"language-text\">cloud watch</code>에 쌓인 로그도 함께 날라간다. 따라서 이를 방지하려면 귀찮더라도 DB는 <code class=\"language-text\">serverless</code>에서 관리되는게 아닌 그냥 직접 관리해서 접근 하거나 그냥 함부로 삭제가 아닌 소스 업데이트만 사용해야 한다.</p>\n<h3 id=\"26-callbackwaitsforemptyeventloop\" style=\"position:relative;\"><a href=\"#26-callbackwaitsforemptyeventloop\" aria-label=\"26 callbackwaitsforemptyeventloop permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.6 callbackWaitsForEmptyEventLoop</h3>"}},{"node":{"fields":{"slug":"/posts/aws/aws-vpc/","__typename":"MarkdownRemarkFields","categorySlug":"/category/aws/"},"frontmatter":{"template":"post","title":"AWS- Network","date":"2022-08-25T04:20:10.125Z","tags":["infra","aws","network"],"socialImage":null,"draft":false,"description":"AWS 기본적인 네트워크 용어 정리","category":"aws"},"id":"482d4d32-8eb2-5c03-b243-d64bf0a45aa5","html":"<h2 id=\"vpcvirtual-private-cloud\" style=\"position:relative;\"><a href=\"#vpcvirtual-private-cloud\" aria-label=\"vpcvirtual private cloud permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>VPC(virtual private cloud)</h2>\n<ul>\n<li>aws 클라우드에서 논리적으로 격리된 공간</li>\n<li>가상 네트워크 공간이라 생각하면 됨</li>\n</ul>\n<h2 id=\"az\" style=\"position:relative;\"><a href=\"#az\" aria-label=\"az permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>AZ</h2>\n<ul>\n<li>물리적으로 분리 되어있는 인프라가 모여있는 데이터 센터</li>\n<li>하나의 리전은 2개 이상의 AZ이 구성되어 있음</li>\n</ul>\n<h2 id=\"subnet\" style=\"position:relative;\"><a href=\"#subnet\" aria-label=\"subnet permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Subnet</h2>\n<ul>\n<li>VPC 하위 단위(부분 집합. 하나의 vpc를 쪼개 놓은 공간이라 생각하면 된다)</li>\n<li>하나의 서브넷은 하나의 AZ에서만 존재 가능</li>\n<li>인터넷을 통한 접근 가능/불가 설정을 할 수 있음(private subnet, public subnet)</li>\n<li>cidr block(사용 할 수 있는 아이피 범위) 적용 가능</li>\n</ul>\n<h2 id=\"internet-gatewayigw\" style=\"position:relative;\"><a href=\"#internet-gatewayigw\" aria-label=\"internet gatewayigw permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Internet Gateway(IGW)</h2>\n<ul>\n<li>인터넷으로 나가는 통로</li>\n<li>고가용성이 확보되어 있음</li>\n<li>IGW 로 연결되어 있지 않은 서브넷 = Private Subnet</li>\n<li>Route Table에서 연결 해줘야하</li>\n<li>하나의 vpc에만 연결 가능</li>\n</ul>\n<h2 id=\"nacl--security-group\" style=\"position:relative;\"><a href=\"#nacl--security-group\" aria-label=\"nacl  security group permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NACL / Security Group</h2>\n<ul>\n<li>검문소</li>\n<li>NACL => Stateless, SG => Stateful</li>\n<li>기본적으로 VPC 생성 시 만들어줌</li>\n<li>Deny는 NACL 에서만 가능</li>\n</ul>\n<h2 id=\"route-table\" style=\"position:relative;\"><a href=\"#route-table\" aria-label=\"route table permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Route Table</h2>\n<ul>\n<li>트래픽이 어디로 가야할지 알려주는 테이블</li>\n<li>기본적으로 vpc 생성 시 만들어줌</li>\n<li>local에 해당하는 아이피는 말그대로 자기한테서 찾고 그 외의 대역은 다른 igw(or nat gateway)에서 찾도록 셋팅 가능</li>\n</ul>\n<h2 id=\"nat-gateway\" style=\"position:relative;\"><a href=\"#nat-gateway\" aria-label=\"nat gateway permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>NAT Gateway</h2>\n<ul>\n<li>private instance가 외부의 인터넷과 통신하기 위한 통로</li>\n<li>내부 사설망이 있는 private 인스턴스들이 외부 인터넷과 통신을 위해 생성 된 일종의 통로</li>\n<li>하나의 공인 ip 를 가짐</li>\n<li>public subnet에 있어야함</li>\n</ul>\n<hr>\n<p>여기까지가 aws에 종속된 서비스. 이 이하는 추가적으로 함께 이해하면 좋은 네트워크 관련 내용</p>\n<h2 id=\"cidrclassless-inter-domain-routing\" style=\"position:relative;\"><a href=\"#cidrclassless-inter-domain-routing\" aria-label=\"cidrclassless inter domain routing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>cidr(Classless Inter Domain Routing)</h2>\n<ul>\n<li>클래스 없이 도메인간 라우팅기법(a,b,c 클래스기반 X). class를 안써서 더 유연한 ip 범위을 갖는다</li>\n<li>private network를 위해 만들어짐(ip가 부족해서 사설망을 구축하기 위해)</li>\n<li>ip주소의 영역을 여러 네트워크 영역으로 나누기 위해 ip를 묶는 방식</li>\n<li>ip 주소에서 네트워크 주소/호스트 주소 구분을 위해 사용된다.</li>\n</ul>\n<p>예를들어 네트워크 대역이 <code class=\"language-text\">192.168.0.0/16</code> 이라치면 앞의 2개(<code class=\"language-text\">192.168</code>)는 네트워크 주소로, 나머지 2개(<code class=\"language-text\">0.0</code>)은 호스트 주소 구분용으로 쓰인다는 의미이다.\n즉, 이 대역의 호스트 개수는 <code class=\"language-text\">192.168.0.0</code> ~ <code class=\"language-text\">192.168.255.255</code> 까지 가능하다(예약된 ip 주소 포함)</p>\n<p>추가로 <code class=\"language-text\">subnet</code> 은 <code class=\"language-text\">vpc</code>의 부분 집합이라 하였는데 <code class=\"language-text\">vpc</code>의 <code class=\"language-text\">cidr block</code> 보다 더 작은 대역을 갖게 된다.\n예를들어 <code class=\"language-text\">vpc</code> 의 <code class=\"language-text\">cidr block</code> 이 <code class=\"language-text\">192.168.0.0/16</code> 이라면 <code class=\"language-text\">subnet</code> <code class=\"language-text\">cidr</code>는 17 이상이 되어야 한다.</p>\n<p>아래 이미지는 vpc의 네트워크 대역과 하위 subnet 대역, subnet에 소속된 기기들의 아이피 주소를 설명하고 있다</p>\n<h3 id=\"private-network사설망\" style=\"position:relative;\"><a href=\"#private-network%EC%82%AC%EC%84%A4%EB%A7%9D\" aria-label=\"private network사설망 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Private Network(사설망)</h3>\n<ul>\n<li>하나의 public ip를 여러 기기가 공유 할 수 있는 방법</li>\n<li>하나의 망에는 private ip를 갖는 기기들과 gateway로 구성됨.</li>\n</ul>\n<p>즉 하나의 사설망 안에 여러 컴퓨터를 셋팅 해놓고 그 컴퓨터 기기에 고유한 private ip(망 안에서만 고유한)를 부여 받도록 구축해놓으면 하나의 public ip를 통해서 여러 컴퓨터가 인터넷을 쓸 수가 있다. 이때, 어느 기기로 트래픽을 보내야할지 라우팅 테이블이 필요하다.</p>"}},{"node":{"fields":{"slug":"/posts/etc/etc-db-optimizer/","__typename":"MarkdownRemarkFields","categorySlug":"/category/etc/"},"frontmatter":{"template":"post","title":"Mysql Optimizer","date":"2021-12-30T13:17:17.507Z","tags":["db","mysql","optimizer"],"socialImage":null,"draft":false,"description":"mysql 옵티마이저의 함정 요소. 옵티마이저를 너무 믿으면 안되는 이유","category":"etc"},"id":"c40620a0-7997-5f69-bc09-d238d2b8a85a","html":"<h3 id=\"사전지식-1-옵티마이저\" style=\"position:relative;\"><a href=\"#%EC%82%AC%EC%A0%84%EC%A7%80%EC%8B%9D-1-%EC%98%B5%ED%8B%B0%EB%A7%88%EC%9D%B4%EC%A0%80\" aria-label=\"사전지식 1 옵티마이저 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>사전지식 1. 옵티마이저</h3>\n<p>rdb는 sql질의문을 요청하면 해당 쿼리를 분석하여 최적의 실행 방법을 결정(어딜 어떻게 먼저 조회하고, 어떤 인덱스를 쓰고, 인덱스 타입은 이렇게 된다. -> 실행계획) 한 후, 그거 대로 실행한다. 그래서 적당히만 짜도 옵티마이저가 알아서 잘 분석하고 실행한다. 물론 최적의 인덱스 퍼포먼스를 보여줘야 한다면 그건 쫌 다른 이야기가 되버리는데, index랑 옵티마이저만 믿고 있다간 <code class=\"language-text\">full scan</code> or <code class=\"language-text\">full index</code> 이런거 걸려버리면 성능적으로 엄청난 문제가 생기긴 한다. 아무튼 요지는 테이블 순서나 <code class=\"language-text\">where</code> 조건절 순서 등에 관해선 옵티마이저 믿고 꽤나 자유롭게 짜도 별 상관이 없다.</p>\n<h3 id=\"사전지식-2-mysql-옵티마이저는-비용-기반으로-책정됨\" style=\"position:relative;\"><a href=\"#%EC%82%AC%EC%A0%84%EC%A7%80%EC%8B%9D-2-mysql-%EC%98%B5%ED%8B%B0%EB%A7%88%EC%9D%B4%EC%A0%80%EB%8A%94-%EB%B9%84%EC%9A%A9-%EA%B8%B0%EB%B0%98%EC%9C%BC%EB%A1%9C-%EC%B1%85%EC%A0%95%EB%90%A8\" aria-label=\"사전지식 2 mysql 옵티마이저는 비용 기반으로 책정됨 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>사전지식 2. mysql 옵티마이저는 비용 기반으로 책정됨</h3>\n<p>옵티마이저는 규칙 기반 옵티마이저(rule based optimizer. 줄여서 rbo), 비용기반 옵티마이저(cost based optimizer. 줄여서 cbo) 2가지 종류가 있는데, 줄여서 설명하면 rbo는 그냥 룰이 무조건 정해져서 별다른 리소스 상태 같은건 무시하고 그 조건 내에서만 실행계획을 새워서 실행하고 cbo는 먼저 각을 재고(비용,리소스 계산. 어떻게 검색해야 더 좋을까, 드라이빙 테이블은 어떤걸 지정할까 등등) 실행계획을 새운다.</p>\n<p>mysql을 포함해서 너무 오래된 버전이 아니라면 사실상 다 cbo를 쓰는데 방금 말한거 처럼 각 재고 실행을 한다는 점. 그니까 <strong>똑같은 쿼리문을 날려도 경우에 따라 실행 계획이 달라질 수 있다는 점이다.</strong></p>\n<hr>\n<p>이번 post에선 옵티마이저가 실행계획을 잘못 만드는 케이스를 소개&#x26;분석하는게 목적이다.</p>\n<p>테스트용 테이블. 미리 말하면 이전 샘플용으로 만들어져 있는 테이블을 테스트용 테이블로 쓰고 있어서 스키마&#x26;관계 정보는 이해 부탁드립니다.\n<img src=\"/blog/media/db/img01.png\" alt=\"img1\"></p>\n<h3 id=\"테이블-설명\" style=\"position:relative;\"><a href=\"#%ED%85%8C%EC%9D%B4%EB%B8%94-%EC%84%A4%EB%AA%85\" aria-label=\"테이블 설명 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>테이블 설명</h3>\n<ul>\n<li><code class=\"language-text\">article</code> -> 그냥 테이블1. 테스트 환경을 기준으로 10만개 정도 데이터 row 가 있음</li>\n<li><code class=\"language-text\">tag</code> -> article과 연관관계가 있고, fk를 같고있는 주체가 되는 테이블이며 <strong>1대1 관계로 관리 되고 있음.</strong> 15개 정도 데이터 row가 있음</li>\n<li><code class=\"language-text\">tag2</code> -> tag 테이블이랑 다 똑같은데 데이터 row가 딱 1개만 있음</li>\n</ul>\n<h2 id=\"case-1-위와-같은-상황에서-articletag-테이블을-left-join-하면\" style=\"position:relative;\"><a href=\"#case-1-%EC%9C%84%EC%99%80-%EA%B0%99%EC%9D%80-%EC%83%81%ED%99%A9%EC%97%90%EC%84%9C-articletag-%ED%85%8C%EC%9D%B4%EB%B8%94%EC%9D%84-left-join-%ED%95%98%EB%A9%B4\" aria-label=\"case 1 위와 같은 상황에서 articletag 테이블을 left join 하면 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>case 1. 위와 같은 상황에서 article&#x26;tag 테이블을 left join 하면?</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> article\n<span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> tag <span class=\"token keyword\">on</span> tag<span class=\"token punctuation\">.</span>article_id <span class=\"token operator\">=</span> article<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> article<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">limit</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그냥 정상적인 결과가 나온다. 실행 계획상에서도 전혀 문제가 없고, 실행되는 시간도 내 테스트 환경 기준으로 0.0019초 나온다.</p>\n<p><img src=\"/blog/media/db/img02.png\" alt=\"img2\"></p>\n<h2 id=\"case-2-하지만-여기서-articletag2-테이블을-left-join-하면\" style=\"position:relative;\"><a href=\"#case-2-%ED%95%98%EC%A7%80%EB%A7%8C-%EC%97%AC%EA%B8%B0%EC%84%9C-articletag2-%ED%85%8C%EC%9D%B4%EB%B8%94%EC%9D%84-left-join-%ED%95%98%EB%A9%B4\" aria-label=\"case 2 하지만 여기서 articletag2 테이블을 left join 하면 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>case 2. 하지만 여기서 article&#x26;tag2 테이블을 left join 하면?</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> article\n<span class=\"token keyword\">left</span> <span class=\"token keyword\">join</span> tag2 <span class=\"token keyword\">on</span> tag2<span class=\"token punctuation\">.</span>article_id <span class=\"token operator\">=</span> article<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">order</span> <span class=\"token keyword\">by</span> article<span class=\"token punctuation\">.</span>id\n<span class=\"token keyword\">limit</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>엄청나게 느려진다. 실행 시간도 0.08초 ~ 0.152초로 대폭 증가한다(이 갭 관련해선 밑에서 설명). 다른 요소는 다 똑같은데 데이터가 많은 테이블을 조인하는건 빠르고 데이터가 적은 테이블을 조인 해서 결과를 얻는 것이 더 느리다는게 일반적으로 생각하면 말이 안된다.</p>\n<p><code class=\"language-text\">mysql 5.7</code> 버전으로 실행 계획을 확인해보면 아래와 같이 나온다\n<img src=\"/blog/media/db/img03.png\" alt=\"img3\"></p>\n<p>이런 결과가 나온건 내가 알기론 먼저 db조인을 할때 만약 테이블에 데이터가 얼마 없다면 옵티마이저가 모든 데이터와 조인 결과를 memory에 다 올려놓고 처리하는걸로 알고 있다. 근데 하필 <code class=\"language-text\">left join</code> 을 하면서 모든데이터를 올려놓다 보니 너무 데이터가 많아서 오히려 더 안좋은 실행계획이 세워지는 것으로 추측하고 있다</p>\n<p>두번째 실행 계획에서 <code class=\"language-text\">using join buffer(BNL)</code> , <code class=\"language-text\">Using temprary; Using filesort</code> 이렇게 뜨는걸 보고 그렇게 추측하였다(row 개수가 적으면 모든 데이터를 불러 온 후, 핸들링 하는거 자체는 맞는 말이다).</p>\n<p>이런 케이스는 일하면서 한번쯤은 만날 수 있는 경우라고 생각되는데 해결 방법으로는</p>\n<ol>\n<li>그냥 조인 안씀(개인적으로 이거 추천)</li>\n<li>가능하면 inner join으로 변경</li>\n<li>hint를 줘서 실행계획을 유도(딱히 추천하지는 않음. 해당 쿼리에 대해 관리비용이 더 들 수도 있다)</li>\n</ol>\n<blockquote>\n<p>개발하면서 RDB라서 별 수 없긴 하지만 join이란건 생각보다 어플리케이션에 많은 문제를 발생시킬 수가 있다(대부분 의존관계 문제이다. 무분별하게 의존관계를 다 때려 넣는 짓은 하면 안된다) 이런 저런 이유로 생각 외로 join 안쓰면 많은 문제를 예방 하는 효과가 있긴하다.</p>\n</blockquote>\n<p>만약 <code class=\"language-text\">inner join</code> 을 하게 되면 위와 같은 문제가 없어지고, 실행계획을 봐도 <code class=\"language-text\">driving table</code> 이 바뀌는거 말곤 딱히 특이한 점은 없다.</p>\n<p>참고 사항으로 <code class=\"language-text\">mysql 5.7</code> 버전에선 <code class=\"language-text\">BNL 조인</code>이 되어버리지만 <code class=\"language-text\">mysql 8.0</code>이면 <code class=\"language-text\">hash join</code>으로 처리 해준다(8.0부터 지원 해주는걸로 알고 있다) 위에서 실행 시간 말할때 0.15초 정도 걸린 환경은 <code class=\"language-text\">mysql 5.7</code> 버전에서 BNL 조인 되면서 나온 속도이고 <code class=\"language-text\">mysql 8.0</code>으로 올리면 hash join 으로 개선되어 0.8초 정도 속도가 나오고 있다. 물론 0.8초도 엄청 느린거고 row 개수에 따라 더욱 느려질 것이므로 피해서 써야하는건 똑같다.</p>\n<p><img src=\"/blog/media/db/img04.png\" alt=\"img4\"></p>\n<blockquote>\n<p>성능 측정 같은 경우엔 컴퓨터 성능에 따라 달라 질 수도 있다.</p>\n</blockquote>\n<hr>\n<p>결론</p>\n<ol>\n<li>옵티마이저는 똑똑하지만 항상 정확한 실행계획을 보장 해주는건 아니다.</li>\n<li>모르겠다 생각 되면 그냥 실행계획 보자.</li>\n</ol>"}},{"node":{"fields":{"slug":"/posts/etc/etc-docker-build/","__typename":"MarkdownRemarkFields","categorySlug":"/category/etc/"},"frontmatter":{"template":"post","title":"Docker - build cache","date":"2020-06-24T01:14:51.261Z","tags":["docker","devOps","infra"],"socialImage":null,"draft":false,"description":"Docker image 생성 시 레이어 캐시를 유도하여 빠르게 빌드 & 멀티 스테이지로 빌드 환경, 실행환경 분리","category":"etc"},"id":"38688cd3-ec80-5d00-bd6b-86036d71f06e","html":"<h1 id=\"docker-image-구조\" style=\"position:relative;\"><a href=\"#docker-image-%EA%B5%AC%EC%A1%B0\" aria-label=\"docker image 구조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker image 구조</h1>\n<p>도커 이미지의 구조는 여러 레이어의 순차적으로 겹쳐져 하나의 이미지를 구성한다. 가장 기본이 되는 layer는 파일 시스템으로 뭐 <code class=\"language-text\">docker</code>가 관리하니까 개발자의 관리포인트는 벗어나 생략하고,\n예를들어 <code class=\"language-text\">Spring boot</code> 어플리케이션을 <code class=\"language-text\">Dockerizing</code>하여 실행 시킨다고 할때 일단 먼저 빌드 환경이 제공되야 할것이다. <code class=\"language-text\">gradle wrapper</code>를 안쓴다면 <code class=\"language-text\">gradle</code>, <code class=\"language-text\">jdk</code>가\n설치되어 있어야 하고 그다음 빌드할 대상(소스 파일들), 마지막으로 빌드된 산출물 or <code class=\"language-text\">jar 파일</code>을 통해 최종적으로 어플리케이션이 실행되게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">FROM openjdk:8-jdk-slim\n\nRUN mkdir -p /app/java\nWORKDIR /app/java\n\nCOPY . .\n\nRUN ./gradlew build\n\nCMD [&quot;java&quot;, &quot;-jar&quot;, &quot;build/libs/auth-server-1.0.0.jar&quot;]</code></pre></div>\n<p>위의 Dockerfile은 가장 기본적인 <code class=\"language-text\">spring boot</code> 어플리케이션을 빌드하는 형태가 된다(일부 커스터 마이징 설명은 생략). 해당 파일을 일단 <code class=\"language-text\">docker image</code>로 빌드해보고 layer 구조를 확인해보고 싶으면</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ docker build -t auth-no-cache:1.0.0 .\n$ docker history auth-no-cache:1.0.0</code></pre></div>\n<p>위와 같이 build 후 history 명령을 통해 구조를 확인할 수가 있다. 밑의 내용은 로컬환경에서 빌드 후, 출력되는 히스토리 내용</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT\n71ed18b7025d        29 minutes ago      /bin/sh -c #(nop)  CMD [\"java\" \"-jar\" \"-serv…   0B\n1d2f52d9e713        29 minutes ago      /bin/sh -c ./gradlew build -x test              397MB\n259562f0edd3        31 minutes ago      /bin/sh -c #(nop) COPY dir:f0800f876ec82b2e3…   113MB\n2cd82ea610e3        31 minutes ago      /bin/sh -c #(nop) WORKDIR /app/java             0B\n4f44aa4209bc        31 minutes ago      /bin/sh -c mkdir -p /app/java                   0B\n41fd53971008        7 months ago        /bin/sh -c set -eux;   dpkgArch=\"$(dpkg --pr…   206MB\n&lt;missing>           7 months ago        /bin/sh -c #(nop)  ENV JAVA_URL_VERSION=8u23…   0B\n&lt;missing>           7 months ago        /bin/sh -c #(nop)  ENV JAVA_BASE_URL=https:/…   0B\n&lt;missing>           7 months ago        /bin/sh -c #(nop)  ENV JAVA_VERSION=8u232       0B\n&lt;missing>           7 months ago        /bin/sh -c { echo '#/bin/sh'; echo 'echo \"$J…   27B\n&lt;missing>           7 months ago        /bin/sh -c #(nop)  ENV PATH=/usr/local/openj…   0B\n&lt;missing>           7 months ago        /bin/sh -c #(nop)  ENV JAVA_HOME=/usr/local/…   0B\n&lt;missing>           7 months ago        /bin/sh -c #(nop)  ENV LANG=C.UTF-8             0B\n&lt;missing>           7 months ago        /bin/sh -c set -eux;  apt-get update;  apt-g…   8.79MB\n&lt;missing>           7 months ago        /bin/sh -c #(nop)  CMD [\"bash\"]                 0B\n&lt;missing>           7 months ago        /bin/sh -c #(nop) ADD file:bc8179c87c8dbb3d9…   69.2MB</code></pre></div>\n<p>설명하자면 밑에서부터 이미지 레이어가 하나씩 쌓여 최종적으로 하나의 이미지를 구성하고 있다. <code class=\"language-text\">CREATED BY</code>를 살펴보면 명령어가 실행되는 단위로 레이어가 생성되고 있으며, 참고사항으로 각 레이어는 이전 레이어 + 실행 컨텍스트에 종속 적이다.(필요 시 뒤에서 설명)</p>\n<p>이렇게 레이어로 나누어 관리되면서 생기는 장점이 각 명령어가 실행되는 환경(컨텍스트)이 같으면 새롭게 레이어를 빌드(생성)하는게 아니라 기존 레이어를 재사용해서 빌드 시간을 단축할 수가 있다.</p>\n<p>따라서 기존 빌드된 레이어를 재사용을 유도(캐싱)하는 것이 docker build cache의 핵심이다.</p>\n<p><strong>참고</strong></p>\n<blockquote>\n<p><code class=\"language-text\">missing</code>은 다른 시스템에서 빌드되어 로컬에서 정보가 없어 재사용이 불가능하다는걸 나타낸다</p>\n</blockquote>\n<h1 id=\"1-spring-boot-application-dockerizing\" style=\"position:relative;\"><a href=\"#1-spring-boot-application-dockerizing\" aria-label=\"1 spring boot application dockerizing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Spring boot application Dockerizing</h1>\n<h2 id=\"11-기존-dockerfile의-문제점\" style=\"position:relative;\"><a href=\"#11-%EA%B8%B0%EC%A1%B4-dockerfile%EC%9D%98-%EB%AC%B8%EC%A0%9C%EC%A0%90\" aria-label=\"11 기존 dockerfile의 문제점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 기존 Dockerfile의 문제점</h2>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">FROM openjdk:8-jdk-slim\n\nRUN mkdir -p /app/java\nWORKDIR /app/java\n\nCOPY . .\n\nRUN ./gradlew build\n\nCMD [&quot;java&quot;, &quot;-jar&quot;, &quot;build/libs/auth-server-1.0.0.jar&quot;]</code></pre></div>\n<p>위에서 예를 들어 설명한 <code class=\"language-text\">Dockerfile</code>로 보이는 개선 사항이 2가지가 존재한다.</p>\n<h3 id=\"빌드-캐시-적용-x\" style=\"position:relative;\"><a href=\"#%EB%B9%8C%EB%93%9C-%EC%BA%90%EC%8B%9C-%EC%A0%81%EC%9A%A9-x\" aria-label=\"빌드 캐시 적용 x permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>빌드 캐시 적용 x</h3>\n<p>작업을 할때마다 위 <code class=\"language-text\">Dockerfile</code>로 빌드하면 딱 <code class=\"language-text\">WORKDIR</code> 지정하는 부분까지만 이미지 레이어를 재사용하고 그 이후에는 항상 새로운 이미지 레이어를 생성한다.\n그 이유는 <code class=\"language-text\">WORKDIR</code>까진 항상 똑같은 과정이니까 레이어 재사용이 가능하지만 소스를 <code class=\"language-text\">COPY</code>하는 과정에서 기존 소스와 다르다면 <code class=\"language-text\">COPY</code> 하는 결과가 달라지게 된다.\n결과가 다르면 작업 환경도 다르므로 캐시 적용이 아닌 새로운 이미지 레이어 생성 작업을 시작하게 된다. 그래서 결과적으로 항상 빌드할때마다 캐싱 효과는 없다.</p>\n<p>일단 어느 이미지 레이어를 캐싱 해야할지 고민해봐야한다. 일반적으로 어플리케이션을 개발하면서 연관 라이브러리의 변동은 많지는 않다. 그래서 연관 <code class=\"language-text\">dependencies</code>를 다운로드 하는 부분, 소스 파일을 컴파일 하는 부분 이렇게 2단계로 나눈다면 적어도 <code class=\"language-text\">dependencies</code>를 다운로드하는데 걸리는 시간만큼은 줄일 수가 있다.</p>\n<p>소스 파일도 도메인 별로 분리해서 각각 따로 빌드한다면 시간을 아낄수 있을진 몰라도 각 도메인 사이 의존도에따라 빌드 시 영향을 미칠수가 있으므로 그냥 pass</p>\n<h3 id=\"최종-이미지에-불필요한-내용이-있다\" style=\"position:relative;\"><a href=\"#%EC%B5%9C%EC%A2%85-%EC%9D%B4%EB%AF%B8%EC%A7%80%EC%97%90-%EB%B6%88%ED%95%84%EC%9A%94%ED%95%9C-%EB%82%B4%EC%9A%A9%EC%9D%B4-%EC%9E%88%EB%8B%A4\" aria-label=\"최종 이미지에 불필요한 내용이 있다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>최종 이미지에 불필요한 내용이 있다.</h3>\n<p>소스파일을 실행시키는데 구지 <code class=\"language-text\">jdk</code>환경까진 필요없다. 또 이미지 안에 실행 시키는데 필요없는 소스 파일들도 함께 포함되어 있어 불필요한 용량을 차지하고 있다.</p>\n<p><code class=\"language-text\">docker</code>에서 지원하는 <code class=\"language-text\">multi stage</code>로 구성해서 빌드환경과 실행환경을 나누고, 실행환경은 <code class=\"language-text\">jdk</code>가 아닌 <code class=\"language-text\">jre</code>, 전체 소스 파일이 아닌 빌드된 결과물만 가진다면 많은 용량을 줄일수가 있다.</p>\n<h2 id=\"12-docker-file-개선\" style=\"position:relative;\"><a href=\"#12-docker-file-%EA%B0%9C%EC%84%A0\" aria-label=\"12 docker file 개선 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 Docker file 개선</h2>\n<p><strong>주의!</strong>\n<code class=\"language-text\">Spring boot</code> 어플리케이션 내에서 설정을 변경하여 기본 빌드 후, jar파일을 압축 분리하여 불필요한 소스파일을 제거하도록 변경하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">FROM openjdk:8-jdk-slim as builder\n\nENV APP_HOME=/app/java\nRUN mkdir -p $APP_HOME\nWORKDIR $APP_HOME\n\nCOPY build.gradle .\nCOPY settings.gradle .\nCOPY gradlew .\nCOPY gradlew.bat .\nCOPY gradle .\nRUN ./gradlew build || return 0\n\nCOPY . .\nRUN ./gradlew build\n\nFROM openjdk:8-jre-slim\n\nRUN mkdir -p /app/java\nWORKDIR /app/java\n\nCOPY --from=builder /app/java/build/unpack/lib BOOT-INF/lib\nCOPY --from=builder /app/java/build/unpack/app .\n\nCMD [&quot;java&quot;, &quot;-Duser.timezone=Asia/Seoul&quot;, &quot;-Dfile.encoding=utf-8&quot;, &quot;org.springframework.boot.loader.JarLauncher&quot;]</code></pre></div>\n<p>우선 첫번째로 빌드환경과 실행환경을 분리하였다.</p>\n<ol>\n<li>\n<p>빌드 시 <code class=\"language-text\">openjdk:8-jdk-slim</code>환경에서 분리 후 실행 시 <code class=\"language-text\">openjdk:8-jre-slim</code> 환경에서 실행하도록 분리하였다.</p>\n<blockquote>\n<p>실행 시 <code class=\"language-text\">docker container</code>에 jdk는 불필요하기 때문이다.</p>\n</blockquote>\n</li>\n<li>\n<p>소스를 COPY 하기 전, 연관 dependencies 다운로드 유도</p>\n<blockquote>\n<p><code class=\"language-text\">RUN ./gradlew build || return 0</code> 이 명령어가 실행 시 소스 파일이 없기 때문에 실패할 것이다. 실패 하더라도 계속 진행하기 위해 <code class=\"language-text\">return 0</code>를 통해 억지로 스크립트를 진행 시킨다.\n이렇게 하는 이유는 연관 <code class=\"language-text\">라이브러리를 미리 다운로드 받는 이미지 레어어</code>, <code class=\"language-text\">소스 파일을 빌드하는 이미지 레이어</code>를 분리하기 위해서 이다. 이렇게 하면 <code class=\"language-text\">라이브러리를 미리 다운로드 받는 이미지 레어어</code>는\n레이어 캐시가 적용되기 떄문이다.</p>\n</blockquote>\n</li>\n</ol>\n<p>이런 작업을 한 이후에 첫 도커 빌드를 한 이후, <code class=\"language-text\">build.gradle</code> 파일 변경없이 소스파일만 변경 후 빌드 해보면</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">Step 1/18 : FROM openjdk:8-jdk-slim as builder\n ---&gt; 41fd53971008\nStep 2/18 : ENV APP_HOME=/app/java\n ---&gt; Using cache\n ---&gt; ba835b60d6fe\nStep 3/18 : RUN mkdir -p $APP_HOME\n ---&gt; Using cache\n ---&gt; de95b45175d5\nStep 4/18 : WORKDIR $APP_HOME\n ---&gt; Using cache\n ---&gt; 92cafae54301\nStep 5/18 : COPY build.gradle .\n ---&gt; Using cache\n ---&gt; f86985388e5b\nStep 6/18 : COPY settings.gradle .\n ---&gt; Using cache\n ---&gt; b3deb0b0f8b4\nStep 7/18 : COPY gradlew .\n ---&gt; Using cache\n ---&gt; d52fb4bffbb4\nStep 8/18 : COPY gradlew.bat .\n ---&gt; Using cache\n ---&gt; 6b599b33aa5f\nStep 9/18 : COPY gradle .\n ---&gt; Using cache\n ---&gt; ffbc4cb71957\nStep 10/18 : RUN ./gradlew build -x test || return 0\n ---&gt; Using cache\n ---&gt; f2a311fdd13f\nStep 11/18 : COPY . .\n ---&gt; 9717040224fe</code></pre></div>\n<p>이런식으로 <code class=\"language-text\">Using cache</code>를 통해 원하는 부분까지 캐시가 적중됬음을 알수 있다.</p>\n<h2 id=\"2-react-create-react-app\" style=\"position:relative;\"><a href=\"#2-react-create-react-app\" aria-label=\"2 react create react app permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. React (create-react-app)</h2>\n<p>여기서 설명한 cra 코드는 <a href=\"https://github.com/qweasd147/StudyNote/tree/master/docker/dockerfile/cra/docker-sample\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">docker-cra</a> 여기서 확인 가능</p>\n<p><code class=\"language-text\">react</code>는 <code class=\"language-text\">Spring boot</code> 어플리케이션보단 단순하다. 연관 라이브러리 다운로드를 직접 명령할 수 있기 때문에(<code class=\"language-text\">install</code>) 분리가 쉽다.</p>\n<p>소스 관련해서 레이어 분리 및 캐싱 유도는 아래와 같이 나눈다.</p>\n<ol>\n<li>연관 라이브러리 install(<code class=\"language-text\">npm install</code> or <code class=\"language-text\">yarn install</code>)</li>\n<li>소스 번들링(cra에서 build 스크립트 실행)</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">...\n\nRUN mkdir -p /app/react/app\nWORKDIR /app/react/app\n\n# install에 필요한 파일 복사\nCOPY package.json .                    # 1\nCOPY yarn.lock .                       # 2\n\nRUN yarn install --frozen-lockfile     # 3\nCOPY . .                               # 4\nRUN yarn build                         # 5\n\n...</code></pre></div>\n<p><code class=\"language-text\">1~3</code> 과정처럼 소스 전체를 copy하는게 아니라, 연관 <code class=\"language-text\">dependency</code>를 먼저 다운로드 받고, 그 이후에 전체 소스를 카피하고 빌드하는 방법이다(<code class=\"language-text\">4~5</code>).\n이렇게 하면 <code class=\"language-text\">package.json</code>파일이 바뀌지 않는 한, <code class=\"language-text\">1~3</code> 과정이 캐싱되어 다음에 빌드 할땐 더욱 빠르게 빌드가 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">Step 1/15 : FROM node:14.4.0-alpine3.10 as builder\n ---&gt; 85fb5475404d\nStep 2/15 : RUN mkdir -p /app/react/app\n ---&gt; Using cache\n ---&gt; 8bfc805888ec\nStep 3/15 : WORKDIR /app/react/app\n ---&gt; Using cache\n ---&gt; 843e9c640fdf\nStep 4/15 : COPY package.json .\n ---&gt; Using cache\n ---&gt; 7d0537613a99\nStep 5/15 : COPY yarn.lock .\n ---&gt; Using cache\n ---&gt; 29a9f82b6f1b\nStep 6/15 : RUN yarn install --frozen-lockfile\n ---&gt; Using cache\n ---&gt; 55c71c78b339\nStep 7/15 : COPY . .\n ---&gt; b0db46f509a1\nStep 8/15 : RUN yarn build</code></pre></div>\n<p>이런식으로 <code class=\"language-text\">Using cache</code> 된걸 확인 가능하다.</p>"}},{"node":{"fields":{"slug":"/posts/etc/etc-docker/","__typename":"MarkdownRemarkFields","categorySlug":"/category/etc/"},"frontmatter":{"template":"post","title":"Docker - 기본","date":"2020-06-10T00:40:53.901Z","tags":["docker","devOps","infra"],"socialImage":null,"draft":false,"description":"배포 환경을 쉽게 구축하고 서버 확장을 유연하게 하고 싶을때 & 컴퓨터 리소스를 효율적으로 사용하고 싶을 때","category":"etc"},"id":"79a84710-a288-5517-92d4-21c62fd6c3a3","html":"<h1 id=\"docker\" style=\"position:relative;\"><a href=\"#docker\" aria-label=\"docker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker</h1>\n<p>컨테이너 환경에서 OS를 가상화</p>\n<h1 id=\"1-장점\" style=\"position:relative;\"><a href=\"#1-%EC%9E%A5%EC%A0%90\" aria-label=\"1 장점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 장점</h1>\n<p>리눅스 환경에서 서버나 db 아니면 뭐 기타 프로그램 설치 할때 에러나는 케이스를 종종 경험해본 케이스가 있을 것이다.\n<code class=\"language-text\">mac의 home brew</code>나 <code class=\"language-text\">npm</code>을 사용하면 그나마 낫지만 gcc 컴파일 부터 시작해서 <code class=\"language-text\">make</code>, <code class=\"language-text\">make install</code>을 사용해서 설치 시도 중, 실패할때면 그 짜증은 겪어본 사람만 안다.\n일단 하나 성공해도 다른 컴퓨팅 환경에서도 성공한다는 보장도 없고 이런거 3~4개 설치하려면 얼마나 걸릴지 장담할 수도 없다.</p>\n<p>또 하나의 프로그램 설치를 했고 그 프로그램에서 <code class=\"language-text\">80</code>포트를 사용한다고 가정하면 이걸 설치하는데 <code class=\"language-text\">root</code>계정이 필요하고 (major port 사용 시 root 권한 필요) 포트를 바꾸고 싶으면\n해당 소스를 변경해야만 수정이 가능한 경우가 많다. 하지만 <code class=\"language-text\">docker</code>를 사용하면 특정 계정에 <code class=\"language-text\">docker</code> 사용 가능 권한을 주고(이때는 <code class=\"language-text\">root</code> 권한 필요) <code class=\"language-text\">docker</code> 통해 설치하면\nroot 계정 정보가 필요 없고, 외부에서 들어오는 포트를 docker를 통해 내부 컨테이너 포트로 쉽게 포트 포워딩이 가능해서 구지 소스 변경 없이 포트 변경이 가능하다.</p>\n<p>여기까지가 직접 사용해보면서 느낀 <code class=\"language-text\">docker</code>의 장점이고 이론적으로 가상머신과의 차이, 거기서 얻는 컴퓨터 자원의 이득, 네트워크 방식(<code class=\"language-text\">bridge</code>, <code class=\"language-text\">host</code> 등)을 통한 보안 및 컨테이너\n간의 통신 등 정말 많은 이득이 있다(필요 시 다른곳에서 설명)</p>\n<h1 id=\"2-docker-run실행-옵션\" style=\"position:relative;\"><a href=\"#2-docker-run%EC%8B%A4%ED%96%89-%EC%98%B5%EC%85%98\" aria-label=\"2 docker run실행 옵션 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. docker run(실행) 옵션</h1>\n<table>\n<thead>\n<tr>\n<th>옵션</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>-d</td>\n<td>detached mode. 백그라운드 모드</td>\n</tr>\n<tr>\n<td>-p</td>\n<td>호스트와 컨테이너의 포트를 연결(포워딩) <br /> ex) … -p 1234:8080 … 옵션을 주면 1234번 포트로 접속하면 내부 컨테이너의 8080으로 포워딩(연결)하여 준다.</td>\n</tr>\n<tr>\n<td>-v</td>\n<td>호스트와 컨테이너의 디렉토리를 연결(마운트)</td>\n</tr>\n<tr>\n<td>-e</td>\n<td>컨테이너 내에서 사용할 환경변수 설정</td>\n</tr>\n<tr>\n<td>-name</td>\n<td>컨테이너 이름 설정</td>\n</tr>\n<tr>\n<td>-rm</td>\n<td>프로세스 종료 시 컨테이너 자동 제거</td>\n</tr>\n<tr>\n<td>-it</td>\n<td>i(interactive)옵션과 t(pseudo-tty)옵션을 사용하여 bash 쉘 사용</td>\n</tr>\n<tr>\n<td>-link</td>\n<td>컨테이너 연결 [컨테이너명:별칭]</td>\n</tr>\n</tbody>\n</table>\n<p>ex) ubuntu 이미지를 hello 라는 컨테이너로 생성 한 뒤, bash 쉘 실행\n$ docker run -i -t —name hello ubuntu /bin/bash</p>\n<p>ex) testnode 이미지의 0.1 tag를 컨테이너의 3000번 포트와 외부 포트 4000번을 연결함</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ docker run -p 4000:3000 testnode:0.1</code></pre></div>\n<p>ex) httpd 컨테이너를 생성하여 컨테이너의 /usr/local/apache2/htdocs경로와 <code class=\"language-text\">소스 경로</code>를 연결하고</p>\n<p>컨테이너 80포트를 외부포트 3000번과 연결</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ docker run -d -p 3000:80 --name=board-front -v 소스경로:/usr/local/apache2/htdocs httpd</code></pre></div>\n<p>ex base-node:0.1 컨테이너를 생성하여 컨테이너의 /app 경로를 <code class=\"language-text\">소스 경로</code>를 연결하고</p>\n<p>컨테이너 4000번 포트를 외부 포트 4000번과 연결</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ run -d -p 4000:4000 --name=board-api -v 소스경로:/app base-node:0.1</code></pre></div>\n<h1 id=\"3-그외-docker-명령어\" style=\"position:relative;\"><a href=\"#3-%EA%B7%B8%EC%99%B8-docker-%EB%AA%85%EB%A0%B9%EC%96%B4\" aria-label=\"3 그외 docker 명령어 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 그외 docker 명령어</h1>\n<h3 id=\"31-docker-inspect\" style=\"position:relative;\"><a href=\"#31-docker-inspect\" aria-label=\"31 docker inspect permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 docker inspect</h3>\n<p>기본 $ docker inspect [옵션][컨테이너 명] 으로 실행되며 컨테이너 정보를 보여준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ docker run -d --name test-httpd httpd\n\n$ docker inspect test-httpd</code></pre></div>\n<h3 id=\"32-docker-exec\" style=\"position:relative;\"><a href=\"#32-docker-exec\" aria-label=\"32 docker exec permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 docker exec</h3>\n<p>기본 $ docker exec [옵션][컨테이너명] [명령어] 으로 해당 컨테이너의 명령어를 날린다.</p>\n<p>ex) <code class=\"language-text\">abc</code> 컨테이너에 접근(/bin/bash 명령어 사용).\n참고로 옵션은 STDIN 표준 입출력으로(i) 가상 tty (pseudo-TTY,t) 를 통해 접속하겠다는 의미이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ docker exec -it abc /bin/bash</code></pre></div>\n<p>주의! 참고로 해당 컨테이너에 접속하여 여러 작업을 하는건 추천하지 않는다. 이유는 히스토리 관리가 큰데</p>\n<p>docker를 사용하는 이유 중 하나가 여러 컨테이너를 마구마구 찍어내서 생산성을 높이는것을 목표로 하는데 직접 접근하여</p>\n<p>파일을 수정하면 각 컨테이너를 만들때 마다 그러한 작업이 요구될 수도 있기 때문이다. 따라서 파일 수정등이 목적이라면</p>\n<p>Dockerfile을 사용하여 수정하는것을 추천한다.</p>\n<h1 id=\"4-docker-compose\" style=\"position:relative;\"><a href=\"#4-docker-compose\" aria-label=\"4 docker compose permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. docker compose</h1>\n<h3 id=\"41-docker와-docker-compose-차이점\" style=\"position:relative;\"><a href=\"#41-docker%EC%99%80-docker-compose-%EC%B0%A8%EC%9D%B4%EC%A0%90\" aria-label=\"41 docker와 docker compose 차이점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 docker와 docker compose 차이점</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">docker compose\nDocker Compose는 컨테이너 여럿을 띄우는 도커 애플리케이션을 정의하고 실행하는 도구(Tool for defining and running multi-container Docker applications)\n컨테이너를 여러개 띄울 시, 순서대로 컨테이너를 띄울 수 있고, run 할때 옵션들을 미리 정의할수도 있다.</code></pre></div>\n<table>\n<thead>\n<tr>\n<th>docker</th>\n<th>docker-compose</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Dockerfile</td>\n<td>Dockerfile-dev</td>\n<td>서버 구성을 문서화 <br /> ex) 클래스 선언</td>\n</tr>\n<tr>\n<td>docker build</td>\n<td>docker-compose build</td>\n<td>도커 이미지 만들기 <br /> ex) 클래스 선언을 어플리케이션에 로드</td>\n</tr>\n<tr>\n<td>docker run (+@ 옵션들)</td>\n<td>docker-compose.yml</td>\n<td>이미지에 붙이는 장식들. <br /> ex) 인스턴스의 변수들</td>\n</tr>\n<tr>\n<td>docker run</td>\n<td>docker-compose up</td>\n<td>장식 붙은 이미지를 실제로 실행 <br /> ex) 인스턴스 생성</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"5-발생했던-문제점들\" style=\"position:relative;\"><a href=\"#5-%EB%B0%9C%EC%83%9D%ED%96%88%EB%8D%98-%EB%AC%B8%EC%A0%9C%EC%A0%90%EB%93%A4\" aria-label=\"5 발생했던 문제점들 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 발생했던 문제점들</h1>\n<h3 id=\"51-docker-chain이-제대로-설정x\" style=\"position:relative;\"><a href=\"#51-docker-chain%EC%9D%B4-%EC%A0%9C%EB%8C%80%EB%A1%9C-%EC%84%A4%EC%A0%95x\" aria-label=\"51 docker chain이 제대로 설정x permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.1 docker chain이 제대로 설정x</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">~(생략) -i docker0: iptables: No chain/target/match by that name. (exit status 1)).</code></pre></div>\n<p>docker 컨테이너를 올릴 때 iptables에 docker chain이 없을 때 발생. 맨 처음 docker를 실행 할 때 발생하였는데 정확한</p>\n<p>원인은 모르겠음…</p>\n<h4 id=\"해결책\" style=\"position:relative;\"><a href=\"#%ED%95%B4%EA%B2%B0%EC%B1%85\" aria-label=\"해결책 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>해결책</h4>\n<p>수동으로 docker chain을 iptables에 등록한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ iptables -t filter -N DOCKER\n$ iptables -t nat -N DOCKER</code></pre></div>\n<p>or</p>\n<p>docker 서비스를 재시작 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ service docker stop\n$ service docker start</code></pre></div>\n<h1 id=\"6-참고\" style=\"position:relative;\"><a href=\"#6-%EC%B0%B8%EA%B3%A0\" aria-label=\"6 참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. 참고</h1>\n<h4 id=\"docker-file을-써서-linux위에-centos나-ubuntu-설치-시-guest-os가-설치-되는건지\" style=\"position:relative;\"><a href=\"#docker-file%EC%9D%84-%EC%8D%A8%EC%84%9C-linux%EC%9C%84%EC%97%90-centos%EB%82%98-ubuntu-%EC%84%A4%EC%B9%98-%EC%8B%9C-guest-os%EA%B0%80-%EC%84%A4%EC%B9%98-%EB%90%98%EB%8A%94%EA%B1%B4%EC%A7%80\" aria-label=\"docker file을 써서 linux위에 centos나 ubuntu 설치 시 guest os가 설치 되는건지 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker file을 써서 Linux위에 Centos나 Ubuntu 설치 시 Guest OS가 설치 되는건지</h4>\n<blockquote>\n<p>X. Host OS(Linux)와 <code class=\"language-text\">CentoOS</code>, <code class=\"language-text\">Ubuntu</code> 등의 다른 부분(diff)만 따로 패키징하여 결과적으로 훨씬 가볍다.</p>\n</blockquote>\n<ul>\n<li><a href=\"https://developer.ibm.com/kr/cloud/2019/02/01/easy_container_kubernetes/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://developer.ibm.com/kr/cloud/2019/02/01/easy_container_kubernetes/</a></li>\n</ul>\n<h4 id=\"도커-무작정-따라하기책\" style=\"position:relative;\"><a href=\"#%EB%8F%84%EC%BB%A4-%EB%AC%B4%EC%9E%91%EC%A0%95-%EB%94%B0%EB%9D%BC%ED%95%98%EA%B8%B0%EC%B1%85\" aria-label=\"도커 무작정 따라하기책 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>도커 무작정 따라하기(책)</h4>\n<p><a href=\"http://pyrasis.com/docker/2015/02/09/docker-for-dummies\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://pyrasis.com/docker/2015/02/09/docker-for-dummies</a></p>\n<h4 id=\"하루만에-배우는-도커책\" style=\"position:relative;\"><a href=\"#%ED%95%98%EB%A3%A8%EB%A7%8C%EC%97%90-%EB%B0%B0%EC%9A%B0%EB%8A%94-%EB%8F%84%EC%BB%A4%EC%B1%85\" aria-label=\"하루만에 배우는 도커책 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>하루만에 배우는 도커(책)</h4>\n<p><a href=\"http://www.hanbit.co.kr/store/books/look.php?p_code=E7149016842\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://www.hanbit.co.kr/store/books/look.php?p_code=E7149016842</a></p>\n<h4 id=\"인터넷-클라우드에서-도커-체험\" style=\"position:relative;\"><a href=\"#%EC%9D%B8%ED%84%B0%EB%84%B7-%ED%81%B4%EB%9D%BC%EC%9A%B0%EB%93%9C%EC%97%90%EC%84%9C-%EB%8F%84%EC%BB%A4-%EC%B2%B4%ED%97%98\" aria-label=\"인터넷 클라우드에서 도커 체험 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>인터넷 클라우드에서 도커 체험</h4>\n<p><a href=\"https://labs.play-with-docker.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://labs.play-with-docker.com/</a></p>\n<h4 id=\"docker-설명블로그\" style=\"position:relative;\"><a href=\"#docker-%EC%84%A4%EB%AA%85%EB%B8%94%EB%A1%9C%EA%B7%B8\" aria-label=\"docker 설명블로그 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>docker 설명(블로그)</h4>\n<ul>\n<li><a href=\"http://raccoonyy.github.io/docker-usages-for-dev-environment-setup/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://raccoonyy.github.io/docker-usages-for-dev-environment-setup/</a></li>\n<li><a href=\"https://blog.nacyot.com/articles/2014-01-27-easy-deploy-with-docker/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://blog.nacyot.com/articles/2014-01-27-easy-deploy-with-docker/</a></li>\n<li><a href=\"http://programmingsummaries.tistory.com/392?category=695325\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://programmingsummaries.tistory.com/392?category=695325</a></li>\n</ul>"}},{"node":{"fields":{"slug":"/posts/etc/etc-git-alias_hooks_merge/","__typename":"MarkdownRemarkFields","categorySlug":"/category/etc/"},"frontmatter":{"template":"post","title":"Git - 알면 유용한 명령어들","date":"2022-06-18T16:04:47.302Z","tags":["git","alias","hooks"],"socialImage":null,"draft":false,"description":"alias, hooks, rebase 중 merge commit 유지하기","category":"etc"},"id":"29b80747-6350-5af2-9ab5-f8a09f53b732","html":"<h1 id=\"1-alias\" style=\"position:relative;\"><a href=\"#1-alias\" aria-label=\"1 alias permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. alias</h1>\n<p>git 명령어 중 옵션이 너무 많아서 기억하기 힘들거나 타이핑이 귀찮은 경우, 연속되는 명령줄을 alias로 묶어 한방에 처리할 때 유용하다.\n개념자체는 간단하지만 alais를 사용하기 위해선 git 명령어의 적용 범위를 먼저 알아야 한다.</p>\n<h3 id=\"11-config-scope\" style=\"position:relative;\"><a href=\"#11-config-scope\" aria-label=\"11 config scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 Config Scope</h3>\n<p>git 최초 설정을 할때 한번쯤은 <code class=\"language-text\">user name</code>, <code class=\"language-text\">email</code> 등을 지정하기 위해 <code class=\"language-text\">$ git config ~~~~</code> 이런 명령어들 써봤을 것이라 생각된다. 이런 명령어가 설정값 적용 범위를 지정해 놓기 위해 설정한건데 설정값 범위는 크게 3가지 종류로 구분 된다.</p>\n<ol>\n<li>System</li>\n</ol>\n<p>전체적인 시스템에 일괄 적용되며 <code class=\"language-text\">/etc/gitconfig</code> 에 저장된다. 모든 사용자를 대상으로 설정값을 지정하기 위해서 적용한다.</p>\n<ol start=\"2\">\n<li>Global</li>\n</ol>\n<p>global 설정으로, 이 값을 설정하면 해당 user의 모든 git repository에 적용된다. 위치는 해당 사용자를 위한 설정 값이니까</p>\n<ol start=\"3\">\n<li>Local</li>\n</ol>\n<p>특정 <code class=\"language-text\">repository</code>에 적용하기 위해 사용된다. 저장 위치는 <code class=\"language-text\">/프로젝트경로/.git/config</code> 가 된다.</p>\n<p>다시 좀 전에 말했던 걸로 되돌아가서, git commit 작성자 정보를 지정하기 위해 <code class=\"language-text\">git config --global user.name</code> 이런식으로 git 설정값을 건드려 본적 있을텐데, 이제 보면 알겠지만 global 설정, 즉 내 계정의 모든 git repository에 적용하기 위한 scope를 지정한 것이고 반대로 <code class=\"language-text\">--local</code> 옵션을 주면 해당 repository에만 적용된다.</p>\n<blockquote>\n<p>적용 우선 순위는 local -> global -> system 순으로 적용된다.</p>\n</blockquote>\n<h3 id=\"12-alias-적용\" style=\"position:relative;\"><a href=\"#12-alias-%EC%A0%81%EC%9A%A9\" aria-label=\"12 alias 적용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 Alias 적용</h3>\n<p>일단 예제는 global scope를 대상으로 했다.</p>\n<ol>\n<li>등록</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ cd ~/프로젝트 위치\n$ git config --global alias.b &#39;branch&#39; # git branch 명령 alia\n$ git b # 위에서 적용한 alias (git branch 명령어) 사용\n# 현재 로컬의 브랜치 목록 표출</code></pre></div>\n<ol start=\"2\">\n<li>적용 된 목록</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ git config --global --list | grep alias</code></pre></div>\n<ol start=\"3\">\n<li>삭제</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">git config --global --unset alias.b</code></pre></div>\n<p><strong>Tip</strong>\n여러 사람과 git 작업 + 공통 브랜치(git flow 같은거) 공유하면서 사용하다 보면 공통 브랜치를 항상 pull 받기 귀찮을 수도 있다. 이런거 alias 등록 해놓으면 편하게 사용 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ cd ~/프로젝트_위치\n$ vi ./.git/config</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">~~~ 로컬 설정값 + branch들 ~~~~~\n[alias]\n\tpull-all = \"!git checkout master &amp;&amp; git pull origin \\\n\t; git checkout develop &amp;&amp; git pull origin \\</code></pre></div>\n<p>이런식으로 설정하고 <code class=\"language-text\">$ git pull-all</code> 명령어로 한번에 여러 브랜치 pull을 할 수도 있다</p>\n<blockquote>\n<p>참고로 alias 명령어는 중간에 <code class=\"language-text\">_</code> 이거 넣으면 안되니까 주의하자</p>\n</blockquote>\n<h1 id=\"2-hooks\" style=\"position:relative;\"><a href=\"#2-hooks\" aria-label=\"2 hooks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. hooks</h1>\n<p>어렵게 생각 할것 없이 그냥 특정 조건에 만족되면 실행되는 로직을 hook 이라고 이해하면 된다. git에서도 자체적으로 이런 Hooks들을 지원하는데 git 커밋 전후나 push 전후에 실행되는 로직을 스크립트로 관리 해줄 수 있게 지원해주고 있다.</p>\n<h3 id=\"21-대표적인-hooks-종류들\" style=\"position:relative;\"><a href=\"#21-%EB%8C%80%ED%91%9C%EC%A0%81%EC%9D%B8-hooks-%EC%A2%85%EB%A5%98%EB%93%A4\" aria-label=\"21 대표적인 hooks 종류들 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 대표적인 hooks 종류들</h3>\n<ul>\n<li>pre-commit - 커밋 직전 실행되는 hook</li>\n<li>commit-msg - 커밋 메세지 쓰고 저장 직전에 실행되는 hook</li>\n<li>post-commit - 커밋을 완료 된 후 실행되는 hook</li>\n<li>pre-push - 푸시 직전에 실행되는 hook</li>\n<li>pre-rebase - 리베이스 직전에 실행되는 hook</li>\n<li>post-rewrite - 리베이스나 커밋을 수정한 직후 실행 되는 hook</li>\n<li>post-merge - 머지 직후 실행되는 hook</li>\n</ul>\n<blockquote>\n<p>pre로 시작되는 hooks는 해당 action을 reject 시킬 수도 있다</p>\n</blockquote>\n<h3 id=\"22-사용법\" style=\"position:relative;\"><a href=\"#22-%EC%82%AC%EC%9A%A9%EB%B2%95\" aria-label=\"22 사용법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 사용법</h3>\n<p>그냥 특정 위치에 지정된 파일명으로 스크립트 짜 넣으면 알아서 실행된다.</p>\n<p><code class=\"language-text\">.git/hooks</code> 디렉토리 하위에 위에 적어놓은 <code class=\"language-text\">hooks 종류</code> 이름으로 파일로 만들면 자동으로 실행된다. 주의점은 <strong>실행 가능한 스크립트</strong> 이어야 한다는 점이다. 뭐 특별히 어려운건 없고 그냥 <code class=\"language-text\">rwx</code> 옵션에서 x 옵션 잘 잇나 확인하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">#pre-commit\ncho &#39;action pre-commit&#39;</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ ls -l .git/hooks # 지정 된 위치에 hooks 잘 있나 확인\n-rwxr-xr-x  1 (기본 파일정보) pre-commit\n\n$ git add . # 변경 된 파일 전부 스테이지에 올림\n$ git commit -m 'git hooks test' # git 커밋&amp;커밋 메세지\naction pre-commit # git hooks 스크립트에 저장된 echo 실행된거\n[master 6f4b9fa] git hooks test</code></pre></div>\n<p>이런식으로 쉽게 사용이 가능하다.</p>\n<h3 id=\"23-단점\" style=\"position:relative;\"><a href=\"#23-%EB%8B%A8%EC%A0%90\" aria-label=\"23 단점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 단점</h3>\n<p>git hooks 관련해서 가장 큰 단점은 이 스크립트들이 .git 디렉토리 하위에 있어야 하다보니 버전관리하기가 힘들다. 그래서 실상은 개개인 별로 쓰거나 그냥 서드파티 라이브러리에 의존해서 많이 쓰인다. 또한 강제성이 없다는것도 큰 단점이다. 뭐 어찌어찌 버전관리하고 스크립트도 알아서 설치(지정된 위치로 이동or심볼릭 링크) 해놔도 그냥 로컬에서 빼버리면 그만이라서 정말 warning 정도로만 많이 쓰게 된다. 물론 git cloud 서버 측에서 관리 할수 있는 hook도 있다(pre-receive, update, post-receive). 단점이 너무 커서 애매하긴 하지만 일단 ‘이렇게도 사용 할 수 있다’는 정도로 마스터 브랜치는 rebase를 막는 <code class=\"language-text\">pre-rebase</code> 는 기록해 둔다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">#pre-rebase\nbranch=&quot;$(git rev-parse --abbrev-ref HEAD)&quot;\n\nif [ &quot;$branch&quot; = &quot;master&quot; ]; then\n  echo &quot;마스터 브랜치는 리베이스 허용 안함&quot;\n  exit 1\nfi</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ git checkout master # master 브랜치로 이동\n$ git rebase test-rebase # master 브랜치 리베이스 시도\n마스터 브랜치는 리베이스 허용 안함\nfatal: 리베이스 전 후크에서 리베이스를 거부했습니다.\n\n# 반대로 test-rebase 브랜치를 master로 리베이스 시도\n$ git checkout test-rebase\n&#39;test-rebase&#39; 브랜치로 전환합니다\n$ git rebase master\nSuccessfully rebased and updated refs/heads/test-rebase. #다른 브랜치는 rebase 가능</code></pre></div>\n<blockquote>\n<p>rebase는 히스토리 관리 측면에선 안좋으니까 master 브랜치는 rebase가 안되게 설정을 많이 해놓는다.</p>\n</blockquote>\n<h1 id=\"3-rebase-과정-중-merge-커밋-유지\" style=\"position:relative;\"><a href=\"#3-rebase-%EA%B3%BC%EC%A0%95-%EC%A4%91-merge-%EC%BB%A4%EB%B0%8B-%EC%9C%A0%EC%A7%80\" aria-label=\"3 rebase 과정 중 merge 커밋 유지 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. rebase 과정 중 merge 커밋 유지</h1>\n<p>git rebase는 파괴적인 작업이다. 이름에서 부터 알수 있듯이 re + base로 기존 작업의 히스토리를 직접적으로 덮어쓰기 형태로 작업하여 잘못하면 커밋을 날려먹을 수가 있다.</p>\n<blockquote>\n<p>정확히는 내부적으로 직접 커밋을 수정하는게 아니라 새로운 커밋을 만들어 이어 붙인 다음, 접근할수 없는 이전 커밋은 자연스럽게 버려지는 구조이다.</p>\n</blockquote>\n<p>개인적으로 rebase를 자주 사용하는데 특정 커밋을 합치거나(squash) 삭제, 수정 등등 case by case로 쉬운방법을 골라서 쓰고 있지만 이런 작업 중 중간에 merge commit 이 섞여들어가면 진짜 귀찮아진다(물론 내가 몰랐을때)</p>\n<p><strong>상황 설명을 위한 기본 branch 상황</strong>\n<img src=\"/blog/media/git/rebase_merge/git-rebase-merge-1.png\" alt=\"img1\"></p>\n<p>이 상태에서 rebase 작업을 하려다가 그냥 빠져나와도 git 그래프는 바껴있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ git checkout master # master 브랜치에서 작업\n$ git rebase -i HEAD~2 # HEAD를 기준으로 최근 2개 커밋을 핸들링 한다.\n\n~~~\n대충 대화식 화면. 별다른 수정 없이 :wq 를 통해 빠져나왔다고 가정\n~~~</code></pre></div>\n<p><img src=\"/blog/media/git/rebase_merge/git-rebase-merge-2.png\" alt=\"img2\"></p>\n<p>그나마 별다른 수정없이 빠져나와서 눈치 챈거지, 추가로 작업도 하고 rebase 종료 &#x26; 이렇게 flat하게 바껴버리면 진짜 내가 뭘 한건지 인지하기 힘들다. 아무튼 이럴때 쓰는게 -r 옵션(—rebase-merges)을 써서 rebase 과정 중에 merge 커밋을 유지한다는 옵션을 쓰면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ git checkout master\n$ git rebase -i -r HEAD~2</code></pre></div>\n<p>이러면 옵션을 안줬을 때와 다르게 merge 커밋과 label(그냥 있는 그대로 라벨이다. 큰 의미는 갖지 않아도 됨) 정보가 함께 보여준다.\n<img src=\"/blog/media/git/rebase_merge/git-rebase-merge-3.png\" alt=\"img3\"></p>\n<p>이런 다음 다시 그대로 wq로 빠져나오면 rebase 전후로 달라진게 없다는걸 알 수있다.\n조금더 연장선 &#x26; 응용 하면 merge 커밋만 지우거나 기능 브랜치에서 특정 커밋만 삭제 후 병합 한걸로 한방에 작업 된걸로 처리가 가능하다</p>\n<p><strong>Case 1. 머지커밋 되돌리기</strong></p>\n<p><img src=\"/blog/media/git/rebase_merge/git-rebase-merge-4.png\" alt=\"img4\"></p>\n<p>맨 밑의 merge commit(해시 아이디가 ed80daa 커밋. 이전에 작업한거 몇번 시도해서 첫번째 이미지랑 아이디가 달라진건 이해 부탁드립니다)을 d 옵션을 줘서 삭제하면 merge 자체를 되돌릴 수가 있다(근데 최근 merge 커밋 되돌리는건 reset이 압도적으로 편하다)</p>\n<p><strong>Case 2. feature/fature-1 커밋의 특정 커밋만 재외하고 merge</strong></p>\n<p>이미 머지 되어있는 상황에서 기능브랜치의 특정 커밋만 뺀 다음 merge하는 효과를 주고 싶을때\n<img src=\"/blog/media/git/rebase_merge/git-rebase-merge-5.png\" alt=\"img5\"></p>\n<p>이런식으로 <code class=\"language-text\">작업 2-2</code> 커밋을 삭제(d) 처리하면 이 커밋만 빼놓고 병합한 효과를 줄 수가 있다.</p>\n<p>이렇게 종료 되면 아래 결과처럼 바껴잇다\n<img src=\"/blog/media/git/rebase_merge/git-rebase-merge-6.png\" alt=\"img5\"></p>\n<blockquote>\n<p>참고로 merge commit을 유지하는 기능으로 비슷한 역할을 하는 —preserve-merges 라는 옵션이 있는데 이건 deprecated 됬다. 라벨 정보가 오히려 익숙하지 않은 사람은 임시로 이걸 쓰는것도 괜찮다(사용법이 오히려 이게 더 직관적이라고 생각된다).</p>\n</blockquote>"}},{"node":{"fields":{"slug":"/posts/etc/etc-git-rebase/","__typename":"MarkdownRemarkFields","categorySlug":"/category/etc/"},"frontmatter":{"template":"post","title":"Git Rebase","date":"2020-06-09T00:50:06.996Z","tags":["git","rebase"],"socialImage":null,"draft":false,"description":"소스를 병합 하고 싶을때, 아니면 최신 코드와 동기화 하고 싶을 때","category":"etc"},"id":"e08c3400-0c38-5090-b7cb-2a03be93dc58","html":"<h1 id=\"rebase\" style=\"position:relative;\"><a href=\"#rebase\" aria-label=\"rebase permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rebase</h1>\n<h2 id=\"1-fast-forward\" style=\"position:relative;\"><a href=\"#1-fast-forward\" aria-label=\"1 fast forward permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1 fast-forward</h2>\n<p><code class=\"language-text\">master</code>브랜치에서 새로운 브랜치를 생성하여 기능 추가 후, 다시 <code class=\"language-text\">master</code>브랜치로 합칠 때 새로운 브랜치를 생성하는 시점 이후로 <code class=\"language-text\">master</code>브랜치 변경이력(<code class=\"language-text\">commit</code>)이 없으면 충돌 날 이유도 없고, 새로운 브랜치가 그대로 흡수되어 병합이 가능하다. 이러한 상태를 <code class=\"language-text\">fast-forward</code>상태, <code class=\"language-text\">fast-forward</code>상태에서 병합 시 <code class=\"language-text\">fast-forward</code>병합 이라고도 한다.</p>\n<blockquote>\n<p><a href=\"https://backlog.com/git-tutorial/kr/stepup/stepup1_4.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://backlog.com/git-tutorial/kr/stepup/stepup1_4.html</a></p>\n</blockquote>\n<p>또한 <code class=\"language-text\">fast-forward</code>상태에서 브랜치를 병합하면 git graph가 여러 갈래로 나누어지는 일 없이 깔끔하게 합쳐진다.</p>\n<h2 id=\"2-rebase를-하는-이유\" style=\"position:relative;\"><a href=\"#2-rebase%EB%A5%BC-%ED%95%98%EB%8A%94-%EC%9D%B4%EC%9C%A0\" aria-label=\"2 rebase를 하는 이유 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2 rebase를 하는 이유</h2>\n<p><code class=\"language-text\">fast-forward</code>상태 라면 브랜치를 합칠때 신경 쓸 요소가 없지만 <code class=\"language-text\">fast-forward</code>상태가 아니라면 <code class=\"language-text\">merge</code>시 git graph 모양이 마음에 안들 수가 있다.\n브랜치가 많아지고, 새로운 브랜치에서 작업량(커밋 수 &#x26; 기간)이 많아지면 그래프도 한눈에 안들어오고 어지럽게만 보인다. 이럴때 내가 작업한 것을 <code class=\"language-text\">fast-forward</code>상태로 만들어 병합 시키면 git graph가 여러 갈래로 나누어지지 않고 깔끔하게 관리가 가능하다. 결과적으로 병합을 목적으로 <code class=\"language-text\">rebase</code>작업은 <code class=\"language-text\">master</code>브랜치와 새로운 기능 추가용 <code class=\"language-text\">func1</code>브랜치가 있을 때 <code class=\"language-text\">func1</code>브랜치의 시작지점(브랜치 생성 시점의 커밋)을 <code class=\"language-text\">master</code>브랜치의 가장 최근 커밋 지점으로 base를 재정의(git 커밋 이력을 수정)하여 <code class=\"language-text\">fast-forward</code>상태로 만드는 작업이다.</p>\n<h2 id=\"3-merge와-rebase-차이점-및-과정-with-source-tree\" style=\"position:relative;\"><a href=\"#3-merge%EC%99%80-rebase-%EC%B0%A8%EC%9D%B4%EC%A0%90-%EB%B0%8F-%EA%B3%BC%EC%A0%95-with-source-tree\" aria-label=\"3 merge와 rebase 차이점 및 과정 with source tree permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3 merge와 rebase 차이점 및 과정. with source tree</h2>\n<h3 id=\"31-상황-설명을-위한-기본-브랜치-상황\" style=\"position:relative;\"><a href=\"#31-%EC%83%81%ED%99%A9-%EC%84%A4%EB%AA%85%EC%9D%84-%EC%9C%84%ED%95%9C-%EA%B8%B0%EB%B3%B8-%EB%B8%8C%EB%9E%9C%EC%B9%98-%EC%83%81%ED%99%A9\" aria-label=\"31 상황 설명을 위한 기본 브랜치 상황 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 상황 설명을 위한 기본 브랜치 상황</h3>\n<p><img src=\"/blog/media/git/rebase/img01.PNG\" alt=\"img1\"></p>\n<p>진행 과정을 위한 브랜치 상황 셋팅</p>\n<ul>\n<li>일반적인 master 브랜치를 가정한 브랜치(git_m)와 기능 추가를 위한 서브 브랜치(git_s)를 추가</li>\n<li>git_m에서 일정 커밋을 쌓은 뒤 git_s 브랜치를 생성 후 각자 적당한 커밋을 추가</li>\n</ul>\n<h3 id=\"32-merge-방법\" style=\"position:relative;\"><a href=\"#32-merge-%EB%B0%A9%EB%B2%95\" aria-label=\"32 merge 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 merge 방법</h3>\n<p>rollback시 기존 브랜치를 유지하고 헤깔리지 않게 하기위해 <code class=\"language-text\">git_s</code>와 이력이 똑같은 새로운 브랜치 <code class=\"language-text\">git_s_for_merge</code> 브랜치를 추가. <code class=\"language-text\">merge</code>용 <code class=\"language-text\">git_s</code> 브랜치는 <code class=\"language-text\">git_s_for_merge</code></p>\n<p><img src=\"/blog/media/git/rebase/img02.png\" alt=\"img2\"></p>\n<p><strong>현재 브랜치를 git_m</strong> 상태에서 원하는 브랜치 우클릭->병합</p>\n<p><img src=\"/blog/media/git/rebase/img03.png\" alt=\"img3\"></p>\n<blockquote>\n<p>만약 충돌 시, 충돌난 파일을 적절히 수동으로 병합 후, <code class=\"language-text\">스테이지에 올라간 파일</code>에서 해당 파일 우클릭-><code class=\"language-text\">충돌해결</code>-><code class=\"language-text\">해결된 것으로 표시</code> 클릭 후 다시 커밋</p>\n</blockquote>\n<h4 id=\"주의사항\" style=\"position:relative;\"><a href=\"#%EC%A3%BC%EC%9D%98%EC%82%AC%ED%95%AD\" aria-label=\"주의사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>주의사항</h4>\n<p>현재 브랜치가 <code class=\"language-text\">git_m</code>에서 <code class=\"language-text\">git_s_for_merge</code>를 우클릭하여 병합하면 병합 되어진 대상 브랜치(즉 변하는 브랜치)는 <code class=\"language-text\">git_m</code>으로, <code class=\"language-text\">git_s_for_merge</code>는 아무런 변화가 없다.</p>\n<p>반대로 현재 브랜치가 <code class=\"language-text\">git_s_for_merge</code>에서 <code class=\"language-text\">git_m</code>를 병합하면 병합 되어진 대상 브랜치(변하는 브랜치)는 <code class=\"language-text\">git_s_for_merge</code>가 된다. 이는 현재 <code class=\"language-text\">git_s_for_merge</code>에서 개발 중, 중간에 마스터 브랜치(<code class=\"language-text\">git_m</code>)로 <code class=\"language-text\">push</code>된 소스 파일들을 <code class=\"language-text\">git_s_for_merge</code>로도 업데이트(동기화) 하는 효과를 준다.</p>\n<p><img src=\"/blog/media/git/rebase/img04.png\" alt=\"img4\"></p>\n<p>추가로 이 방금 말한 방법대로 <code class=\"language-text\">git_m</code>내용을 <code class=\"language-text\">merge</code> 후 다시 <code class=\"language-text\">git_m</code>에서 <code class=\"language-text\">git_s_for_merge</code>를 <code class=\"language-text\">merge</code>할 수도 있다. 병합 과정중 특별한 일이 없다면 그냥 <code class=\"language-text\">git_m</code>에서 <code class=\"language-text\">git_s_for_merge</code>를 병합한 효과와 같다. 물론 이러한 방법은 history가 헤깔리니까 추천은 x</p>\n<p><img src=\"/blog/media/git/rebase/img06.png\" alt=\"img6\"></p>\n<h3 id=\"33-rebase-방법\" style=\"position:relative;\"><a href=\"#33-rebase-%EB%B0%A9%EB%B2%95\" aria-label=\"33 rebase 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3 rebase 방법</h3>\n<p>rollback시 기존 브랜치를 유지하고 헤깔리지 않게 하기위해 <code class=\"language-text\">git_s</code>와 이력이 똑같은 새로운 브랜치 <code class=\"language-text\">git_s_for_rebase</code> 브랜치를 추가. <code class=\"language-text\">rebase</code>용 <code class=\"language-text\">git_s</code> 브랜치는 <code class=\"language-text\">git_s_for_rebase</code></p>\n<p><strong>rebase 시 주의!</strong>\nrebase는 말 그대로 브랜치의 base를 재정의하는 작업이기 때문에 <code class=\"language-text\">git_s_for_rebase</code>브랜치를 활성화 하고 작업해야됨. 중요한 내용이니까 다시 상황 및 목적을 정리하자면</p>\n<ol>\n<li>마스터 브랜치(<code class=\"language-text\">git_m</code>)에 새로운 기능을 개발한 브랜치(<code class=\"language-text\">git_s_for_rebase</code>)내용을 추가 하고 싶음</li>\n<li>history 및 그래프를 깔끔하게 관리하고 싶어, <code class=\"language-text\">git_m</code>와 <code class=\"language-text\">git_s_for_rebase</code>브랜치 관계를 <code class=\"language-text\">fast-forward</code>상태로 만들고 싶음(<code class=\"language-text\">rebase</code> 사용 목적 1)</li>\n<li>그러기 위해선 <code class=\"language-text\">git_s_for_rebase</code>브랜치 base를 <code class=\"language-text\">git_m</code>의 가장 최근 <code class=\"language-text\">commit</code> 된 곳으로 맞추어야됨(<code class=\"language-text\">rebase</code> 사용 목적 2)</li>\n<li><code class=\"language-text\">git_s_for_rebase</code>를 수정해야 하는 작업이므로 <code class=\"language-text\">git_s_for_rebase</code>를 활성화 한 상태에서 <code class=\"language-text\">git_m</code>을 선택하여 <code class=\"language-text\">rebase</code></li>\n</ol>\n<p><img src=\"/blog/media/git/rebase/img07.png\" alt=\"img7\"></p>\n<p>이러한 이유로 위의 그림대로 rebase를 하려고 하면 경고창이 나타난다. 경고창 말대로 <code class=\"language-text\">rebase</code>는 해당 프로젝트의 git history를 수정하는 작업(base 수정) 하는 작업이므로 해당 브랜치를 누군가가 작업을 하고 있는 중에 <code class=\"language-text\">rebase</code>시 history가 꼬여 귀찮아 진다.</p>\n<p><img src=\"/blog/media/git/rebase/img08.png\" alt=\"img8\"></p>\n<p><code class=\"language-text\">확인</code> 버튼을 눌러 rebase를 진행 중, 혹시나마 파일간 충돌이 일어나면 꽤나 귀찮아 진다.</p>\n<p><img src=\"/blog/media/git/rebase/img09.png\" alt=\"img9\"></p>\n<p>위 그림은 일부로 충돌을 낸 상황으로 브랜치를 새로 생성 후 <code class=\"language-text\">git_m</code>에서 <code class=\"language-text\">temp.txt</code>를 수정 후 커밋(git<em>m에서 커밋 5), 이후 <code class=\"language-text\">git_s</code>에서 똑같은 파일을 2번 수정 후 커밋(git_s에서 커밋 2, git_s</em>에서 커밋 3)을 하여 충돌을 유발시킨 상황 &#x26; 이미지 이다.</p>\n<p><code class=\"language-text\">rebase</code> 충돌이 귀찮은 이유는 충돌난 파일을 가지고 있는 커밋들(위 상황에서 git<em>s에서 커밋 2, git_s</em>에서 커밋 3)을 모두 적절히 해결을 해주어야 한다. 수정 중 모두 똑같은 내용으로 수정하면 commit history가 이상해 지니까 이 점을 고려해서 적절하게 수정 해주어야 한다. <code class=\"language-text\">gits_s에서 커밋 2</code>, <code class=\"language-text\">gits_s에서 커밋 3</code>의 <code class=\"language-text\">temp.txt</code>파일 내용을 똑같게 만들고, git message는 다른 상황이라면 나중에 git 이력을 보며 수정사항을 확인할 일이 생기면 더 헤깔리는 일이 생길 것이다.</p>\n<p>이러한 점을 고려하면서, <code class=\"language-text\">rebase</code>를 계속 하자면 위 그림에선 (git<em>s에서 커밋 2)에서 충돌난 파일을 적절히 수정하고 <code class=\"language-text\">source tree</code>의 <code class=\"language-text\">액션</code>-><code class=\"language-text\">재배치 계속</code>(또는 <code class=\"language-text\">$ git rebase --continue</code> 명령어 입력) 후 (git_s</em>에서 커밋 3)에서 충돌난 상황을 또 적절히 해결한 후에 다시 <code class=\"language-text\">액션</code>-><code class=\"language-text\">재배치 계속</code>(또는 <code class=\"language-text\">$ git rebase --continue</code> 명령어 입력)을 입력해야만 아래 그림처럼 정상적으로 <code class=\"language-text\">rebase</code>가 완료된다.</p>\n<p><img src=\"/blog/media/git/rebase/img10.png\" alt=\"img10\"></p>\n<p>위 그림은 어차피 rollback을 위한 브랜치를 추가한거니까 <code class=\"language-text\">git_s</code>를 신경쓰지 말고(아예 없다고 가정) <code class=\"language-text\">git_s_for_rebase</code>브랜치가 정상적으로 <code class=\"language-text\">fast-forward</code> 상태, 즉 <code class=\"language-text\">git_m</code>의 가장 최근 커밋으로 base가 변경 된 상태를 확인 할 수가 있다. 또한 커밋한 날짜도 변경 된 것도 같이 확인이 가능하다</p>\n<h2 id=\"그-외-사용-용도\" style=\"position:relative;\"><a href=\"#%EA%B7%B8-%EC%99%B8-%EC%82%AC%EC%9A%A9-%EC%9A%A9%EB%8F%84\" aria-label=\"그 외 사용 용도 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>그 외 사용 용도</h2>\n<p>rebase의 사용 목적으로는 위에서 설명한 소스 병합 말고도 커밋 삭제, 수정 커밋 합치기(<code class=\"language-text\">squash</code>), 수정 일시, 작업한 사람 정보(아이디, 이메일) 수정 등 많은 용도로 사용된다.</p>\n<p>하지만 이러한 작업들은 수정하는 개념이라기 보단 기존 정보를 삭제하고 새로운 정보를 원하는 위치에 끼워 넣는 작업이다.</p>"}},{"node":{"fields":{"slug":"/posts/etc/etc-rabbitmq/","__typename":"MarkdownRemarkFields","categorySlug":"/category/etc/"},"frontmatter":{"template":"post","title":"RabbitMQ","date":"2020-05-26T00:36:37.672Z","tags":["messagequeue","mq","rabbitmq"],"socialImage":null,"draft":false,"description":"메세지 큐를 사용하는 이유 및 사용 방법. with RabbitMQ","category":"etc"},"id":"3c05ce54-78fb-5d49-a246-6e052a033ac2","html":"<h1 id=\"rabbitmq\" style=\"position:relative;\"><a href=\"#rabbitmq\" aria-label=\"rabbitmq permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>RabbitMQ.</h1>\n<p>메세지 큐 중 하나로 대표적으로 kafka, rabbitmq가 있지만 여기선 rabbitmq 위주로 설명할 예정</p>\n<p>여기서 설명할 내용 및 샘플은 <a href=\"https://github.com/qweasd147/StudyNote/tree/master/springboot/rabbitmq\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">rabbitmq-sample</a> 여기서 확인 가능</p>\n<h1 id=\"1-메세지-큐\" style=\"position:relative;\"><a href=\"#1-%EB%A9%94%EC%84%B8%EC%A7%80-%ED%81%90\" aria-label=\"1 메세지 큐 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 메세지 큐</h1>\n<p>여러 어플리케이션에서 메세지를 주고 받는 시스템. 간단히 설명하면 일종의 DB를 외부에 두고 여러 어플리케이션에서 해당 DB에 데이터를 교환하는 시스템이다.\n일종의 DB라고 설명했지만 DB와 큰 차이점은 각 메세지를 주고받는데 목적이 있고, 내부 처리 방식은 전혀 다른 점이다.\n메세지 큐를 사용할 수도 있는 곳을 예를 들면 대용량 알림 시스템이다. 예를 들어 10만명의 사용자한테 이메일을 보내야 한다고 가정할때 메세지 큐를 사용 안한다면 대략적으로 다음과 같은 플로우를 거쳐야 할 것이다.</p>\n<ol>\n<li>DB에서 사용자 정보 조회 및 변수에 저장</li>\n<li>이메일 대상 필터링(validation 포함)</li>\n<li>이메일 발송</li>\n</ol>\n<p>이러한 작업은 주기적으로 cron이 돌면서 처리해야할 정보가 있나 체크도 해야할 것이며(감시해야하는 프로세스가 주기적으로 돌고 있어야됨), <code class=\"language-text\">3. 이메일 발송</code>은 뭐 자바를 기준으로 <code class=\"language-text\">java 8의 Stream</code>기반으로 처리하던가 푸시 기반인 <code class=\"language-text\">RxJava</code>등을 사용 할 수도 있을 것이다. 하지만 결국 문제는 이 모든 작업이 하나의 어플리케이션에서 수행이 된다는 점이다.</p>\n<p>만약 처리중 예상하지 못한 에러가 발생한다면? 뭐 <code class=\"language-text\">RxJava</code>에서는 알림을 받을 수도 있을 것이다. 그럼 만약 너무 많은 데이터를 어플리케이션에 담고 있어서 처리 중간에 그냥 어플이 죽어버렸다면? 어플이야 다시 복구 하면 되지만 중간에 처리되던 과정들은 통째로 다 날라가게 된다. 2번 과정을 거의다 끝내고 3번이 남았는데 다시 1번 부터 수행해야 할것이고, 더 큰 문제는 많은 사용자들이 메일을 중복해서 받을 수도 있다는 점이다.</p>\n<p>이러한 점을 봤을때 메세지큐를 사용함으로써 생기는 이득은 아래와 같다.</p>\n<ol>\n<li>기본적으로 구독형 방식(폴링 방식x)</li>\n<li>메세지(ex. 처리해야할 정보)를 외부에 저장</li>\n<li>일단 큐에 담고 비동기로 처리 가능</li>\n<li>여러 어플리케이션에서 처리 또는 consumer 개수 증가 등의 확장이 쉬움(분산 처리 가능)</li>\n<li>재처리 및 실패 처리가 쉬움</li>\n</ol>\n<h1 id=\"2-기본-용어\" style=\"position:relative;\"><a href=\"#2-%EA%B8%B0%EB%B3%B8-%EC%9A%A9%EC%96%B4\" aria-label=\"2 기본 용어 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 기본 용어</h1>\n<h3 id=\"21-queue\" style=\"position:relative;\"><a href=\"#21-queue\" aria-label=\"21 queue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 Queue</h3>\n<p>메세지를 담는 큐</p>\n<h3 id=\"22-exchange\" style=\"position:relative;\"><a href=\"#22-exchange\" aria-label=\"22 exchange permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 Exchange</h3>\n<p>메세지를 받아 어느 큐로 옮길지 정한다. Exchange 종류에 따라 똑같은 <code class=\"language-text\">Routing Key</code>라도 다른 큐에 담길 수 있다.</p>\n<h3 id=\"23-binding\" style=\"position:relative;\"><a href=\"#23-binding\" aria-label=\"23 binding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 Binding</h3>\n<p>exchange와 queue를 연동(실질적인 Routing key 패턴과 exchange를 연동)</p>\n<p><strong>참고</strong> 메세지는 생성 후 바로 큐로 옮기는게 아닌, <code class=\"language-text\">Exchange</code>를 한번 거쳐서 전달된다. <code class=\"language-text\">Exchange</code> 종류와 <code class=\"language-text\">Binding</code>에 따라 큐가 결정 &#x26; 전달한다.</p>\n<h3 id=\"24-routing-key\" style=\"position:relative;\"><a href=\"#24-routing-key\" aria-label=\"24 routing key permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.4 Routing Key</h3>\n<p>가상 주소로, 라우팅 시 필요한 key값이다.\n예를 들어 ’<code class=\"language-text\">Routing Key</code>값이 <code class=\"language-text\">r1</code>이면 <code class=\"language-text\">Exchange1</code>로 가라’ 이런식으로 라우팅 하는데 사용</p>\n<h1 id=\"3-dlxdead-latter-exchanges\" style=\"position:relative;\"><a href=\"#3-dlxdead-latter-exchanges\" aria-label=\"3 dlxdead latter exchanges permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. DLX(Dead Latter Exchanges)</h1>\n<blockquote>\n<p>메세지 처리 과정에서 에러가 발생한 메세지를 관리할 exchange</p>\n</blockquote>\n<p>만약 메세지를 처리 중 에러가 발생하는 경우가 발생 할 수도 있다.<code class=\"language-text\">RabbitMQ</code>의 기본 셋팅은 메세지 처리중 에러가 발생하면 다시 큐로 집어넣고 다시 메세지 처리를 시도하게 된다.\n근데 만약 절대 처리할 수 없는 메세지라면? 재처리 과정이 무한하게 반복될 것이다. 이런 케이스를 막기위해 만약 에러가 발생한다면 아래와 같이 처리되도록 유도한다.</p>\n<ol>\n<li>메세지 처리 중 에러 발생</li>\n<li>n번 재시도</li>\n<li>그래도 실패 시, 처리가 불가능 한 메세지라 판단하고 DLX로 보냄</li>\n<li>실패 전용 큐로 해당 메세지로 보낸 후 처리</li>\n</ol>\n<p>메세지 처리 시도 회수와 dlx 정보는 메세지의 헤더에 담겨지고, <code class=\"language-text\">DLX</code>에서 이러한 메세지들을 처리할 목적의 큐로 보내도록 셋팅해놓는다.\n보통 이러한 메세지는 메세지 정보와 알림 정보만 개발자에게 알려주도록 셋팅한다(정상적인 처리가 불가능하니까).</p>\n<h2 id=\"31-ttltime-to-live\" style=\"position:relative;\"><a href=\"#31-ttltime-to-live\" aria-label=\"31 ttltime to live permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 TTL(Time to live)</h2>\n<p><code class=\"language-text\">TTL</code>은 큐에 머무를 수 있는 시간을 제한하는 것으로, 너무 오래된 큐를 방치하는것을 막을 수 있다.</p>\n<p><code class=\"language-text\">Spring Boot</code> + <code class=\"language-text\">RabbitMQ</code> 조합에선 큐를 정의할 때 아래와 같이 쉽게 셋팅이 가능하다.</p>\n<p>큐 셋팅</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">  <span class=\"token annotation punctuation\">@Bean</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">Queue</span> <span class=\"token function\">queue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n      <span class=\"token keyword\">final</span> <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> args <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      args<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"x-dead-letter-exchange\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"dlx exchange 이름\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      args<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"x-dead-letter-routing-key\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"실패 라우팅 키\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      args<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"x-message-ttl\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//2초</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Queue</span><span class=\"token punctuation\">(</span>QUEUE_NAME<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>위와 같이 셋팅 시, ttl(Time to Live)값을 넘기는 메세지는 <code class=\"language-text\">DLX(dlx exchange 이름)</code>로 보내지게 된다.</p>\n<h2 id=\"32-retry-interceptor\" style=\"position:relative;\"><a href=\"#32-retry-interceptor\" aria-label=\"32 retry interceptor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 retry interceptor</h2>\n<p><code class=\"language-text\">TTL</code>에 의해 발생되는 에러 말고 메세지를 처리하다가 발생하는 에러 셋팅을 하고 싶으면 <code class=\"language-text\">RetryInterceptor</code>를 구현해서 리스너에 셋팅하면 된다.\n(근데 <code class=\"language-text\">Message Queue</code>전체로 봤을땐 그냥 <code class=\"language-text\">exchange</code>랑 <code class=\"language-text\">routing-key</code>만 바꿔서 셋팅하는거다)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">  <span class=\"token annotation punctuation\">@Bean</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">SimpleRabbitListenerContainerFactory</span> <span class=\"token function\">listenerContainerFactory</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ConnectionFactory</span> connectionFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">final</span> <span class=\"token class-name\">SimpleRabbitListenerContainerFactory</span> factory <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SimpleRabbitListenerContainerFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    factory<span class=\"token punctuation\">.</span><span class=\"token function\">setConnectionFactory</span><span class=\"token punctuation\">(</span>connectionFactory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    factory<span class=\"token punctuation\">.</span><span class=\"token function\">setDefaultRequeueRejected</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    factory<span class=\"token punctuation\">.</span><span class=\"token function\">setMessageConverter</span><span class=\"token punctuation\">(</span><span class=\"token function\">messageConverter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    factory<span class=\"token punctuation\">.</span><span class=\"token function\">setChannelTransacted</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    factory<span class=\"token punctuation\">.</span><span class=\"token function\">setAdviceChain</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">RetryInterceptorBuilder</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">stateless</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">maxAttempts</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n            <span class=\"token comment\">//.recoverer(new RepublishMessageRecoverer(rabbitTemplate, \"에러용 exchange 이름\", \"실패 큐 이름\"))</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">recoverer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">RabbitMqExceptionHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">backOffOptions</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10000</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> factory<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 셋팅 처럼 실패 시 재시도 횟수(<code class=\"language-text\">maxAttempts</code>) 및 재시도 간격(<code class=\"language-text\">backOffOptions</code>)을 정의 할 수 있고, 실질적인 메세지 실패 처리는 <code class=\"language-text\">RejectAndDontRequeueRecoverer</code> Class를 구현체를\n<code class=\"language-text\">recoverer</code>에 셋팅하면 된다. 라이브러리에서 기본제공되는 <code class=\"language-text\">RepublishMessageRecoverer</code> 클래스도 있긴 하다. 또 간단한게 셋팅하고 싶으면 <code class=\"language-text\">properties</code>로 셋팅이 가능하긴 한데 java로 구현하는게 익숙하니까 pass</p>\n<p>참고 사항으로 메세지 처리 중 <code class=\"language-text\">AmqpRejectAndDontRequeueException</code>에러가 발생하면 더이상 재시도 하지 않고 메세지를 소비하고 끝내게 된다.</p>\n<h1 id=\"4-메세지-구조\" style=\"position:relative;\"><a href=\"#4-%EB%A9%94%EC%84%B8%EC%A7%80-%EA%B5%AC%EC%A1%B0\" aria-label=\"4 메세지 구조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 메세지 구조</h1>\n<p>기본적으로 메세지 구조는 <code class=\"language-text\">header</code> + <code class=\"language-text\">body</code> 형태를 가진다. <code class=\"language-text\">body</code>는 주고받는 메세지 정보를 가지고 있고, <code class=\"language-text\">header</code>에는 어느곳에서 왔는지, <code class=\"language-text\">DLX</code>라면 에러 관련된 정보도 함께 담고 있다.</p>\n<p>아래 내용은 일부로 <code class=\"language-text\">consumer</code>를 구성하지 않고 <code class=\"language-text\">TTL</code> 시간만큼 지났을때 수신되는 메세지의 헤더정보를 확인해 보려는 목적으로 구현한 내용이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">\n  <span class=\"token comment\">//DLX 전용 consumer 메소드</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">failConsumer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Message</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">Item</span> item <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Item</span><span class=\"token punctuation\">)</span> messageConverter<span class=\"token punctuation\">.</span><span class=\"token function\">fromMessage</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> header <span class=\"token operator\">=</span> message<span class=\"token punctuation\">.</span><span class=\"token function\">getMessageProperties</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">String</span> exchangeName <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> header<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"x-first-death-exchange\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Map</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span>xDeath <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token punctuation\">)</span>header<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"x-death\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">String</span> firstReason <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> header<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"x-first-death-reason\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"타임아웃된 아이템 수신 {}\"</span><span class=\"token punctuation\">,</span> item<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"reason : {}, exchange name : {}\"</span><span class=\"token punctuation\">,</span> firstReason<span class=\"token punctuation\">,</span> exchangeName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">warn</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"x-death : {}\"</span><span class=\"token punctuation\">,</span> xDeath<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>만약 <code class=\"language-text\">DLX</code> 전용이 아닌 일반 <code class=\"language-text\">consumer</code>라면 헤더 정보가 거의 없을 수도 있지만 <code class=\"language-text\">DLX</code>라면 위 소스에서 에러난 이유, 발생 횟수(<code class=\"language-text\">retry count</code>) 등의 정보를 확인 가능하다.</p>\n<p>log 내용 샘플</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">타임아웃된 아이템 수신 Item(data=data1, number=1, isThrow=false)\nreason : expired, exchange name : demo-queue-name-exchange\nx-death : {reason=expired, count=1, exchange=demo-queue-name-exchange, time=Wed Jul 08 11:15:21 KST 2020, routing-keys=[foo.bar.baz2], queue=demo-queue-name}</code></pre></div>\n<h1 id=\"5-exchange\" style=\"position:relative;\"><a href=\"#5-exchange\" aria-label=\"5 exchange permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. Exchange</h1>\n<p><code class=\"language-text\">exchange</code>의 역할은 메세지를 전달받아 어느 큐로 전달 할지 결정한다고 하였다. <code class=\"language-text\">exchange</code> 종류로는 크게 3가지가 있다. (<code class=\"language-text\">Header</code> 방식은 생략)</p>\n<table>\n<thead>\n<tr>\n<th>종류</th>\n<th>설명</th>\n<th>용도</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Direct</td>\n<td>라우팅 키가 정확히 일치</td>\n<td>Unicast</td>\n</tr>\n<tr>\n<td>Fanout</td>\n<td>라우팅 키 상관없이 등록된 모든 Queue로 전송</td>\n<td>Broadcast</td>\n</tr>\n<tr>\n<td>Topic</td>\n<td>라우팅 키를 패턴으로 검사하여 패턴에 맞는 모든 Queue로 전송</td>\n<td>Multicast</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"51-direct\" style=\"position:relative;\"><a href=\"#51-direct\" aria-label=\"51 direct permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.1 Direct</h3>\n<p>위 테이블에서 설명 한것 그대로 라우팅 키가 정확히 일치하는 <code class=\"language-text\">Queue</code>로 메세지를 전송한다. 라우팅 키가 정확히 일치 해야하므로 <code class=\"language-text\">Unicast</code> 즉 <code class=\"language-text\">Point to Point</code> 방식으로 메세지를 전송한다.</p>\n<h3 id=\"52-fanout\" style=\"position:relative;\"><a href=\"#52-fanout\" aria-label=\"52 fanout permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.2 Fanout</h3>\n<p>라우팅키를 분석하지 않고 연결된 모든 <code class=\"language-text\">Queue</code>로 메세지를 전송하는 방식이다. 불특정 다수에게 보내는 방식(<code class=\"language-text\">Broadcast</code>)으로 구독형 방식이라 생각 말 할 수도 있겠지만 <code class=\"language-text\">Rabbitmq</code> 기본이 polling이라는 점도 기억은 해놔야한다.</p>\n<h3 id=\"53-topic\" style=\"position:relative;\"><a href=\"#53-topic\" aria-label=\"53 topic permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.3 Topic</h3>\n<p>라우팅키에 패턴 정보가 있으면 패턴을 분석하여 적합한 <code class=\"language-text\">Queue</code>들 한테 메세지를 전송해준다. <code class=\"language-text\">Direct</code>, <code class=\"language-text\">Fanout</code> 특성이 조금씩 섞여있는 형태로 <code class=\"language-text\">Multicast</code>(수신 대상자들을 특정 할 수 있음)로 쓰인다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Bean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"queue1\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Queue</span> <span class=\"token function\">queue1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Queue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"queueName1\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"queue2\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Queue</span> <span class=\"token function\">queue2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Queue</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"queueName2\"</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"topicExchange\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">TopicExchange</span> <span class=\"token function\">exchange</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TopicExchange</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"topicExchangeName\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Binding</span> <span class=\"token function\">binding1</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Qualifier</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"queue1\"</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">Queue</span> queue<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Qualifier</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"topicExchange\"</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">TopicExchange</span> topicExchange<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">BindingBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">to</span><span class=\"token punctuation\">(</span>topicExchange<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">with</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"foo.bar.#\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Binding</span> <span class=\"token function\">binding2</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Qualifier</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"queue2\"</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">Queue</span> queue<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Qualifier</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"topicExchange\"</span><span class=\"token punctuation\">)</span><span class=\"token class-name\">TopicExchange</span> topicExchange<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">BindingBuilder</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">to</span><span class=\"token punctuation\">(</span>topicExchange<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">with</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"foo.bar.#\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>java를 기준으로 위와 같이 <code class=\"language-text\">topic exchange</code>에 라우팅 키 패턴을 <code class=\"language-text\">foo.bar.#</code>으로 <code class=\"language-text\">queue1</code>, <code class=\"language-text\">queue2</code>를 연결해 놓고 있다가 <code class=\"language-text\">foo.bar.baz1</code>, <code class=\"language-text\">foo.bar.baz2</code>이런식으로 라우팅 키가 들어오면 <code class=\"language-text\">queue1</code>, <code class=\"language-text\">queue2</code>에게 각각 메세지를 전달 해준다.</p>"}},{"node":{"fields":{"slug":"/posts/etc/etc-tf-meta_arguments/","__typename":"MarkdownRemarkFields","categorySlug":"/category/etc/"},"frontmatter":{"template":"post","title":"Terraform - Meta-Arguments","date":"2022-06-14T13:38:51.206Z","tags":["terraform","iac"],"socialImage":null,"draft":false,"description":"테라폼 대부분에 넣을 수 있는 기본 argument들","category":"etc"},"id":"4bb62835-fb7e-53b1-9059-c814ab57c685","html":"<p>모든 <code class=\"language-text\">Resource</code> 에서 기본적으로 사용 할 수 있는 <code class=\"language-text\">arguments</code> 들로, 바꿔말하면 특정 리소스에 종속 되지 않고 제공되는 기본적인 arguments 이다</p>\n<h2 id=\"1-depends_on\" style=\"position:relative;\"><a href=\"#1-depends_on\" aria-label=\"1 depends_on permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. depends_on</h2>\n<p>각 resource 들의 생성 되는 순서, 의존관계를 명시하기 위해 사용된다.</p>\n<p>예를 들어, <code class=\"language-text\">EC2</code> 와 거기에 붙일 <code class=\"language-text\">EBS</code> 를 생성해야 한다면 먼저 <code class=\"language-text\">EBS</code> 를 먼저 생성하고, <code class=\"language-text\">ec2</code> 에 연결을 해 줘야 할 것이다. 그럴 때 아래와 같이 사용 할 수가 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_volume_attachment\" \"ebs_att\" {\n  device_name = \"/dev/sdh\"\n  volume_id   = aws_ebs_volume.ec2_volume.id\n  instance_id = aws_instance.server.id\n\n  depends_on = [\n    aws_ebs_volume.ec2_volume,\n  ]\n}\n\nresource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n  availability_zone = \"ap-northeast-2a\"\n\n  depends_on = [\n    aws_ebs_volume.ec2_volume,\n  ]\n}\n\nresource \"aws_ebs_volume\" \"ec2_volume\" {\n  availability_zone = \"ap-northeast-2a\"\n  size              = 30\n}</code></pre></div>\n<p><code class=\"language-text\">depends_on</code> 를 붙여 의존관계가 있는거, 즉 먼저 생성 되어야 하는 resource를 지정 할 수가 있다.</p>\n<blockquote>\n<p>여기선 구지 예시를 들고 싶어서 이런식으로 resource를 따로 만들고 <code class=\"language-text\">depends_on</code> 을 붙였지만 <code class=\"language-text\">aws_instance</code>의 arguments로 <code class=\"language-text\">root_block_device</code> 가 있으니까 구지 이렇게 만들 필요까진 없다. 또한 기본적으로 의존관계를 명시 안해줘도 테라폼이 알아서 잘 생성해준다.</p>\n</blockquote>\n<h2 id=\"2-count\" style=\"position:relative;\"><a href=\"#2-count\" aria-label=\"2 count permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. count</h2>\n<p>동일한 인스턴스를 여러개 생성하고 싶을때 사용한다. 예를 들어 동일한 타입의 <code class=\"language-text\">ec2</code> 를 여러개 만들고 싶을때가 있을 것이다. 그럴 때 여러 resource를 만들어 내는 방법도 있겠지만 count 를 쓰면 더 편하고 쉽게 생성&#x26;관리가 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n  availability_zone = \"ap-northeast-2a\"\n\n  # 똑같은 ec2를 2개 만들어 낸다.\n  count = 2\n  tags = {\n    Name = \"Server ${count.index}\"\n  }\n}</code></pre></div>\n<p>이러고 <code class=\"language-text\">plan</code> 결과를 보면 아래와 같이 나온다</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aws_instance.web[0] will be created\n  + resource \"aws_instance\" \"web\" {\n ... argument 정보\n tags = {\n        + \"Name\" = \"Server 0\"\n }\n}\naws_instance.web[1] will be created\n  + resource \"aws_instance\" \"web\" {\n ... argument 정보\n tags = {\n        + \"Name\" = \"Server 1\"\n }\n}\nPlan: 2 to add, 0 to change, 0 to destroy.</code></pre></div>\n<p><code class=\"language-text\">${count.index}</code> 는 고유 index 정보를 의미한다.</p>\n<h2 id=\"3-for_each\" style=\"position:relative;\"><a href=\"#3-for_each\" aria-label=\"3 for_each permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. for_each</h2>\n<p>목적은 <code class=\"language-text\">count</code> 와 동일하지만, count는 단순 개수에 대한 정보이지만 <code class=\"language-text\">for_each</code> 는 map, set 형태의 데이터 구조로 활용이 가능하다.</p>\n<p><strong>Map</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n  availability_zone = \"ap-northeast-2a\"\n\n  for_each = {\n    web_server : \"nginx\"\n    was : \"java\"\n  }\n\n  tags = {\n    \"${each.key}\" = each.value\n  }\n}</code></pre></div>\n<p><code class=\"language-text\">plan</code> 결과</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># aws_instance.server[\"nginx\"] will be created\n  + resource \"aws_instance\" \"server\" {\n ... argument 정보\n tags = {\n        + \"nginx\" = \"nginx\"\n }\n# aws_instance.server[\"was\"] will be created\n  + resource \"aws_instance\" \"server\" {\n ... argument 정보\n tags = {\n        + \"was\" = \"java\"\n }\nPlan: 2 to add, 0 to change, 0 to destroy.</code></pre></div>\n<p><strong>Set</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n  availability_zone = \"ap-northeast-2a\"\n\n  for_each = toset([\"was\", \"web_server\"])\n  tags = {\n    Name = \"${each.key}\"\n  }\n}</code></pre></div>\n<p><code class=\"language-text\">plan</code> 결과</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># aws_instance.server[\"was\"] will be created\n  + resource \"aws_instance\" \"server\" {\n ... argument 정보\n tags = {\n        + \"Name\" = \"was\"\n }\n# aws_instance.server[\"web_server\"] will be created\n  + resource \"aws_instance\" \"server\" {\n ... argument 정보\n tags = {\n        + \"Name\" = \"web_server\"\n }\nPlan: 2 to add, 0 to change, 0 to destroy.</code></pre></div>\n<p>생성되는 리소스들의 인덱스값도 한번쯤 참고하면서 보면 좋다.</p>\n<p><strong>주의!</strong></p>\n<p>각 <code class=\"language-text\">resource</code>에는 <code class=\"language-text\">count</code> or <code class=\"language-text\">for_each</code> 둘 중 하나만 사용이 가능하다.</p>\n<h2 id=\"4-provider\" style=\"position:relative;\"><a href=\"#4-provider\" aria-label=\"4 provider permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. provider</h2>\n<p>각 <code class=\"language-text\">resource</code>의 <code class=\"language-text\">provider</code>를 명시적으로 지정해 준다. 예를 들어 다른 <code class=\"language-text\">resource</code>는 다 서울 리전을 쓰는데 특정 <code class=\"language-text\">resource</code>만 도쿄 리전을 사용해야한다던가 할때 유용하다(멀티 리전).</p>\n<h2 id=\"5-lifecycle\" style=\"position:relative;\"><a href=\"#5-lifecycle\" aria-label=\"5 lifecycle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. lifecycle</h2>\n<p><code class=\"language-text\">resource</code> 의 <code class=\"language-text\">lifecycle</code> 관련된 설정 값으로 resource가 생성, 변경, 삭제 관련해서 추가로 지정 된 액션을 하도록 설정 할 수 있다.</p>\n<h3 id=\"create_before_destroy-true-or-false\" style=\"position:relative;\"><a href=\"#create_before_destroy-true-or-false\" aria-label=\"create_before_destroy true or false permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">create_before_destroy</code> (true or false)</h3>\n<p>기본적으로 terraform은 resource를 수정 해야하는데 만약 해당 resource를 업데이트를 못한다면 삭제 후, 다시 생성한다.</p>\n<p>Case 1.</p>\n<p>만약 이렇게 설정을 걸어놨다가 보안관련 리소스(security group 같은거)를 수정하다가 해당 role이 삭제되는 짧은 순간 보안적으로 문제가 생길 수도 있다. 이런 상황을 대비하여 이 옵션을 걸어놓으면</p>\n<ol>\n<li>보안 관련 리소스 생성</li>\n<li>해당 resource에 적용</li>\n<li>이전 보안 관련 리소스 삭제</li>\n</ol>\n<p>이런 식으로 안전하게 처리가 가능하다.</p>\n<p>Case 2.</p>\n<p>ELB를 재생성 해야 할때 이 옵션을 주면 먼저 생성 후, 삭제 해버리니까 중간에 딜레이 없이 무중단으로 변경이 가능하다고 한다. → route53 과 연관지어 생각하면 elb를 바꾸거나 할땐 가중치분산 을 활용하는게 정석으로 알고 있는데, 이 옵션만으로도 잘 작동 할 지는 확인 해봐야겠다.</p>\n<h3 id=\"prevent_destroy\" style=\"position:relative;\"><a href=\"#prevent_destroy\" aria-label=\"prevent_destroy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">Prevent_destroy</code></h3>\n<p>리소스가 삭제되는 걸 방지한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n\n  lifecycle {\n    prevent_destroy = true\n  }\n}</code></pre></div>\n<p>이런식으로 삭제 방지 옵션을 주고 <code class=\"language-text\">terraform destroy</code> 를 하면</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aws_instance.server: Refreshing state... [id=i-xxxxxxxxxx]\n╷\n│ Error: Instance cannot be destroyed\n│\n│   on ec2.tf line 98:\n│   98: resource \"aws_instance\" \"server\" {\n│\n│ Resource aws_instance.server has lifecycle.prevent_destroy set, but the plan calls for this resource to be destroyed. To avoid this error and continue with the\n│ plan, either disable lifecycle.prevent_destroy or reduce the scope of the plan using the -target flag.</code></pre></div>\n<p>만약 충분히 다 인지하고 진짜로 resource를 삭제하고 싶으면 <code class=\"language-text\">prevent_destroy</code> 옵션을 주석 처리하고 destroy 하면 된다.</p>\n<h3 id=\"ignore_changes\" style=\"position:relative;\"><a href=\"#ignore_changes\" aria-label=\"ignore_changes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ignore_changes</h3>\n<p>최초 apply 시에만 적용 하고, 그 이후의 변화는 ignore 할때 사용된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n  availability_zone = \"ap-northeast-2a\"\n\n  lifecycle {\n    ignore_changes = [무시할_argument_목록]\n  }\n}</code></pre></div>\n<p>이게 사용되어야 하는 케이스는 아직 잘 와닿지는 않는다</p>\n<h3 id=\"provisioner\" style=\"position:relative;\"><a href=\"#provisioner\" aria-label=\"provisioner permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Provisioner</h3>\n<p>해당 리소스에 특정 작업을 수행하기 위해 리소스 로컬에서 or 원격 시스템에서 스크립트를 실행하고 싶을때 사용된다.</p>\n<ul>\n<li>local-exec : 내 로컬(ex macbook)에서 실행되는 명령어</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n\n  provisioner \"local-exec\" {\n    command = \"hostname\"\n  }\n}</code></pre></div>\n<ul>\n<li>hostname 명령어 실행 결과\naws_instance.server: Creating…\naws_instance.server: Still creating… [10s elapsed]\naws_instance.server: Still creating… [20s elapsed]\naws_instance.server: Provisioning with ‘local-exec’…\naws_instance.server (local-exec): Executing: [“/bin/sh” “-c” “hostname”]\naws_instance.server (local-exec): kimjoohyung-ui-MacBookPro.local\naws_instance.server: Creation complete after 27s [id=i-0f2157fc11e6ba5a9]</li>\n</ul>\n<p>실행한 컴퓨터의 로컬 hostname이 출력되는걸 확인 할 수 있다.</p>\n<ul>\n<li>remote-exec</li>\n</ul>\n<p>해당 리소스에서 직접 실행되는 명령어다. ec2라면 <code class=\"language-text\">connection</code> 정보를 줘서 ssh로 접근 한 후, 명령어를 실행 시킬 수가 있다.</p>\n<p>또한 <code class=\"language-text\">when</code> 옵션을 줘서 실행 주기를 바꿀 수가 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">provisioner \"local-exec\" {\n    when    = destroy\n    command = \"echo 'Destroy-time provisioner'\"\n  }</code></pre></div>\n<p>이렇게 하면 리소스가 삭제 되는 시기에 명령어가 실행된다. 명령어 실행이 실패를 대비한 옵션 (<code class=\"language-text\">on_failure</code>) 옵션도 제공해준다.</p>\n<blockquote>\n<p><strong>Note:</strong> Provisioners should only be used as a last resort. For most common situations there are better alternatives.</p>\n</blockquote>\n<p>왠만하면 쓰지 말라고 한다… ec2에는 비슷한 역할을 하는 <code class=\"language-text\">user_data</code> 라는 얘도 있으니 참고하자</p>\n<ul>\n<li>공식 문서\n<a href=\"https://www.terraform.io/language/resources/syntax#meta-arguments\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.terraform.io/language/resources/syntax#meta-arguments</a></li>\n</ul>"}},{"node":{"fields":{"slug":"/posts/etc/etc-tf-provider/","__typename":"MarkdownRemarkFields","categorySlug":"/category/etc/"},"frontmatter":{"template":"post","title":"Terraform - 기본","date":"2022-03-30T05:56:58.276Z","tags":["terraform","iac","provider"],"socialImage":null,"draft":false,"description":"테라폼 기본 설명 + Provider 역할","category":"etc"},"id":"f76659b2-0bc3-54ff-bccb-6de80c346b10","html":"<p>예전엔 인프라 구성이라고 해봤자 그냥 리눅스 서버 한대 올리고 그곳에 모든 어플리케이션(웹서버, db, was 등등)을 설치하고 사용해서 프로비저닝에 대한 별다른 불편함을 느끼지 못했다. 근데 요즘엔 클라우드 서비스 중에서 <code class=\"language-text\">IaaS</code>를 제공해 주는곳도 많고 그 종류도 다양해져서, 그 사이 연관관계의 복잡함, 한번 설치하고 다른곳에 똑같이 설치하는데에도 실수나 시간도 많이 걸리는 단점이 눈에 띄게 생겨났다. 이런 서비스들 설치와 연관관계 등을 소스코드로 관리하고 설치 할 수 있다면 휴먼에러나 시간을 줄일 수가 있는데, 이런 방식을 IaC(<code class=\"language-text\">Infrastructure as Code</code>)라고 하며, <code class=\"language-text\">Terraform</code>은 <code class=\"language-text\">IaC</code>를 위한 도구로 사용된다.</p>\n<h1 id=\"1-terraform-구성-요소\" style=\"position:relative;\"><a href=\"#1-terraform-%EA%B5%AC%EC%84%B1-%EC%9A%94%EC%86%8C\" aria-label=\"1 terraform 구성 요소 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Terraform 구성 요소</h1>\n<h2 id=\"provider\" style=\"position:relative;\"><a href=\"#provider\" aria-label=\"provider permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>provider</h2>\n<p><code class=\"language-text\">Infrastructure</code>를 제공해주는 곳을 말한다. 대표적으로 <code class=\"language-text\">aws</code> , <code class=\"language-text\">GCP</code> , <code class=\"language-text\">Azure</code> 가 있지만 다른것들은 사실 관심없고 앞으로 다룰 모든 예제는 <code class=\"language-text\">aws</code>로만 할꺼다.</p>\n<blockquote>\n<p>테라폼은 <code class=\"language-text\">IaC</code> 도구일 뿐이지 특정 서비스(<code class=\"language-text\">aws</code>, <code class=\"language-text\">CGP</code> 등등)에 종속적인 기술이 아니다.</p>\n</blockquote>\n<h2 id=\"resource\" style=\"position:relative;\"><a href=\"#resource\" aria-label=\"resource permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>resource</h2>\n<p>인프라 resource 종류라고 생각하면 된다. <code class=\"language-text\">ec2</code>나 <code class=\"language-text\">s3</code>, <code class=\"language-text\">RDS</code> 등 그냥 <code class=\"language-text\">provider</code>에서 제공 해주는 서비스들이라 생각하면 편하다.</p>\n<h2 id=\"values\" style=\"position:relative;\"><a href=\"#values\" aria-label=\"values permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>values</h2>\n<p>input/output values 랑 local values를 통칭해서 적어봤는데 연관된 리소스들을 하나의 모듈 단위로 만들었을 때 필요한 값들(arguments), 또 이 모듈을 참조 하여 다른곳에서 사용할 때 필요한 값들(output)을 말한다.</p>\n<h2 id=\"module\" style=\"position:relative;\"><a href=\"#module\" aria-label=\"module permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>module</h2>\n<p>위에서 설명한 대로 여러 resource들을 소스 코드를 통해 하나로 묶어 모듈단위로 만들어 관리하는걸 의미한다. 예를들어 <code class=\"language-text\">cloud front</code> + <code class=\"language-text\">s3</code>를 기반으로 <code class=\"language-text\">CDN Server</code> 라는 모듈을 구성 할 수도 있고, <code class=\"language-text\">ec2</code> + <code class=\"language-text\">vpc</code> + <code class=\"language-text\">security group</code> 를 기반으로 <code class=\"language-text\">Worker Node</code> 라는 모듈을 구성한다고 생각하면 이해가 될 것이다. input values를 통해 필요한 파라미터를 받도록 구성이 가능하다.</p>\n<h2 id=\"state\" style=\"position:relative;\"><a href=\"#state\" aria-label=\"state permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>state</h2>\n<p>테라폼을 통해 인프라를 구성하고 끝나는게 아니라, 이 인프라 구성요소들(resource 들) 관리하는 하는 역할 까지(추가, 수정, 삭제 등등) 가능하다. 그러기 위해 현재 배포 된 resource 들의 상태 값들을 따로 저장/관리 해주는 역할까지 지원해준다. 이런 state값들을 그냥 local에서 관리 할 수도 있지만 다른 원격지(backend라고 한다)로 저장도 가능하여 여러 관리자가 동일한 서비스를 관리 할 수도 있다.</p>\n<blockquote>\n<p>그냥 git 같은 버전 관리나 별도의 ec2 + cloud9, 아님 terraform cloud 또는 aws 저장소(s3&#x26; dynamodb ) 등등을 통해 여러 사람이 관리 할 수 있게 도와주고 있으며, 인프라 구성 중 다른 사람과 충돌을 방지하기 위해 lock 같은 상태값도 존재한다. 이런 내용은 나중에 다시 실습을 하며 살펴 볼 예정이다.</p>\n</blockquote>\n<h1 id=\"2-terraform-명령어\" style=\"position:relative;\"><a href=\"#2-terraform-%EB%AA%85%EB%A0%B9%EC%96%B4\" aria-label=\"2 terraform 명령어 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Terraform 명령어</h1>\n<h2 id=\"init\" style=\"position:relative;\"><a href=\"#init\" aria-label=\"init permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>init</h2>\n<p>그냥 <code class=\"language-text\">git init</code> 같은거라고 생각하면 된다. 필요한 plugin 들을 설치 하는 과정으로, 현재 위치를 기준으로 xxx.tf 파일을 확인하여 필요한 플러그인을 설치한다. 주의 할 점으로 설치되는 것들은 provider에 종속적이니까 {파일명}.tf 파일을 만든 후, provider를 구성한 후에 init을 통해 필요한 plugin들이 설치되도록 유도해줘야 한다.</p>\n<h2 id=\"plan\" style=\"position:relative;\"><a href=\"#plan\" aria-label=\"plan permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>plan</h2>\n<p>코드를 쓰고 실행 계획을 보고 싶을 때 사용되는데, 현재 state를 기준으로 <code class=\"language-text\">resource</code> 등이 어떻게 변하는지(추가/수정/삭제 되는 <code class=\"language-text\">resource</code>)와 각 <code class=\"language-text\">argumetns</code> 값들을 확인 할 수가 있다.</p>\n<h2 id=\"apply\" style=\"position:relative;\"><a href=\"#apply\" aria-label=\"apply permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>apply</h2>\n<p>plan을 통해 예상되는 내용을 확인하고 apply로 진짜 실행 되도록 명령한다.</p>\n<h2 id=\"destroy\" style=\"position:relative;\"><a href=\"#destroy\" aria-label=\"destroy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>destroy</h2>\n<p>실제 배포된 <code class=\"language-text\">resource</code>들을 제거 할때 사용된다. 리소스들의 삭제 방지 옵션을 줄 수도 있다(라이브 인프라 <code class=\"language-text\">resource</code>들을 실수로 다 날려먹으면 안되니까).</p>\n<h2 id=\"import\" style=\"position:relative;\"><a href=\"#import\" aria-label=\"import permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>import</h2>\n<p>이건 역으로 이미 배포 된 사항을 state로 옮겨주는 역할을 수행한다. 먼저 웹으로 구성 후, 소스코드로 똑같이 작성였다고 하더라도, 내부 <code class=\"language-text\">state</code>값이 다를 때 동기화를 위해 사용된다.</p>\n<h1 id=\"3-provider\" style=\"position:relative;\"><a href=\"#3-provider\" aria-label=\"3 provider permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Provider</h1>\n<p>앞서 설명 했듯이, 인프라 서비스를 제공해주는 cloud 서비스(<code class=\"language-text\">IaaS</code>)를 제공해주는 곳은 많다. 대표적으로 <code class=\"language-text\">AWS</code> 부터 Naver Cloud(<code class=\"language-text\">ncloud</code>)도 있는데 terraform은 이런 특정 플랫폼에 종속되는것이 아니다.</p>\n<blockquote>\n<p>물론 그렇다고 완벽하게 추상화 되어 소스 코드는 그대로 인데 provider만 바꿔 사용할 수 있다거나 하는건 전혀 아니다.</p>\n</blockquote>\n<p>테라폼에서 <code class=\"language-text\">Provider</code>는 이런 서비스들의 정보를 지정하고, 사용되는 플러그인 등의 정보, 버전을 관리하는 역할을 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># 1. terraform 버전 정보와 provider 상세 정보 명시.\n# 옵션값인데 안쓰면 현재 terraform version과 연결된 provider 기본 버전 정보로 셋팅된다.\nterraform {\n  required_version = \">= 0.14.3\"\n\n  required_providers {\n    aws = {\n      source  = \"hashicorp/aws\"\n      version = \">= 3.50.0\"\n    }\n  }\n}\n\n# 2. aws default region + credentials 값 지정\nprovider \"aws\" {\n  region = \"ap-northeast-2\"\n  shared_credentials_files = [\"~/.aws/credentials\"]\n}</code></pre></div>\n<h2 id=\"31-terraform-버전-정보\" style=\"position:relative;\"><a href=\"#31-terraform-%EB%B2%84%EC%A0%84-%EC%A0%95%EB%B3%B4\" aria-label=\"31 terraform 버전 정보 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 terraform 버전 정보</h2>\n<p>terraform도 꾸준히 버전이 올라가고, 그에따라 기존 코드들은 deprecated 될 수도 있다. 주의 할 점은 이 테라폼 버전 정보는 옵션값으로 필수값이 아닌데, 명시해주지 않으면 로컬 버전을 그대로 따라게가 된다. 이전에 <code class=\"language-text\">Serverless framework</code> 를 오래동안 써보면서 버전을 별로 신경쓰지 않았다가(<code class=\"language-text\">Serverless frameowrk</code> 도 버전 명시 안해주면 로컬 버전 따라간다) 로컬 환경에 메이저 버전 올리면서 기존 코드에서 호환되지 않은 부분이 많이 생겨 문제가 됬던 기억이 있는데, 테라폼을 쓸 땐 이런 버전 정보는 무조건 명시하면서 공부 할 예정이다.</p>\n<blockquote>\n<p>뭐 state 값들도 함께 버전 관리 하면 알아서 이런것도 관리해주니까 구지 필요는 없겠지만 진짜 이 코드를 항상 똑같은 환경에서 실행한다는 보장이 없으니까 적어주는게 좋다고 생각된다.</p>\n</blockquote>\n<h3 id=\"required_providers\" style=\"position:relative;\"><a href=\"#required_providers\" aria-label=\"required_providers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>required_providers</h3>\n<p>서비스 provider를 명시하는 block이다. 기본적인 구성요소로는</p>\n<ul>\n<li>source : provider 대상 정보. 보통 (namespace)/(type)으로 구성된다.</li>\n<li>version : provider 의 버전 정보</li>\n</ul>\n<p>참고로 <code class=\"language-text\">Official</code> tier는 <code class=\"language-text\">hashicorp</code> 라는 namespace를 갖는다.</p>\n<blockquote>\n<p>Official providers are owned and maintained by HashiCorp.</p>\n</blockquote>\n<h2 id=\"32-aws-default-region--credentials-값-지정\" style=\"position:relative;\"><a href=\"#32-aws-default-region--credentials-%EA%B0%92-%EC%A7%80%EC%A0%95\" aria-label=\"32 aws default region  credentials 값 지정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 aws default region + credentials 값 지정</h2>\n<p>기본 aws 리전 + access&#x26;secret key(<code class=\"language-text\">credentials</code>) 값 지정한다(직접 명시 할 수 있고, 위 처럼 <code class=\"language-text\">credentials</code> +@로 profile 도 활용 할 수 있다). 이걸 명시하면 기본적인 모든 resource들은 다 aws를 provider로 인식하고 기본 리전 값을 기반으로 셋팅된다. 혹시나 몇몇 resource 들은 특정 리전값으로 바꿔서 활용하고 싶으면 multi provider로 구성하여 사용하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">provider \"aws\" {\n   region  = \"us-east-1\"\n   alias   = \"east\"\n}</code></pre></div>\n<p>이런식으로 provider를 하나 더 추가하고(alias는 필수값이 된다) resource를 만들 때 provider로 해당 alias 값을 연결하면 해당 리소스만 <code class=\"language-text\">us-east-1</code> 으로 사용이 가능하다.</p>"}},{"node":{"fields":{"slug":"/posts/etc/etc-tf-s3-lifecycle/","__typename":"MarkdownRemarkFields","categorySlug":"/category/etc/"},"frontmatter":{"template":"post","title":"aws - S3 Life cycle","date":"2022-06-20T01:35:28.075Z","tags":["terraform","iac","aws","s3"],"socialImage":null,"draft":false,"description":"s3의 lifecycle 기본 설명 + 테라폼으로 구현","category":"etc"},"id":"58eb61f8-3d9a-5275-8b8c-ae1cc5c25d16","html":"<h2 id=\"1-s3-storage-class\" style=\"position:relative;\"><a href=\"#1-s3-storage-class\" aria-label=\"1 s3 storage class permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. S3 Storage Class</h2>\n<p>S3는 모든데이터를 물리적으로 동일한 스펙인 곳에 저장 할 수도 있지만, 경우에 따라 다른 곳에 저장 할 수도 있다. 이렇게 저장되는 디스크의 스팩을 여러개로 나눠서 구분하고, 이를 S3 storage class 라고 한다.</p>\n<blockquote>\n<p>쉽게 말하면 자주 쓰는것(게임)은 ssd에 저장하고 잘 안쓰는 데이터는 그냥 하드 디스크에 저장해서 관리하여 비용 측면에서 더욱 저렴하게 관리 할 수도 있다는 말이다.</p>\n</blockquote>\n<p>제공해주는 class 종류는 많은데 결국엔 최근 쓰여진 파일은 많이 읽기/쓰기가 많으니까 좋은곳에 두고, 오래된 파일들은 어차피 자주 안보고 보존or가끔 볼때가 목적인 경우가 많으니까 어디 구석에 두자는 말이다. 물론 이런 class일 수록 비용은 더 저렴하다.</p>\n<p><img src=\"/blog/media/aws/s3/s3-storage-classes.png\" alt=\"img1\"></p>\n<blockquote>\n<p>이미지 출처 <a href=\"https://catalog.us-east-1.prod.workshops.aws/workshops/f238037c-8f0b-446e-9c15-ebcc4908901a/en-US/002-services/002-storage/003-s3\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://catalog.us-east-1.prod.workshops.aws/workshops/f238037c-8f0b-446e-9c15-ebcc4908901a/en-US/002-services/002-storage/003-s3</a></p>\n</blockquote>\n<p>참고로 일반적으로 사용되는 class는 <code class=\"language-text\">Standard class</code>이다. 각 클래스 마다 장단점은 있지만 눈에 띄는 class만 적어보자면</p>\n<p><strong>1. S3 Zone-IA</strong></p>\n<p>이름처럼 하나의 az에 데이터를 저장하기 때문에 해당 az가 물리적으로 날라가면 데이터가 그냥 날라간다</p>\n<p><strong>2. S3 Glacier Flexible Retrieval, S3 Glacier Deep Archive</strong></p>\n<p>다른 storage는 생각보다 standard 클래스랑 처리량 스펙이 똑같은데 이 두 class는 지연시간이 길 수도 있다. 또한 검색한 gb당 요금이 책정되는 점도 특징이다.</p>\n<h3 id=\"11-각-테이블-별-비용-및-스펙\" style=\"position:relative;\"><a href=\"#11-%EA%B0%81-%ED%85%8C%EC%9D%B4%EB%B8%94-%EB%B3%84-%EB%B9%84%EC%9A%A9-%EB%B0%8F-%EC%8A%A4%ED%8E%99\" aria-label=\"11 각 테이블 별 비용 및 스펙 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 각 테이블 별 비용 및 스펙</h3>\n<p><img src=\"/blog/media/aws/s3/s3-storage-class2.png\" alt=\"img2\"></p>\n<blockquote>\n<p>이미지 출처 - <a href=\"https://aws.amazon.com/ko/s3/storage-classes/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://aws.amazon.com/ko/s3/storage-classes/</a></p>\n</blockquote>\n<p>이렇게 데이터에 따라 특정 규칙을 정하고 어느 class로 보낼지 정할 수가 있고, 아니면 아예 삭제 해버릴수도 있는데 이러한 기능을 <code class=\"language-text\">lifecycle rule(수명주기 규칙)</code>이라고 한다.</p>\n<p>aws 사이트에서 s3 → 버킷 선택 → 수명주기 구성 을 보면 해당 규칙을 확인 할 수가 있다.</p>\n<h3 id=\"12-수명-주기-규칙-구성\" style=\"position:relative;\"><a href=\"#12-%EC%88%98%EB%AA%85-%EC%A3%BC%EA%B8%B0-%EA%B7%9C%EC%B9%99-%EA%B5%AC%EC%84%B1\" aria-label=\"12 수명 주기 규칙 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 수명 주기 규칙 구성</h3>\n<p><img src=\"/blog/media/aws/s3/s3-storage-class3.png\" alt=\"img3\"></p>\n<p>수명 주기 규칙 이름은 그냥 구분용 이름이고, 규칙 범위 선택 을 통해 대상을 지정할 수 있다. 대상 지정은 특정 디렉토리 하위를 지정(접두사)하거나 객체가 가지고 있는 tag를 기준으로 그 대상을 특정 할수가 있다.</p>\n<blockquote>\n<p>참고로 s3파일 삭제를 이런 수명 주기를 이용해서 삭제하면 좋은점이 혹시나 삭제 대상이 많아도 일단 tag만 붙여 준 뒤, tag가 붙은 후 시간이 지나면 삭제되게 처리하면 삭제 처리 시간도 빠르고 혹시나마 복구를 해야한다면 빠르게 복구 할 수도 있다.</p>\n</blockquote>\n<h3 id=\"12-수명-주기-규칙-작업\" style=\"position:relative;\"><a href=\"#12-%EC%88%98%EB%AA%85-%EC%A3%BC%EA%B8%B0-%EA%B7%9C%EC%B9%99-%EC%9E%91%EC%97%85\" aria-label=\"12 수명 주기 규칙 작업 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 수명 주기 규칙 작업</h3>\n<p><img src=\"/blog/media/aws/s3/s3-storage-class4.png\" alt=\"img4\"></p>\n<p>위에서 대상을 지정했다면, 여기서 파일을 진짜 어떻게 처리할지 셋팅하게 된다. 앞서 말한대로 생성 후, 지정된 날짜가 지나면 storage class를 옮겨버리거나(위의 2개 작업) 물리적으로 삭제 처리 되도록 지정(3,4번째꺼) 할 수도 있다.</p>\n<blockquote>\n<p><code class=\"language-text\">버전</code>이라는 말도 나오는데, 그냥 <code class=\"language-text\">s3 객체 버전 관리</code>를 말하는거다.</p>\n</blockquote>\n<p><img src=\"/blog/media/aws/s3/s3-storage-class5.png\" alt=\"img5\">\n이런식으로 클릭클릭 하면서 셋팅해 나아가면 최종적으로 생성일을 기준으로 데이터 라이프 사이클을 확인 할 수가 있다</p>\n<blockquote>\n<p>위 이미지는 특정 날짜가 지나면 class를 계속 옮기다가 최종적으로 영구 삭제 처리 되도록 설정한 내용이다</p>\n</blockquote>\n<h2 id=\"2-terraform으로-구현\" style=\"position:relative;\"><a href=\"#2-terraform%EC%9C%BC%EB%A1%9C-%EA%B5%AC%ED%98%84\" aria-label=\"2 terraform으로 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. terraform으로 구현</h2>\n<p>전체 소스는 <a href=\"https://github.com/qweasd147/StudyNote/blob/master/terraform/s3_lifecycle/main.tf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">개인 git repository</a>에 올려놨고, 몇가지 옵션 설명을 하자면 아래와 같다</p>\n<h3 id=\"21-aws_s3_bucket_public_acces_block\" style=\"position:relative;\"><a href=\"#21-aws_s3_bucket_public_acces_block\" aria-label=\"21 aws_s3_bucket_public_acces_block permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 <code class=\"language-text\">aws_s3_bucket_public_acces_block</code></h3>\n<p>별다른 설정없이 만들면 s3에 올려진 파일들은 외부에서 접근이 가능하다. 그냥 테스트 용도긴 하지만 이런거 굉장히 불편해서 다 block 되게 막아놓기 위해 설정 해놨다\n<img src=\"/blog/media/aws/s3/s3-image-01.png\" alt=\"img6\"></p>\n<p>웹에서 보면 위와 같은 설정 적용 한거다</p>\n<h3 id=\"22-aws_s3_bucketlifecycle_configuration\" style=\"position:relative;\"><a href=\"#22-aws_s3_bucketlifecycle_configuration\" aria-label=\"22 aws_s3_bucketlifecycle_configuration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 <code class=\"language-text\">aws_s3_bucketlifecycle_configuration</code></h3>\n<p>lifecycle 적용이 필요한 terraform resource이다</p>\n<h3 id=\"23-aws-웹에서-봤을때-설정-결과-화면\" style=\"position:relative;\"><a href=\"#23-aws-%EC%9B%B9%EC%97%90%EC%84%9C-%EB%B4%A4%EC%9D%84%EB%95%8C-%EC%84%A4%EC%A0%95-%EA%B2%B0%EA%B3%BC-%ED%99%94%EB%A9%B4\" aria-label=\"23 aws 웹에서 봤을때 설정 결과 화면 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 aws 웹에서 봤을때 설정 결과 화면</h3>\n<p>웹에서 보면 아래와 같이 적용된 걸 확인 할수 있다(terraform 소스 적용한 결과)</p>\n<p><img src=\"/blog/media/aws/s3/s3-image-02.png\" alt=\"img7\">\n<img src=\"/blog/media/aws/s3/s3-image-03.png\" alt=\"img8\"></p>"}},{"node":{"fields":{"slug":"/posts/etc/etc-tf-resource/","__typename":"MarkdownRemarkFields","categorySlug":"/category/etc/"},"frontmatter":{"template":"post","title":"Terraform - Resource","date":"2022-04-15T01:28:28.137Z","tags":["terraform","iac","aws"],"socialImage":null,"draft":false,"description":"테라폼으로 provider(aws) 서비스를 사용하려고 할때 + Meta-Arguments","category":"etc"},"id":"f2f18d56-7aad-5fcd-b0b2-1b3fd6f0f4ea","html":"<h2 id=\"1-resource\" style=\"position:relative;\"><a href=\"#1-resource\" aria-label=\"1 resource permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Resource</h2>\n<p>실질적으로 aws 서비스(ec2, s3, rds 등등)들을 프로비저닝 할 수 있는 코드들이 된다.</p>\n<p>기본 문법으로는 아래와 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_resource_name\" \"tf_고유_이름\" {\n\n   # TODO : 각 resource에 필요한 arguments 들\n}</code></pre></div>\n<p>주의 할 점으로는 여기서 말하는 <code class=\"language-text\">tf_고유_이름</code>은 테라폼이 내부적으로 리소스를 구분하기 위한 고유 key값이 된다. 즉, 동일한 종류의 <code class=\"language-text\">resource</code> 중에선 유니크 해야하며, 이 이름이 aws에서 표기되는 이름과는 연관이 없다(리소스 종류별로 조금씩 다르긴 하다)</p>\n<p>ec2 인스턴스 한대를 올리기 위한 샘플은 아래와 같이 작성하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"test-ec2-instance\" {\n  ami           = \"ami-014009fa4a1467d53\"\n  instance_type = \"t2.micro\"\n}</code></pre></div>\n<p>결국엔 필요한 <code class=\"language-text\">arguments</code>와 각 리소스 간의 특징을 잘 알아야하는데 그 말은 <code class=\"language-text\">terraform</code>만 알면 안되고 <code class=\"language-text\">aws</code>로 잘 해야 한다는 점이다.\naws는 그냥 꾸준히 공부하고 구성에 필요한 내용은 테라폼 공식 문서를 참고해서 구현하면 된다</p>\n<blockquote>\n<p><a href=\"https://registry.terraform.io/providers/hashicorp/aws/latest/docs\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://registry.terraform.io/providers/hashicorp/aws/latest/docs</a></p>\n</blockquote>\n<h2 id=\"2-meta-arguments\" style=\"position:relative;\"><a href=\"#2-meta-arguments\" aria-label=\"2 meta arguments permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Meta-Arguments</h2>\n<p>모든 <code class=\"language-text\">Resource</code>에 기본적으로 적용할 수가 있는 <code class=\"language-text\">arguments</code>들이 있다. 바꺼 ㅁㄹ하면 특정 리소스에 종속되지 않고 제공되는 가장 기본적인 <code class=\"language-text\">arguments</code> 이다.</p>\n<h3 id=\"21-depends_on\" style=\"position:relative;\"><a href=\"#21-depends_on\" aria-label=\"21 depends_on permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 depends_on</h3>\n<p>프로비저닝을 위해 각 resource 간에 생성되는 순서를 명시 해야하거나 참조되는 <code class=\"language-text\">attribute</code>를 위해 의존관계를 명시하기 위해 사용된다.</p>\n<p>예를들어 <code class=\"language-text\">ec2</code>와 거기에 붙일 <code class=\"language-text\">EBS</code>가 필요하다면 <code class=\"language-text\">EBS</code>를 먼저 생성하고 <code class=\"language-text\">ec2</code>에 연결을 해 줘야 할것이다. 그럴 때 아래와 같이 사용 할 수가 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_volume_attachment\" \"ebs_att\" {\n  device_name = \"/dev/sdh\"\n  volume_id   = aws_ebs_volume.ec2_volume.id\n  instance_id = aws_instance.server.id\n\n  depends_on = [\n    aws_ebs_volume.ec2_volume,\n  ]\n}\n\nresource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n  availability_zone = \"ap-northeast-2a\"\n\n  depends_on = [\n    aws_ebs_volume.ec2_volume,\n  ]\n}\n\nresource \"aws_ebs_volume\" \"ec2_volume\" {\n  availability_zone = \"ap-northeast-2a\"\n  size              = 30\n}</code></pre></div>\n<p><code class=\"language-text\">depends_on</code>를 붙여 먼저 생성되어야 하는 resource를 지정 할 수가 있다.</p>\n<blockquote>\n<p>여기선 구지 예시를 들고 싶어서 이런식으로 구성하였지만 <code class=\"language-text\">aws_instance</code>의 arguments로 <code class=\"language-text\">root_block_device</code>가 있으니 이렇게 구지 따로 만들 필요까진 없고, 기본적으로 의존관계를 명시 안해줘도 테라폼이 알아서 필요한 순서대로 생성해준다.</p>\n</blockquote>\n<h3 id=\"22-count\" style=\"position:relative;\"><a href=\"#22-count\" aria-label=\"22 count permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 count</h3>\n<p>동일한 <code class=\"language-text\">resource</code>를 여러개 생성하고 싶을 때 사용한다. 예를들어 동일한 타입의 <code class=\"language-text\">ec2</code>를 여러개 만들고 싶을때 <code class=\"language-text\">resource</code>를 여러번 정의 할 수도 있겠지만 그냥 <code class=\"language-text\">count</code>를 쓰면 더 편하고 쉽게 생성이 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n  availability_zone = \"ap-northeast-2a\"\n\n  # 똑같은 ec2를 2개 만들어 낸다.\n  count = 2\n  tags = {\n    Name = \"Server ${count.index}\"\n  }\n}</code></pre></div>\n<p>plan또는 apply를 해보면 아래와같이 2개의 인스턴스가 생성되고, 이 리소스의 고유한 key값으로 <code class=\"language-text\">web[0]</code>과 <code class=\"language-text\">web[1]</code>가 생성되는 것도 함께 기억해야한다(count는 index기반으로 키가 생성된다)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aws_instance.web[0] will be created\n  + resource \"aws_instance\" \"web\" {\n ... argument 정보\n tags = {\n        + \"Name\" = \"Server 0\"\n }\n}\naws_instance.web[1] will be created\n  + resource \"aws_instance\" \"web\" {\n ... argument 정보\n tags = {\n        + \"Name\" = \"Server 1\"\n }\n}\nPlan: 2 to add, 0 to change, 0 to destroy.</code></pre></div>\n<p><code class=\"language-text\">${count.index}</code> 는 고유 index 정보를 의미한다.</p>\n<h3 id=\"23-for_each\" style=\"position:relative;\"><a href=\"#23-for_each\" aria-label=\"23 for_each permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 for_each</h3>\n<p>목적은 count 와 동일하지만, count는 단순 개수에 대한 정보이지만 for_each 는 map, set 형태의 데이터 구조로 활용이 가능하다.</p>\n<h4 id=\"231-map\" style=\"position:relative;\"><a href=\"#231-map\" aria-label=\"231 map permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3.1 Map</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n  availability_zone = \"ap-northeast-2a\"\n\n  for_each = {\n    web_server : \"nginx\"\n    was : \"java\"\n  }\n\n  tags = {\n    \"${each.key}\" = each.value\n  }\n}</code></pre></div>\n<p><code class=\"language-text\">plan</code> 결과</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># aws_instance.server[\"nginx\"] will be created\n  + resource \"aws_instance\" \"server\" {\n ... argument 정보\n tags = {\n        + \"web_server\" = \"nginx\"\n }\n# aws_instance.server[\"was\"] will be created\n  + resource \"aws_instance\" \"server\" {\n ... argument 정보\n tags = {\n        + \"was\" = \"java\"\n }\nPlan: 2 to add, 0 to change, 0 to destroy.</code></pre></div>\n<h4 id=\"232-set\" style=\"position:relative;\"><a href=\"#232-set\" aria-label=\"232 set permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3.2 Set</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n  availability_zone = \"ap-northeast-2a\"\n\n  for_each = toset([\"was\", \"web_server\"])\n  tags = {\n    Name = \"${each.key}\"\n  }\n}</code></pre></div>\n<p>plan 결과</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># aws_instance.server[\"was\"] will be created\n  + resource \"aws_instance\" \"server\" {\n  ... argument 정보\n\n  tags_all                             = {\n    + \"was\" = \"java\"\n  }\n# aws_instance.server[\"web_server\"] will be created\n  + resource \"aws_instance\" \"server\" {\n  ... argument 정보\n  tags_all                             = {\n    + \"web_server\" = \"nginx\"\n  }\nPlan: 2 to add, 0 to change, 0 to destroy.</code></pre></div>\n<p>꼭꼭 기억해야할 점으로 <code class=\"language-text\">count</code>와 다르게 map이나 set으로 구성하면 리소스 구분 키값으로 <code class=\"language-text\">server[\"was\"]</code>, <code class=\"language-text\">server[\"web_server\"]</code> 이런식으로 key값이 그대로 유니크 키로 적용 된다는 점이다.</p>\n<p>또한 각 <code class=\"language-text\">resource</code>에는 <code class=\"language-text\">count</code> or <code class=\"language-text\">for_each</code> 둘 중 하나만 사용이 가능하다.</p>\n<h3 id=\"24-provider\" style=\"position:relative;\"><a href=\"#24-provider\" aria-label=\"24 provider permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.4 provider</h3>\n<p>각 <code class=\"language-text\">resource</code>의 <code class=\"language-text\">provider</code>를 명시적으로 지정 해준다. 예를 들어 다른 <code class=\"language-text\">resource</code>는 다 서울 리전을 쓰는데 특정 <code class=\"language-text\">resource</code>만 도쿄 리전을 사용해야한다던가 할때 유용하다(멀티 리전).</p>\n<h3 id=\"25-lifecycle\" style=\"position:relative;\"><a href=\"#25-lifecycle\" aria-label=\"25 lifecycle permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5 lifecycle</h3>\n<p><code class=\"language-text\">resource</code>의 <code class=\"language-text\">lifecycle</code> 관련된 설정 값으로 <code class=\"language-text\">resource</code>가 생성, 변경, 삭제 관련해서 추가로 지정 된 액션을 하도록 설정 할 수 있다.</p>\n<h4 id=\"251-create_before_destroy\" style=\"position:relative;\"><a href=\"#251-create_before_destroy\" aria-label=\"251 create_before_destroy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5.1 create_before_destroy</h4>\n<p>기본적으로 <code class=\"language-text\">terraform</code>은 <code class=\"language-text\">resource</code>를 수정 해야하는데 만약 해당 <code class=\"language-text\">resource</code>가 무중단 업데이트가 불가능하다고 판단되면 삭제 후 다시 생성한다.</p>\n<p>예를 들어 만약 보안관련 리소스(<code class=\"language-text\">security group</code> 같은거)를 수정하다가 해당 <code class=\"language-text\">role</code>이 삭제되는 짧은 순간 보안적으로 문제가 생길 수도 있다. 이런상황을 대비하여 이 옵션을 걸어두면 <code class=\"language-text\">old 조건</code>이 삭제 전 <code class=\"language-text\">new 조건</code>이 추가되니까 특별히 문제가 될 것이 없다</p>\n<ol>\n<li>보안 관련 리소스 생성</li>\n<li>해당 resource에 적용</li>\n<li>이전 보안 관련 리소스 삭제</li>\n</ol>\n<p>이런식으로 안전하게 처리가 가능하다.</p>\n<h4 id=\"252-prevent_destroy\" style=\"position:relative;\"><a href=\"#252-prevent_destroy\" aria-label=\"252 prevent_destroy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5.2 prevent_destroy</h4>\n<p>리소스가 삭제되는 걸 방지한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n\n  lifecycle {\n    prevent_destroy = true\n  }\n}</code></pre></div>\n<p>이런식으로 삭제 방지 옵션을 주고 terraform destroy를 하면</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">╷\n│ Error: Instance cannot be destroyed\n│\n│   on main.tf line 44:\n│   44: resource \"aws_instance\" \"server\" {\n│\n│ Resource aws_instance.server has lifecycle.prevent_destroy set, but the plan calls for this resource to be destroyed. To avoid this error\n│ and continue with the plan, either disable lifecycle.prevent_destroy or reduce the scope of the plan using the -target flag.</code></pre></div>\n<p>만약 충분히 다 인지하고 진짜로 resource를 삭제하고 싶으면 <code class=\"language-text\">prevent_destroy</code>옵션을 주석 처리하고 destroy 하면 된다.</p>\n<h4 id=\"253-ignore_changes\" style=\"position:relative;\"><a href=\"#253-ignore_changes\" aria-label=\"253 ignore_changes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5.3 Ignore_changes</h4>\n<p>최초 apply 시에만 적용하고, 그 이후의 변화는 무시할 때 사용된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n  availability_zone = \"ap-northeast-2a\"\n\n  lifecycle {\n    ignore_changes = [무시할_argument_목록]\n  }\n}</code></pre></div>\n<h3 id=\"26-provisioner\" style=\"position:relative;\"><a href=\"#26-provisioner\" aria-label=\"26 provisioner permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.6 Provisioner</h3>\n<p>해당 리소스에 특정 작업을 수행하기 위해 리소스 로컬 ㄸ는 원격 시스템에서 스크립트를 실행 하고 싶을때 사용된다.</p>\n<h4 id=\"261-local-exec\" style=\"position:relative;\"><a href=\"#261-local-exec\" aria-label=\"261 local exec permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.6.1 local-exec</h4>\n<p>내 로컬에서 실행되는 명령어를 정의한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"server\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n\n  provisioner \"local-exec\" {\n    command = \"hostname\"\n  }\n}</code></pre></div>\n<p>apply하면 아래처럼 표출된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">aws_instance.server: Creating...\naws_instance.server: Still creating... [10s elapsed]\naws_instance.server: Still creating... [20s elapsed]\naws_instance.server: Provisioning with 'local-exec'...\naws_instance.server (local-exec): Executing: [\"/bin/sh\" \"-c\" \"hostname\"]\naws_instance.server (local-exec): 내꺼_개인_컴퓨터_hostname\naws_instance.server: Creation complete after 27s [id=i-0f2157fc11e6ba5a9]</code></pre></div>\n<p>또한 <code class=\"language-text\">when</code> 옵션을 줘서 실행 주기를 바꿀 수가 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">provisioner \"local-exec\" {\n  when    = destroy\n  command = \"echo 'Destroy-time provisioner'\"\n}</code></pre></div>\n<p>이렇게 하면 리소스가 삭제되는 시기에 명령어가 실행된다. 명령어 실행이 실패를 대비한 옵션(<code class=\"language-text\">on_failure</code>) 옵션도 제공해준다.</p>\n<h4 id=\"262-remote-exec\" style=\"position:relative;\"><a href=\"#262-remote-exec\" aria-label=\"262 remote exec permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.6.2 remote-exec</h4>\n<p>해당 리소스에서 직접 실행되는 명령어이다. ec2라면 <code class=\"language-text\">connection</code> 정보를 줘서 ssh로 접근 한 후, 명령어를 실행 시킬 수가 있다.</p>\n<p><strong>주의!</strong></p>\n<blockquote>\n<p>Note: Provisioners should only be used as a last resort. For most common situations there are better alternatives.</p>\n</blockquote>\n<p>왠만하면 쓰지 말라고 한다… <code class=\"language-text\">ec2</code>는 비슷한 역할을 하는 <code class=\"language-text\">user_data</code>라는 옵션도 있으니 필요하면 이 옵션을 사용하면 될 것이다.</p>\n<blockquote>\n<p><a href=\"https://www.terraform.io/language/resources/syntax#meta-arguments\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.terraform.io/language/resources/syntax#meta-arguments</a></p>\n</blockquote>"}},{"node":{"fields":{"slug":"/posts/etc/etc-tf-value_type/","__typename":"MarkdownRemarkFields","categorySlug":"/category/etc/"},"frontmatter":{"template":"post","title":"Terraform - value/type","date":"2022-05-03T05:29:50.878Z","tags":["terraform","iac","provider"],"socialImage":null,"draft":false,"description":"테라폼 입력/출력값 및 type 종류","category":"etc"},"id":"03d3820a-7017-582f-97fe-d8bcdee1e50a","html":"<p>테라폼에서 사용되는 값(입출력 값)들을 기반으로 인프라를 구성 할 수가 있고, 생성 된 리소스를 기반으로 또 다른 리소스를 구성 할 수가 있다.</p>\n<h2 id=\"1-variableinput-value\" style=\"position:relative;\"><a href=\"#1-variableinput-value\" aria-label=\"1 variableinput value permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. variable(input value)</h2>\n<p>입력 값을 기반으로 인프라를 구성하기 위해 사용된다. 즉, 소스 베이스는 그대로 인데 몇가지 값을 입력받아 구성하려고 할때 사용된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">variable \"ec2-ami\" {\n  type        = string\n  description = \"ec2 ami value\"\n  default     = \"ami-014009fa4a1467d53\"\n}\n\nresource \"aws_instance\" \"test-ec2\" {\n  ami           = var.ec2-ami\n  instance_type = \"t2.micro\"\n}</code></pre></div>\n<p><code class=\"language-text\">ec2</code>를 만들기 위한 <code class=\"language-text\">ami</code> 값을 외부에서 받기위해 <code class=\"language-text\">variable</code>로 분리해서 받고 있고, <code class=\"language-text\">var.ec2-ami</code>로 접근해서 입력 된 변수에 접근하고 있다.\n<code class=\"language-text\">variable</code>은 type과 default value를 지정 할 수가 있다. 위 처럼 default value로 처리 할 수도 있지만 외부에서 값을 입력받는 대표적인 방법은 입력값들을 모아놓은 별도의 <code class=\"language-text\">file</code>로 분리하던가, 아님 cli를 통해 값을 입력 받을 수도 있다.</p>\n<h3 id=\"11-cli-명령어를-통한-variable-입력\" style=\"position:relative;\"><a href=\"#11-cli-%EB%AA%85%EB%A0%B9%EC%96%B4%EB%A5%BC-%ED%86%B5%ED%95%9C-variable-%EC%9E%85%EB%A0%A5\" aria-label=\"11 cli 명령어를 통한 variable 입력 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 cli 명령어를 통한 variable 입력</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">variable \"ec2-ami1\" {\n  type = string\n  description = \"ec2 ami value\"\n}\n\nvariable \"ec2-ami2\" {\n  type        = string\n  description = \"ec2 ami value\"\n}\n\nresource \"aws_instance\" \"test-ec2-1\" {\n  ami           = var.ec2-ami1\n  instance_type = \"t2.micro\"\n}\n\nresource \"aws_instance\" \"test-ec2-2\" {\n  ami           = var.ec2-ami2\n  instance_type = \"t2.micro\"\n}</code></pre></div>\n<p>이러한 형태의 resource를 구성 한 후, cli를 통해 아래와 같이 입력하면 지정된 variable값을 입력 할 수가 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">$ terraform plan -var ec2-ami1=&quot;ami-014009fa4a1467d53&quot; -var ec2-ami2=&quot;ami-014009fa4a1467d53&quot;</code></pre></div>\n<h3 id=\"12-파일을-통합-variable-입력\" style=\"position:relative;\"><a href=\"#12-%ED%8C%8C%EC%9D%BC%EC%9D%84-%ED%86%B5%ED%95%A9-variable-%EC%9E%85%EB%A0%A5\" aria-label=\"12 파일을 통합 variable 입력 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 파일을 통합 variable 입력</h3>\n<p><code class=\"language-text\">terraform</code> 파일이 있는 동일한 위치에 <code class=\"language-text\">terraform.tfvars</code> 파일을 위치 시킨후, 명령어를 실행하면 자동으로 해당 파일을 읽어들인다.</p>\n<p>terraform.tfvars</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ec2-ami1 = \"ami-014009fa4a1467d53\"\nec2-ami2 = \"ami-014009fa4a1467d53\"</code></pre></div>\n<p>일반 key-value 형태의 <code class=\"language-text\">json</code> 형태로 관리하기 위해 <code class=\"language-text\">terraform.tfvars.json</code> 파일을 만든 후, 그 안에 json 형태로 관리 할 수도 있지만 이런 json 파일은 주석이 안되서 개인적으로 그냥 파일로 입력하는걸 선호하고 있다. 일반 텍스트 파일이지만 <code class=\"language-text\">variable</code> 구조가 <code class=\"language-text\">map</code> 이어도 정상적으로 입력이 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">test-map = {\n  \"test1\" : \"test2\",\n  \"test3\" : \"test4\"\n}</code></pre></div>\n<p>이런식으로 입력해도 map형태의 <code class=\"language-text\">test-map</code>라는 <code class=\"language-text\">variable</code>을 입력 할 수가 있다.</p>\n<h3 id=\"13-validation\" style=\"position:relative;\"><a href=\"#13-validation\" aria-label=\"13 validation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3 validation</h3>\n<p>입력값 검증이 필요할 때 사용된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">variable \"val_1\" {\n  type        = string\n  description = \"값 테스트1\"\n\n  validation {\n    condition     = length(var.val_1) > 10\n    error_message = \"10자 이상만 가능\"\n  }\n}</code></pre></div>\n<p>위와 같이 구성하고 cli로 <code class=\"language-text\">terraform plan -var val_1=\"테스트값 1\"</code> 를 입력하면 아래와 같이 validation 결과를 볼 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">│ Error: Invalid validation error message\n│\n│   on main.tf line 23, in variable \"val_1\":\n│   23:     error_message = \"10자 이상만 가능\"</code></pre></div>\n<p>validation 하는 방법은 여러가지가 존재하고 그 중엔 정규 식도 가능하다 <code class=\"language-text\">can(regex(정규식_조건, 검사_대상))</code>,</p>\n<h2 id=\"2-output\" style=\"position:relative;\"><a href=\"#2-output\" aria-label=\"2 output permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. output</h2>\n<p>값을 출력 할때 사용된다. 생성 된 <code class=\"language-text\">resource</code>의 <code class=\"language-text\">arn</code>을 확인하기 위해 사용하거나 차후 이 <code class=\"language-text\">output</code> 값을 기반으로 다른 모듈을 구성하기 위해 참조용으로 사용된다.</p>\n<h3 id=\"21-기본-사용법\" style=\"position:relative;\"><a href=\"#21-%EA%B8%B0%EB%B3%B8-%EC%82%AC%EC%9A%A9%EB%B2%95\" aria-label=\"21 기본 사용법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 기본 사용법</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">variable \"test-value\" {\n  type    = string\n  default = \"test-value\"\n}\n\nresource \"aws_instance\" \"tf-ec2\" {\n  ami           = \"ami-014009fa4a1467d53\"\n  instance_type = \"t2.micro\"\n}\n\noutput \"output-map\" {\n\n  value = var.test-value\n}\n\noutput \"created-ec2\" {\n  value = aws_instance.tf-ec2.arn\n}</code></pre></div>\n<p>출력 샘플</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Changes to Outputs:\n  + created-ec2 = (known after apply)\n  + output-map  = \"test-value\"</code></pre></div>\n<p>이런식으로 resource를 생성(위 샘플은 plan)시, arn 값 등을 알 수가 있다.</p>\n<h3 id=\"22-sensitive\" style=\"position:relative;\"><a href=\"#22-sensitive\" aria-label=\"22 sensitive permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 sensitive</h3>\n<p>혹시나 생성 되는 값 노출을 숨겨야하지만 다른곳에서 참조해야 할 경우가 있을때, <code class=\"language-text\">sensitive</code> 값을 줘서 화면에 노출되는 것을 막을 수가 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resource \"aws_instance\" \"tf-ec2\" {\n  ami           = \"ami-014009fa4a1467d53\"\n  instance_type = \"t2.micro\"\n}\n\noutput \"created-ec2\" {\n  value     = aws_instance.tf-ec2.arn\n  sensitive = true\n}</code></pre></div>\n<p>plan 결과</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Changes to Outputs:\n  + created-ec2 = (sensitive value)</code></pre></div>\n<p>이런식으로 값이 숨겨져서 출력된다.</p>\n<h2 id=\"3-locals\" style=\"position:relative;\"><a href=\"#3-locals\" aria-label=\"3 locals permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. locals</h2>\n<p><code class=\"language-text\">locals</code>는 입/출력 용도가 아닌 테라폼을 구성할 때 사용 할 임시 변수용도로 사용된다. 말 그대로 로컬용 변수값 이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">locals {\n  test_1 = \"test1\"\n  test_2 = \"test1\"\n  test_3 = {\n    test_3_1 : \"tesst-3-1\"\n    test_3_2 : \"tesst-3-2\"\n  }\n}\n\noutput \"test_local_1\" {\n  value = local.test_1\n}\n\noutput \"test_local_2\" {\n  value = local.test_2\n}\n\noutput \"test_local_3\" {\n  value = local.test_3\n}</code></pre></div>\n<p>plan 결과</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Changes to Outputs:\n  + test_local_1 = \"test1\"\n  + test_local_2 = \"test1\"\n  + test_local_3 = {\n      + test_3_1 = \"tesst-3-1\"\n      + test_3_2 = \"tesst-3-2\"\n    }</code></pre></div>\n<p>주의 할 점은 <code class=\"language-text\">locals.key</code>가 아니라 <code class=\"language-text\">local.key</code>로 접근 해야 한다는 점이고, 보통 가독성을 위해 한번 거쳐가는 변수로 많이 사용된다</p>\n<blockquote>\n<p>지금은 변수가 단순한 형태로 사용해서 별 필요성을 못느끼지만 값이 점점 복잡해지면 가독성을 위해서라도 많이 쓰게 된다.</p>\n</blockquote>\n<h4 id=\"31-locals를-활용한-공통-tags-샘플\" style=\"position:relative;\"><a href=\"#31-locals%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-%EA%B3%B5%ED%86%B5-tags-%EC%83%98%ED%94%8C\" aria-label=\"31 locals를 활용한 공통 tags 샘플 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 locals를 활용한 공통 tags 샘플</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">locals {\n  common_tags = {\n    type = \"web\"\n    env  = \"dev\"\n  }\n}\n\nresource \"aws_instance\" \"test_ec2\" {\n  ami               = \"ami-014009fa4a1467d53\"\n  instance_type     = \"t2.micro\"\n\n  #tags = local.ec2_common_tags # 이런식으로 직접 대입해서 사용도 가능하다.\n  tags = merge(local.common_tags, {\n    type       = \"worker\"\n    size       = \"small\"\n    department = \"department1\"\n  })\n}</code></pre></div>\n<p>이런식으로도 활용 할 수가 있다. 참고로 merge를 통해 나중에 추가 된 <code class=\"language-text\">type=\"worker\"</code> 가 최종 type이 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">+ tags                                 = {\n    + \"department\" = \"department1\"\n    + \"env\"        = \"dev\"\n    + \"size\"       = \"small\"\n    + \"type\"       = \"worker\"\n  }</code></pre></div>\n<h2 id=\"4-type\" style=\"position:relative;\"><a href=\"#4-type\" aria-label=\"4 type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Type</h2>\n<p>테라폼에선 기본 타입(<code class=\"language-text\">string</code>, <code class=\"language-text\">number</code>, <code class=\"language-text\">bool</code> 등)으로 타입을 지정 할 수도 있지만 <code class=\"language-text\">collection</code> 타입도 사용이 가능하다.</p>\n<ul>\n<li><code class=\"language-text\">list&lt;type></code></li>\n<li><code class=\"language-text\">set&lt;type></code></li>\n<li><code class=\"language-text\">map&lt;type></code></li>\n<li><code class=\"language-text\">object({key = name, ...})</code></li>\n<li><code class=\"language-text\">tuple(type...)</code></li>\n</ul>\n<p>여기서 <code class=\"language-text\">type</code>을 collection을 중첩해서 사용도 가능하다. 위 <code class=\"language-text\">collection</code> 타입들은 다른 언어에서도 많이 쓰이는 직관적인 타입이니까 구지 하나하나 설명하기 보단 그냥 결과 값을 보는게 더 빠를 것이라 생각된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">\nvariable \"list_string\" {\n  type    = list(string)\n  default = [\"list\", \"string\", \"value\"]\n}\n\nvariable \"set_string\" {\n  type    = set(string)\n  default = [\"list\", \"list\", \"string\", \"string\", \"value\"]\n}\n\nvariable \"map_num\" {\n  type = map(number)\n  default = {\n    \"val1\" = 1\n    \"val2\" = 2\n    \"val3\" = 3\n    \"val4\" = 4\n  }\n}\n\nvariable \"object_key_val\" {\n  type = object({\n    type   = string\n    length = number\n    is     = bool\n  })\n  default = {\n    type   = \"type1\"\n    length = 5\n    is     = false\n  }\n}\n\nvariable \"map_object\" {\n  type = map(object({\n    type    = string\n    count   = number\n    private = bool\n  }))\n\n  default = {\n    \"private_ec2\" = {\n      count   = 2\n      private = true\n      type    = \"smal\"\n    }\n    \"public_ec2\" = {\n      count   = 3\n      private = false\n      type    = \"large\"\n    }\n  }\n}\n\nvariable \"tuple_test\" {\n  type = tuple([string, number, bool])\n\n  default = [\"test\", 1, false]\n}\n\noutput \"list_string\" {\n  value = var.list_string\n}\n\noutput \"set_string\" {\n  value = var.set_string\n\n}\n\noutput \"map_num\" {\n  value = var.map_num\n}\n\noutput \"map_num_val1\" {\n  value = var.map_num.val1\n}\n\noutput \"object_key_val\" {\n  value = var.object_key_val\n}\n\noutput \"object_key_val_type\" {\n  value = var.object_key_val.type\n}\n\noutput \"map_object\" {\n  value = var.map_object\n}\n\noutput \"tuple_test\" {\n  value = var.tuple_test\n}\n\noutput \"tuple_first\" {\n  value = var.tuple_test[0]\n}</code></pre></div>\n<p>plan 결과</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Changes to Outputs:\n  + list_string         = [\n      + \"list\",\n      + \"string\",\n      + \"value\",\n    ]\n  + map_num             = {\n      + \"val1\" = 1\n      + \"val2\" = 2\n      + \"val3\" = 3\n      + \"val4\" = 4\n    }\n  + map_num_val1        = 1\n  + map_object          = {\n      + \"private_ec2\" = {\n          + count   = 2\n          + private = true\n          + type    = \"smal\"\n        }\n      + \"public_ec2\"  = {\n          + count   = 3\n          + private = false\n          + type    = \"large\"\n        }\n    }\n  + object_key_val      = {\n      + is     = false\n      + length = 5\n      + type   = \"type1\"\n    }\n  + object_key_val_type = \"type1\"\n  + set_string          = [\n      + \"list\",\n      + \"string\",\n      + \"value\",\n    ]\n  + tuple_first         = \"test\"\n  + tuple_test          = [\n      + \"test\",\n      + 1,\n      + false,\n    ]</code></pre></div>"}},{"node":{"fields":{"slug":"/posts/java/java-boxing/","__typename":"MarkdownRemarkFields","categorySlug":"/category/java/"},"frontmatter":{"template":"post","title":"Boxing, Unboxing & Cache","date":"2022-12-28T10:19:01.562Z","tags":["java"],"socialImage":null,"draft":false,"description":"Wrapper class의 boxing과 unboxing, 과도한 객체 생성을 막기 위한 캐싱 전략","category":"java"},"id":"829e8cb3-66f5-56bf-b1b9-4c47a8238add","html":"<h1 id=\"1-boxing-unboxing\" style=\"position:relative;\"><a href=\"#1-boxing-unboxing\" aria-label=\"1 boxing unboxing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. boxing, unboxing</h1>\n<p>자바를 공부 해본 사람이라면 <code class=\"language-text\">boxing</code>과 <code class=\"language-text\">unboxing</code>은 한번씩 들어 봤을 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">int</span> primitive <span class=\"token operator\">=</span> <span class=\"token number\">42142</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Integer</span> wrapper <span class=\"token operator\">=</span> <span class=\"token number\">1414141</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">boxing</span><span class=\"token punctuation\">(</span>primitive<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">unboxing</span><span class=\"token punctuation\">(</span>wrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">boxing</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Integer</span> boxing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"boxing \"</span> <span class=\"token operator\">+</span> boxing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">unboxing</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> unboxing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unboxing \"</span> <span class=\"token operator\">+</span> unboxing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>기본적으로 <code class=\"language-text\">primitive type</code>을 argument로 넘겨줘도 해당 메소드에서 class 타입(<code class=\"language-text\">wrapper class</code>)으로 받을 수도 있고, 그 반대도 가능하다. 또 서로 변수에 대입도 가능한데 이게 가능한 이유가 다 java에서 자동으로 <code class=\"language-text\">boxing</code>과 <code class=\"language-text\">unboxing</code>을 해주기 때문이다.</p>\n<p>참고로 null값을 <code class=\"language-text\">unboxing</code>하게 되면 에러가 발생하니, 이러한 점은 주의해야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">Integer</span> wrapper <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">unboxing</span><span class=\"token punctuation\">(</span>wrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//NPE가 발생한다.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">unboxing</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> unboxing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unboxing \"</span> <span class=\"token operator\">+</span> unboxing<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">primitive type</code>은 null일 수는 없으니까 <code class=\"language-text\">auto boxing</code>하는 경우엔 적어도 NPE는 발생하지 않는다.</p>\n<h1 id=\"2-wrapper-class-비교\" style=\"position:relative;\"><a href=\"#2-wrapper-class-%EB%B9%84%EA%B5%90\" aria-label=\"2 wrapper class 비교 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Wrapper class 비교</h1>\n<p>위 내용을 설명하려고 포스트를 작성한건 아니고, wrapper class도 결국엔 class의 인스턴스이다. 그 말은 인스턴스의 <code class=\"language-text\">==</code> 비교를 하게 되면 값으로 비교 하는게 아니라 주소값을 비교하는게 기본 원칙인데, 막상 비교 해보면 주소값이 아니라 진짜 ‘값’으로써 비교 하는게 아닐까 의심 될 수도 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">Integer</span> a <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Integer</span> b <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Integer</span> c <span class=\"token operator\">=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"result 1 \"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>a <span class=\"token operator\">==</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"result 2 \"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>a <span class=\"token operator\">==</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//false</span>\n\n    <span class=\"token class-name\">Integer</span> d <span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Integer</span> e <span class=\"token operator\">=</span> <span class=\"token number\">200</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"result 3 \"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>d <span class=\"token operator\">==</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//false</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 코드에서 a,b,c 세 변수만 비교한 결과값을 보면 정말 값으로써 비교 한 것 처럼 보인다. 근데 밑의 d,e 두 개를 비교한 결과를 보면 이번엔 주소값을 비교한 것 처럼 느껴진다.</p>\n<h2 id=\"21-wrapper-class-cache\" style=\"position:relative;\"><a href=\"#21-wrapper-class-cache\" aria-label=\"21 wrapper class cache permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 Wrapper class Cache</h2>\n<p>이러한 결과를 설명 하자면 일단 주소값을 통해 비교하는것은 맞다. 그런데도 a,b,c 변수의 비교 결과가 발생한 이유는 java에서 자주 사용되는 값들은 미리 객체를 생성 해놓고, 그 인스턴스를 반복해서 사용하도록 만들었기 때문이다.</p>\n<p><code class=\"language-text\">Integer</code>도 결국 방식은 똑같은데 이해하기 쉬운 <code class=\"language-text\">Character</code>를 기준으로 설명하자면, <code class=\"language-text\">Character</code> 클래스를 찾아보면 아래와 같은 <code class=\"language-text\">CharacterCache</code> 클래스를 찾을 수 있다.</p>\n<p><strong>Character.java</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CharacterCache</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token class-name\">CharacterCache</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">Character</span> cache<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Character</span><span class=\"token punctuation\">[</span><span class=\"token number\">127</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">static</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> cache<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n                cache<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Character</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">)</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>이런식으로 class가 메모리에 올라갈 때 미리 <code class=\"language-text\">cache</code>라는 변수에 인스턴스를 미리 생성해서 채워넣는다. 그 후, <code class=\"language-text\">Character.valueOf</code> 메소드를 사용하면 먼저 <code class=\"language-text\">cache</code>에 해당 값을 찾고, 존재한다면 해당 객체를 사용하게 된다. 이래서 <code class=\"language-text\">valueOf</code>를 통해 생성 된 객체는 캐시 범위 내에 있다면 매번 똑같은 객체를 사용하게 되니까 주소값 비교를 하게 되어도 동일한 인스턴스를 비교하게 되고, 결과는 <code class=\"language-text\">true</code>일 수 밖에 없다.</p>\n<p><strong>Character.valueOf</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Character</span> <span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span> c<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>c <span class=\"token operator\">&lt;=</span> <span class=\"token number\">127</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// must cache</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">CharacterCache</span><span class=\"token punctuation\">.</span>cache<span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>c<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Character</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>대부분의 <code class=\"language-text\">wrapper class</code>는 자주 사용되는 범위 안에 값들을 이런식으로 미리 생성 해 놓는데 <code class=\"language-text\">Integer</code> 값의 범위는 -128 ~ 127까지 미리 생성 해놓는다. 즉, 이 범위 안에 있는 값들은 자주 사용 되는 값이라 판단되어 사용할때마다 매번 객체를 생성하는게 아니라 캐싱을 통해 재사용되고, 이 범위 밖에 있는 건 매번 진짜 인스턴스를 생성하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Main</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> numberList1 <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">129</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">127</span><span class=\"token punctuation\">,</span> <span class=\"token number\">126</span><span class=\"token punctuation\">,</span> <span class=\"token number\">127</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> numberList2 <span class=\"token operator\">=</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">129</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">128</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">127</span><span class=\"token punctuation\">,</span> <span class=\"token number\">126</span><span class=\"token punctuation\">,</span> <span class=\"token number\">127</span><span class=\"token punctuation\">,</span> <span class=\"token number\">128</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> numberList1<span class=\"token punctuation\">.</span><span class=\"token function\">size</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>\n                    <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%s -> %s\"</span><span class=\"token punctuation\">,</span>\n                            numberList1<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                            numberList1<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> numberList2<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/**\n결과\n-129 -> false\n-128 -> true\n-127 -> true\n126 -> true\n127 -> true\n128 -> false\n**/</span></code></pre></div>\n<p>만약 <code class=\"language-text\">new Integer(xxx)</code>를 통해 생성 된 객체를 비교하면 정말로 매번 객체 생성을 하게 된다. -> <code class=\"language-text\">auto boxing</code>은 <code class=\"language-text\">valueOf</code>메소드를 통해 생성 된다는 것을 간접적으로 알 수 있다.</p>\n<blockquote>\n<p>jvm 옵션을 통해 캐싱 범위를 더 넓힐 수도 있다.</p>\n</blockquote>\n<blockquote>\n<p>코틀린은 <code class=\"language-text\">==</code>은 <code class=\"language-text\">equals</code>를, <code class=\"language-text\">===</code>는 주소값을 비교하니까 헤깔리면 안된다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">fun</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">val</span> data1<span class=\"token operator\">:</span> Int<span class=\"token operator\">?</span> <span class=\"token operator\">=</span> <span class=\"token number\">12345</span>\n    <span class=\"token keyword\">val</span> data2<span class=\"token operator\">:</span> Int <span class=\"token operator\">=</span> <span class=\"token number\">12345</span>\n\n    <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"result </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>data1 <span class=\"token operator\">==</span> data2<span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">//true</span>\n    <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"result </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\"><span class=\"token punctuation\">(</span>data1 <span class=\"token operator\">===</span> data2<span class=\"token punctuation\">)</span></span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//false</span>\n<span class=\"token punctuation\">}</span></code></pre></div>"}},{"node":{"fields":{"slug":"/posts/java/java-enum/","__typename":"MarkdownRemarkFields","categorySlug":"/category/java/"},"frontmatter":{"template":"post","title":"Enum","date":"2016-09-01T23:46:37.121Z","tags":["java","enum"],"socialImage":"/media/image-2.jpg","draft":false,"description":"enum 정의","category":"java"},"id":"90415a83-bd5a-5e36-8505-d8191da6c974","html":"<h1 id=\"enum\" style=\"position:relative;\"><a href=\"#enum\" aria-label=\"enum permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>enum.</h1>\n<h1 id=\"1-enum-\" style=\"position:relative;\"><a href=\"#1-enum-\" aria-label=\"1 enum  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. enum ?</h1>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">타입관리까지 가능한 열거형 상수. 값이라기 보단 클래스에 가깝다.</code></pre></div>\n<h1 id=\"2-장점\" style=\"position:relative;\"><a href=\"#2-%EC%9E%A5%EC%A0%90\" aria-label=\"2 장점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 장점</h1>\n<h3 id=\"21-타입에-안전한-열거형typesafe-enum\" style=\"position:relative;\"><a href=\"#21-%ED%83%80%EC%9E%85%EC%97%90-%EC%95%88%EC%A0%84%ED%95%9C-%EC%97%B4%EA%B1%B0%ED%98%95typesafe-enum\" aria-label=\"21 타입에 안전한 열거형typesafe enum permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 타입에 안전한 열거형(typesafe enum).</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">enumBase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">//Card.Kind.CLOVER == Card.Value.FOUR;  //ERROR 내부적으로 값이 다름. 안전하게 값 비교 가능</span>\n\n    <span class=\"token class-name\">Card<span class=\"token punctuation\">.</span>Kind</span><span class=\"token punctuation\">.</span>CLOVER <span class=\"token operator\">==</span> <span class=\"token class-name\">Card<span class=\"token punctuation\">.</span>Kind</span><span class=\"token punctuation\">.</span>HEART     <span class=\"token comment\">//false</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>만약 상수값을 <code class=\"language-text\">int</code> 형태로 관리한다면 경우에따라 값을 비교 시, 원하지 않는 결과가 반환될 수도 있다.</p>\n<p>하지만 enum을 사용 시, 이러한 부분은 안전하게 비교가 가능하다.</p>\n<h3 id=\"22-각-서드파티에-원하는-형태의-데이터-관리가-편함\" style=\"position:relative;\"><a href=\"#22-%EA%B0%81-%EC%84%9C%EB%93%9C%ED%8C%8C%ED%8B%B0%EC%97%90-%EC%9B%90%ED%95%98%EB%8A%94-%ED%98%95%ED%83%9C%EC%9D%98-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EA%B4%80%EB%A6%AC%EA%B0%80-%ED%8E%B8%ED%95%A8\" aria-label=\"22 각 서드파티에 원하는 형태의 데이터 관리가 편함 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 각 서드파티에 원하는 형태의 데이터 관리가 편함</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">enumStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">Status<span class=\"token punctuation\">.</span>ProcessStatus</span> thirdPartyResult <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">someThirdPartyProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                        <span class=\"token comment\">//구현은 자유!!</span>\n        thirdPartyResult <span class=\"token operator\">=</span> <span class=\"token class-name\">Status<span class=\"token punctuation\">.</span>ProcessStatus</span><span class=\"token punctuation\">.</span>SUCCESS<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RuntimeException</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        thirdPartyResult <span class=\"token operator\">=</span> <span class=\"token class-name\">Status<span class=\"token punctuation\">.</span>ProcessStatus</span><span class=\"token punctuation\">.</span>FAIL<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    각 서드파티에 맞는 데이터 관리가 쉬워진다<span class=\"token punctuation\">.</span>\n    <span class=\"token function\">insertFile</span><span class=\"token punctuation\">(</span>thirdPartyResult<span class=\"token punctuation\">.</span><span class=\"token function\">getNumberStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//파일에는 숫자형태로 기록</span>\n    <span class=\"token function\">insertDB</span><span class=\"token punctuation\">(</span>thirdPartyResult<span class=\"token punctuation\">.</span><span class=\"token function\">getStrStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">//DB에는 문자 형태로 기록</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>처리 결과를 파일, RDB, NoSQL에 각각 저장하고, 저장 되는 정보는 다 다르다고 가정.</p>\n<p>이럴땐 성공 여부와 데이터 정보를 각각 따로 관리를 하게 되서 꽤나 지저분하고 한번에 눈에 안들어 올 가능성이 크다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">enumStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">String</span> SUCCESS <span class=\"token operator\">=</span> <span class=\"token string\">\"SUCCESS\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">String</span> FAIL <span class=\"token operator\">=</span> <span class=\"token string\">\"FAIL\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">String</span> SUCCESS_FILE<span class=\"token operator\">=</span><span class=\"token string\">\"success\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">String</span> FAIL_FILE<span class=\"token operator\">=</span><span class=\"token string\">\"fail\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">int</span> SUCCESS_DB <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> FAIL_DB <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">String</span> thirdPartyResult <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">try</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">someThirdPartyProcess</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                        <span class=\"token comment\">//구현은 자유!!</span>\n        thirdPartyResult <span class=\"token operator\">=</span> SUCCESS<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RuntimeException</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        thirdPartyResult <span class=\"token operator\">=</span> FAIL<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>SUCCESS<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>thirdPartyResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">insertFile</span><span class=\"token punctuation\">(</span>SUCCESS_FILE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">insertDB</span><span class=\"token punctuation\">(</span>SUCCESS_DB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n        <span class=\"token function\">insertFile</span><span class=\"token punctuation\">(</span>FAIL_FILE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">insertDB</span><span class=\"token punctuation\">(</span>SUCCESS_DB<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>대충 이런식이 될 것이다. 이해하는데 큰 문제는 없을 지라도 뭔가 쫌 아쉽게 보인다.</p>\n<p>물론 적당한 디자인 패턴을 적용 할 수도 있겠지만 enum보다 좋은 형태로 적용하기는 쉽지 않을 것이다.</p>\n<h3 id=\"23-를-사용하여-동등-여부-계산이-빠르다\" style=\"position:relative;\"><a href=\"#23-%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EC%97%AC-%EB%8F%99%EB%93%B1-%EC%97%AC%EB%B6%80-%EA%B3%84%EC%82%B0%EC%9D%B4-%EB%B9%A0%EB%A5%B4%EB%8B%A4\" aria-label=\"23 를 사용하여 동등 여부 계산이 빠르다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 <code class=\"language-text\">==</code>를 사용하여 동등 여부 계산이 빠르다.</h3>\n<p>문자열 비교 시, <code class=\"language-text\">equals</code>를 사용 할 것이다. 하지만 enum의 동등 비교는 <code class=\"language-text\">==</code>를 사용 하므로써 더욱 빠르게 연산된다.</p>\n<h1 id=\"3-주요-사용법\" style=\"position:relative;\"><a href=\"#3-%EC%A3%BC%EC%9A%94-%EC%82%AC%EC%9A%A9%EB%B2%95\" aria-label=\"3 주요 사용법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 주요 사용법</h1>\n<h3 id=\"31-기본-사용법\" style=\"position:relative;\"><a href=\"#31-%EA%B8%B0%EB%B3%B8-%EC%82%AC%EC%9A%A9%EB%B2%95\" aria-label=\"31 기본 사용법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 기본 사용법</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">enumBase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">//Card.Kind.CLOVER == Card.Value.FOUR;          //ERROR 내부적으로 값이 다름. 안전하게 값 비교 가능</span>\n\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Card<span class=\"token punctuation\">.</span>Kind</span><span class=\"token punctuation\">.</span>CLOVER <span class=\"token operator\">==</span> <span class=\"token class-name\">Card<span class=\"token punctuation\">.</span>Kind</span><span class=\"token punctuation\">.</span>HEART<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>   <span class=\"token comment\">//equals가 아닌 '=='를 통해 비교하여 빠르게 연산 가능</span>\n\n    <span class=\"token class-name\">Card<span class=\"token punctuation\">.</span>Kind</span> val <span class=\"token operator\">=</span> <span class=\"token class-name\">Card<span class=\"token punctuation\">.</span>Kind</span><span class=\"token punctuation\">.</span><span class=\"token function\">valueOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CLOVER\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//문자열로 선언값 가져올 수 있음</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name : \"</span><span class=\"token operator\">+</span>val<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Card<span class=\"token punctuation\">.</span>Kind</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> cardKinds <span class=\"token operator\">=</span> <span class=\"token class-name\">Card<span class=\"token punctuation\">.</span>Kind</span><span class=\"token punctuation\">.</span><span class=\"token function\">values</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">//선언된 값 배열을 물러옴</span>\n\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CLOVER name : \"</span><span class=\"token operator\">+</span><span class=\"token class-name\">Card<span class=\"token punctuation\">.</span>Kind</span><span class=\"token punctuation\">.</span>CLOVER<span class=\"token punctuation\">.</span><span class=\"token function\">name</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"CLOVER toString : \"</span><span class=\"token operator\">+</span><span class=\"token class-name\">Card<span class=\"token punctuation\">.</span>Kind</span><span class=\"token punctuation\">.</span>CLOVER<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">//toString은 어디서 override 할수 잇어서 사용을 권장안함</span>\n\n    <span class=\"token comment\">//Card.Value.FOUR.val;            //필드는 private, public하게 선언 가능</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<table>\n<thead>\n<tr>\n<th>구분</th>\n<th>method</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>public final</td>\n<td>String name()</td>\n<td>enum 선언 시 똑같은 선언명을 돌려준다.</td>\n</tr>\n<tr>\n<td>public final</td>\n<td>int ordinal()</td>\n<td>0부터 시작하여 선언 된 순서를 반환한다.</td>\n</tr>\n<tr>\n<td>public final</td>\n<td>int compareTo(E o)</td>\n<td>비교 결과를 반환한다. o 보다 작을 시 음수, 같을 시 0, 크면 양수</td>\n</tr>\n<tr>\n<td>public static</td>\n<td>&#x3C;T extends Enum<T>> T valueOf(String name)</td>\n<td>지정된 열거형의 이름(선언명)을 찾아 반환한다.</td>\n</tr>\n<tr>\n<td>public static</td>\n<td>&#x3C;T extends Enum<T>> T[] values</td>\n<td>지정된 열거형 전체를 배열형태로 반환한다.</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"32-추상-메소드-사용-가능\" style=\"position:relative;\"><a href=\"#32-%EC%B6%94%EC%83%81-%EB%A9%94%EC%86%8C%EB%93%9C-%EC%82%AC%EC%9A%A9-%EA%B0%80%EB%8A%A5\" aria-label=\"32 추상 메소드 사용 가능 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 추상 메소드 사용 가능</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">WithAbstract</span><span class=\"token punctuation\">{</span>\n    ADD <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">double</span> <span class=\"token function\">handleData</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> aDouble1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> aDouble2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> aDouble1 <span class=\"token operator\">+</span> aDouble2<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">abstract</span> <span class=\"token keyword\">double</span> <span class=\"token function\">handleData</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span> aDouble1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">double</span> aDouble2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이런식으로 추상 메소드를 선언 시, enum 생성 시에 구현체를 구현 해준다. 또한 functional interface도 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">enum</span> <span class=\"token class-name\">WithLamda</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token function\">ADD</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>aDouble1<span class=\"token punctuation\">,</span> aDouble2<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> aDouble1 <span class=\"token operator\">+</span> aDouble2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">BiFunction</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Double</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">></span></span> expression<span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">WithLamda</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BiFunction</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Double</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">></span></span> expression<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>expression <span class=\"token operator\">=</span> expression<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">double</span> <span class=\"token function\">handleData</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Double</span> aDouble1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Double</span> aDouble2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> expression<span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>aDouble1<span class=\"token punctuation\">,</span> aDouble2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>사실상 똑같은 로직을 추상 클래스가 아닌 생성자 + lambda + functional interface를 사용하여 구현한 것이다.</p>\n<p>이런식으로 사용할 시 장점이 enum을 통해 상태값과 연관된 메소드를 함께 관리 할 수 있다는 점이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleEnumWithLamda</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">double</span> handleResult <span class=\"token operator\">=</span> <span class=\"token class-name\">HandleEnum<span class=\"token punctuation\">.</span>WithLamda</span><span class=\"token punctuation\">.</span>ADD<span class=\"token punctuation\">.</span><span class=\"token function\">handleData</span><span class=\"token punctuation\">(</span><span class=\"token number\">10.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"add result : \"</span><span class=\"token operator\">+</span>handleResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    handleResult <span class=\"token operator\">=</span> <span class=\"token class-name\">HandleEnum<span class=\"token punctuation\">.</span>WithLamda</span><span class=\"token punctuation\">.</span>MINUS<span class=\"token punctuation\">.</span><span class=\"token function\">handleData</span><span class=\"token punctuation\">(</span><span class=\"token number\">10.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"minus result : \"</span><span class=\"token operator\">+</span>handleResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 소스에서 보는바와 같이 상태(ADD, MINUS)에 따른 메소드(더하기 또는 빼기)도 함께 관리 할수가 있다.</p>\n<h1 id=\"4-주의할점\" style=\"position:relative;\"><a href=\"#4-%EC%A3%BC%EC%9D%98%ED%95%A0%EC%A0%90\" aria-label=\"4 주의할점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 주의할점</h1>\n<h4 id=\"41-값을-사용-시-직접-정의된-값-사용-권장\" style=\"position:relative;\"><a href=\"#41-%EA%B0%92%EC%9D%84-%EC%82%AC%EC%9A%A9-%EC%8B%9C-%EC%A7%81%EC%A0%91-%EC%A0%95%EC%9D%98%EB%90%9C-%EA%B0%92-%EC%82%AC%EC%9A%A9-%EA%B6%8C%EC%9E%A5\" aria-label=\"41 값을 사용 시 직접 정의된 값 사용 권장 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 값을 사용 시 직접 정의된 값 사용 권장</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Enum class에 정의된 ordinal()이 열거형 상수가 정의된 순서를 반환하지만, 이 값은\n자바 내부적인 용도로 사용되기 위한 값으로, 열거형 상수의 값으로 사용하지 않는걸 추천</code></pre></div>\n<h4 id=\"42-생성자는-기본적으로-private\" style=\"position:relative;\"><a href=\"#42-%EC%83%9D%EC%84%B1%EC%9E%90%EB%8A%94-%EA%B8%B0%EB%B3%B8%EC%A0%81%EC%9C%BC%EB%A1%9C-private\" aria-label=\"42 생성자는 기본적으로 private permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2 생성자는 기본적으로 private</h4>\n<p>enum의 생성자는 무조건 private하다. 오직 클래스 정의 내에서만 생성이 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">enumBase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">//Card.Kind data = new Card.Kind();     //ERROR!</span>\n\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4 id=\"43-value는-final-권장\" style=\"position:relative;\"><a href=\"#43-value%EB%8A%94-final-%EA%B6%8C%EC%9E%A5\" aria-label=\"43 value는 final 권장 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.3 value는 final 권장</h4>\n<p>열거형의 인스턴스 변수는 반드시 final이어야 한다는 제약은 없지만, value는 열거형 상수의 값을</p>\n<p>저장하기 위한 것이므로 final을 붙이는것을 권장. 따라서 setter와 getter가 큰 의미를 갖지는 않는다.</p>\n<p>(물론 필요하면 쓰는것이 맞음)</p>"}},{"node":{"fields":{"slug":"/posts/java/java-generic/","__typename":"MarkdownRemarkFields","categorySlug":"/category/java/"},"frontmatter":{"template":"post","title":"Generic","date":"2016-12-01T22:40:32.169Z","tags":null,"socialImage":null,"draft":false,"description":"타입의 정확성과 유연함을 갖춰야 할때","category":"java"},"id":"a4ec1e73-b2ad-57fe-8ed4-f4bf9ceeb5d7","html":"<h1 id=\"generics\" style=\"position:relative;\"><a href=\"#generics\" aria-label=\"generics permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Generics.</h1>\n<h1 id=\"1-generics-\" style=\"position:relative;\"><a href=\"#1-generics-\" aria-label=\"1 generics  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Generics ?</h1>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">메소드 또는 collection class에 컴파일 시 타입 체크를 해주는 기능. 컴파일 시 체크하기 때문에\n타입 안정성을 높이고 형변환 번거로움을 줄임.</code></pre></div>\n<h1 id=\"2-장점\" style=\"position:relative;\"><a href=\"#2-%EC%9E%A5%EC%A0%90\" aria-label=\"2 장점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 장점</h1>\n<h3 id=\"21-형변환을-줄이고-안정성을-높임\" style=\"position:relative;\"><a href=\"#21-%ED%98%95%EB%B3%80%ED%99%98%EC%9D%84-%EC%A4%84%EC%9D%B4%EA%B3%A0-%EC%95%88%EC%A0%95%EC%84%B1%EC%9D%84-%EB%86%92%EC%9E%84\" aria-label=\"21 형변환을 줄이고 안정성을 높임 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 형변환을 줄이고, 안정성을 높임</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">safeNunSafe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">SubGenerics</span> unsafeSub <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SubGenerics</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    unsafeSub<span class=\"token punctuation\">.</span><span class=\"token function\">setItem</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unsafe\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">String</span> unSafeitem <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span>unsafeSub<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>    <span class=\"token comment\">// warning. String 이라는 보장이 안됨</span>\n\n    <span class=\"token class-name\">SubGenerics</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> safeSub <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SubGenerics</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">String</span> safeItem <span class=\"token operator\">=</span> safeSub<span class=\"token punctuation\">.</span><span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                <span class=\"token comment\">//String 이라는게 보장이 됨</span>\n\n    <span class=\"token class-name\">SubGenerics</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> safeSub2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SubGenerics</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//컴파일 시, String 라는걸 유추(추론) 가능하여서 생략가능.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이런식으로 가져올떄 형변환을 할 필요가 없다(객체 타입이 보장됨).</p>\n<h3 id=\"22-와일드-카드를-사용함으로써-코드-확장성을-자유롭게-함\" style=\"position:relative;\"><a href=\"#22-%EC%99%80%EC%9D%BC%EB%93%9C-%EC%B9%B4%EB%93%9C%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%A8%EC%9C%BC%EB%A1%9C%EC%8D%A8-%EC%BD%94%EB%93%9C-%ED%99%95%EC%9E%A5%EC%84%B1%EC%9D%84-%EC%9E%90%EC%9C%A0%EB%A1%AD%EA%B2%8C-%ED%95%A8\" aria-label=\"22 와일드 카드를 사용함으로써 코드 확장성을 자유롭게 함 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 와일드 카드를 사용함으로써 코드 확장성을 자유롭게 함</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">'?', 'super', 'extends'를 써서 확장성을 높임\n\n첨부된 소스 코드를 보자(mainInstance.wildCard 실행)</code></pre></div>\n<h3 id=\"23-제너릭-메소드의-사용\" style=\"position:relative;\"><a href=\"#23-%EC%A0%9C%EB%84%88%EB%A6%AD-%EB%A9%94%EC%86%8C%EB%93%9C%EC%9D%98-%EC%82%AC%EC%9A%A9\" aria-label=\"23 제너릭 메소드의 사용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 제너릭 메소드의 사용</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">중복된 소스를 줄이고 제너릭 클래스 여부와 상관없이 사용가능</code></pre></div>\n<h1 id=\"3-주요-사용법\" style=\"position:relative;\"><a href=\"#3-%EC%A3%BC%EC%9A%94-%EC%82%AC%EC%9A%A9%EB%B2%95\" aria-label=\"3 주요 사용법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 주요 사용법</h1>\n<h3 id=\"31-기본-사용법\" style=\"position:relative;\"><a href=\"#31-%EA%B8%B0%EB%B3%B8-%EC%82%AC%EC%9A%A9%EB%B2%95\" aria-label=\"31 기본 사용법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 기본 사용법</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SuperGenerics</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">T</span> item<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">T</span> <span class=\"token function\">getItem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> item<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setItem</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> item<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>item <span class=\"token operator\">=</span> item<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>제너릭을 사용하는 이유는 타입을 자유롭게 받아 처리할 수 있다는 점이다. 기본적으로 클래스 명 옆에 사용할 타입들을</p>\n<p>선언해 놓고(여러개 가능) 그 타입을 맞춰 각 필드, 메소드에서 지정된 타입을 매칭 시켜 사용하면 된다.</p>\n<h3 id=\"32-와일드-카드-확장\" style=\"position:relative;\"><a href=\"#32-%EC%99%80%EC%9D%BC%EB%93%9C-%EC%B9%B4%EB%93%9C-%ED%99%95%EC%9E%A5\" aria-label=\"32 와일드 카드 확장 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 와일드 카드 확장</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleSubWildCard</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">SuperSomeThingClass</span><span class=\"token punctuation\">></span></span> someThingList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//some thing...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleSuperWildCard</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">super</span> <span class=\"token class-name\">SuperSomeThingClass</span><span class=\"token punctuation\">></span></span> someThingList<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//some thing...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>? extends A -> A와 A를 확장한 class만 허용(child class)</p>\n<p>? super A -> A와 A의 super class만 허용</p>\n<p>? -> 아무거나. 사실상 ? extends Object</p>\n<h3 id=\"33-타입-추론이-가능함\" style=\"position:relative;\"><a href=\"#33-%ED%83%80%EC%9E%85-%EC%B6%94%EB%A1%A0%EC%9D%B4-%EA%B0%80%EB%8A%A5%ED%95%A8\" aria-label=\"33 타입 추론이 가능함 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3 타입 추론이 가능함</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token class-name\">SubGenerics</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> safeSub2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SubGenerics</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">SubGenerics</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> safeSub2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">SubGenerics</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위의 두 줄은 서로 같다. 컴파일 시, String 라는걸 유추 가능함(생략 가능). jdk 1.7 이상만 가능</p>\n<h3 id=\"34-제너릭-메소드\" style=\"position:relative;\"><a href=\"#34-%EC%A0%9C%EB%84%88%EB%A6%AD-%EB%A9%94%EC%86%8C%EB%93%9C\" aria-label=\"34 제너릭 메소드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.4 제너릭 메소드</h3>\n<h4 id=\"341-제너릭-클래스와-상관없이-독립적으로-사용가능\" style=\"position:relative;\"><a href=\"#341-%EC%A0%9C%EB%84%88%EB%A6%AD-%ED%81%B4%EB%9E%98%EC%8A%A4%EC%99%80-%EC%83%81%EA%B4%80%EC%97%86%EC%9D%B4-%EB%8F%85%EB%A6%BD%EC%A0%81%EC%9C%BC%EB%A1%9C-%EC%82%AC%EC%9A%A9%EA%B0%80%EB%8A%A5\" aria-label=\"341 제너릭 클래스와 상관없이 독립적으로 사용가능 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.4.1 제너릭 클래스와 상관없이 독립적으로 사용가능</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">SubSomeThingClass</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isEquals1</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> s1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">T</span> s2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">int</span> s1Code <span class=\"token operator\">=</span> s1<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> s2Code <span class=\"token operator\">=</span> s2<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> s1Code <span class=\"token operator\">==</span> s2Code<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 isEquals1 메소드는 제너릭 클래스에서 사용한 메소드도 아니지만 T를 사용이 가능하다. 이는 제너릭 메소드를 선언하여 사용하기에 가능.</p>\n<p>추가로 제너릭을 사용 시, 원래는 static하게 만들 수 없지만 제너릭 메소드는 완전 독립적으로 사용이 가능하며, 제너릭 클래스에서 사용한다</p>\n<p>하더라도 위에서 T는 클래스에서 선언한 T와 별개의 타입이 된다.</p>\n<h4 id=\"342-중복된-소스를-줄여줌\" style=\"position:relative;\"><a href=\"#342-%EC%A4%91%EB%B3%B5%EB%90%9C-%EC%86%8C%EC%8A%A4%EB%A5%BC-%EC%A4%84%EC%97%AC%EC%A4%8C\" aria-label=\"342 중복된 소스를 줄여줌 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.4.2 중복된 소스를 줄여줌</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">SubSomeThingClass</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isEquals2</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SubGenerics</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> s1<span class=\"token punctuation\">,</span> <span class=\"token class-name\">SubGenerics</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> s2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">int</span> s1Code <span class=\"token operator\">=</span> s1<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> s2Code <span class=\"token operator\">=</span> s2<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> s1Code <span class=\"token operator\">==</span> s2Code<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">isEquals3</span><span class=\"token punctuation\">(</span>\n        <span class=\"token class-name\">SubGenerics</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">SubSomeThingClass</span><span class=\"token punctuation\">></span></span> s1\n        <span class=\"token punctuation\">,</span> <span class=\"token class-name\">SubGenerics</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">SubSomeThingClass</span><span class=\"token punctuation\">></span></span> s2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">int</span> s1Code <span class=\"token operator\">=</span> s1<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">int</span> s2Code <span class=\"token operator\">=</span> s2<span class=\"token punctuation\">.</span><span class=\"token function\">hashCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> s1Code <span class=\"token operator\">==</span> s2Code<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 두 소스는 같은 역할을 한다. 차이점은 매개변수 타입을 제너릭 메소드로 선언해서 한곳에서 관리하느냐(위에꺼)</p>\n<p>매개변수 타입을 매개변수를 나열할 때 쓰느냐(밑에 소스) 차이점이 된다.</p>\n<h3 id=\"35-중첩된-제한-가능\" style=\"position:relative;\"><a href=\"#35-%EC%A4%91%EC%B2%A9%EB%90%9C-%EC%A0%9C%ED%95%9C-%EA%B0%80%EB%8A%A5\" aria-label=\"35 중첩된 제한 가능 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.5 중첩된 제한 가능</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Enum</span> <span class=\"token operator\">&amp;</span> <span class=\"token class-name\">DummyForEnum</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">void</span> <span class=\"token function\">multipleGenerics</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> enumClass<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    enumClass<span class=\"token punctuation\">.</span><span class=\"token function\">testMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">multipleGenerics</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">EnumExtend</span><span class=\"token punctuation\">.</span>DUMMY_ENUM<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//제너릭 제한</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 소스에서 보는 바와 같이 제너릭 타입 제한을 <code class=\"language-text\">&amp;</code> 통해 중첩된 제한이 가능하다. 위 소스는 제너릭 타입 <code class=\"language-text\">T</code>의</p>\n<p>제한을 <code class=\"language-text\">Enum</code>, interface <code class=\"language-text\">DummyForEnum</code>를 확장한 형태만 받을 수 있게 제한하고 있다.</p>\n<h1 id=\"4-주의할점\" style=\"position:relative;\"><a href=\"#4-%EC%A3%BC%EC%9D%98%ED%95%A0%EC%A0%90\" aria-label=\"4 주의할점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 주의할점</h1>\n<h4 id=\"41-extends-super-사용-시-주의-점\" style=\"position:relative;\"><a href=\"#41-extends-super-%EC%82%AC%EC%9A%A9-%EC%8B%9C-%EC%A3%BC%EC%9D%98-%EC%A0%90\" aria-label=\"41 extends super 사용 시 주의 점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 extends, super 사용 시 주의 점</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">SuperSomeThingClass</span><span class=\"token punctuation\">></span></span> list <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    list<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">SuperSomeThingClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">//ERROR!</span></code></pre></div>\n<p>참고 사항으로 이런 방식으로는 안된다. 될꺼 같지만 list에 각 아이템 요소가 무엇으로 처리해야 할지 보장이 안된다.</p>\n<p>쫌더 자세히 설명하면 만약 저게 가능하다고 가정하면</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">SuperSomeThingClass</span><span class=\"token punctuation\">></span></span> list <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    list<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">SuperSomeThingClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    list<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">SubSomeThingClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span> someThing<span class=\"token operator\">=</span> list<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이런식으로 someThing의 클래스가 어떤것인지 몰라서 내부적으로 문제가 발생한다고 한다. 클래스의 안정성을 위해서라도 이런방식은 막아두었다고 한다.</p>\n<p>참고 <a href=\"https://stackoverflow.com/questions/24861758/difference-for-super-extends-string-in-method-and-variable-declaration?utm_medium=organic&#x26;utm_source=google_rich_qa&#x26;utm_campaign=google_rich_qa\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://stackoverflow.com/questions/24861758/difference-for-super-extends-string-in-method-and-variable-declaration?utm_medium=organic&#x26;utm_source=google_rich_qa&#x26;utm_campaign=google_rich_qa</a></p>\n<h4 id=\"42-exception을-확장한-클래스에서는-사용-불가\" style=\"position:relative;\"><a href=\"#42-exception%EC%9D%84-%ED%99%95%EC%9E%A5%ED%95%9C-%ED%81%B4%EB%9E%98%EC%8A%A4%EC%97%90%EC%84%9C%EB%8A%94-%EC%82%AC%EC%9A%A9-%EB%B6%88%EA%B0%80\" aria-label=\"42 exception을 확장한 클래스에서는 사용 불가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2 Exception을 확장한 클래스에서는 사용 불가</h4>\n<p>Exception(정확히 Throwable)을 확장한 클래스에서는 사용이 불가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token comment\">//ERROR! Generic class may not extend 'java.lang.Throwable'</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">BusinessException</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>제너릭을 설명하면서 빠뜨린 부분이 있는데, 제너릭을 사용하더라도 내부적으로 컴파일 되면서</p>\n<p>동적으로 제너릭 부분을 없애준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> list <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// after compile ==> List list = new ArrayList&lt;>();</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>꼭 이렇게 바꾸는게 아니라 제너릭 타입만 없애준다는 사실만 기억 하고, 자세한건 아래 링크 참고!</p>\n<p>참고 : <a href=\"https://stackoverflow.com/questions/19253174/are-generics-removed-by-the-compiler-at-compile-time\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://stackoverflow.com/questions/19253174/are-generics-removed-by-the-compiler-at-compile-time</a></p>\n<p>컴파일 과정중에서 제너릭 타입이 제거되면서, exception catch 과정 중에 문제가 발생하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n           <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BusinessException</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">BusinessException</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n           <span class=\"token comment\">//handle exception ...</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">BusinessException</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n           <span class=\"token comment\">//handle exception ...</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>위와 같은 소스가 아래와 같이 변한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n           <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BusinessException</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">BusinessException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n           <span class=\"token comment\">// ???</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">BusinessException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n           <span class=\"token comment\">// ???</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>제너릭이 제거되면서 exception이 어디서 catch 하는지 알 수 없게 되어 막아놓았다고 한다.</p>\n<p>참고 : <a href=\"https://stackoverflow.com/questions/501277/why-doesnt-java-allow-generic-subclasses-of-throwable\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://stackoverflow.com/questions/501277/why-doesnt-java-allow-generic-subclasses-of-throwable</a></p>"}},{"node":{"fields":{"slug":"/posts/java/java-jvm/","__typename":"MarkdownRemarkFields","categorySlug":"/category/java/"},"frontmatter":{"template":"post","title":"JVM Heap 구조 및 GC","date":"2022-02-03T09:47:11.834Z","tags":["jvm","java","heap","GC"],"socialImage":null,"draft":false,"description":"JVM에서 Heap & Metaspace, GC(Garbage Collector) 이해와 종류","category":"java"},"id":"44eb98ae-ad52-5375-b691-029a9fc41c4b","html":"<p>개발 하면서 메모리 구조를 알면 좋을 때가 종종 있다. 개인적으로 일하면서 서버가 터져 버렸을 때(…) 어디서 어떻게 터진지 알아야 빠르게 원인 및 대처가 가능한데 이러한 구조를 몰랐을 땐 <code class=\"language-text\">Heap</code>이 왜 터지는지, <code class=\"language-text\">Metaspace</code>는 또 뭔지 당황했었던 기억이 있다. 물론 알아도 당황스럽긴 하지만 빠른 원인 파악에 도움되고 추가로 이러한 것도 알야야 메모리 튜닝이 가능하니까 한번쯤 공부해보고 추가로 GC가 무엇인지, 자바 버전별 어떤 GC를 쓰고 있는지 아는게 꽤 도움이 되는거 같다(운영중인 서비스의 java 버전업 동기부여로 좋은거 같다)</p>\n<h1 id=\"1-jvm-메모리-구조\" style=\"position:relative;\"><a href=\"#1-jvm-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EA%B5%AC%EC%A1%B0\" aria-label=\"1 jvm 메모리 구조 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. JVM 메모리 구조</h1>\n<p><img src=\"/blog/media/java/jvm_memory.png\" alt=\"img1\"></p>\n<blockquote>\n<p>이미지 참조 <a href=\"https://deepu.tech/memory-management-in-jvm/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://deepu.tech/memory-management-in-jvm/</a></p>\n</blockquote>\n<p>JVM 메모리 구조는 위의 이미지로 생각하면 된다.</p>\n<h2 id=\"heap-memory\" style=\"position:relative;\"><a href=\"#heap-memory\" aria-label=\"heap memory permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Heap Memory</h2>\n<p>객체 인스턴스 등이 생성되면 저장되는 공간이다. <code class=\"language-text\">java8</code> 이후 부턴 <code class=\"language-text\">static object</code>도 Heap에 저장되기 시작했다.</p>\n<blockquote>\n<p>사실 난 개발을 java8부터 써서 직접 겪은적은 없는데 그 이하 버전에선 class의 static 변수값도 <code class=\"language-text\">method area(PermGen)</code>에 저장되어서 문제가 많았었다고 한다.</p>\n</blockquote>\n<h2 id=\"metaspace\" style=\"position:relative;\"><a href=\"#metaspace\" aria-label=\"metaspace permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Metaspace</h2>\n<p><code class=\"language-text\">java8</code> 이후부터 생겨났고, 이름 그대로 class의 메타데이터 (메소드 정보 포함) 등이 저장되는 공간이다. heap과 별개로 <code class=\"language-text\">native memory</code>에서 관리되며, 별다른 설정값을 안넣으면 최대 메모리 용량 만큼이나 늘어날 수가 있다.</p>\n<h2 id=\"thread-stack\" style=\"position:relative;\"><a href=\"#thread-stack\" aria-label=\"thread stack permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Thread Stack</h2>\n<p>각 메소드 등을 실행&#x26;결과 값과 지역변수 등이 저장된다. 이 영역은 스레드 마다 하나씩 생성되는데, 위의 <code class=\"language-text\">Heap &amp; Metaspace</code>의 정보를 가져와 사용하기도 한다.</p>\n<p>중요한 특징들을 다시한번 나열하면</p>\n<ol>\n<li>stack은 스레드 당 하나씩 할당(생성) 된다</li>\n<li>객체(reference 타입)은 heap에 저장되고 그 연결 정보(변수)를 stack에 저장한다.</li>\n<li>생성된 객체는 heap에 저장되고 여러 스레드에서 공유하는 형태로 관리된다.</li>\n<li>primitive type(원시타입)은 그냥 값으로써 stack에 저장된다.</li>\n</ol>\n<p>아래 링크는 코드에 따라 heap, stack에 순차적으로 쌓이는 구조를 확인 할 수 있다.</p>\n<blockquote>\n<p><a href=\"https://speakerdeck.com/deepu105/jvm-memory-usage-stack-vs-heap\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://speakerdeck.com/deepu105/jvm-memory-usage-stack-vs-heap</a></p>\n</blockquote>\n<h2 id=\"code-cache\" style=\"position:relative;\"><a href=\"#code-cache\" aria-label=\"code cache permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code cache</h2>\n<p><code class=\"language-text\">JVM</code>이 네이티브 코드로 컴파일 된 바이트 코드를 저장하는 영역이다. <code class=\"language-text\">JIT</code> 컴파일러가 가장 많이 사용한다(자주 사용되는 컴파일 된 코드를 저장한다).</p>\n<h2 id=\"shared-library\" style=\"position:relative;\"><a href=\"#shared-library\" aria-label=\"shared library permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Shared Library</h2>\n<p>어플리케이션에서 사용할 공유 라이브러리들(with jni)</p>\n<h1 id=\"2-garbage-collector\" style=\"position:relative;\"><a href=\"#2-garbage-collector\" aria-label=\"2 garbage collector permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Garbage Collector</h1>\n<p>먼저 <code class=\"language-text\">Garbage Collector</code>(줄여서 GC)란 메모리에서 더 이상 접근 할 일이 없는 객체(<code class=\"language-text\">unreachable</code>)를 찾은 후, 이전 객체를 없애버리는 작업을 말한다. 이 과정을 순서대로 나열하면 아래와 같다.</p>\n<ol>\n<li>GC Roots에 의해 접근 할 수도 있는(<code class=\"language-text\">reachable</code>) 객체/접근 할 수 없는(<code class=\"language-text\">unreachable</code>) 객체를 구분한다.</li>\n<li>더 이상 접근 할 수 없는 객체를 수거한다(메모리 상에서 없애버린다)</li>\n<li>GC에 따라 <code class=\"language-text\">Compaction</code> 과정. 메모리 파편화&#x26;관리 때문에 object 위치를 이동 시킨다(새로운 메모리 할당이 쉽고 빠르게 가능하다).</li>\n</ol>\n<p>gc 알고리즘에 따라 차이는 있지만 기본적으로 이러한 방식으로 이루어 진다. 여기서 gc가 작동하면서 gc 과정 중 부분적(선택 된 알고리즘에 따라 다르다)으로 <code class=\"language-text\">Applicatin</code> 전체가 순간적으로 멈춰지게 되는데 이러한 현상을 <code class=\"language-text\">Stop the world</code>라고 말한다(줄여서 <code class=\"language-text\">stw</code>라고도 한다). 역시 gc 동작 방식(gc 알고리즘)에 따라 이런 <code class=\"language-text\">stw</code> 차이가 나고, 장단점이 있지만 대체로 java 버전업 하면서 더욱 성능 좋은 gc가 붙지만, 이거 또한 필수는 아니며 이런 <code class=\"language-text\">stw</code> 시간을 최소화하고 gc로 인한 오버헤드를 줄이는걸 <code class=\"language-text\">GC 튜닝</code>이라고 한다(=java 개발자의 관리 포인트이다…)</p>\n<h2 id=\"minor-gc--major-gc\" style=\"position:relative;\"><a href=\"#minor-gc--major-gc\" aria-label=\"minor gc  major gc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Minor GC &#x26; Major GC</h2>\n<p>위에서 설명한 GC 과정은 정말 간단하게 설명한거고 실질적으로 튜닝을 위해서라면 더욱 많은 지식이 필요하다. 그 중 <code class=\"language-text\">GC</code>도 종류가 있는데(알고리즘 or 방법이 아니라 분류 정도라고 이해 해야한다) <code class=\"language-text\">Young generation</code>에서 발생하는 GC를 <code class=\"language-text\">Minor GC</code>, <code class=\"language-text\">Old generation</code>에서 발생하는 GC는 <code class=\"language-text\">Major GC</code>라고 한다. 둘다 돌리는건 <code class=\"language-text\">Full GC</code>라고 한다.</p>\n<p>참고로 객체가 생성되면 <code class=\"language-text\">Young generation</code>에 배치되고 gc 이후로도 계속해서 살아남는 objects들은 <code class=\"language-text\">Old generation</code>으로 이동하게 된다.</p>\n<h3 id=\"minor-gc\" style=\"position:relative;\"><a href=\"#minor-gc\" aria-label=\"minor gc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Minor GC</h3>\n<p>위에서 <code class=\"language-text\">Young generation</code>을 대상으로 하는 gc라고 하였다 이런 식으로 구분하는 이유는 새롭게 생긴 객체는 빠르게 <code class=\"language-text\">unreachable</code>하게 바뀔 확률이 높다. 이런 <code class=\"language-text\">unreachable</code>한 객체들이 많아서 매우 빠르게 수집이 가능하다고 한다</p>\n<blockquote>\n<p>A young generation full of dead objects is collected very quickly (<a href=\"https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/gc01/index.html</a>)</p>\n</blockquote>\n<p>참고 사항으로 객체가 새롭게 생성되면 <code class=\"language-text\">Eden</code>에 배치되고, <code class=\"language-text\">Eden</code>이 꽉차면 <code class=\"language-text\">Minor GC</code>가 발생하면서 <code class=\"language-text\">Eden</code>에 있는 객체는 <code class=\"language-text\">S0</code>으로 이동하고(죽은 객체 빼고) <code class=\"language-text\">Eden</code>은 clear 된다(메모리 파편화에도 용이하다) 이런식으로 <code class=\"language-text\">Eden</code> -> <code class=\"language-text\">S0</code> &#x3C;-> <code class=\"language-text\">S1</code> (<code class=\"language-text\">Survivor</code>은 서로 왔다갔다 하기도 한다.) 옮겨지면서 이전 공간은 clear되고, 옮겨지는 객체는 age값이 증가하고 이 값이 계속 올라가다 일정 수준으로 올라가면 <code class=\"language-text\">Old generation</code>으로 옮겨지게 된다.</p>\n<h3 id=\"major-gc\" style=\"position:relative;\"><a href=\"#major-gc\" aria-label=\"major gc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Major GC</h3>\n<p><code class=\"language-text\">Major GC</code>관련해선 필요한 내용은 다 설명 했고, 과정도 딱히 뭐 특별한건 없다. 발동 조건은 <code class=\"language-text\">Old generation</code> 영역이 지정된 메모리 이상 차이하거나 꽉차면 실행된다.</p>\n<p>참고로 <code class=\"language-text\">Major or Full GC</code>는 수행 시간이 길고, 그에따라 <code class=\"language-text\">stw</code>도 길어져서 어플리케이션에 영향을 줄 수도 있는데 <code class=\"language-text\">GC</code> 빈도수를 줄이려면 <code class=\"language-text\">Old generation</code> 크기를 늘리고, <code class=\"language-text\">GC</code> 수행 시간을 줄이려면 <code class=\"language-text\">Old generation</code> 크기를 줄여야 한다. 적당히 타협점을 찾던가 아님 서버 <code class=\"language-text\">scale down</code>을 고려해야 한다(그냥 gc가 발생해도 물리적으로 서버 부담을 줄이자는거).</p>\n<h1 id=\"3-gc-알고리즘-종류\" style=\"position:relative;\"><a href=\"#3-gc-%EC%95%8C%EA%B3%A0%EB%A6%AC%EC%A6%98-%EC%A2%85%EB%A5%98\" aria-label=\"3 gc 알고리즘 종류 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. GC 알고리즘 종류</h1>\n<h3 id=\"serial-gc\" style=\"position:relative;\"><a href=\"#serial-gc\" aria-label=\"serial gc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Serial GC</h3>\n<p><code class=\"language-text\">Mark Sweep Compact</code> 알고리즘을 쓰고 <code class=\"language-text\">Minor GC</code>, <code class=\"language-text\">Major GC</code> 순으로(연속적으로) 실행된다. 이름부터가 serial이다.</p>\n<p>그냥 쓸일이 없는 GC. 싱글코어에선 써도 괜찮다고 한다. java 5,6 기본 GC</p>\n<h3 id=\"parallel-oldgc\" style=\"position:relative;\"><a href=\"#parallel-oldgc\" aria-label=\"parallel oldgc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Parallel (Old)GC</h3>\n<p><code class=\"language-text\">parallel GC</code>랑 <code class=\"language-text\">parallel Old GC</code>는 다르지만 그냥 묶어서 설명. <code class=\"language-text\">Yong/Old generation</code>을 병렬로 처리한다. 만약 싱글코어 환경이라면 의미가 없어지고, 기본 GC의 스레드 개수는 cpu 개수만큼 지정 된다(설정값으로 변경 할 수가 있다.)</p>\n<p>java 7,8 기본 GC</p>\n<h3 id=\"concurrent-mark-sweep-collector-cms-gc\" style=\"position:relative;\"><a href=\"#concurrent-mark-sweep-collector-cms-gc\" aria-label=\"concurrent mark sweep collector cms gc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Concurrent Mark-Sweep Collector (CMS GC)</h3>\n<p><code class=\"language-text\">stw</code> 시간이 위에서 설명한 gc보다 짧다. 특이한 점은 <code class=\"language-text\">Compaction</code> 과정((메모리가 중간중간 빈 공간을 없애기 위해 object를 옮기는 작업))이 없다는건데 다른 GC에선 이 작업에 많은 시간이 소모 되는데 <code class=\"language-text\">CMS GC</code>에선 <code class=\"language-text\">Compaction</code> 작업이 없어 GC 과정이 빠른것도 있다. 하지만 메모리 파편화가 심해지면 <code class=\"language-text\">Full GC</code>가 발생 할수도 있다. <code class=\"language-text\">Parallel GC</code> 대비 메모리&#x26;CPU 리소스도 더 많이 사용된다.</p>\n<h3 id=\"garbage-first-gc-g1-gc\" style=\"position:relative;\"><a href=\"#garbage-first-gc-g1-gc\" aria-label=\"garbage first gc g1 gc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Garbage First GC (G1 GC)</h3>\n<p>Heap 영역을 여러개의 region으로 나누고 각 region을 <code class=\"language-text\">yong(eden, survivor)</code>, <code class=\"language-text\">old</code>를 동적으로 부여하여 사용하는 방식이다. GC 시간이 짧다는 장점이 있다.\n<img src=\"/blog/media/java/g1_gc.png\" alt=\"img2\"></p>\n<p>GC과정은 먼저 살아있는 객체를 마킹하고 죽은 객체가 많은 영역부터 먼저 수집을 시작한다. 이런 우선순위로 계산되서 <code class=\"language-text\">Garbage First</code> 라고 한다.</p>\n<blockquote>\n<p>After the mark phase completes, G1 knows which regions are mostly empty. It collects in these regions first, which usually yields a large amount of free space. This is why this method of garbage collection is called Garbage-First (<a href=\"https://www.oracle.com/technetwork/tutorials/tutorials-1876574.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.oracle.com/technetwork/tutorials/tutorials-1876574.html</a>)</p>\n</blockquote>\n<p>java 9부터 기본 GC</p>\n<h3 id=\"zgc\" style=\"position:relative;\"><a href=\"#zgc\" aria-label=\"zgc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ZGC</h3>\n<p>Heap 용량에 상관없이 GC 수행 시간이 10ms 이하로 처리된다. 모든 객체의 포인터에 64bit를 사용하는데 이 중 4bit를 mark(<code class=\"language-text\">Colored pointers</code>)를 위해 사용되며 재배치 여부, 참조 여부를 알 수 있다. 그렇기 때문에 64bit 운영체제에서만 사용 가능하고 재배치 과정에서 <code class=\"language-text\">stw</code>가 발생하지 않는게 큰 장점이다.</p>\n<p>java 15부터 정식으로 사용할 수 있지만(이전버전들은 실험적 ZGC이다) default GC는 바뀌지 않았다(G1 그대로)</p>"}},{"node":{"fields":{"slug":"/posts/java/java-lambda/","__typename":"MarkdownRemarkFields","categorySlug":"/category/java/"},"frontmatter":{"template":"post","title":"Lambda","date":"2016-02-02T22:40:32.169Z","tags":["lambda","java","functional","function"],"socialImage":null,"draft":false,"description":"중요한 로직만 작성하여 가독성을 높이고 functional interface에 적합하게 사용하고 싶을때","category":"java"},"id":"045c19f4-e858-5a6f-87ef-2a01d56ce05d","html":"<h1 id=\"lambda\" style=\"position:relative;\"><a href=\"#lambda\" aria-label=\"lambda permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lambda.</h1>\n<h1 id=\"1-장점\" style=\"position:relative;\"><a href=\"#1-%EC%9E%A5%EC%A0%90\" aria-label=\"1 장점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 장점</h1>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">간단하다! 그래서 알아보기가 쉽고 마치 자바에 없는 함수를 사용하는 느낌을 받는다.</code></pre></div>\n<h1 id=\"2-lambda-기본-사용법\" style=\"position:relative;\"><a href=\"#2-lambda-%EA%B8%B0%EB%B3%B8-%EC%82%AC%EC%9A%A9%EB%B2%95\" aria-label=\"2 lambda 기본 사용법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Lambda 기본 사용법</h1>\n<h3 id=\"21-메소드-표현식을--형태로-사용함\" style=\"position:relative;\"><a href=\"#21-%EB%A9%94%EC%86%8C%EB%93%9C-%ED%91%9C%ED%98%84%EC%8B%9D%EC%9D%84--%ED%98%95%ED%83%9C%EB%A1%9C-%EC%82%AC%EC%9A%A9%ED%95%A8\" aria-label=\"21 메소드 표현식을  형태로 사용함 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 메소드 표현식을 ()=>{} 형태로 사용함</h3>\n<h3 id=\"22-functional-interface\" style=\"position:relative;\"><a href=\"#22-functional-interface\" aria-label=\"22 functional interface permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 Functional Interface</h3>\n<h4 id=\"221-기본-사용법\" style=\"position:relative;\"><a href=\"#221-%EA%B8%B0%EB%B3%B8-%EC%82%AC%EC%9A%A9%EB%B2%95\" aria-label=\"221 기본 사용법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2.1 기본 사용법</h4>\n<p>java에선 기본적으로 함수 개념이 없다. 하지만 함수를 주고 받아야 하기 때문에 조금 편법을 사용한다.</p>\n<p>interface에 하나의 메소드만 선언 해 놓고, 이 메소드의 구현하여 interface를 주고 받는 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">LambdaInterface</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">doSomeThing</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">likeCallback</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LambdaInterface</span> cb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 함수를 넘겨 받아 원하는 시점에 호출할수 있다</span>\n    cb<span class=\"token punctuation\">.</span><span class=\"token function\">doSomeThing</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token function\">likeCallback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//TODO : .....</span>\n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위와 같이 interface에 단 하나의 메소드만 선언하고(<code class=\"language-text\">LambdaInterface</code>의 <code class=\"language-text\">doSomeThing</code>) 사용 시,</p>\n<p>그 메소드 부분만 정의 하고 사용 하는 쪽에서는 해당 인터페이스로 받아 그냥 사용하는 방식이다. 다른 부분은</p>\n<p>그렇다 치더라도, 위의 <code class=\"language-text\">LambdaInterface</code>는 진짜 별 의미 없는 인터페이스가 된다.</p>\n<p>무조건 하나의 메소드만 강제해야 되고, 가장 큰 문제점은 확장성이다.</p>\n<p>위의 <code class=\"language-text\">doSomeThing</code>은 반환값이 없고, 매개변수가 없다. 하지만 매개변수가 있고 반환값이 있다면?</p>\n<p>또 새로운 의미없는 인터페이스를 작성하는 방식이다. java 1.8이상부터 이렇게 별 의미없고</p>\n<p>(어디까지나 모든 소스에서 쓸수도 있는 인터페이스 라는 점에서 의미가 없다는 것이다.)</p>\n<p>경우에 따라 많이 선언해 놓아야 하는 이런 인터페이스를 미리 선수 쳐서 선언만 해놓았다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@FunctionalInterface</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">Function</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">R</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token class-name\">R</span> <span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 <code class=\"language-text\">interface</code>는 이러한 조건을 만족하려고 1.8버전 이상부터 미리 만들어 놓은 인터페이스 이다.</p>\n<p>제너릭을 이용하여 타입을 선언 해놓았고(T -> argument type, R -> result type) 단 하나의 메소드(apply)만 존재한다.</p>\n<p>이렇게 단 하나의 메소드만 선언 해 놓고 사용시 그 메소드만 사용 목적인 인터페이스를 컴파일에서 강제하기 위하여,</p>\n<p><code class=\"language-text\">@FuntionalInterface</code>를 선언해 놓는다. 이 어노테이션을 적어 놓으면 2개 이상의 메소드는 선언이 불가능하다.</p>\n<p>아래 표는 자바에서 제공하는 함수형 인터페이스를 표로 나타냈다(전부 다는 아니고 일부만)</p>\n<table>\n<thead>\n<tr>\n<th>Interface</th>\n<th>Method</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Function&#x3C;T, R></td>\n<td>R apply(T t);</td>\n</tr>\n<tr>\n<td>Predicate&#x3C;T></td>\n<td>boolean test(T t);</td>\n</tr>\n<tr>\n<td>Consumer&#x3C;T></td>\n<td>void accept(T t);</td>\n</tr>\n<tr>\n<td>Supplier&#x3C;T></td>\n<td>T get();</td>\n</tr>\n<tr>\n<td>Runnable</td>\n<td>void run();</td>\n</tr>\n</tbody>\n</table>\n<p>T는 type(매개변수 타입), R은 Return Type을 나타내므로, 용도는 꽤나 직관적으로 알 수 있다.</p>\n<p>또한 표에는 없지만 매개변수가 2개인 함수형 인터페이스는 위 인터페이스 명 앞에 Bi가 붙는다(<code class=\"language-text\">BiFunction&lt;T,U,R></code>).</p>\n<p><code class=\"language-text\">Runnable</code> 만 java.lang 패키지에 있고 그 외 것들과 더 많은 함수형 인터페이스는</p>\n<p>java.util.function 패키지에 더 많은 함수형 인터페이스가 존재한다.</p>\n<hr>\n<h4 id=\"222-collection-framework-에서-활용\" style=\"position:relative;\"><a href=\"#222-collection-framework-%EC%97%90%EC%84%9C-%ED%99%9C%EC%9A%A9\" aria-label=\"222 collection framework 에서 활용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2.2 collection framework 에서 활용</h4>\n<p>이런 함수형 인터페이스의 강점은 javascript의 callback과 같은 기능을 생각하면 된다.</p>\n<p>기본 native code에서 공통적인 비지니스 로직을 처리하고, 딱 필요한 부분만 사용자가</p>\n<p>함수(정확히는 메소드)를 구현 하여 호출하는 방식이다.</p>\n<table>\n<thead>\n<tr>\n<th>Interface</th>\n<th>Method</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Collection</td>\n<td>boolean removeIf(Predicate&#x3C;E> filter)</td>\n<td>조건에 맞는 요소를 삭제</td>\n</tr>\n<tr>\n<td>List</td>\n<td>void replaceAll(UnaryOperator&#x3C;E> operator)</td>\n<td>모든 요소를 변환하여 대체</td>\n</tr>\n<tr>\n<td>Iterable</td>\n<td>void forEach(Consumer&#x3C;T> action)</td>\n<td>모든 요소에 작업 action을 수행</td>\n</tr>\n<tr>\n<td>Map</td>\n<td>V compute(K key, BiFunction&#x3C;K, V, V> f)</td>\n<td>지정된 키의 값에 작업 f를 수행</td>\n</tr>\n<tr>\n<td>Map</td>\n<td>V computeIfAbsent(K key, Function&#x3C;K, V> f)</td>\n<td>키가 없으면, 작업 f 수행 후 추가</td>\n</tr>\n<tr>\n<td>Map</td>\n<td>V computeIfPresent(K key, BiFunction&#x3C;K, V, V> f)</td>\n<td>지정된 키가 있을 때, 작업 f 수행</td>\n</tr>\n<tr>\n<td>Map</td>\n<td>V merge(K key, V value, BiFunction&#x3C;V, V, V> f)</td>\n<td>모든 요소에 병합작업 f를 수행</td>\n</tr>\n<tr>\n<td>Map</td>\n<td>void forEach(BiConsumer&#x3C;K, V> action)</td>\n<td>모든 요소에 작업 action을 수행</td>\n</tr>\n<tr>\n<td>Map</td>\n<td>void replaceAll(BiFunction&#x3C;K, V, V> action)</td>\n<td>모든 요소에 치환작업 f를 수행</td>\n</tr>\n</tbody>\n</table>\n<p>개인적으로 좋은 내용들이라 생각해서 ‘자바의 정석’ 책을 읽다가 그냥 배꼇다…</p>\n<p>아무튼 사용 예제를 보면</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">collectionDefaultMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> strList <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    strList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"one\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    strList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"two\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    strList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"three\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    strList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"four\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    strList<span class=\"token punctuation\">.</span><span class=\"token function\">replaceAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token string\">\"number : \"</span><span class=\"token operator\">+</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    strList<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위와 같이 내가 List에 모든 아이템을 변경할때와 모든 아이템을 출력 한다고 가정하면</p>\n<p>replaceAll과 forEach문을 사용을 안한다면 일일이 모든 아이템을 꺼내서 작업을 해야 할 것이다.</p>\n<p>하지만 위와같이 정말 내가 필요한 부분만 구현하여 빠르고 간결하게 사용 가능하다.</p>\n<p>공부하면서 느낀 바로는 jdk 1.8 부터 interface의 default method + lambda + collection framework의 조합으로 상당히</p>\n<p>편하고 간결해졌다고 생각한다.</p>\n<h4 id=\"223-default-method\" style=\"position:relative;\"><a href=\"#223-default-method\" aria-label=\"223 default method permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2.3 default method</h4>\n<p>java 1.8부터 인터페이스에 default method와 static method가 추가되었다. 간단히 설명하면</p>\n<p>인터페이스에 default 또는 static으로 메소드의 구현부를 추가할 수 있다.</p>\n<p>함수형 인터페이스는 하나의 메소드만 선언할 수가 있지만 이러한 default, static 메소드는 따로 제약 없이 여러개 추가가 가능하다.</p>\n<p>이러한 특성 때문에 사용할 땐 마치 함수를 넘겨주고 내부적으로는 객체로 사용하는 듯한 느낌이다.</p>\n<p><code class=\"language-text\">Function</code>과 <code class=\"language-text\">Predicate</code>에는 아래 표와 같이 각각 default method가 존재한다.</p>\n<h3 id=\"function-class\" style=\"position:relative;\"><a href=\"#function-class\" aria-label=\"function class permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Function class</h3>\n<table>\n<thead>\n<tr>\n<th>구분</th>\n<th>method</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>default</td>\n<td>Function&#x3C;V, R> <br/> compose(Function&#x3C;? super V, ? extends T> before)</td>\n<td>before Function을 실행 후, 자기 자신 Function 실행</td>\n</tr>\n<tr>\n<td>default</td>\n<td>Function&#x3C;T, V> <br/> andThen(Function&#x3C;? super R, ? extends V> after)</td>\n<td>자기자신 Function을 실행 후, after Function 실행</td>\n</tr>\n<tr>\n<td>static</td>\n<td>Function&#x3C;T, T> identity()</td>\n<td>항등 함수를 반환 t->t</td>\n</tr>\n</tbody>\n</table>\n<p>솔직히 딱히 설명할께 없다…</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">funcCombine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Function</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> before <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"before\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">\"before\"</span><span class=\"token operator\">+</span>str<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Function</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> after <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> str<span class=\"token operator\">+</span><span class=\"token string\">\"after\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Function</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> combine <span class=\"token operator\">=</span> before<span class=\"token punctuation\">.</span><span class=\"token function\">andThen</span><span class=\"token punctuation\">(</span>after<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">String</span> resultStr <span class=\"token operator\">=</span> combine<span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"문자열\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>resultStr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/*\n    before\n    after\n    before문자열after\n    */</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Function class를 활용하여 함수를 합성하여 새로운 함수를 만들어 낼 수가 있다.</p>\n<p>compose와 andthen의 차이는 그저 어떤게 먼저 실행 될 지 차이고, 소스 자체가 몇줄 되지 않아 소스 까보는것도 괜찮은 방법이다.</p>\n<h3 id=\"predicate-class\" style=\"position:relative;\"><a href=\"#predicate-class\" aria-label=\"predicate class permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Predicate class</h3>\n<table>\n<thead>\n<tr>\n<th>구분</th>\n<th>method</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>default</td>\n<td>Predicate&#x3C;T> and(Predicate&#x3C;? super T> other)</td>\n<td>자기 자신 결과와 other Predicate 결과 and 연산</td>\n</tr>\n<tr>\n<td>default</td>\n<td>Predicate&#x3C;T> negate()</td>\n<td>자기자신 결과를 not 연산</td>\n</tr>\n<tr>\n<td>default</td>\n<td>Predicate&#x3C;T> or(Predicate&#x3C;? super T> other)</td>\n<td>자기 자신 결과와 other Predicate 결과 or 연산</td>\n</tr>\n<tr>\n<td>static</td>\n<td>Predicate&#x3C;T> isEqual(Object targetRef)</td>\n<td>입력받은 object와 같은지 비교하는 Predicate을 반환한다</td>\n</tr>\n</tbody>\n</table>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">funcCombine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Predicate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> isTrue <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>str<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Predicate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> isFalse <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>str<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Boolean</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Predicate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> onlyFalse <span class=\"token operator\">=</span> isTrue<span class=\"token punctuation\">.</span><span class=\"token function\">and</span><span class=\"token punctuation\">(</span>isFalse<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Predicate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> onlyTrue <span class=\"token operator\">=</span> onlyFalse<span class=\"token punctuation\">.</span><span class=\"token function\">negate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">Predicate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> mayBeTrue <span class=\"token operator\">=</span> isTrue<span class=\"token punctuation\">.</span><span class=\"token function\">or</span><span class=\"token punctuation\">(</span>isFalse<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">boolean</span> onlyFalseResult <span class=\"token operator\">=</span> onlyFalse<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"true\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> onlyTrueResult <span class=\"token operator\">=</span> onlyTrue<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"true\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">boolean</span> byInputResult <span class=\"token operator\">=</span> mayBeTrue<span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"false\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"only false : \"</span><span class=\"token operator\">+</span>onlyFalseResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"only true : \"</span><span class=\"token operator\">+</span>onlyTrueResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"may be true : \"</span><span class=\"token operator\">+</span>byInputResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/*\n    only false : false\n    only true : true\n    by input : true\n    */</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Predicate를 활용해서 함수를 만들고, and, or not 연산을 실행할 수가 있다.</p>\n<p>이것도 간단하게 구현이 되어 있어서 혹시나마 이해가 안된다면 소스 까보는것도 괜찮다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">아무튼 이런식으로 함수형 인터페이스를 사용함으로써 꽤나 유용하고,\n\njavascript 디자인 패턴에서 커링(currying) 같은것도 충분히 구현이 가능할꺼 라고 본다.</code></pre></div>\n<h1 id=\"3-주의할점-및-기타-활용\" style=\"position:relative;\"><a href=\"#3-%EC%A3%BC%EC%9D%98%ED%95%A0%EC%A0%90-%EB%B0%8F-%EA%B8%B0%ED%83%80-%ED%99%9C%EC%9A%A9\" aria-label=\"3 주의할점 및 기타 활용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3 주의할점 및 기타 활용</h1>\n<h3 id=\"31-외부-변수는-별다른-선언이-없어도-final하다-아래-소스는-18-버전-기준\" style=\"position:relative;\"><a href=\"#31-%EC%99%B8%EB%B6%80-%EB%B3%80%EC%88%98%EB%8A%94-%EB%B3%84%EB%8B%A4%EB%A5%B8-%EC%84%A0%EC%96%B8%EC%9D%B4-%EC%97%86%EC%96%B4%EB%8F%84-final%ED%95%98%EB%8B%A4-%EC%95%84%EB%9E%98-%EC%86%8C%EC%8A%A4%EB%8A%94-18-%EB%B2%84%EC%A0%84-%EA%B8%B0%EC%A4%80\" aria-label=\"31 외부 변수는 별다른 선언이 없어도 final하다 아래 소스는 18 버전 기준 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 외부 변수는 별다른 선언이 없어도 final하다. 아래 소스는 1.8 버전 기준</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">lambdaBase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> num <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">callMethod</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//num = 10;  ERROR!</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">callMethod</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">LambdaInterface</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token annotation punctuation\">@Override</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">doSomeThing</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">//num = 10;  ERROR!</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다음과 같은 소스가 있다고 했을떄, 내부에서 num을 바꾸는 행위(num=10)는 할수 없다. 이는 내부적으로</p>\n<p>변수가 final로 선언 되어서 그러는데, 암시적으로 fianl로 처리하는 이유는 thread safe 문제 때문이라고 한다.</p>\n<p>해당 메소드의 실행 시점(또는 순서)을 알 수가 없기에, 아예 내부적으로도 final로 입력 받는다고 한다.</p>\n<p>따라서 공통된 resource(위 소스에서 num)를 어디서 요청 되든 공통된 값으로 사용 가능하다.</p>\n<p>추가적으로 자세히 알고 싶을 경우, side effect, effectively final, thread safe 등의 키워드로 검색!</p>\n<p>참고 자료 : <a href=\"http://wonwoo.ml/index.php/post/1125\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://wonwoo.ml/index.php/post/1125</a></p>\n<h3 id=\"32-closure\" style=\"position:relative;\"><a href=\"#32-closure\" aria-label=\"32 closure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 closure</h3>\n<p>java에서 closure를 사용할 수 있는데, 다른 쪽에서 설명하기도 뭐해서 람다와 같이 설명함.</p>\n<p>혹시나 closure 개념을 모른다면 javascript를 참고하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">Function</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getFunction</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">int</span> num <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> n <span class=\"token operator\">-></span>  n<span class=\"token operator\">*</span>num<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 static method는 Function(Interface이다)의 구현체를 반환하는 메소드가 되겠다.</p>\n<p>Funtion은 단일 메소드의 함수형 인터페이스 이므로, 이러한 형태가 가능하다.</p>\n<p>아무튼 반환 된 메소드를 사용시, 내부의 num값 범위를 기억(마치 javascript의 lexical scope)</p>\n<p>하고 있다는 점에서 closure와 비슷하다고 볼수 있다. 문제점은 역시 반환하는 메소드에서 num값을</p>\n<p>바꿀수 없다는 제한 사항이 존재한다.</p>\n<p>혹시나 소스가 잘 이해가 안간다면 <code class=\"language-text\">Function</code>은 <code class=\"language-text\">interface</code>라는 점을 잘 기억하고, 추상팩토리 패턴(design pattern)을 공부하자.</p>\n<h3 id=\"33-method-reference\" style=\"position:relative;\"><a href=\"#33-method-reference\" aria-label=\"33 method reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3 Method Reference</h3>\n<p>메소드 참조는 정말 순수 하고 최소화된 소스만 작성하는 목적으로 사용된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">methodReference</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Consumer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> notUseReference <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Consumer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> useReference <span class=\"token operator\">=</span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token operator\">::</span><span class=\"token function\">println</span><span class=\"token punctuation\">;</span>\n\n    notUseReference<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"only Lambda!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    useReference<span class=\"token punctuation\">.</span><span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"use Method Reference!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>소스 자체는 이해하는데 무리는 없을 꺼라고 생각된다.</p>\n<p><code class=\"language-text\">ClassName::MethodName</code> 형태로 작성하고, 메소드는 static이건 아니건 상관없다.</p>\n<p>참고로 생성자는 <code class=\"language-text\">ClassName::new(String::new)</code> 이런식으로 사용한다.</p>\n<p>위 소스를 보면 <code class=\"language-text\">useReference</code> 메소드에서 넘겨받는 파라미터는 Cusumer의 generics에 의해 개수와 타입이</p>\n<p>제한되어 맵핑(유추 가능)되는 것을 알수 있다. 근데 개인적으로 메소드 참조는 뭔가</p>\n<p>엄청 유용하다! 간결하다! 혁신이다! 라는 느낌보단 익숙하지 않아 헤깔리기만 하여 잘 사용은 안할꺼 같다.</p>"}},{"node":{"fields":{"slug":"/posts/java/java-lambda_compile/","__typename":"MarkdownRemarkFields","categorySlug":"/category/java/"},"frontmatter":{"template":"post","title":"Lambda를 써야하는 이유","date":"2023-01-06T04:49:25.173Z","tags":["lambda","java","function"],"socialImage":null,"draft":false,"description":"익명클래스 보다 람다를 써야하는 이유","category":"java"},"id":"d17dc552-c09f-58c0-ad12-638aadb3ddc0","html":"<p>처음으로 자바에서 람다를 배울 때 쓰는 이유 중 하나는 ‘그냥 간편해서’ 라고 배웠던 기억이 난다. 람다를 씀으로써 문법적으로 더 간단해지고, 여기서 더 나아가면 함수형 인터페이스(<code class=\"language-text\">functional interface</code>) 까진 많이들 알 것이라 생각되는데 비교적 최근에 자바를 좀 더 공부하면서 차이를 더 알게 되었다. 여기서 비교 할 코드는 아래와 같다.</p>\n<h3 id=\"lambda\" style=\"position:relative;\"><a href=\"#lambda\" aria-label=\"lambda permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lambda</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> items <span class=\"token operator\">=</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test item1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test item2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">LambdaTest</span> test <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LambdaTest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        test<span class=\"token punctuation\">.</span><span class=\"token function\">testLambda</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testLambda</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> items<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        items<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>s <span class=\"token operator\">-></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>s<span class=\"token operator\">-></span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"anonymous\" style=\"position:relative;\"><a href=\"#anonymous\" aria-label=\"anonymous permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Anonymous</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> items <span class=\"token operator\">=</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test item1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test item2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">LambdaTest</span> test <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LambdaTest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        test<span class=\"token punctuation\">.</span><span class=\"token function\">testAnonymous</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testAnonymous</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> items<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        items<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Predicate</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token annotation punctuation\">@Override</span>\n                    <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> s<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">return</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Consumer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token annotation punctuation\">@Override</span>\n                    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> o<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>o<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>이전엔 두 메소드가 컴파일러를 거치면 완벽히 똑같은 코드가 될 것이라 생각하였다. 하지만 막상 컴파일 된 바이트 코드를 까보면 생각보다 꽤 많은 차이가 있다.</p>\n<h2 id=\"람다와-익명-클래스의-차이점\" style=\"position:relative;\"><a href=\"#%EB%9E%8C%EB%8B%A4%EC%99%80-%EC%9D%B5%EB%AA%85-%ED%81%B4%EB%9E%98%EC%8A%A4%EC%9D%98-%EC%B0%A8%EC%9D%B4%EC%A0%90\" aria-label=\"람다와 익명 클래스의 차이점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>람다와 익명 클래스의 차이점</h2>\n<h3 id=\"31-this-객체\" style=\"position:relative;\"><a href=\"#31-this-%EA%B0%9D%EC%B2%B4\" aria-label=\"31 this 객체 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1. this 객체</h3>\n<p>쉬운거 먼저 말하면 <code class=\"language-text\">this</code>가 가르키는 객체가 다르다. 람다에서 <code class=\"language-text\">this</code>는 <code class=\"language-text\">LambdaTest</code> 클래스의 인스턴스를 가르키지만 익명클래스에서 this는 익명객체를 통해 생성 된 인스턴스 그 자체를 가르키게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> items <span class=\"token operator\">=</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test item1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"test item2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">LambdaTest</span> test <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LambdaTest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        test<span class=\"token punctuation\">.</span><span class=\"token function\">testLambda</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        test<span class=\"token punctuation\">.</span><span class=\"token function\">testAnonymous</span><span class=\"token punctuation\">(</span>items<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testLambda</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> items<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"객체 this(lambda) -> \"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        items<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>s <span class=\"token operator\">-></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"lambda this -> \"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">testAnonymous</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> items<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"객체 this(anonymous) -> \"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        items<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Consumer</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token annotation punctuation\">@Override</span>\n            <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">accept</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> o<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"anonymous this -> \"</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/*\n    출력 내용\n    객체 this(lambda) -> LambdaTest@3d24753a\n    lambda this -> LambdaTest@3d24753a\n    lambda this -> LambdaTest@3d24753a\n    객체 this(anonymous) -> LambdaTest@3d24753a\n    anonymous this -> LambdaTest$1@506e6d5e\n    anonymous this -> LambdaTest$1@506e6d5e\n    */</span></code></pre></div>\n<p>출력 내용을 보면 함수에서 호출 한 <code class=\"language-text\">this</code>와 람다에서 호출한 <code class=\"language-text\">this</code>는 같은 주소를 출력하지만 익명 함수 안에서 호출 한 <code class=\"language-text\">this</code>는 다른 값을 출력 해주는 걸 알 수 있다.</p>\n<h3 id=\"32-바이트-코드\" style=\"position:relative;\"><a href=\"#32-%EB%B0%94%EC%9D%B4%ED%8A%B8-%EC%BD%94%EB%93%9C\" aria-label=\"32 바이트 코드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 바이트 코드</h3>\n<p>다시 위에서 <code class=\"language-text\">filter</code>와 <code class=\"language-text\">forEach</code>를 사용한 코드를 바이트 코드로 만들면 아래와 같이 확인 할 수 있다.</p>\n<h4 id=\"람다-함수-바이트-코드-내용\" style=\"position:relative;\"><a href=\"#%EB%9E%8C%EB%8B%A4-%ED%95%A8%EC%88%98-%EB%B0%94%EC%9D%B4%ED%8A%B8-%EC%BD%94%EB%93%9C-%EB%82%B4%EC%9A%A9\" aria-label=\"람다 함수 바이트 코드 내용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>람다 함수 바이트 코드 내용</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">public testLambda(Ljava/util/List;)V\n   L0\n    LINENUMBER 22 L0\n    ALOAD 1\n    INVOKEINTERFACE java/util/List.stream ()Ljava/util/stream/Stream; (itf)\n    INVOKEDYNAMIC test()Ljava/util/function/Predicate; [\n      // handle kind 0x6 : INVOKESTATIC\n      java/lang/invoke/LambdaMetafactory.metafactory(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;\n      // arguments:\n      (Ljava/lang/Object;)Z,\n      // handle kind 0x6 : INVOKESTATIC\n      LambdaTest.lambda$testLambda$0(Ljava/lang/String;)Z,\n      (Ljava/lang/String;)Z\n    ]\n   L1\n    LINENUMBER 23 L1\n    INVOKEINTERFACE java/util/stream/Stream.filter (Ljava/util/function/Predicate;)Ljava/util/stream/Stream; (itf)\n    INVOKEDYNAMIC accept()Ljava/util/function/Consumer; [\n      // handle kind 0x6 : INVOKESTATIC\n      java/lang/invoke/LambdaMetafactory.metafactory(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite;\n      // arguments:\n      (Ljava/lang/Object;)V,\n      // handle kind 0x6 : INVOKESTATIC\n      LambdaTest.lambda$testLambda$1(Ljava/lang/String;)V,\n      (Ljava/lang/String;)V\n    ]\n   L2\n    LINENUMBER 24 L2\n    INVOKEINTERFACE java/util/stream/Stream.forEach (Ljava/util/function/Consumer;)V (itf)\n   L3\n    LINENUMBER 25 L3\n    RETURN\n   L4\n    LOCALVARIABLE this LLambdaTest; L0 L4 0\n    LOCALVARIABLE items Ljava/util/List; L0 L4 1\n    // signature Ljava/util/List&lt;Ljava/lang/String;>;\n    // declaration: items extends java.util.List&lt;java.lang.String>\n    MAXSTACK = 2\n    MAXLOCALS = 2\n\n  // access flags 0x100A\n  private static synthetic lambda$testLambda$1(Ljava/lang/String;)V\n   L0\n    LINENUMBER 24 L0\n    GETSTATIC java/lang/System.out : Ljava/io/PrintStream;\n    ALOAD 0\n    INVOKEVIRTUAL java/io/PrintStream.println (Ljava/lang/String;)V\n    RETURN\n   L1\n    LOCALVARIABLE s Ljava/lang/String; L0 L1 0\n    MAXSTACK = 2\n    MAXLOCALS = 1\n\n  // access flags 0x100A\n  private static synthetic lambda$testLambda$0(Ljava/lang/String;)Z\n   L0\n    LINENUMBER 23 L0\n    ALOAD 0\n    INVOKEVIRTUAL java/lang/String.length ()I\n    ICONST_1\n    IF_ICMPLE L1\n    ICONST_1\n    GOTO L2\n   L1\n   FRAME SAME\n    ICONST_0\n   L2\n   FRAME SAME1 I\n    IRETURN\n   L3\n    LOCALVARIABLE s Ljava/lang/String; L0 L3 0\n    MAXSTACK = 2\n    MAXLOCALS = 1\n}</code></pre></div>\n<h4 id=\"익명-함수-바이드-코드-내용\" style=\"position:relative;\"><a href=\"#%EC%9D%B5%EB%AA%85-%ED%95%A8%EC%88%98-%EB%B0%94%EC%9D%B4%EB%93%9C-%EC%BD%94%EB%93%9C-%EB%82%B4%EC%9A%A9\" aria-label=\"익명 함수 바이드 코드 내용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>익명 함수 바이드 코드 내용</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">public testAnonymous(Ljava/util/List;)V\n   L0\n    LINENUMBER 31 L0\n    ALOAD 1\n    INVOKEINTERFACE java/util/List.stream ()Ljava/util/stream/Stream; (itf)\n    NEW LambdaTest$2\n    DUP\n    ALOAD 0\n    INVOKESPECIAL LambdaTest$2.&lt;init> (LLambdaTest;)V\n   L1\n    LINENUMBER 32 L1\n    INVOKEINTERFACE java/util/stream/Stream.filter (Ljava/util/function/Predicate;)Ljava/util/stream/Stream; (itf)\n    NEW LambdaTest$1\n    DUP\n    ALOAD 0\n    INVOKESPECIAL LambdaTest$1.&lt;init> (LLambdaTest;)V\n   L2\n    LINENUMBER 38 L2\n    INVOKEINTERFACE java/util/stream/Stream.forEach (Ljava/util/function/Consumer;)V (itf)\n   L3\n    LINENUMBER 44 L3\n    RETURN\n   L4\n    LOCALVARIABLE this LLambdaTest; L0 L4 0\n    LOCALVARIABLE items Ljava/util/List; L0 L4 1\n    // signature Ljava/util/List&lt;Ljava/lang/String;>;\n    // declaration: items extends java.util.List&lt;java.lang.String>\n    MAXSTACK = 4\n    MAXLOCALS = 2\n}</code></pre></div>\n<h4 id=\"참고\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0\" aria-label=\"참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고</h4>\n<ul>\n<li>INVOKEINTERFACE - 인터페이스 메소드 호출</li>\n<li>INVOKESPECIAL - 생성자, private 메소드, 슈퍼 클래스의 메소드 호출</li>\n<li>INVOKESTATIC - static 메소드 호출</li>\n<li>INVOKEVIRTUAL - 인스턴스 메소드 호출</li>\n</ul>\n<p>만들어진 바이트 코드를 통해 람라 먼저 보면 만들어진 부분은 아예 <code class=\"language-text\">static</code>의 별도의 메소드가 만들어 진다는 점이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">private static synthetic lambda$testLambda$1(Ljava/lang/String;)V\n...\nprivate static synthetic lambda$testLambda$0(Ljava/lang/String;)Z</code></pre></div>\n<p>람다식은 컴파일러를 거치면서 해당 람다 메소드가 정의 된 클래스의 <code class=\"language-text\">private static</code> 메소드로 정의 되고, 그 메소드를 매번 호출 하는 형태가 된다.</p>\n<blockquote>\n<p>주의 할 점은 람다식 내에서 <code class=\"language-text\">this</code>를 쓰냐, 아니냐에 따라 <code class=\"language-text\">static</code>이냐, 아니냐가 갈리게 된다. <code class=\"language-text\">this</code>를 사용 안하면 위와 같이 <code class=\"language-text\">static</code>으로, <code class=\"language-text\">this</code>를 쓰면 <code class=\"language-text\">static</code>한 메소드에선 사용 할 수 없으니까 <code class=\"language-text\">static</code>이 아니게 된다.</p>\n</blockquote>\n<p>즉 람다는 메소드로 변환 되어 매번 객체를 생성하지 않아도 된다.</p>\n<p>하지만 익명클래스로 직접 구현한 방식에선 <code class=\"language-text\">INVOKESPECIAL</code>을 사용하여 객체를 생성 하는 것을 확인 할 수가 있다. 따라서 익명 클래스는 상대적으로 더 많은 객체를 생성하게 되므로, 람다에 비해 메모리가 더 많이 필요하게 된다.</p>\n<p>여기서 끝나는게 아니라 한가지 더 확인 할 수가 있는데 익명 클래스의 바이트 코드는 아래와 같은 내용을 볼 수가 있다</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">...\nINVOKESPECIAL LambdaTest$2.&lt;init>\n...\nINVOKESPECIAL LambdaTest$1.&lt;init></code></pre></div>\n<p>이게 무슨 클래스 생성자를 호출 하는것인지 의아 할 수가 있는데, 이건 진짜 컴파일 된 파일 결과를 보면 알 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"># 컴파일 된 결과를 떨어뜨리는 디렉토리로 이동. 개인 설정 기준 다를 수 있음\n$ out/production/TestJava\n$ ls\nLambdaTest$1.class LambdaTest$2.class LambdaTest.class   Main.class</code></pre></div>\n<p>즉, 익명 클래스를 쓰면 아예 새로운 클래스를 컴파일 과정에서 만들고 그 클래스의 인스턴스를 만드는 것이다.</p>\n<p>-> 힙뿐만 이나라 메타스페이스 메모리도 더 사용하게 된다.</p>\n<blockquote>\n<p>익명클래스 2개 썻다고 2개의 새로운 클래스 <code class=\"language-text\">LambdaTest$1.class</code>, <code class=\"language-text\">LambdaTest$2.class</code>가 만들어진 것이다\n코드에 따라 최적화 결과가 다르므로 람다도 클래스를 동적으로 만들어 사용 될 수도 있다.</p>\n</blockquote>\n<p>추가로 람다의 장점은 더 있는데, <code class=\"language-text\">INVOKEDYNAMIC</code>을 통해 컴파일 타임이 아닌 런타임 시에 호출 되는 특징과 외부 객체 참조 여부, this 사용 여부에 따라 똑같은 람다를 반복되어 사용하는 특징(마치 string 처럼)등이 있다. 물론 최적화 과정은 익명 클래스도 어느 정도 지원을 하지만 기본적으로 람다를 쓰는게 메모리 측면에서 더 좋다</p>"}},{"node":{"fields":{"slug":"/posts/java/java-oome/","__typename":"MarkdownRemarkFields","categorySlug":"/category/java/"},"frontmatter":{"template":"post","title":"Java OOME 종류","date":"2022-02-10T05:55:23.624Z","tags":["jvm","java","heap","GC"],"socialImage":null,"draft":false,"description":"OOME(Out Of Memory Error) 종류 및 발생 조건","category":"java"},"id":"ab9fc5a8-f2c7-565f-b93a-92d9922c60e2","html":"<p>미리 말하면 샘플 코드들은 OOME 발생을 쉽게 하기 위해 힙/메타스페이스 메모리 공간을 상당히 적게 만들고 테스트 하였다</p>\n<h2 id=\"1-java-heap-space\" style=\"position:relative;\"><a href=\"#1-java-heap-space\" aria-label=\"1 java heap space permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Java heap space</h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OOME</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">OOME</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">heap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">heap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> list <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LinkedList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">int</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            list<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그냥 위 코드를 실행 시키면 언젠가 heap 메모리가 터지게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">java.lang.OutOfMemoryError: Java heap space\n\tat java.base/java.lang.Class.forName0(Native Method)\n\tat java.base/java.lang.Class.forName(Class.java:315)\n  ...\n  ...\n  ...</code></pre></div>\n<p>가장 많이 볼 것이라 예상되는 <code class=\"language-text\">OOME</code> 이다. 발생 이유는 <code class=\"language-text\">heap</code> 메모리가 부족해서 발생하는것인데, 발생했다고 heap 메모리만 늘리다보면 답이 없다. 메모리 누수는 없었는지, 현재 차지하고 있는 heap memory가 어느 정도인지 파악하고 <code class=\"language-text\">heap</code> 메모리를 늘리던가 경우에 따라 <code class=\"language-text\">java application</code>을 <code class=\"language-text\">scale down</code> 하는게 더 나은지 생각하고 작업하는걸 추천한다.</p>\n<p><code class=\"language-text\">heap</code> 영역에는 생성된 객체가 저장되는 공간인데, 생성된 객체가 heap 영역에 저장할 공간이 없다고 바로 <code class=\"language-text\">OOME</code>가 발생하는게 아니라 일단 <code class=\"language-text\">GC</code>를 돌려보고(필요에 따라 <code class=\"language-text\">yong/old/full</code>이 돌아간다) 그래도 메모리가 부족하면 <code class=\"language-text\">OOME</code>가 발생하는 것이다. 즉, 기회를 줬는데도(GC 돌아가는거) 터졌다는건 메모리 누수 여부도 반드시 확인 해볼 사항이다(물론 진짜 물리적으로 heap이 너무 부족 해서 발생 할 수도 있다).</p>\n<blockquote>\n<p>GC 로그를 보다보면 GC가 돌아가는 이유도 알 수 있는데, 메모리 할당 실패(<code class=\"language-text\">Allocation Failure</code>) 시에도 GC가 돌아가는것을 확인 할 수 있다.</p>\n</blockquote>\n<h2 id=\"2-gc-overhead-limit-exceeded\" style=\"position:relative;\"><a href=\"#2-gc-overhead-limit-exceeded\" aria-label=\"2 gc overhead limit exceeded permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. GC overhead limit exceeded</h2>\n<p>발생 조건을 적어보자면</p>\n<ul>\n<li>cpu 사용량 중 98%를 GC 돌리는데 사용</li>\n<li>GC 돌렸는데도 heap의 2% 이하면 확보</li>\n</ul>\n<p>이름 그대로 GC로 인한 오버헤드가 너무 크면 발생한다. 현재 내 환경을 기준으로 당장 위의 <code class=\"language-text\">Java heap space</code>에서 설명한 코드를 자바 버전만 8로 바꿔서 실행 해봤더니 발생하였고, 발생 근본적인 원인은 <strong>똑같은 이유</strong> 일 가능성이 높다. 즉, 결국엔 <code class=\"language-text\">heap</code> 메모리가 부족해서 인데 일시적으로 메모리가 큰 작업, 메모리 누수 등이 발생 이유 일 수도 있다. 또한 limit조건을 없앨수도 있지만 그런식으로 해결하는건 별로 좋은 방법은 아니다.</p>\n<blockquote>\n<p>자바 8의 기본 GC는 <code class=\"language-text\">Parallel GC</code> 이다.</p>\n</blockquote>\n<blockquote>\n<p>혹시나마 오버헤드 제한을 끄고 싶으면 <code class=\"language-text\">-XX:-UseGCOverheadLimit</code> 옵션을 주면 된다. (비추천)</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Exception in thread \"main\" java.lang.OutOfMemoryError: GC overhead limit exceeded\n\tat java.lang.Integer.valueOf(Integer.java:832)\n  ...\n  ...</code></pre></div>\n<h2 id=\"3-requested-array-size-exceeds-vm-limit\" style=\"position:relative;\"><a href=\"#3-requested-array-size-exceeds-vm-limit\" aria-label=\"3 requested array size exceeds vm limit permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Requested array size exceeds VM limit</h2>\n<p>힙보다 더 큰 Array가 요청되는 경우 발생한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OOME</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">array</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> arr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">[</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">.</span>MAX_VALUE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Exception in thread \"main\" java.lang.OutOfMemoryError: Requested array size exceeds VM limit\n  ...\n  ...</code></pre></div>\n<p>이건 그냥 코드가 잘못된 케이스라고 봐야한다. break 없이 동적으로 배열 크기를 늘리는게 아닌지 확인해봐야한다.</p>\n<h2 id=\"4-metaspace\" style=\"position:relative;\"><a href=\"#4-metaspace\" aria-label=\"4 metaspace permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Metaspace</h2>\n<p><code class=\"language-text\">Metaspace</code>는 <code class=\"language-text\">Class</code> 관련 메타데이터가 저장되는 공간이라고 하였다. 즉, 너무 많은 <code class=\"language-text\">Class</code> 정보를 로드하면 발생하게 되지만, 물론 이 <code class=\"language-text\">metaspace</code>로 GC 대상이며 해당 클래스에 대한 참조 및 인스턴스가 없을때 GC에 의해 회수된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OOME</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">metaspace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">ClassPool</span> cp <span class=\"token operator\">=</span> <span class=\"token class-name\">ClassPool</span><span class=\"token punctuation\">.</span><span class=\"token function\">getDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000000000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token class-name\">Class</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token operator\">?</span><span class=\"token punctuation\">></span></span> clazz <span class=\"token operator\">=</span> cp<span class=\"token punctuation\">.</span><span class=\"token function\">makeClass</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dummy clazz \"</span> <span class=\"token operator\">+</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"created \"</span> <span class=\"token operator\">+</span> clazz<span class=\"token punctuation\">.</span><span class=\"token function\">getSimpleName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">CannotCompileException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"make clazz error\"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>참고로 동적으로 클래스를 만들기 위해 외부 라이브러리를 사용하였고, 해당 <code class=\"language-text\">OOME</code>를 쉽게 발생하기 위해 상대적으로 Heap 메모리는 크게, metaspace(<code class=\"language-text\">MaxMetaspaceSize</code>)는 적게 셋팅하고 실행하여야 한다. TMI로 GC 로그를 보면 metaspace를 확보 하려하고 해도 실패하는거 봐선 이 라이브러리에 동적으로 만들어진 클래스를 참조&#x26;관리하는 로직이 있을것이라 생각된다.</p>\n<blockquote>\n<p><a href=\"https://github.com/jboss-javassist/javassist\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/jboss-javassist/javassist</a></p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Exception in thread \"main\" java.lang.OutOfMemoryError: Metaspace\n  ...\n  ...</code></pre></div>\n<h2 id=\"5-그-외-oome\" style=\"position:relative;\"><a href=\"#5-%EA%B7%B8-%EC%99%B8-oome\" aria-label=\"5 그 외 oome permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 그 외 OOME</h2>\n<p>그 외에도 발생 이유가 있지만 정말 보기 힘든 에러들이며, 일반적인 상황에선 볼 일이 없는 에러들이 있다. 추가로 쓰는것 말고도 몇가지가 있는데 그건 더더욱 보기 힘들꺼라 생각된다.</p>\n<h3 id=\"request-size-bytes-for-reason-out-of-swap-space\" style=\"position:relative;\"><a href=\"#request-size-bytes-for-reason-out-of-swap-space\" aria-label=\"request size bytes for reason out of swap space permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>request size bytes for reason. Out of swap space?</h3>\n<p>런타임 시에 가상 메모리(swap memory)를 추가로 확보 할 수 없을 경우 발생한다.</p>\n<h3 id=\"compressed-class-space\" style=\"position:relative;\"><a href=\"#compressed-class-space\" aria-label=\"compressed class space permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Compressed class space</h3>\n<p>class의 정보가 저장되는 크기가 부족하면 발생한다.</p>\n<p>이 공간에 대해 요약해서 설명하자면 기본적으로 <code class=\"language-text\">UseCompressedClassPointers</code>라는 옵션을 사용하면 <code class=\"language-text\">metaspace</code>는 2개의 context로 분리되는데, 클래스 정보 일부분이 <code class=\"language-text\">Compressed class space</code>라는 곳에 저장된다(기본 옵션으로 활성화 되어 있음).</p>\n<blockquote>\n<p>java 클래스의 내부 정보(<code class=\"language-text\">internal representation of Java classes</code>)는 <code class=\"language-text\">class space (Compressed class space)</code> 안에, 그 외 <code class=\"language-text\">method</code>, <code class=\"language-text\">constant pools</code>, <code class=\"language-text\">anotation</code> 등이 <code class=\"language-text\">non class metaspace</code> 저장된다. 궁극적으로 이렇게 하는 이유는 32/64 bit로 차이로 인한 메모리 최적화를 위해 설계되었으며, 이런 두 공간의 합은 최대 metaspace(<code class=\"language-text\">MaxMetaspaceSize</code>) 공간보다 클 수 없다.</p>\n</blockquote>\n<ul>\n<li><a href=\"https://wiki.openjdk.java.net/display/HotSpot/Metaspace\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">compressed 옵션에 따른 metaspace context 설명</a></li>\n<li><a href=\"https://stackoverflow.com/questions/54250638/is-compressedclassspacesize-area-contains-maxmetaspacesize-area\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Compressed Class Space 관련 질답(Stack overflow)</a></li>\n<li><a href=\"https://stuefe.de/posts/metaspace/sizing-metaspace/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">class area + non class area + metaspace 설명</a></li>\n<li><a href=\"https://shipilev.net/jvm/anatomy-quarks/23-compressed-references/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">jvm Compressed References 관련 설명</a></li>\n</ul>"}},{"node":{"fields":{"slug":"/posts/java/java-stream/","__typename":"MarkdownRemarkFields","categorySlug":"/category/java/"},"frontmatter":{"template":"post","title":"Stream","date":"2016-02-03T22:40:32.169Z","tags":["stream","java","functional"],"socialImage":null,"draft":false,"description":"많은 데이터를 손쉽게 처리","category":"java"},"id":"92ea4cc8-8ee3-5ae8-a88e-8b5fa6555a3b","html":"<h1 id=\"stream\" style=\"position:relative;\"><a href=\"#stream\" aria-label=\"stream permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Stream.</h1>\n<h1 id=\"1-장점\" style=\"position:relative;\"><a href=\"#1-%EC%9E%A5%EC%A0%90\" aria-label=\"1 장점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 장점</h1>\n<h3 id=\"11-내부-반복처리를-진행하고-직관적이라-이해하기-쉽다\" style=\"position:relative;\"><a href=\"#11-%EB%82%B4%EB%B6%80-%EB%B0%98%EB%B3%B5%EC%B2%98%EB%A6%AC%EB%A5%BC-%EC%A7%84%ED%96%89%ED%95%98%EA%B3%A0-%EC%A7%81%EA%B4%80%EC%A0%81%EC%9D%B4%EB%9D%BC-%EC%9D%B4%ED%95%B4%ED%95%98%EA%B8%B0-%EC%89%BD%EB%8B%A4\" aria-label=\"11 내부 반복처리를 진행하고 직관적이라 이해하기 쉽다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 내부 반복처리를 진행하고, 직관적이라 이해하기 쉽다.</h3>\n<h3 id=\"12-손쉬운-병렬처리\" style=\"position:relative;\"><a href=\"#12-%EC%86%90%EC%89%AC%EC%9A%B4-%EB%B3%91%EB%A0%AC%EC%B2%98%EB%A6%AC\" aria-label=\"12 손쉬운 병렬처리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 손쉬운 병렬처리</h3>\n<h3 id=\"13-최종-연산이-실행될때-중간연산들을-실행한다-지연-실행\" style=\"position:relative;\"><a href=\"#13-%EC%B5%9C%EC%A2%85-%EC%97%B0%EC%82%B0%EC%9D%B4-%EC%8B%A4%ED%96%89%EB%90%A0%EB%95%8C-%EC%A4%91%EA%B0%84%EC%97%B0%EC%82%B0%EB%93%A4%EC%9D%84-%EC%8B%A4%ED%96%89%ED%95%9C%EB%8B%A4-%EC%A7%80%EC%97%B0-%EC%8B%A4%ED%96%89\" aria-label=\"13 최종 연산이 실행될때 중간연산들을 실행한다 지연 실행 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.3 최종 연산이 실행될때 중간연산들을 실행한다. (지연 실행)</h3>\n<p>이 부분이 좋은 점이 불필요한 연산을 줄여준다는 점이다. 밑에 2.1에서 좀 더 자세히 설명</p>\n<h1 id=\"2-stream-기본-사용법\" style=\"position:relative;\"><a href=\"#2-stream-%EA%B8%B0%EB%B3%B8-%EC%82%AC%EC%9A%A9%EB%B2%95\" aria-label=\"2 stream 기본 사용법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Stream 기본 사용법</h1>\n<h3 id=\"21-중간연산-최종연산\" style=\"position:relative;\"><a href=\"#21-%EC%A4%91%EA%B0%84%EC%97%B0%EC%82%B0-%EC%B5%9C%EC%A2%85%EC%97%B0%EC%82%B0\" aria-label=\"21 중간연산 최종연산 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 중간연산, 최종연산</h3>\n<p>스트림 사용 시 중간연산, 최종 연산이 존재 하며, 최종 연산이 실행되면 해당 스트림은 더이상 사용 할 수가 없다.</p>\n<p>일단 표부터 확인!</p>\n<table>\n  <thead>\n    <tr><th>중간연산</th><th>설명</th></tr>\n  </thead>\n  <tbody>\n    <tr><td>Stream&lt;T&gt; distinct()</td><td>중복을 제거</td></tr>\n    <tr><td>Stream&lt;T&gt; filter(Predicate&lt;T&gt; predicate)</td><td>조건에 안맞는 요소 제외</td></tr>\n    <tr><td>Stream&lt;T&gt; limit(long maxSize)</td><td>스트림의 일부를 제한(개수 제한)한다.</td></tr>\n    <tr><td>Stream&lt;T&gt; skip(long n)</td><td>스트림의 일부를 skip한다.</td></tr>\n    <tr><td>Stream&lt;T&gt; peek(Consumer&lt;T&gt; action)</td><td>스트림의 요소에 작업을 수행한다.</td></tr>\n    <tr><td>Stream&lt;T&gt; sorted()</td><td rowspan=\"2\">스트림의 요소를 정렬한다.</td></tr>\n    <tr><td>Stream&lt;T&gt; sorted(Conparator&lt;T&gt; comparator)</td></tr>\n    <tr><td>Stream&lt;R&gt; map(Function&lt;T, R&gt; mapper)</td><td rowspan=\"8\">스트림의 요소를 변환한다.</td></tr>\n    <tr><td>DoubleStream mapToDouble(ToDoubleFunction&lt;T&gt; mapper</td></tr>\n    <tr><td>IntStream mapToInt(ToIntFunction&lt;T&gt; mapper)</td></tr>\n    <tr><td>LongStream mapToLong(ToLongFunction&lt;T&gt; mapper)</td></tr>\n    <tr><td>Stream&lt;R&gt; flatMap(Function&lt;T, Stream&lt;R&gt;&gt; mapper)</td></tr>\n    <tr><td>DoubleStream flatMapToDouble(Function&lt;T, DoubleStream&gt; m)</td></tr>\n    <tr><td>IntStream flatMapToInt(Function&lt;T, IntStream&gt; m)</td></tr>\n    <tr><td>LongStream flatMapToLong(Function&lt;T, LongStream&gt; m)</td></tr>\n  </tbody>\n</table>\n<table>\n  <thead>\n    <tr><th>최종연산</th><th>설명</th></tr>\n  </thead>\n  <tbody>\n    <tr><td>void forEach(Consumer&lt;? super T&gt; action)</td><td>각 요소에 지정된 작업 수행</td></tr>\n    <tr><td>void forEachOrdered(Consumer&lt;? super T&gt; action)</td><td>각 요소에 지정된 작업 수행</td></tr>\n    <tr><td>long count()</td><td>스트림의 요소의 개수 반환</td></tr>\n    <tr><td>Optional&lt;T&gt; max(Comparator&lt;? super T&gt; comparator)</td><td>스트림의 최대값 반환</td></tr>\n    <tr><td>Optional&lt;T&gt; min(Comparator&lt;? super T&gt; comparator)</td><td>스트림의 최소값 반환</td></tr>\n    <tr><td>Optional&lt;T&gt; findAny()</td><td>스트림의 아무거나 하나 반환</td></tr>\n    <tr><td>Optional&lt;T&gt; findFirst()</td><td>스트림의 첫번째 요소 반환</td></tr>\n    <tr><td>boolean allMatch(Predicate&lt;T&gt; p)</td><td>조건에 모든 요소가 만족하는지</td></tr>\n    <tr><td>boolean anyMatch(Predicate&lt;T&gt; p)</td><td>조건에 하나라도 만족하는지</td></tr>\n    <tr><td>boolean noneMatch(Predicate&lt;T&gt; p)</td><td>조건에 모두 만족하지 않는지</td></tr>\n    <tr><td>Object[] toArray()</td><td>스트림의 모든 요소를 배열로 반환</td></tr>\n    <tr><td>A[] toArray(IntFunction&lt;A[]&gt; generator)</td><td>스트림의 모든 요소를 배열로 반환</td></tr>\n    <tr><td>Optional&lt;T&gt; reduce(BinaryOperator&lt;T&gt; accumulator)</td><td rowspan=\"4\">스트림의 요소를 하나씩 줄여 가면서 계산한다.</td></tr>\n    <tr><td>T reduce(T identity, BinaryOperator&lt;T&gt; accumulator)</td></tr>\n    <tr><td>U reduce(U identity, BinaryOperator&lt;U, T, U&gt; accumulator)</td></tr>\n    <tr><td>BinaryOperator&lt;U&gt; combiner</td></tr>\n    <tr><td>R collect(Collector&lt;T, A, R&gt; collector)</td><td rowspan=\"2\">스트림의 요소를 수집한다.<br/>주로 요소를 그룹화 하거나 분할한<br/>결과를 컬렉션에 담아 반환하는데 사용한다.</td></tr>\n    <tr><td>R collect(Supplier&lt;R&gt; supplier<br/>\n      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ,BiConsumer&lt;T, R&gt; accumulator<br/>\n      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, BiConsumer&lt;R, T&gt; Combiner)</td></tr>\n  </tbody>\n</table>\n<p>미리 말하면 ‘자바의 정석’ 보고 배꼇다… 그래도 markdown + table 조합때문에 작성이 힘들었다…</p>\n<p>아무튼 중간연산은 항상 stream을 반환하는 것을 확인 할 수가 있다. 이러한 점을 활용하여 각 중간 연산을</p>\n<p>chaining 하여 편하게 사용이 가능하다. 또한 중간연산은 최종 연산을 하여야 의미가 있으므로, 최종적으로 최종 연산</p>\n<p>을 하지 않으면 실행되지 않는다(바꿔 말하면 최종 연산이 될때 중간연산을 실행함).</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">streamOperator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">//중간연산만 단독으로 실행 시, 실행되지 않는다.</span>\n  <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVo</span><span class=\"token punctuation\">></span></span> userVoStream <span class=\"token operator\">=</span> <span class=\"token function\">getMockUserList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  userVoStream<span class=\"token punctuation\">.</span><span class=\"token function\">peek</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token operator\">::</span><span class=\"token function\">println</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 소스와 표를 보면 peek 메소드는 각 요소에 일정한 작업을 하기위한 ‘중간 연산’이다.</p>\n<p>하지만 중간연산이라 화면에 표출되는 것은 아무것도 없다. 최종연산인 forEach로 바꾸던가</p>\n<p>아니면 peek 이후에 최종연산 메소드를 체이닝 하여야한다.</p>\n<p>이러한 점이 좋은 점이유는 불필요한 연산을 줄여준다는 점이다. 예를들어 스트림 요소가 무한 스트림이고</p>\n<p>그 중 중간연산에서 limit을 사용 후 중간연산 처리시 무한한 데이터를 전부 핸들링하는게 아니라 limit만큼</p>\n<p>제한 후 핸들링 하는 점이라 효율적이라고 말할 수 있다.</p>\n<h3 id=\"22-병렬처리\" style=\"position:relative;\"><a href=\"#22-%EB%B3%91%EB%A0%AC%EC%B2%98%EB%A6%AC\" aria-label=\"22 병렬처리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 병렬처리</h3>\n<p>병렬처리는 스레드를 사용 해야 할것이고 그럴때 생각 해야 할 것이 많을 것이다.</p>\n<p>하지만 stream을 사용하여 병렬 처리 시 사용자(프로그래머)는 그냥 일반 stream 사용 시 사용하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">parallelStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">IntStream</span> forParallelStream <span class=\"token operator\">=</span> <span class=\"token class-name\">IntStream</span><span class=\"token punctuation\">.</span><span class=\"token function\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    forParallelStream\n            <span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"parallel numbering : \"</span><span class=\"token operator\">+</span>n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 소스와 같이 스트림을 병렬처리 스트림으로 변경(parallel) 후 일반 스트림 같이 사용하면 된다.</p>\n<h3 id=\"22-collect\" style=\"position:relative;\"><a href=\"#22-collect\" aria-label=\"22 collect permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 collect</h3>\n<p>가공 및 처리한 데이터를 수집. 간단히 stream을 array, collection framework 등으로 형변환 한다고 생각하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">streamCollect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n  <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVo</span><span class=\"token punctuation\">></span></span> userList <span class=\"token operator\">=</span> <span class=\"token function\">getMockUserList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">//stream -> array</span>\n  <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVo</span><span class=\"token punctuation\">></span></span> toArrayStream <span class=\"token operator\">=</span> userList<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token class-name\">UserVo</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> resultArray <span class=\"token operator\">=</span> toArrayStream<span class=\"token punctuation\">.</span><span class=\"token function\">toArray</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">UserVo</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">::</span><span class=\"token keyword\">new</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>array로 변환 시, 그냥 toArray() 메소드를 호출하면된다. 하지만 여기서 Object 배열이 아닌 지정된 배열로 반환하기</p>\n<p>위해서는 toArray() 메소드에 IntFunction 인터페이스를 구현해서 넘겨줘야한다.</p>\n<p>번외로 메소드 참조에 관련해서 꽤나 부정적인 인식이 있었는데 이렇게 보니까 깔끔한것 같기는하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">streamCollect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVo</span><span class=\"token punctuation\">></span></span> userList <span class=\"token operator\">=</span> <span class=\"token function\">getMockUserList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVo</span><span class=\"token punctuation\">></span></span> toMapStream <span class=\"token operator\">=</span> userList<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserVo</span><span class=\"token punctuation\">></span></span> resultMap <span class=\"token operator\">=</span> toMapStream<span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMap</span><span class=\"token punctuation\">(</span>userVo <span class=\"token operator\">-></span> userVo<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> userVo <span class=\"token operator\">-></span> userVo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>collection framework로 변환 시, Stream.collect를 사용하고, 인자값(함수 같은 메소드)으로 toMap을 넘겨주면 된다.</p>\n<p>여기서 주의점으로 map은 (key, value)로 존재하므로 key값을 구하기 위한 Function interface, value값을 구하기 위한</p>\n<p>Function interface를 구현해서 넘겨줘야 한다. 소스를 보면 key 값으로 user name, 값으로 vo객체 그대로 넘겨주는 것을</p>\n<p>확인 할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">streamCollect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVo</span><span class=\"token punctuation\">></span></span> userList <span class=\"token operator\">=</span> <span class=\"token function\">getMockUserList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVo</span><span class=\"token punctuation\">></span></span> toListStream <span class=\"token operator\">=</span> userList<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVo</span><span class=\"token punctuation\">></span></span> resultList <span class=\"token operator\">=</span> toListStream<span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>list로 변환은 간단하다. 다른 쪽도 마찬가지지만 현재 스트림을 통해 타입 유추가 가능하므로, 그냥 리스트로 받겠다는 명령만 하면 된다.</p>\n<h3 id=\"23-map\" style=\"position:relative;\"><a href=\"#23-map\" aria-label=\"23 map permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 map</h3>\n<p>각 스트림마다 동일한 작업을 수행한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">streamMap</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> strArrStream <span class=\"token operator\">=</span> <span class=\"token class-name\">Stream</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"1_1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1_2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1_3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1_4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1_5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1_6\"</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token string\">\"2_1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2_2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2_3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2_4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2_5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2_6\"</span>\n    <span class=\"token punctuation\">,</span> <span class=\"token string\">\"3_1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"3_2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"3_3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"3_4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"3_5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"3_6\"</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  strArrStream\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token string\">\"prefix_\"</span><span class=\"token operator\">+</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token operator\">::</span><span class=\"token function\">println</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"24-flatmap\" style=\"position:relative;\"><a href=\"#24-flatmap\" aria-label=\"24 flatmap permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.4 flatMap</h3>\n<p>스트림의 타입이 배열 등인 경우, 핸들링 하기가 불편한 경우가 있을 수 있다. 예를 들어 Stream&#x3C;String[]> 같이 배열로</p>\n<p>스트림이 구성 된 경우 각 배열을 꺼내 모든 아이템을 문자열로 직렬화 하여 핸들링하는 경우가 더 편하게 느껴질 수도 있다.</p>\n<p>(개인 차에 따라 무조건 편하지 않을 수도 있다.) 그런 경우 flatMap을 사용하여 말그대로 스트림의 배열을 평평하게? 만들어 줄 수도 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">flatStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">Stream</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> strArrStream <span class=\"token operator\">=</span> <span class=\"token class-name\">Stream</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"1_1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1_2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1_3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1_4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1_5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"1_6\"</span><span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"2_1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2_2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2_3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2_4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2_5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"2_6\"</span><span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"3_1\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"3_2\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"3_3\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"3_4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"3_5\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"3_6\"</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  strArrStream\n    <span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Arrays</span><span class=\"token operator\">::</span><span class=\"token function\">stream</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token operator\">::</span><span class=\"token function\">println</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>flatMap을 사용하여 스트림 내 배열(또는 객체)로 구성된 된 아이템을 단일 원소로 구성 할 수가 있다.</p>\n<h3 id=\"25-reduce\" style=\"position:relative;\"><a href=\"#25-reduce\" aria-label=\"25 reduce permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5 reduce</h3>\n<p>처음 부터 마지막 원소까지 하나씩 처리하면서 하나의 원소로 줄여가는 작업을 수행한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">streamReduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> numberArr <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> numberStream1 <span class=\"token operator\">=</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">Integer</span> intReuslt <span class=\"token operator\">=</span> numberStream1<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>integer1<span class=\"token punctuation\">,</span> integer2<span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> integer1 <span class=\"token operator\">+</span> integer2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"integer Sum : \"</span><span class=\"token operator\">+</span>intReuslt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 소스에서 reduce 메소드에 넘겨주는 첫번째 인자값은 저장될 변수(Stream의 제너릭 타입을 따라간다)와</p>\n<p>두번째 인자로 함수를 받아 어떻게 줄여갈지를 결정한다. 위 소스는 각 원소를 순회하면서 모든 값을 더해가는 형태이다.</p>\n<p>참고로\n첫번째 사이클 : 0+1\n두번째 사이클 : 1+2\n세번째 사이클 : 3+3\n…</p>\n<h3 id=\"26-collector-구현\" style=\"position:relative;\"><a href=\"#26-collector-%EA%B5%AC%ED%98%84\" aria-label=\"26 collector 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.6 Collector 구현</h3>\n<p>스트림의 최종 연산 메소드 중 하나인 Stream.collect()를 사용하여 map, list, set 등의 형태로 수집하여</p>\n<p>반환하고 싶을 경우도 있겠지만, 경우에 따라서 내가 원하는 형태의 결과로 수집되어 받고 싶은 경우도 있을 것이다.</p>\n<p>이런 경우에 Stream.collect() 메소드의 인자값으로 Collector를 구현한 인스턴스를 넘겨주면 된다. 이것만 구현하면</p>\n<p>내부적으로 병렬 처리 시 생각해야 할 부분을 내부적으로 해결이 되므로 꽤나 편하다고 생각된다.</p>\n<p>소스가 길어지므로 collectorImpl 메소드와 CollectorImpl 클래스를 참고!</p>\n<p>참고로 CollectorImpl 클래스는 메소드(정확히 함수형 인터페이스) 표현 방법은 여러가지로 써놓았다. 모르거나</p>\n<p>어디서 무조건 배껴온거 아니다.</p>\n<p>위에서 말한 두 부분을 보기만하면 얼추 이해는 갈것이라고 생각되고, 추가로 내부적으로는 reduce를 사용한다는 점도</p>\n<p>같이 기억하면 될것이다.</p>\n<h1 id=\"3-optionalt-optionalint\" style=\"position:relative;\"><a href=\"#3-optionalt-optionalint\" aria-label=\"3 optionalt optionalint permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Optional<T> OptionalInt</h1>\n<p>java 1.8에 추가된 Optional은 제너릭 타입을 한번 wrap한 레퍼 클래스라고 생각하면 된다. 장점으로는 데이터를</p>\n<p>핸들링하다 null값 처리를 유연하게 해주는 유틸성 클래스 정도라고 생각하면 된다.</p>\n<p>참고로 Stream과는 큰 연관성은 없지만 Stream 사용시 유용하게 사용하므로 Optional을 껴놓았다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">T</span> value<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Optional</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token class-name\">Objects</span><span class=\"token punctuation\">.</span><span class=\"token function\">requireNonNull</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">T</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">T</span> value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 소스는 <code class=\"language-text\">Optional</code> Class의 일부분으로 정말 제너릭 타입(T)을 랩핑한 클래스이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">  <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">handleOptional1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Optional</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> wrapIntVal <span class=\"token operator\">=</span> <span class=\"token class-name\">Optional</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Integer</span> intVal <span class=\"token operator\">=</span> wrapIntVal<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>      <span class=\"token comment\">//intVal == 5</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>보는 바와 같이 사용법은 간단하고 <code class=\"language-text\">Optional</code> 클래스를 살펴보면 다른 유틸성 메소드가 많긴 많이 있다…</p>\n<p>아무튼 스트림과 연계하여 사용하면 편리한점이 많이 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">  <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">safeValWithOptional</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n      <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Integer</span><span class=\"token punctuation\">></span></span> mockupMap <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> findKey <span class=\"token operator\">=</span> <span class=\"token string\">\"data10\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//찾으려는 키값</span>\n\n      <span class=\"token comment\">//mock data</span>\n      mockupMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data1\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      mockupMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data2\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      mockupMap<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data3\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token class-name\">Integer</span> findVal <span class=\"token operator\">=</span> mockupMap<span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>entry <span class=\"token operator\">-></span> findKey<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>entry <span class=\"token operator\">-></span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">findAny</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>              <span class=\"token comment\">//Optional 객체가 반환된다.</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">orElse</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"검색된 값 : \"</span><span class=\"token operator\">+</span>findVal<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>데이터 스트림 값중 아무 값이나 한가지를 반환(<code class=\"language-text\">findAny</code>)하고, 만약 조건에 맞는 값이 없을 시, -1을</p>\n<p>반환하도록 짜여져 있다.</p>\n<p>OptionalInt 같은 얘들은 IntStream 처럼 불필요한 형변환으로 인한 성능저하를 막기 위하여 사용된다.</p>\n<h1 id=\"4-주의점\" style=\"position:relative;\"><a href=\"#4-%EC%A3%BC%EC%9D%98%EC%A0%90\" aria-label=\"4 주의점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 주의점</h1>\n<h3 id=\"41-데이터-원본을-변경하지-않음\" style=\"position:relative;\"><a href=\"#41-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%9B%90%EB%B3%B8%EC%9D%84-%EB%B3%80%EA%B2%BD%ED%95%98%EC%A7%80-%EC%95%8A%EC%9D%8C\" aria-label=\"41 데이터 원본을 변경하지 않음 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 데이터 원본을 변경하지 않음</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">streamOperator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVo</span><span class=\"token punctuation\">></span></span> mockUserList <span class=\"token operator\">=</span> <span class=\"token function\">getMockUserList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">UserVo</span><span class=\"token punctuation\">></span></span> userListStream <span class=\"token operator\">=</span> mockUserList<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n    userListStream\n      <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>userVo <span class=\"token operator\">-></span> userVo<span class=\"token punctuation\">.</span><span class=\"token function\">getAge</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">></span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span>\n      <span class=\"token comment\">//.peek(System.out::println)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>userVo <span class=\"token operator\">-></span> userVo<span class=\"token punctuation\">.</span><span class=\"token function\">getAuth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"master\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>userVo <span class=\"token operator\">-></span> <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>userVo<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//스트림 연산을 하여도 원본은 변경되지 않는다.</span>\n    mockUserList<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>userVo<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span><span class=\"token punctuation\">{</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span>userVo<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 소스를 보면 stream으로 변경하여 User List를 필터링 작업을 수행했다. 하지만 mockUserList의 내용을 보면</p>\n<p>그대로 변함없이 출력 되는 것을 확인 할 수 있다.</p>\n<h3 id=\"42-일회용\" style=\"position:relative;\"><a href=\"#42-%EC%9D%BC%ED%9A%8C%EC%9A%A9\" aria-label=\"42 일회용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2 일회용</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">baseStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//create stream</span>\n    <span class=\"token class-name\">Stream</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> strToStream <span class=\"token operator\">=</span> <span class=\"token class-name\">Stream</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"one\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"two\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"three\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"four\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    strToStream\n      <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>s<span class=\"token operator\">-></span>s<span class=\"token punctuation\">.</span><span class=\"token function\">equals</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"one\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token operator\">::</span><span class=\"token function\">println</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n    <span class=\"token comment\">//strToStream.forEach(System.out::println); ERROR!! 스트림은 소모성</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>스트림은 최종 연산을 수행하며 다시 재사용이 불가능하다.</p>\n<p>재사용은 불가능하지만 그래도 요청할때마다 일관된 스트림을 얻기 위해 <code class=\"language-text\">Supplier</code> 함수형 인터페이스를 사용하기도 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">baseStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//함수를 저장</span>\n    <span class=\"token class-name\">Supplier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Stream</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> getListStream <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> list<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    getListStream<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token operator\">::</span><span class=\"token function\">println</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    getListStream<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token operator\">::</span><span class=\"token function\">println</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이런식으로 list의 stream을 얻는 함수(<code class=\"language-text\">Functional interface</code>)를 사용한다. 하지만 보는바와 같이 같은 스트림을</p>\n<p>재사용하는게 아니라 각각 새로운 스트림을 얻는점은 변함이 없다.</p>\n<h3 id=\"43-내부-작업을-반복으로-처리\" style=\"position:relative;\"><a href=\"#43-%EB%82%B4%EB%B6%80-%EC%9E%91%EC%97%85%EC%9D%84-%EB%B0%98%EB%B3%B5%EC%9C%BC%EB%A1%9C-%EC%B2%98%EB%A6%AC\" aria-label=\"43 내부 작업을 반복으로 처리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.3 내부 작업을 반복으로 처리</h3>\n<p>주의점이라기 보단 3.2에 있는 소스를 보면 forEach문을 사용하여 스트림에 반복된 작업 수행이 가능하다.</p>\n<p>이는 for문을 사용하여 직접 데이터를 가져와서 작업하는 방법이 아니라, 더 간결하고 빠르게 작업이 가능하다.</p>\n<h3 id=\"44-병렬처리-thread-safe\" style=\"position:relative;\"><a href=\"#44-%EB%B3%91%EB%A0%AC%EC%B2%98%EB%A6%AC-thread-safe\" aria-label=\"44 병렬처리 thread safe permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.4 병렬처리 thread safe</h3>\n<p>아무리 병렬 처리가 쉽다고 해도, 결국엔 병렬 처리이다. 순서가 보장 되지 않으므로 이에 따른 문제가 발생 할 수도 있다.</p>\n<p>당장 2.2에 있는 소스만 봐도 순서가 보장 되지 않는 것을 확인 할 수가 있다.</p>\n<p>병렬 처리 시 thread safe 관련 해서 항상 유의해야 한다(thread safe 관련 설명은 생략).</p>\n<p>참고로 공부하면서 <code class=\"language-text\">ArrayList</code>가 경우에 따라서 thread-safe하지 않을 수도 있다는 점도 알게되었다.</p>\n<p>참고. Array List(Collections)를 thread-safe하게 사용하기</p>\n<p><a href=\"https://beginnersbook.com/2013/12/how-to-synchronize-arraylist-in-java-with-example/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://beginnersbook.com/2013/12/how-to-synchronize-arraylist-in-java-with-example/</a></p>\n<h3 id=\"45-병렬처리-시-sort\" style=\"position:relative;\"><a href=\"#45-%EB%B3%91%EB%A0%AC%EC%B2%98%EB%A6%AC-%EC%8B%9C-sort\" aria-label=\"45 병렬처리 시 sort permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5 병렬처리 시 sort</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">streamSort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">IntStream</span> intsStream <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ints</span><span class=\"token punctuation\">(</span><span class=\"token number\">30</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//intsStream.sorted().forEach(System.out::println);</span>\n    intsStream<span class=\"token punctuation\">.</span><span class=\"token function\">parallel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">-></span> value<span class=\"token operator\">></span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">sorted</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token operator\">::</span><span class=\"token function\">println</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>병렬처리의 문제점이다. 위 소스에서 filter 후 sort 시, sort는 모든 처리가 종료 된 후 마지막에 정렬이 되야 하지만</p>\n<p>병렬처리라서 실행 순서를 보장 할 수가 없다. 따라서 위 소스는 filter는 정상적으로 작동 해도, sort는 정상 작동하지 않는다.</p>\n<p>하지만 ‘forEach’메소드 대신 ‘forEachOrdered’ 사용 시, 병렬 처리 여부에 상관없이 처리가 가능하지만</p>\n<p>병렬처리로서의 이점(속도)은 줄어든다고 한다.</p>\n<h3 id=\"46-callback-hell\" style=\"position:relative;\"><a href=\"#46-callback-hell\" aria-label=\"46 callback hell permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.6 callback hell</h3>\n<p>스트림안에 스트림을 처리해야 하는 경우, 이럴때 생각나는건 javascript의 callback hell이 생각이 난다.</p>\n<p>flatMap으로 해결 할 수 있으면 좋겠지만 상황이 그렇게 좋지 않을 때 개인적으로는 딱히 해결법이 떠오르지 않는다.</p>\n<p>아쉬운데로 그냥 함수(<code class=\"language-text\">Functional interface</code>)를 넘겨줘, 그나마 가독성을 해결하려고 하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">streamSort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> map <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> strArr <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"key1\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"key2\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"key3\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"key4\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"key5\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"key6\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"key7\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//더미 데이터 입력</span>\n    <span class=\"token class-name\">Stream</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>strArr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">-></span> map<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span>strArr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Set</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> itemSetList <span class=\"token operator\">=</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">-></span> map<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>itemList <span class=\"token operator\">-></span>\n                itemList\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>item <span class=\"token operator\">-></span> <span class=\"token string\">\"update\"</span> <span class=\"token operator\">+</span> item<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 소스에서 2번째 <code class=\"language-text\">map</code>에서 다시한번 스트림을 불러와 처리를 하고 있다. 이런식으로 내부적으로 연속해서 stream을</p>\n<p>처리하다 보면 가독성이 그리 좋을꺼 같지 않다고 생각하고 있다. 그래서 2번째 <code class=\"language-text\">map</code>에 인자값으로 함수를 반환하는</p>\n<p>메소드로 대체하여 사용하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">streamSort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> map <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HashMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> strArr <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"key1\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"key2\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"key3\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"key4\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"key5\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"key6\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"key7\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//더미 데이터 입력</span>\n    <span class=\"token class-name\">Stream</span><span class=\"token punctuation\">.</span><span class=\"token function\">of</span><span class=\"token punctuation\">(</span>strArr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">-></span> map<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span>strArr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Set</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> itemSetList <span class=\"token operator\">=</span> map<span class=\"token punctuation\">.</span><span class=\"token function\">keySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>key <span class=\"token operator\">-></span> map<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>itemList <span class=\"token operator\">-></span> <span class=\"token function\">handleItemList</span><span class=\"token punctuation\">(</span>itemList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token class-name\">Supplier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Set</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> <span class=\"token function\">handleItemList</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> itemList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> itemList\n        <span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>item <span class=\"token operator\">-></span> <span class=\"token string\">\"update\"</span> <span class=\"token operator\">+</span> item<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이런식으로 하면 그나마 가독성이 좋아졌다고 생각하고 있다.</p>\n<p>함수형 언어나 javascript에서 많이 들어본 thunk, currying이 생각나게 하고 있다.</p>\n<h3 id=\"46-auto-close\" style=\"position:relative;\"><a href=\"#46-auto-close\" aria-label=\"46 auto close permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.6 auto close</h3>\n<p>아무래도 Stream을 사용하다보면 자원을 사용 후, 닫는것에 대해 예민하게 생각할 것이다.</p>\n<p>일반적으로 사용하는 <code class=\"language-text\">Stream</code>은 대부분 <code class=\"language-text\">AutoCloseable</code>를 구현하여 알아서 자원을 닫아준다.</p>\n<p>하지만 <code class=\"language-text\">Files.lines()</code> 등의 io channel을 사용하는 메소드는 주의해야 한다. 그냥 <code class=\"language-text\">try-with-resource</code> 구문을 사용</p>\n<p>시 편하게 할 수가 있다.(소스는 흔하니까 생략!)</p>\n<p>참고로 <code class=\"language-text\">Stream</code>의 하위<code class=\"language-text\">flatMap</code>, <code class=\"language-text\">concat</code>등의 메소드도 알아서 잘 닫아준다(새로운 스트림을 만들고, 이전 스트림은 close).</p>\n<ul>\n<li><a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#flatMap-java.util.function.Function-\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html#flatMap-java.util.function.Function-</a></li>\n</ul>\n<p>flatMap</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Each mapped stream is closed after its contents have been placed into this stream.</code></pre></div>\n<p>concat</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">When the resulting stream is closed, the close handlers for both input streams are invoked.</code></pre></div>\n<h3 id=\"47-병렬-처리-시-내부적으로-fork-join-framework를-사용한다\" style=\"position:relative;\"><a href=\"#47-%EB%B3%91%EB%A0%AC-%EC%B2%98%EB%A6%AC-%EC%8B%9C-%EB%82%B4%EB%B6%80%EC%A0%81%EC%9C%BC%EB%A1%9C-fork-join-framework%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%9C%EB%8B%A4\" aria-label=\"47 병렬 처리 시 내부적으로 fork join framework를 사용한다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.7 병렬 처리 시, 내부적으로 Fork Join Framework를 사용한다.</h3>\n<p>주의사항이라기 보단 참고사항인데, 병렬처리 시 기본적으로 내부에서 Fork Join Framework를 사용해서 처리한다.</p>\n<p>스레드 개수 또한 알아서 정해져 있고(기본 코어 개수) 변경은 가능하지만 추천하지는 않는다. 아무튼 이러한 방법으로</p>\n<p>내가(개발자가) 아닌 시스템이 알아서 처리하는 고수준 코딩이 가능하다.</p>\n<h3 id=\"48-checked-exception-처리-불가\" style=\"position:relative;\"><a href=\"#48-checked-exception-%EC%B2%98%EB%A6%AC-%EB%B6%88%EA%B0%80\" aria-label=\"48 checked exception 처리 불가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.8 Checked Exception 처리 불가</h3>\n<p>스트림 처리중엔 <code class=\"language-text\">Checked Exception</code>은 밖으로 던질 수가 없다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">encodeWithEx</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> str<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">UnsupportedEncodingException</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">URLEncoder</span><span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">,</span> <span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>위와 같은 메소드가 있을 때 스트림에서 Exception을 상위로 던지는걸 유도하고 싶을 수도 있지만 불가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">        strs<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">WithCheckedEx</span><span class=\"token operator\">::</span><span class=\"token function\">encodeWithEx</span><span class=\"token punctuation\">)</span>   <span class=\"token comment\">//ERROR!</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>내부적인 이유는 잘 모르겠지만 설계상 미스 or <code class=\"language-text\">Checked Exception</code>은 사실상 버려진 ? 그런 평가를 스택오버플로우에서 종종 봤다.</p>\n<p>아무튼 <code class=\"language-text\">Checked Exception</code>은 한번 랩핑해서 <code class=\"language-text\">RunTime Exception</code>으로 던지도록 할수밖에 없다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token class-name\">String</span> <span class=\"token function\">encodeWithoutEx</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> str<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token class-name\">URLEncoder</span><span class=\"token punctuation\">.</span><span class=\"token function\">encode</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">,</span> <span class=\"token string\">\"utf-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">UnsupportedEncodingException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">RuntimeException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> strs <span class=\"token operator\">=</span> <span class=\"token class-name\">Arrays</span><span class=\"token punctuation\">.</span><span class=\"token function\">asList</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"첫번째\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"두번째\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"세번째\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        strs<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">WithCheckedEx</span><span class=\"token operator\">::</span><span class=\"token function\">encodeWithoutEx</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">collect</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Collectors</span><span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>"}},{"node":{"fields":{"slug":"/posts/java/java-thread/","__typename":"MarkdownRemarkFields","categorySlug":"/category/java/"},"frontmatter":{"template":"post","title":"Thread","date":"2016-02-05T22:40:32.169Z","tags":["thread","java"],"socialImage":null,"draft":false,"description":"Thread","category":"java"},"id":"cd211a20-fde6-51bd-9998-67b3b4f741a5","html":"<h1 id=\"thread\" style=\"position:relative;\"><a href=\"#thread\" aria-label=\"thread permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Thread</h1>\n<h1 id=\"1-정의\" style=\"position:relative;\"><a href=\"#1-%EC%A0%95%EC%9D%98\" aria-label=\"1 정의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 정의</h1>\n<p>하나의 어플리케이션 안에서 여러가지 작업을 동시에 하는것을 의미. 각각의 작업을</p>\n<p>thread라고 불린다. 컴퓨터에서 프로세스(process)와 thread라는 2가지의 실행 단위가 있는데,</p>\n<p>차이점은 프로세스는 자신 만의 데이터를 가지지만 스레드들은 동일한 데이터를 공유한다.</p>\n<h3 id=\"11-스레드-상태-라이프-사이클\" style=\"position:relative;\"><a href=\"#11-%EC%8A%A4%EB%A0%88%EB%93%9C-%EC%83%81%ED%83%9C-%EB%9D%BC%EC%9D%B4%ED%94%84-%EC%82%AC%EC%9D%B4%ED%81%B4\" aria-label=\"11 스레드 상태 라이프 사이클 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 스레드 상태, 라이프 사이클</h3>\n<table>\n<thead>\n<tr>\n<th>상태</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>NEW</td>\n<td>스레드가 생성되고 아직 start()가 호출되지 않은 상태</td>\n</tr>\n<tr>\n<td>RUNNABLE</td>\n<td>실행 중 또는 실행 가능한 상태</td>\n</tr>\n<tr>\n<td>BLOCKED</td>\n<td>동기화 블럭에 의해서 일시정지된 생태(lock이 풀릴 때까지 기다리는 상태)</td>\n</tr>\n<tr>\n<td>WAITING, <br /> TIMED_WAITING</td>\n<td>스레드의 작업이 종료되지는 않았지만 실행가능하지 않은(unrunnable) 일시정지 상태. <br /> TIMED_WAITING은 일시정지 시간이 지정된 경우를 의미</td>\n</tr>\n<tr>\n<td>TERMINATED</td>\n<td>스레드의 작업이 종료된 상태</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"2-장점\" style=\"position:relative;\"><a href=\"#2-%EC%9E%A5%EC%A0%90\" aria-label=\"2 장점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 장점</h1>\n<h1 id=\"3-주요-사용법\" style=\"position:relative;\"><a href=\"#3-%EC%A3%BC%EC%9A%94-%EC%82%AC%EC%9A%A9%EB%B2%95\" aria-label=\"3 주요 사용법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 주요 사용법</h1>\n<h3 id=\"31-thread-하위-메소드\" style=\"position:relative;\"><a href=\"#31-thread-%ED%95%98%EC%9C%84-%EB%A9%94%EC%86%8C%EB%93%9C\" aria-label=\"31 thread 하위 메소드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 Thread 하위 메소드</h3>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Thread</td>\n<td>매개변수가 없는 기본 생성자</td>\n</tr>\n<tr>\n<td>Thread(String name)</td>\n<td>이름이 name인 thread 객체 생성</td>\n</tr>\n<tr>\n<td>Thread(Runnable target, String name)</td>\n<td>Runnable을 구현하는 객체로 부터 스레드를 생성</td>\n</tr>\n<tr>\n<td>static int activeCount()</td>\n<td>현재 활동 중인 스레드의 개수를 반환</td>\n</tr>\n<tr>\n<td>String getName()</td>\n<td>스레드의 이름을 반환</td>\n</tr>\n<tr>\n<td>int getPriority()</td>\n<td>스레드의 우선순위를 반환</td>\n</tr>\n<tr>\n<td>void interrupt()</td>\n<td>현재의 스레드를 중단</td>\n</tr>\n<tr>\n<td>boolean isInterrupted()</td>\n<td>현재의 스레드가 중단될 수 있는지를 검사</td>\n</tr>\n<tr>\n<td>void setPriority(int priority)</td>\n<td>스레드의 우선순위를 지정</td>\n</tr>\n<tr>\n<td>void setName(String name)</td>\n<td>스레드의 이름을 지정한다.</td>\n</tr>\n<tr>\n<td>static void sleep(int milliseconds)</td>\n<td>현재 스레드를 지정된 시간만큼 재운다.</td>\n</tr>\n<tr>\n<td>void run()</td>\n<td>스레드가 시작될 때 이 메소드가 호출. 스레드가 해야하는 작업을 구현한다.</td>\n</tr>\n<tr>\n<td>void start()</td>\n<td>스레드를 시작한다.</td>\n</tr>\n<tr>\n<td>static void yield()</td>\n<td>현재 스레드를 다른 스레드에 양보하게 만든다.</td>\n</tr>\n<tr>\n<td>void join()</td>\n<td>해당 스레드가 소멸될때까지 기다리게 한다.</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"32-우선순위\" style=\"position:relative;\"><a href=\"#32-%EC%9A%B0%EC%84%A0%EC%88%9C%EC%9C%84\" aria-label=\"32 우선순위 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 우선순위</h3>\n<p>어떠한 스레드에 더 많은 양의 실행시간이 주어져, 결과적으로 더 빨리 완료 될지 설정하는 값.</p>\n<p>최소 우선순위(1) 부터 보통 우선순위(5), 최대 우선순위(10)까지 설정 가능하고, 메인스레드는 5이다.</p>\n<p>또한 메인스레드 내에서 생성하는 스레드의 우선순위는 별다른 입력이 없을 시, 우선순위를 상속 받아,</p>\n<p>자동으로 5가 된다. 또한 우선순위 변경은 스레드를 실행 하기 전에만 우선순위 변경이 가능.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">멀티코어라고 해도 프로세서 환경에서 작업 시, 실행시간과 실행 기회를 더 많이 갖게 될 것이라고 기대할 수는 없다.\n이는 os 레벨에서 다른 방식으로 스케쥴링 하기 때문에 어떠한 os에 따라 다른 결과를 얻을 수 있다.\n따라서 os 별 스케쥴링 정책과 jvm 구현을 확인해야 한다. 따라서 환경에 상관없이 처리를 하고 싶으면\nPriorityQueue 등에 우선순위를 저장해 놓고 작업을 처리하는게 나을 수 있다.</code></pre></div>\n<h3 id=\"33-데몬-스레드\" style=\"position:relative;\"><a href=\"#33-%EB%8D%B0%EB%AA%AC-%EC%8A%A4%EB%A0%88%EB%93%9C\" aria-label=\"33 데몬 스레드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3 데몬 스레드</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">다른 일반 스레드의 작업을 돕는 보조적인 역할을 수행하는 스레드.\n일반 스레드가 모두 종료되면 데몬 스레드는 강제적으로 자동 종료됨.\n이유는 보조적인 스레드라 종속된 일반 스레드가 종료되면 의미가 없어지게 된다. 이러한\n점만 빼면 일반 스레드와 다른점이 없음. 또한 setDaemon 메소드는 start 이전에 설정해야함</code></pre></div>\n<h3 id=\"34-join다른-쓰레드의-작업을-기다린다\" style=\"position:relative;\"><a href=\"#34-join%EB%8B%A4%EB%A5%B8-%EC%93%B0%EB%A0%88%EB%93%9C%EC%9D%98-%EC%9E%91%EC%97%85%EC%9D%84-%EA%B8%B0%EB%8B%A4%EB%A6%B0%EB%8B%A4\" aria-label=\"34 join다른 쓰레드의 작업을 기다린다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.4 join(다른 쓰레드의 작업을 기다린다)</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">쓰레드 자신이 하던 작업을 잠시 멈추고 다른 쓰레드가 지정된 시간동안 작업을 수행하도록\n할때 join()을 사용한다. 현재 쓰레드가 아닌 특정 쓰레드에 대해 동작하는점이 sleep()과 다르다.</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">baseThread2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">InterruptedException</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">int</span> triesCount <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">Thread</span> threadForSleep <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Thread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">ConcreteInterface1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        threadForSleep<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>threadForSleep<span class=\"token punctuation\">.</span><span class=\"token function\">isAlive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token function\">printMsg</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"threadForSleep 아직 살아있음\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            triesCount<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n            threadForSleep<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//3초간 스레드 종료를 기다리고, 3초가 지나면 넘어감.</span>\n\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>triesCount <span class=\"token operator\">></span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token function\">printMsg</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"강제 인터럽트\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                threadForSleep<span class=\"token punctuation\">.</span><span class=\"token function\">interrupt</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                threadForSleep<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>          <span class=\"token comment\">//스레드가 종료할때까지 무한 대기</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"threadForSleep 스레드 종료\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 소스에서 <code class=\"language-text\">join</code>은 다른 스레드가 종료할때 까지 기다리게 된다. 참고로 sleep과 마찬가지로 대기 중</p>\n<p>interrupt가 들어올 수 있으며, interrupt가 들어올 시, exception이 발동된다(위 소스에선 그런거 고려안함)</p>\n<h1 id=\"4-동기화\" style=\"position:relative;\"><a href=\"#4-%EB%8F%99%EA%B8%B0%ED%99%94\" aria-label=\"4 동기화 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 동기화</h1>\n<h3 id=\"41-synchronized\" style=\"position:relative;\"><a href=\"#41-synchronized\" aria-label=\"41 synchronized permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 synchronized()</h3>\n<p>lock, transaction, thread-safe 등의 관련 설명은 패스!</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Buffer</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">int</span> data<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">boolean</span> empty <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">int</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>empty<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//생산될 때 까지 기다린다.</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        empty <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">notifyAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> data<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">synchronized</span> <span class=\"token keyword\">void</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>empty<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">wait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//소비 될 때까지 기다린다.</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">printStackTrace</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n\n        empty <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">notifyAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여러 스레드 안에서도 안전하게 데이터를 핸들링하기 위해서 <code class=\"language-text\">synchronized</code>를 사용한다.</p>\n<p>즉, thread-safe를 위하여 공통된 임계구역을 지정하고 특정 메소드 또는 블럭을 지정하여 <code class=\"language-text\">synchronized</code>사용하면 항상</p>\n<p>일관된 데이터를 얻을 수가 있다.</p>\n<p>참고로 특정 블럭에 <code class=\"language-text\">synchronized</code>적용 시</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">synchronized</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//TODO : handle critical data</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 소스에서 this는 critical한 data를 지정하고(보통 this이지만 아닐수도 있음) 내부 블록에서 lock을 얻어 사용해야할</p>\n<p>처리를 정의해주기만 하면 된다. 또한 메소드 통째로가 아닌 블록으로 지정하여 동기화 하였을 시, 특정 블록만 lock을 걸어서</p>\n<p>아무래도 메소드 전체보다는 빠를수 밖에 없다. 참고로 <code class=\"language-text\">synchronized</code> 안에서 예외가 발생하여도 lock은 자동적으로 풀린다.</p>\n<h3 id=\"42-wait-notify\" style=\"position:relative;\"><a href=\"#42-wait-notify\" aria-label=\"42 wait notify permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2 wait(), notify()</h3>\n<ul>\n<li>Object에 정의되어 있다(따로 import x)</li>\n<li>동기화 블록(synchronized)내에서만 사용할 수 있다.</li>\n<li>wait는 lock을 반납하고 대기</li>\n<li>notify를 호출하면 작업을 중단했던 스레드가 다시 락을 얻어 작업을 진행</li>\n</ul>\n<p>위 <code class=\"language-text\">4.1</code> 소스에서 <code class=\"language-text\">synchronized</code>안에 <code class=\"language-text\">wait()</code>, <code class=\"language-text\">notifyAll()</code>를 사용하고 있다.</p>\n<p><code class=\"language-text\">get</code>, <code class=\"language-text\">put</code> 메소드 내부에서는 임계구역(<code class=\"language-text\">synchronized</code>)이므로 lock을 얻은 뒤, 다른 작업 처리를 기다리기</p>\n<p>위해 현재 스레드의 lock을 반납하고 대기(<code class=\"language-text\">wait()</code>) 하고 있다가, <code class=\"language-text\">notify</code> 또는 <code class=\"language-text\">notifyAll</code>에 의해 다시 처리가</p>\n<p>계속 진행되게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">notify()와 notifyAll()의 차이점은 notify()는 waiting pool에서 대기 중인 스레드 중 하나를 임의로 선택하여\n그 스레드한테만 알려주지만, notifyAll()은 모든 waiting pool에 대기중은 스레드에게 알려준다. 따라서 notify()는\n경우에따라서 원하는 스레드에게 알림이 안갈 수도 있고, notifyAll()은 모든 스레드에게 알림이 가지만 프로세서를 할당\n받지 못한 스레드는 다시 waiting pool로 들어가게 된다.</code></pre></div>\n<h3 id=\"43-volatile\" style=\"position:relative;\"><a href=\"#43-volatile\" aria-label=\"43 volatile permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.3 volatile</h3>\n<p>스레드 환경에서 각 프로세서에서 특정 필드 데이터를 캐싱하여 사용하면 캐시와 메모리 간 데이터가 불일치 하고, 따라서</p>\n<p>여러 프로세서에서 값이 불일치 하는 경우가 발생할 수도 있다. 이러한 케이스를 방지하기 위해 <code class=\"language-text\">volatile</code> 키워드를 사용하여</p>\n<p>변수 선언 시, ‘이 변수에 값은 캐시가 아닌 항상 메모리에서 읽어들이겠다’ 라는 뜻이 된다. 따라서 항상 프로세서 별로 동일한</p>\n<p>값이 보장되게 된다. <code class=\"language-text\">synchronized</code>를 사용해도 값이 보장되지 않는다면 위 내용을 의심해봐야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token class-name\">ThreadTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">volatile</span> <span class=\"token keyword\">int</span> inMemoryData <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위의 <code class=\"language-text\">inMemoryData</code> 값은 항상 캐시에 저장되지 않고 오로지 메모리에서만 저장되므로, 여러 스레드에서 프로세서 별로</p>\n<p>캐싱된 데이터로 사용하지 않고 항상 메모리에서 읽어들이게 된다.</p>\n<h3 id=\"44-lock-condition을-이용한-동기화\" style=\"position:relative;\"><a href=\"#44-lock-condition%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EB%8F%99%EA%B8%B0%ED%99%94\" aria-label=\"44 lock condition을 이용한 동기화 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.4 lock, condition을 이용한 동기화</h3>\n<h4 id=\"441-lock\" style=\"position:relative;\"><a href=\"#441-lock\" aria-label=\"441 lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.4.1 lock</h4>\n<h4 id=\"442-condition\" style=\"position:relative;\"><a href=\"#442-condition\" aria-label=\"442 condition permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.4.2 condition</h4>\n<p><code class=\"language-text\">wait()</code>와 <code class=\"language-text\">notify()</code>, <code class=\"language-text\">notifyAll()</code>은 특정 스레드를 대기, 알림 통지하지 못한다는 한계점이 있다.</p>\n<p>이에 <code class=\"language-text\">Condition</code>은 스레드를 그룹화 하고 그 그룹에게만 알림을 보낼 수가 있다.</p>\n<table>\n<thead>\n<tr>\n<th>Object</th>\n<th>Condotion</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>void wait()</td>\n<td>void await() <br /> void awaitUninterruptibly()</td>\n</tr>\n<tr>\n<td>void await(long timeout)</td>\n<td>boolean await(long time, TimeUnit unit) <br /> long awaitNanos(long nanosTimeout) <br /> boolean awaitUntil(Date deadline)</td>\n</tr>\n<tr>\n<td>void notify()</td>\n<td>void signal()</td>\n</tr>\n<tr>\n<td>void notifyAll()</td>\n<td>void signalAll()</td>\n</tr>\n</tbody>\n</table>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">int</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        lock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span>empty<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                putCond<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            empty <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n            getCond<span class=\"token punctuation\">.</span><span class=\"token function\">signal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"인터럽트 감지. \"</span><span class=\"token operator\">+</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n            lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> data<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">put</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        lock<span class=\"token punctuation\">.</span><span class=\"token function\">lock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">while</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>empty<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                getCond<span class=\"token punctuation\">.</span><span class=\"token function\">await</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            empty <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<span class=\"token punctuation\">;</span>\n\n            putCond<span class=\"token punctuation\">.</span><span class=\"token function\">signal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">InterruptedException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token class-name\">System</span><span class=\"token punctuation\">.</span>out<span class=\"token punctuation\">.</span><span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"인터럽트 감지. \"</span><span class=\"token operator\">+</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n            lock<span class=\"token punctuation\">.</span><span class=\"token function\">unlock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>핵심은 <code class=\"language-text\">Condition</code>의 인스턴스인 <code class=\"language-text\">getCond</code>객체와 <code class=\"language-text\">putCond</code>객체이다. 각 인스턴스는 특정 객체를 대기, 알림을 받을 수가 있어서</p>\n<p>소스에선 <code class=\"language-text\">put</code>과 <code class=\"language-text\">get</code>메소드는 크로스 형태로 대기, 알림을 직접적으로 알려줄 수가 있다. 물론 이런 형태는 인터럽트를 발생 시</p>\n<p>오히려 무한루프에 빠질수 있는 취약한 구조이므로 실무에서 써먹을려면 잘 생각해야한다.(물론 <code class=\"language-text\">condition</code>의 단점이라기보단 스레드가 그렇다)</p>\n<h3 id=\"45-fork-join-프레임워크\" style=\"position:relative;\"><a href=\"#45-fork-join-%ED%94%84%EB%A0%88%EC%9E%84%EC%9B%8C%ED%81%AC\" aria-label=\"45 fork join 프레임워크 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.5 fork, join 프레임워크</h3>\n<p>fork, join 프레임워크는 하나의 작업을 작은 작업으로 분할하여 큐에 담은 다음, 각 스레드에서 큐에 담긴 작업을 하나씩 잡고</p>\n<p>처리하도록 설계되어 있다. 따라서 특정 스레드가 따로 노는 일이 없으므로 빠른 처리가 가능하다. 물론 선행, 후행 작업이</p>\n<p>있으므로 오버헤드가 나는 케이스도 발생할 수 있다. 아무튼 그래서 작업을 나누는(fork) 처리와 다시 합치는(join) 부분(compute)</p>\n<p>을 구현해야한다.</p>\n<h1 id=\"5-주의할점\" style=\"position:relative;\"><a href=\"#5-%EC%A3%BC%EC%9D%98%ED%95%A0%EC%A0%90\" aria-label=\"5 주의할점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 주의할점</h1>\n<h3 id=\"51-독립적인-stack에서-실행됨\" style=\"position:relative;\"><a href=\"#51-%EB%8F%85%EB%A6%BD%EC%A0%81%EC%9D%B8-stack%EC%97%90%EC%84%9C-%EC%8B%A4%ED%96%89%EB%90%A8\" aria-label=\"51 독립적인 stack에서 실행됨 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.1 독립적인 stack에서 실행됨</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">stack trace를 사용시 확인 가능. 따라서 한 스레드가 예외가 발생해서 종료되어도 다른 스레드의 실행에는\n영향을 미치지 않는다. run, start 메소드에 따라 호출 스택이 달라짐</code></pre></div>\n<ul>\n<li>소스 내 <code class=\"language-text\">checkCallStack</code>메소드를 스레드 <code class=\"language-text\">run</code>으로 호출 시 call stack</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">java.lang.Exception: Exception\nat thread.items.CheckCallStack.throwException(CheckCallStack.java:12)\nat thread.items.CheckCallStack.run(CheckCallStack.java:7)\nat java.lang.Thread.run(Thread.java:745)\nat thread.ThreadMain.checkCallStack(ThreadMain.java:133)\nat thread.ThreadMain.main(ThreadMain.java:26)\nPicked up JAVA_TOOL_OPTIONS: -Djava.net.preferIPv4Stack=true</code></pre></div>\n<ul>\n<li>소스내 <code class=\"language-text\">checkCallStack</code>메소드를 스레드 <code class=\"language-text\">start()</code>으로 호출 시 call stack</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">java.lang.Exception: Exception\nat thread.items.CheckCallStack.throwException(CheckCallStack.java:12)\nat thread.items.CheckCallStack.run(CheckCallStack.java:7)\nat java.lang.Thread.run(Thread.java:745)</code></pre></div>\n<p><code class=\"language-text\">run</code>을 통해 새로운 스레드 환경이 아닌 일반 메소드로 호출 시, callstack 최하단에 <code class=\"language-text\">main</code> 메소드에서 부터 callstack이 쌓이는 것을 확인 할 수가</p>\n<p>있다. 하지만 <code class=\"language-text\">start</code>를 써서 새로운 스레드 환경에서 호출 시, 독립적인 stack으로 옮겨 실행 되므로 callstack의 최하단에는 <code class=\"language-text\">main</code>메소드가 아닌</p>\n<p><code class=\"language-text\">Thread</code>에서 부터 시작하는 것을 확인 할 수가 있다.</p>\n<h3 id=\"52-한번-실행이-종료된-스레드는-다시-실행-할-수-없다\" style=\"position:relative;\"><a href=\"#52-%ED%95%9C%EB%B2%88-%EC%8B%A4%ED%96%89%EC%9D%B4-%EC%A2%85%EB%A3%8C%EB%90%9C-%EC%8A%A4%EB%A0%88%EB%93%9C%EB%8A%94-%EB%8B%A4%EC%8B%9C-%EC%8B%A4%ED%96%89-%ED%95%A0-%EC%88%98-%EC%97%86%EB%8B%A4\" aria-label=\"52 한번 실행이 종료된 스레드는 다시 실행 할 수 없다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.2 한번 실행이 종료된 스레드는 다시 실행 할 수 없다.</h3>\n<h3 id=\"53-sleep은-항상-현재-실행-중인-쓰레드에-대해-작동한다\" style=\"position:relative;\"><a href=\"#53-sleep%EC%9D%80-%ED%95%AD%EC%83%81-%ED%98%84%EC%9E%AC-%EC%8B%A4%ED%96%89-%EC%A4%91%EC%9D%B8-%EC%93%B0%EB%A0%88%EB%93%9C%EC%97%90-%EB%8C%80%ED%95%B4-%EC%9E%91%EB%8F%99%ED%95%9C%EB%8B%A4\" aria-label=\"53 sleep은 항상 현재 실행 중인 쓰레드에 대해 작동한다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.3 sleep은 항상 현재 실행 중인 쓰레드에 대해 작동한다.</h3>\n<p><code class=\"language-text\">sleep</code> 메소드는 현재 실행 중인 스레드에 대해서만 반응한다.</p>\n<p>따라서 인스턴스에서 호출하는건 의미가 없다 (태생이 static method 이다)</p>\n<h3 id=\"6-참고자료\" style=\"position:relative;\"><a href=\"#6-%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C\" aria-label=\"6 참고자료 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. 참고자료</h3>\n<ul>\n<li>\n<p>스레드, 스레드 풀 관련 설명 : <a href=\"http://hamait.tistory.com/612\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://hamait.tistory.com/612</a></p>\n</li>\n<li>\n<p>병렬처리 관련 설명. ForkJoin프레임워크 포함 : <a href=\"https://www.popit.kr/java8-stream%EC%9D%98-parallel-%EC%B2%98%EB%A6%AC/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.popit.kr/java8-stream%EC%9D%98-parallel-%EC%B2%98%EB%A6%AC/</a></p>\n</li>\n</ul>"}},{"node":{"fields":{"slug":"/posts/java/kotlin-variance/","__typename":"MarkdownRemarkFields","categorySlug":"/category/java/"},"frontmatter":{"template":"post","title":"Kotlin - 변성","date":"2021-04-16T08:36:05.678Z","tags":null,"socialImage":null,"draft":false,"description":"generic 타입의 상위, 하위 타입의 제한 사항 및 일부 유연하게 사용하고 싶을때","category":"java"},"id":"d507babd-6660-523c-ac9f-3e8efd313daf","html":"<h2 id=\"변성\" style=\"position:relative;\"><a href=\"#%EB%B3%80%EC%84%B1\" aria-label=\"변성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>변성</h2>\n<p>파라미터화한 타입이 서로 어떤 하위 타입 관계에 있는지 결정하는 방식을 말함</p>\n<h2 id=\"변성이-문제되는-이유\" style=\"position:relative;\"><a href=\"#%EB%B3%80%EC%84%B1%EC%9D%B4-%EB%AC%B8%EC%A0%9C%EB%90%98%EB%8A%94-%EC%9D%B4%EC%9C%A0\" aria-label=\"변성이 문제되는 이유 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>변성이 문제되는 이유</h2>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> intArr <span class=\"token operator\">:</span> MutableList<span class=\"token operator\">&lt;</span>Int<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">mutableListOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> numberArr <span class=\"token operator\">:</span>MutableList<span class=\"token operator\">&lt;</span>Number<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">mutableListOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> numberArr2 <span class=\"token operator\">:</span>MutableList<span class=\"token operator\">&lt;</span>Number<span class=\"token operator\">></span> <span class=\"token operator\">=</span> intArr    <span class=\"token comment\">//error!</span></code></pre></div>\n<p>Int는 Number를 확장한 형태니까 논리적으로 충분히 받아 들여 사용 할수도 있어 보이지만 그렇지 못함. 기본적으로 제너릭 타입은 무공변성이라, T가 T1의 부모 타입이라도 List<T>와 List<T1> 사이에는 아무런 부모 자식 관계가 아니다\n이렇게 쓰고 싶으면 컴파일러한테 상위타입처럼 쓸수 있도록 알려줘야한다. 상위 타입으로 써도 안전한 이유는 Number타입은 처리할때 오직 읽기 전용으로 쓴다는걸 문법적으로 보장 하는걸 말한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> intArr <span class=\"token operator\">:</span> MutableList<span class=\"token operator\">&lt;</span>Int<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">mutableListOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> numberArr <span class=\"token operator\">:</span>MutableList<span class=\"token operator\">&lt;</span>Number<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">mutableListOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> numberArr2 <span class=\"token operator\">:</span>MutableList<span class=\"token operator\">&lt;</span><span class=\"token keyword\">out</span> Number<span class=\"token operator\">></span> <span class=\"token operator\">=</span> intArr</code></pre></div>\n<p>반대로 <code class=\"language-text\">in</code> 이라는 키워드는 쓰기 전용으로 상위 오브젝트를 하위 오브젝트에 담을수가 있다</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> intArr <span class=\"token operator\">:</span> MutableList<span class=\"token operator\">&lt;</span>Int<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">mutableListOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> numberArr <span class=\"token operator\">:</span>MutableList<span class=\"token operator\">&lt;</span>Number<span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token function\">mutableListOf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">val</span> intArr2 <span class=\"token operator\">:</span>MutableList<span class=\"token operator\">&lt;</span><span class=\"token keyword\">in</span> Int<span class=\"token operator\">></span> <span class=\"token operator\">=</span> numberArr</code></pre></div>\n<table>\n<thead>\n<tr>\n<th>변성</th>\n<th>설명</th>\n<th>kotlin</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>공변성(covariant)</td>\n<td>T1이 T의 하위 타입이면 C&#x3C;T1>은 C&#x3C;T>의 서브 타입이다</td>\n<td>C&#x3C;T1> 은 C&#x3C;out T>의 서브타입이다.</td>\n</tr>\n<tr>\n<td>반공변성(contravariant)</td>\n<td>T1이 T의 하위 타입이면 C&#x3C;T>은 C&#x3C;T1>의 서브 타입이다</td>\n<td>C&#x3C;T> 은 C&#x3C;in T1>의 서브타입이다.</td>\n</tr>\n<tr>\n<td>무공변성(invariant)</td>\n<td>C&#x3C;T>와 C&#x3C;T1>는 아무관계 없다</td>\n<td>C&#x3C;T>는 오직 C&#x3C;T>만 관계가 있다</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"읽기-쓰기-전용\" style=\"position:relative;\"><a href=\"#%EC%9D%BD%EA%B8%B0-%EC%93%B0%EA%B8%B0-%EC%A0%84%EC%9A%A9\" aria-label=\"읽기 쓰기 전용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>읽기, 쓰기 전용</h2>\n<p><code class=\"language-text\">out</code>은 read 전용, <code class=\"language-text\">in</code>은 write 전용이라 평가받는다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">interface</span> UsingInOut<span class=\"token operator\">&lt;</span><span class=\"token keyword\">out</span> T1<span class=\"token punctuation\">,</span> <span class=\"token keyword\">in</span> T2<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> T1       <span class=\"token comment\">//값을 내보낼 수만 있다</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">use</span><span class=\"token punctuation\">(</span>t2<span class=\"token operator\">:</span> T2<span class=\"token punctuation\">)</span>     <span class=\"token comment\">//값을 받을 수만 있다</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">무공변성(invariant)</code> 제약 일부를 없애주는 대신, <code class=\"language-text\">out</code> 키워드는 오직 생산(read)만을, <code class=\"language-text\">in</code> 키워드는 오직 사용만이 가능하도록 설계되었다. 근데 read 전용 이긴 하지만 불변성을 보장하진 않는다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">val</span> numberArr2 <span class=\"token operator\">:</span>MutableList<span class=\"token operator\">&lt;</span><span class=\"token keyword\">out</span> Number<span class=\"token operator\">></span> <span class=\"token operator\">=</span> intArr\nnumberArr2<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//이건 가능</span></code></pre></div>\n<table>\n<thead>\n<tr>\n<th>Kotlin</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>out</td>\n<td>생산하긴 하지만 소비하지 않음(read 전용)</td>\n</tr>\n<tr>\n<td>in</td>\n<td>소비하긴 하지만 생산하지 않음(write 전용)</td>\n</tr>\n<tr>\n<td>(따로 지정x)</td>\n<td>생산 &#x26; 소비 가능(read, write 가능)</td>\n</tr>\n</tbody>\n</table>"}},{"node":{"fields":{"slug":"/posts/js/js-closure/","__typename":"MarkdownRemarkFields","categorySlug":"/category/javascript/"},"frontmatter":{"template":"post","title":"Closure","date":"2016-02-06T22:40:32.169Z","tags":["js","closure","scope"],"socialImage":null,"draft":false,"description":"private, scope등 개념을 활용, 변수의 유효범위를 늘린다.","category":"javascript"},"id":"8b87ece3-d1aa-5820-b368-fd074e0adbcc","html":"<h1 id=\"closure\" style=\"position:relative;\"><a href=\"#closure\" aria-label=\"closure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>closure.</h1>\n<h1 id=\"1-정의\" style=\"position:relative;\"><a href=\"#1-%EC%A0%95%EC%9D%98\" aria-label=\"1 정의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 정의</h1>\n<p>변수 등의 유효범위를 늘림.</p>\n<p>조금 길게 말하면, 함수를 렉시컬 스코프 밖에서 호출해도 함수는 자신의 렉시컬 스코프를 기억하고 접근할 수 있는 특성이다. 바꿔 말하면 렉시컬 스코프만 명확하게 기억하면 클로저 자체는 이해하는데 무리가 없을 것이라고 생각된다.</p>\n<h1 id=\"2-주요-내용\" style=\"position:relative;\"><a href=\"#2-%EC%A3%BC%EC%9A%94-%EB%82%B4%EC%9A%A9\" aria-label=\"2 주요 내용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 주요 내용</h1>\n<h3 id=\"21-기본-내용\" style=\"position:relative;\"><a href=\"#21-%EA%B8%B0%EB%B3%B8-%EB%82%B4%EC%9A%A9\" aria-label=\"21 기본 내용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 기본 내용</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">closure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> innerVal <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">getInnerVal</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> innerVal<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">setInnerVal</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_val</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      innerVal <span class=\"token operator\">=</span> _val<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> closureFunc <span class=\"token operator\">=</span> <span class=\"token function\">closure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nclosureFunc<span class=\"token punctuation\">.</span><span class=\"token function\">getInnerVal</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//10</span></code></pre></div>\n<p>소스를 설명하자면 ‘closure1’의 내부 값인 ‘innerVal’의 값을 반환되는 함수 ‘getInnerVal’와 ‘getInnerVal’를 통해서 접근이 가능하다는 점을 볼수가 있다. 원래대로라면 바깥 스코프에서 안에 있는 스코프에 접근 할 수도 없고, 변수 ‘innerVal’는 gc 대상이 될 것이라는 생각이 들겠지만 반환되는 ‘getInnerVal’와 ‘getInnerVal’로 접근이 가능하므로, gc 대상에서도 벗어나게 된다.</p>\n<h3 id=\"22-선언-시-결정됨\" style=\"position:relative;\"><a href=\"#22-%EC%84%A0%EC%96%B8-%EC%8B%9C-%EA%B2%B0%EC%A0%95%EB%90%A8\" aria-label=\"22 선언 시 결정됨 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 선언 시 결정됨</h3>\n<p>스코프 관련해서 똑같은 내용이고 당연히 적용되는 내용이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> setter<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> getter<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">closure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> innerVal <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function-variable function\">getter</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> innerVal<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function-variable function\">setter</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">_val</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    innerVal <span class=\"token operator\">=</span> _val<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">closure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//10</span>\n<span class=\"token function\">setter</span><span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//50</span>\n<span class=\"token function\">getter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//50</span></code></pre></div>\n<p>단순 getter, setter의 유효범위는 전역 스코프에 속해 있고 변수 innerVal의 유효범위는 closure 함수에 속해 있다. getter, setter의 유효범위와 상관없이 내부에서 함수를 주입하고, 주입된 함수의 유효범위는 선언 될 시 결정이 된다.</p>\n<h1 id=\"3-사용-범위\" style=\"position:relative;\"><a href=\"#3-%EC%82%AC%EC%9A%A9-%EB%B2%94%EC%9C%84\" aria-label=\"3 사용 범위 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 사용 범위</h1>\n<h3 id=\"31-이벤트-바인딩\" style=\"position:relative;\"><a href=\"#31-%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EB%B0%94%EC%9D%B8%EB%94%A9\" aria-label=\"31 이벤트 바인딩 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 이벤트 바인딩</h3>\n<p>단순 html의 이벤트 바인딩, 또는 jquery의 이벤트 바인딩 등에서도 이 클로저를 이용된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">bindEvent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> innerData <span class=\"token operator\">=</span> <span class=\"token string\">\"inner scope data\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#bindBtn\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"click\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>innerData<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">bindEvent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>외부에서 innerData 변수에 접근 할 수 없지만 이벤트 발동 시, 값(렉시컬 스코프)을 기억하고 정상적으로 표출된다.</p>\n<h3 id=\"32-모듈화\" style=\"position:relative;\"><a href=\"#32-%EB%AA%A8%EB%93%88%ED%99%94\" aria-label=\"32 모듈화 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 모듈화</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> MyModules <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">Manager</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> modules <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name<span class=\"token punctuation\">,</span> deps<span class=\"token punctuation\">,</span> impl</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> deps<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      deps<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> modules<span class=\"token punctuation\">[</span>deps<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    modules<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">impl</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>impl<span class=\"token punctuation\">,</span> deps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> modules<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">define</span><span class=\"token operator\">:</span> define<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">get</span><span class=\"token operator\">:</span> get<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>es 6 이상에서 import, export 등의 키워드(또는 require)를 사용해서 모듈화 된 스크립트를 사용 할 수도 있다. 이는 각 파일(정확히는 모듈)마다 독립적인 렉시컬 스코프를 제공해야 한다. 위에 소스는 각 모듈마다 독립적인 렉시컬 스코프를 제공하려는 목적으로 작성이 되었다. 내부 this 바인딩 관련해서 문제가 생길 수도 있으니, 실제로 사용하지는 말고 ‘모듈화 시 각각 독립적인 스코프를 제공한다’ 라는 초점으로만 확인!</p>"}},{"node":{"fields":{"slug":"/posts/js/js-destructuring/","__typename":"MarkdownRemarkFields","categorySlug":"/category/javascript/"},"frontmatter":{"template":"post","title":"구조 분해 & 할당","date":"2021-04-06T00:41:24.507Z","tags":["js"],"socialImage":null,"draft":false,"description":"Object를 그때그때 유연하게 spread 하여 사용","category":"javascript"},"id":"9678330c-e594-59a2-8393-481ff9ce990b","html":"<h1 id=\"destructuring\" style=\"position:relative;\"><a href=\"#destructuring\" aria-label=\"destructuring permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Destructuring</h1>\n<h1 id=\"1-array-타입-구조분해\" style=\"position:relative;\"><a href=\"#1-array-%ED%83%80%EC%9E%85-%EA%B5%AC%EC%A1%B0%EB%B6%84%ED%95%B4\" aria-label=\"1 array 타입 구조분해 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Array 타입 구조분해</h1>\n<p>기본적으로 <code class=\"language-text\">Array</code>는 저장된 순서대로 펼치기가 가능하다</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> arr<span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//1 2 3</span></code></pre></div>\n<p><code class=\"language-text\">null</code>, 직접 <code class=\"language-text\">undefined</code> 할당, 정의 되지 않은 상태(<code class=\"language-text\">undefined</code>) 일때 각 출력과 기본값 할당이 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> e <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> arr<span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//1 null, undefined, undefined</span></code></pre></div>\n<h1 id=\"2-object-타입-구조분해\" style=\"position:relative;\"><a href=\"#2-object-%ED%83%80%EC%9E%85-%EA%B5%AC%EC%A1%B0%EB%B6%84%ED%95%B4\" aria-label=\"2 object 타입 구조분해 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Object 타입 구조분해</h1>\n<p>기본적으로 <code class=\"language-text\">key</code> 값을 기준으로 값을 펼칠수가 있고, key값을 변경 하고 싶을땐 <code class=\"language-text\">b:f</code>와 같이 하면 문법적으로 <code class=\"language-text\">const f=obj.b</code>와 같이 사용이 가능하다</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">a</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">b</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">c</span><span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> a<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">b</span><span class=\"token operator\">:</span> f<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">,</span> d <span class=\"token operator\">=</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> f<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">,</span> d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>구조 분해한걸 다시 구조분해</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">a</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">b</span><span class=\"token operator\">:</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">c</span><span class=\"token operator\">:</span> <span class=\"token number\">7</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">a</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> b<span class=\"token punctuation\">,</span> c <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">,</span> c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이런식으로 쉽게 펼치기가 가능하고 물론 변수명 변경 및 기본값 할당이 가능하다 주의 점은 존재하지 않은 key 값으로 구조분해를 시도하면 에러난다.</p>\n<h1 id=\"3-spread\" style=\"position:relative;\"><a href=\"#3-spread\" aria-label=\"3 spread permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Spread</h1>\n<p>아래처럼 Array는 기본적으로 분해가 가능함</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> combinedArr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>arr<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>combinedArr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//[1, 2, 3, 4, 5, 6]</span></code></pre></div>\n<p>프로퍼티들을 순회 하면서 하나씩 spread씩 하게 해준다. 기본 json 타입에서도 가능하며, 객체를 합쳐지는 효과로도 많이 사용된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">a</span><span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">b</span><span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">c</span><span class=\"token operator\">:</span> <span class=\"token number\">3</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token operator\">...</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">b</span><span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">c</span><span class=\"token operator\">:</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//{a: 1, b: 4, c: 5} 나중에 전개된 b, c로 값이 변경됨</span></code></pre></div>\n<p>전개(<code class=\"language-text\">...</code>)구문은 순회가 가능하면(<code class=\"language-text\">iterable</code>) 사용 가능하며, 배열의 중복 제거도 유용하게 사용 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//Set &amp; spread를 활용해서 array 중복 제거</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//1 2 3 4</span></code></pre></div>\n<h1 id=\"4-rest-parameter\" style=\"position:relative;\"><a href=\"#4-rest-parameter\" aria-label=\"4 rest parameter permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Rest Parameter</h1>\n<p><code class=\"language-text\">Rest Parameter</code>는 자바에서 가변인자, 코틀린에서 <code class=\"language-text\">vararg</code>를 생각하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">restFunc</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>rest</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>rest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//[1, 2, 3]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">restFunc2</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">ignore<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>rest</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>rest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//[2, 3]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">restFunc</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>"}},{"node":{"fields":{"slug":"/posts/js/js-generator/","__typename":"MarkdownRemarkFields","categorySlug":"/category/javascript/"},"frontmatter":{"template":"post","title":"Generator","date":"2020-05-21T00:37:15.710Z","tags":["js","async"],"socialImage":null,"draft":false,"description":"비동기 로직을 동기식으로 & 메세징 통신을 하고 싶을때","category":"javascript"},"id":"fe08b9c3-1a54-5ebe-9446-24c8ebbe552b","html":"<h1 id=\"generator\" style=\"position:relative;\"><a href=\"#generator\" aria-label=\"generator permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Generator.</h1>\n<h1 id=\"1-정의\" style=\"position:relative;\"><a href=\"#1-%EC%A0%95%EC%9D%98\" aria-label=\"1 정의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 정의</h1>\n<p>javascript에서 기본적인 함수의 완전 실행이 아닌 중간중간 <code class=\"language-text\">generator</code> 함수 호출부와 메세징(통신)이 가능한 함수</p>\n<h1 id=\"2-주요-내용\" style=\"position:relative;\"><a href=\"#2-%EC%A3%BC%EC%9A%94-%EB%82%B4%EC%9A%A9\" aria-label=\"2 주요 내용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 주요 내용</h1>\n<h2 id=\"21-실행-범위\" style=\"position:relative;\"><a href=\"#21-%EC%8B%A4%ED%96%89-%EB%B2%94%EC%9C%84\" aria-label=\"21 실행 범위 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 실행 범위</h2>\n<p><code class=\"language-text\">generator</code>를 실행 후, <code class=\"language-text\">next()</code> 함수를 실행 시 <code class=\"language-text\">yield</code>를 만나기 직전 or <code class=\"language-text\">return</code> 까지 실행.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span><span class=\"token operator\">*</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"point 1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">yield</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"point 2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> _it <span class=\"token operator\">=</span> <span class=\"token function\">foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n_it<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//point 1</span>\n_it<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//point 2</span></code></pre></div>\n<h2 id=\"22-값을-주고-받을-수-있음\" style=\"position:relative;\"><a href=\"#22-%EA%B0%92%EC%9D%84-%EC%A3%BC%EA%B3%A0-%EB%B0%9B%EC%9D%84-%EC%88%98-%EC%9E%88%EC%9D%8C\" aria-label=\"22 값을 주고 받을 수 있음 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 값을 주고 받을 수 있음</h2>\n<p><code class=\"language-text\">generator</code> 내부에서 외부로 값 넘겨주기</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span><span class=\"token operator\">*</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> _bar <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">yield</span> _bar<span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> _barIt <span class=\"token operator\">=</span> <span class=\"token function\">bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> firstNext <span class=\"token operator\">=</span> _barIt<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>firstNext<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 10</span>\n_barIt<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//end</span></code></pre></div>\n<p>외부에서 <code class=\"language-text\">generator</code>로 값 넘겨주기</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span><span class=\"token operator\">*</span> <span class=\"token function\">baz</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token number\">10</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">yield</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> _bazIt <span class=\"token operator\">=</span> <span class=\"token function\">baz</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n_bazIt<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> res <span class=\"token operator\">=</span> _bazIt<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2 id=\"23-외부에서-generator-제어\" style=\"position:relative;\"><a href=\"#23-%EC%99%B8%EB%B6%80%EC%97%90%EC%84%9C-generator-%EC%A0%9C%EC%96%B4\" aria-label=\"23 외부에서 generator 제어 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 외부에서 generator 제어</h2>\n<p>가장 많이 사용하는 <code class=\"language-text\">next</code>를 제외 하더라도 <code class=\"language-text\">throw</code>, <code class=\"language-text\">return</code>으로 <code class=\"language-text\">generator</code>를 제어 가능하다</p>\n<h2 id=\"231-throw\" style=\"position:relative;\"><a href=\"#231-throw\" aria-label=\"231 throw permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3.1 throw</h2>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span><span class=\"token operator\">*</span> <span class=\"token function\">genWithTryCath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> cnt <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"break \"</span><span class=\"token punctuation\">,</span> cnt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cnt<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">yield</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error 감지. \"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> it1 <span class=\"token operator\">=</span> <span class=\"token function\">genWithTryCath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nit1<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//break 1</span>\nit1<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//break 2</span>\nit1<span class=\"token punctuation\">.</span><span class=\"token function\">throw</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"외부에서 에러 발생!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//error 감지.  외부에서 에러 발생!</span>\n<span class=\"token comment\">//break 3</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>it1<span class=\"token punctuation\">.</span><span class=\"token function\">return</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span></code></pre></div>\n<p>이런식으로 외부에서 <code class=\"language-text\">generator</code> 함수 내부에 <code class=\"language-text\">exception</code>을 발생 가능하다. 또한 이후 이터레이터는 종료(<code class=\"language-text\">done</code>)상태가 된다</p>\n<h2 id=\"232-return\" style=\"position:relative;\"><a href=\"#232-return\" aria-label=\"232 return permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3.2 return</h2>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span><span class=\"token operator\">*</span> <span class=\"token function\">genWithTryCath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> cnt <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"break \"</span><span class=\"token punctuation\">,</span> cnt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    cnt<span class=\"token operator\">++</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">yield</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error 감지. \"</span><span class=\"token punctuation\">,</span> e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> it2 <span class=\"token operator\">=</span> <span class=\"token function\">genWithTryCath</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nit2<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//break 1</span>\nit2<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//break 2</span>\nit2<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//break 3</span>\n\nit2<span class=\"token punctuation\">.</span><span class=\"token function\">return</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>it2<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>done<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span></code></pre></div>\n<p>이런식으로 외부에서 <code class=\"language-text\">generator</code> 함수 <code class=\"language-text\">return</code>이 가능하다. 또한 이후 이터레이터는 종료(<code class=\"language-text\">done</code>)상태가 된다</p>"}},{"node":{"fields":{"slug":"/posts/js/js-intersection-observer/","__typename":"MarkdownRemarkFields","categorySlug":"/category/javascript/"},"frontmatter":{"template":"post","title":"InterSection Observer","date":"2020-11-18T01:32:47.518Z","tags":["js","react","event driven"],"socialImage":null,"draft":false,"description":"event driven 기반으로 하는 dom 노출 여부를 감지하는 Observer","category":"javascript"},"id":"65051834-85b0-5d3e-96d1-9390fd9a333e","html":"<p>블로그를 하나씩 개선하면서 이번에 처음 <code class=\"language-text\">IntersectionObserver</code>를 써봤는데 너무 편해서 기록</p>\n<h2 id=\"intersection-observer\" style=\"position:relative;\"><a href=\"#intersection-observer\" aria-label=\"intersection observer permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>InterSection Observer</h2>\n<p><code class=\"language-text\">IntersectionObserver</code>는 기본 설정값을 기준으로 설명하면 <code class=\"language-text\">viewport</code>, 그니까 현재 화면에 보여지는 영역에 특정 <code class=\"language-text\">dom element</code>가 노출되거나 사라지는 시점을 감지하는 <code class=\"language-text\">Observer</code>이다</p>\n<p>보통 무한 스크롤에 많이 쓰이긴 하지만 내 블로그에서 쓰인 경험을 바탕으로 설명하자면 PC 버전 기준으로 문서를 거의 끝까지 읽으면 우측 하단에 <code class=\"language-text\">Up</code> 버튼이 표출되는 기능이 있다. <code class=\"language-text\">IntersectionObserver</code>적용 전에는 스크롤 이벤트를 추가해서 문서 위치 정보를 판단해서 <code class=\"language-text\">Up</code>버튼 표출 여부를 결정했다</p>\n<p>기존 코드 일부분</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleScroll</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> windowBottomY <span class=\"token operator\">=</span> window<span class=\"token operator\">?.</span>scrollY <span class=\"token operator\">+</span> window<span class=\"token operator\">?.</span>innerHeight<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>Number<span class=\"token punctuation\">.</span><span class=\"token function\">isInteger</span><span class=\"token punctuation\">(</span>windowBottomY<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> documentY <span class=\"token operator\">=</span> refTarget<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>clientHeight<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> currentPercent <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>windowBottomY <span class=\"token operator\">/</span> documentY<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 전체 문서 길이가 너무 짧으면 버튼 그냥 생략, 전체 문서의 80퍼 이상 읽으면 표출</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentPercent <span class=\"token operator\">&lt;</span> <span class=\"token number\">20</span> <span class=\"token operator\">||</span> currentPercent <span class=\"token operator\">&lt;</span> <span class=\"token number\">80</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setIsShow</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setIsShow</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"scroll\"</span><span class=\"token punctuation\">,</span> handleScroll<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> window<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"scroll\"</span><span class=\"token punctuation\">,</span> handleScroll<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이런식으로 하였었는데, 문제점은 스크롤 이벤트에 있다. 매번 스크롤 위치가 바뀔때마다 <code class=\"language-text\">document</code>위치 정보를 가져와 표출 여부를 판단했었는데, <code class=\"language-text\">dom</code>을 직접 접근해서 하는 작업들은 많은 리소스를 사용하게 된다. 사실 블로그에 많은 기능들이 있는것도 아니고 요즘 워낙 하드웨어가 좋아 별 차이는 없지만 그래도 성능 개선을 위해 <code class=\"language-text\">IntersectionObserver</code>를 적용하였다. 기본적으로 <code class=\"language-text\">IntersectionObserver</code>는 viewport에 <code class=\"language-text\">dom element</code> 표출 여부를 감지하는 역할이지만 감지하는 것은 비동기로, 그니까 메인 스레드가 매번 감지하는 방식이 아니라 변화가 감지되면 callback을 실행하는 방식이라 이벤트 기반 프로그래밍에 맞다고 생각된다.</p>\n<blockquote>\n<p>기존 코드는 스크롤 이벤트가 발생하면 매번 <code class=\"language-text\">handleScroll</code>함수를 메인 스레드에서 실행했다. -> 너무 많이 실행됨</p>\n</blockquote>\n<p><code class=\"language-text\">IntersectionObserver</code> 사용하여 개선한 코드 일부분</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">//props 구조</span>\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">Props</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  buttonText<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  docTarget<span class=\"token operator\">:</span> RefObject<span class=\"token operator\">&lt;</span>HTMLDivElement<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n  observeTarget<span class=\"token operator\">:</span> RefObject<span class=\"token operator\">&lt;</span>HTMLDivElement<span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 주요 함수</span>\n<span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> observer <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IntersectionObserver</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>btnEntry<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">isTooShort</span><span class=\"token punctuation\">(</span>docTarget<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setIsShow</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setIsShow</span><span class=\"token punctuation\">(</span>btnEntry<span class=\"token punctuation\">.</span>isIntersecting<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  observer<span class=\"token punctuation\">.</span><span class=\"token function\">observe</span><span class=\"token punctuation\">(</span>observeTarget<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> observer<span class=\"token operator\">?.</span><span class=\"token function\">disconnect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<blockquote>\n<p>기본적인 사용법으로 감지 할 대상(<code class=\"language-text\">IntersectionObserver.observe</code>)들을 등록하면 대상들이 viewport에 표출되거나 사라지는 시점에 callback 함수가 실행된다. 콜백 함수의 첫번째 argument는 감지하는 대상들로, 배열 형태로 넘어온다. <code class=\"language-text\">isIntersecting</code>값이 <code class=\"language-text\">true</code>면 표출 중인 상태고 <code class=\"language-text\">false</code>면 사라진 상태가 된다(위 소스에선 하나의 dom만 등록했다). 그 외 옵션값도 지정이 가능한데 자세한건 <a href=\"https://developer.mozilla.org/ko/docs/Web/API/IntersectionObserver/IntersectionObserver\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">document</a> 참고.</p>\n</blockquote>\n<p>다시한번 말하지만 <code class=\"language-text\">IntersectionObserver</code>는 특정 영역(기본값 <code class=\"language-text\">viewport</code>)에 특정 <code class=\"language-text\">dom element</code>가 표출여부를 감지하는 함수이다. 따라서 감지할 <code class=\"language-text\">observeTarget</code>을 추가하였는데, 무조건 블로그 하단에 위치하는 투명한 element를 추가하였다. 그래서 해당 dom(<code class=\"language-text\">observeTarget</code>)이 화면에 표출 중 인지 여부(<code class=\"language-text\">btnEntry.isIntersecting</code>)를 판단해서 <code class=\"language-text\">Up</code> 버튼 표출 여부를 결정하도록 개선하였더니 확실히 dom에 직접 접근하는 횟수는 확 줄어 들었다.</p>\n<p>약간 억지스럽게 한것도 있긴하지만 공부도 하게 되고, 말 그대로 react 스럽게 한것 같아 마음에 든다.</p>"}},{"node":{"fields":{"slug":"/posts/js/js-promise/","__typename":"MarkdownRemarkFields","categorySlug":"/category/javascript/"},"frontmatter":{"template":"post","title":"Promise","date":"2020-04-28T00:44:36.019Z","tags":["thenable","js","async"],"socialImage":null,"draft":false,"description":"비동기 처리를 깔끔하고 가독성 높게 처리 + 순서를 보장하고 싶을때","category":"javascript"},"id":"75dbbbe9-d832-5c28-86d6-fb9238532094","html":"<p>여기서 설명한 모든 샘플 코드는 <a href=\"https://github.com/qweasd147/StudyNote/tree/master/javascript/promise\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">note-promise</a> 여기서 확인 가능</p>\n<h1 id=\"promise\" style=\"position:relative;\"><a href=\"#promise\" aria-label=\"promise permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Promise.</h1>\n<h1 id=\"1-정의\" style=\"position:relative;\"><a href=\"#1-%EC%A0%95%EC%9D%98\" aria-label=\"1 정의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 정의</h1>\n<p>비동기 작업일지라도 현재 처리할 작업과 나중에 처리할 작업을 보장해주고 완벽하진 않더라도 callback hell을 벗어게 해주는데 많은 도움을 준다. 최초 <code class=\"language-text\">Promise</code> 객체는 <code class=\"language-text\">pending</code>이며, 차후 비동기 작업이 완료되어 <code class=\"language-text\">resolved(성공)</code>, <code class=\"language-text\">rejected(실패)</code> 상태로 변경되면 해당 연관작업을 실행하는 구조이다.</p>\n<h1 id=\"2-주요-내용\" style=\"position:relative;\"><a href=\"#2-%EC%A3%BC%EC%9A%94-%EB%82%B4%EC%9A%A9\" aria-label=\"2 주요 내용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 주요 내용</h1>\n<h3 id=\"21-promise-기본-형태-with-resolve\" style=\"position:relative;\"><a href=\"#21-promise-%EA%B8%B0%EB%B3%B8-%ED%98%95%ED%83%9C-with-resolve\" aria-label=\"21 promise 기본 형태 with resolve permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 Promise 기본 형태 with resolve</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">after2sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//비동기 작업</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"첫번째 비동기 작업 완료\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"첫번째 결과물\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">after2sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">//첫번째 비동기 작업 완료</span>\n  <span class=\"token comment\">//첫번째 결과물</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>가장 기본적인 형태로 setTimeout을 사용하여 비동기 작업을 할지라도 그 이후에 결과값을 받아 처리가 가능하다. 정상적인 처리는 <code class=\"language-text\">resolve</code>를 실행 하여 인자로 값을 넘기면 <code class=\"language-text\">then</code>의 첫번째 함수에서 callback을 구현하여 데이터를 받을 수 있다.</p>\n<h3 id=\"22-promise-기본-형태-with-reject\" style=\"position:relative;\"><a href=\"#22-promise-%EA%B8%B0%EB%B3%B8-%ED%98%95%ED%83%9C-with-reject\" aria-label=\"22 promise 기본 형태 with reject permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 Promise 기본 형태 with reject</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">after2sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//비동기 작업</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"첫번째 비동기 작업 완료\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"첫번째 결과물 에러\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">after2sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"then\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//실행x</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//실행x</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"catch\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//catch</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//첫번째 결과물 에러</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">resolve</code>는 정상적인 처리라면 <code class=\"language-text\">reject</code>는 명시적으로 에러를 발생시킨다고 생각하면 된다. <code class=\"language-text\">resolve</code>가 아닌 <code class=\"language-text\">reject</code>를 호출 시 <code class=\"language-text\">then</code>의 callbaclk이 아닌 catch의 callback이 실행된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">after2sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//비동기 작업</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"첫번째 비동기 작업 완료\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"첫번째 결과물 에러\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">after2sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n  <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"then\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//실행x</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//실행x</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"catch\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//catch</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//첫번째 결과물 에러</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위 소스처럼 <code class=\"language-text\">catch</code>를 사용하지 않고 then 함수의 두번째 인자값으로 callback함수를 넘겨주고, <code class=\"language-text\">reject</code>를 실행시키면 동일한 결과를 얻을 수 있지만, 직관적으로 알 수도 있고 잡히지 않는 에러도 처리할 수 있어서 대부분의 개발자들은 <code class=\"language-text\">catch</code>를 사용하는것을 추천하고 있다. 에러 관련해는 주의사항 참고!</p>\n<h3 id=\"23-promiseall\" style=\"position:relative;\"><a href=\"#23-promiseall\" aria-label=\"23 promiseall permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 Promise.all</h3>\n<p><code class=\"language-text\">Promise.all</code> static method는 인자값으로 promise 배열(또는 <code class=\"language-text\">thenable</code> 한 객체)를 받아 모든 <code class=\"language-text\">promise</code>가 <code class=\"language-text\">resolve</code> 또는 <code class=\"language-text\">reject</code> 상태, 즉 처리가 완료되어 pending 상태가 아닐때까지 기다린다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">after2sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//비동기 작업</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after2sec 결과물\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">after4sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//비동기 작업</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after4sec 결과물\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token function\">after2sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">after4sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">arrResult</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//약 4초후 실행</span>\n\n  Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>arrResult<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// ==> true</span>\n\n  arrResult<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">promise.all</code>을 사용 시, 비동기 작업 순서를 정하지 않고 동시에 처리되며, 단지 모든 promise가 끝날때까지 기다린다. 위 소스를 보면 2초, 4초의 작업이 걸리는 비동기 작업 시, 두개의 비동기 작업을 같이 처리하여 두 작업이 끝나면 <code class=\"language-text\">then</code>으로 넘어가게 된다. <code class=\"language-text\">then</code>에서 <code class=\"language-text\">resolve</code>를 처리하는 첫번째 callback함수의 매개변수는 항상 배열 형태로 받게된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">after2sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>after4sec<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//약 6초 후 실행</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>당연히 위 소스는 <code class=\"language-text\">after2sec</code> 작업이 끝나고 <code class=\"language-text\">after4sec</code>을 실행하므로 약 6초가 걸리게 된다. 에러 날 때를 대비하여, 똑같이 <code class=\"language-text\">catch</code>를 체이닝 하여 사용 할 수 있다.</p>\n<h3 id=\"24-promiserace\" style=\"position:relative;\"><a href=\"#24-promiserace\" aria-label=\"24 promiserace permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.4 Promise.race</h3>\n<p><code class=\"language-text\">Promise.race</code> static method는 all과 반대로 모든 promise가 처리 완료가 아닌 가장 첫번째로 처리 완료가 된 promise를 처리하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">after2sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//비동기 작업</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after2sec 결과물\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">after4sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//비동기 작업</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"실행은 하지만 결과물은 무시된다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after4sec 결과물\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">race</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token function\">after2sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">after4sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//after2sec 결과물</span>\n<span class=\"token comment\">//실행은 하지만 결과물은 무시된다.</span></code></pre></div>\n<p>위 소스는 항상 <code class=\"language-text\">after2sec</code>의 <code class=\"language-text\">resolve</code>만 실행된다. 주의할 점은 race에 밀린 <code class=\"language-text\">promise</code>의 <code class=\"language-text\">resolve</code>는 조용히 무시된다. 위 소스에서는 <code class=\"language-text\">after4sec</code>의 <code class=\"language-text\">setTimeout</code>은 실행 되도, <code class=\"language-text\">resolve</code>는 실행되지 않는다. 이러한 특징을 이용하여 ajax 요청 timeout을 거는 경우가 많다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//타임아웃 구현</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">timeoutWithPromise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">time</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  time <span class=\"token operator\">=</span> time <span class=\"token operator\">||</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"타임 아웃!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">race</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token function\">callAjax</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">timeoutWithPromise</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>\n  handleResponse<span class=\"token punctuation\">,</span>\n  handleTimeout<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이런식으로 요청 시간(위 소스에선 1초)내 ajax 응답이 오는지 여부에 따라 핸들링이 가능하다. 하지만 백단에서 connection or read timeout을 거는게 더 좋을꺼 같다는게 개인적인 생각이다…</p>\n<h3 id=\"25-promiseresolve-promisereject\" style=\"position:relative;\"><a href=\"#25-promiseresolve-promisereject\" aria-label=\"25 promiseresolve promisereject permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5 Promise.resolve, Promise.reject</h3>\n<p>두 static method는 무조건 <code class=\"language-text\">resolved</code> 또는 <code class=\"language-text\">rejected</code> 상태인 <code class=\"language-text\">promise</code> 생성을 간단하게 만들 수가 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"무조건 resolve\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"무조건 reject\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>primitive한 값들을 간단하게 <code class=\"language-text\">promise</code> 객체로 만들어서 처리가 가능하지만 유용할꺼 같으면서도 어디에 써야할지 잘 감은 안잡힌다…</p>\n<h1 id=\"3-체이닝하여-사용\" style=\"position:relative;\"><a href=\"#3-%EC%B2%B4%EC%9D%B4%EB%8B%9D%ED%95%98%EC%97%AC-%EC%82%AC%EC%9A%A9\" aria-label=\"3 체이닝하여 사용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 체이닝하여 사용</h1>\n<p><code class=\"language-text\">promise</code>는 순서를 보장하기 위하여 여러 함수를 체이닝하여 사용이 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">\n<span class=\"token function\">promise1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>promise2<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>promise3<span class=\"token punctuation\">)</span>\n\n<span class=\"token operator\">...</span>\n</code></pre></div>\n<h3 id=\"31-에러-발생-시-실행-순서\" style=\"position:relative;\"><a href=\"#31-%EC%97%90%EB%9F%AC-%EB%B0%9C%EC%83%9D-%EC%8B%9C-%EC%8B%A4%ED%96%89-%EC%88%9C%EC%84%9C\" aria-label=\"31 에러 발생 시 실행 순서 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 에러 발생 시 실행 순서</h3>\n<p>에러 발생 시, 가장 첫번째 <code class=\"language-text\">catch</code>에서 에러를 처리 후, 정상적인 <code class=\"language-text\">then</code>으로 돌아와서 다시 처리를 시작한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"start\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">first</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//console.log(data);  //start</span>\n\n    <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"first ERROR\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//jump catch</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"end first\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token function\">second</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//second 함수는 무시된다.</span>\n\n    <span class=\"token comment\">//console.log(data);  //end first</span>\n    <span class=\"token keyword\">return</span> <span class=\"token string\">\"end second\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//first ERROR</span>\n<span class=\"token comment\">//end</span></code></pre></div>\n<p>위 소스에서 <code class=\"language-text\">second</code> 함수는 실행되지 않는다. <code class=\"language-text\">first</code>에서 발생된 에러가 <code class=\"language-text\">catch</code>를 통해 가기 때문이다. 그 이후에는 <code class=\"language-text\">catch</code> 이후 다음 <code class=\"language-text\">then</code>으로 돌아가 처리를 시작한다. 물론 <code class=\"language-text\">first</code> 함수는 정상 처리되고, <code class=\"language-text\">second</code> 함수에서 에러가 발생 시 <code class=\"language-text\">catch</code>에서 에러 처리 후, 다음 <code class=\"language-text\">then</code>으로 넘어간다.</p>\n<h3 id=\"32-체이닝-하여-사용시-항상-새로운-promise를-생성\" style=\"position:relative;\"><a href=\"#32-%EC%B2%B4%EC%9D%B4%EB%8B%9D-%ED%95%98%EC%97%AC-%EC%82%AC%EC%9A%A9%EC%8B%9C-%ED%95%AD%EC%83%81-%EC%83%88%EB%A1%9C%EC%9A%B4-promise%EB%A5%BC-%EC%83%9D%EC%84%B1\" aria-label=\"32 체이닝 하여 사용시 항상 새로운 promise를 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 체이닝 하여 사용시 항상 새로운 promise를 생성</h3>\n<p><code class=\"language-text\">then</code> 또는 <code class=\"language-text\">catch</code>를 통해 반환 된 <code class=\"language-text\">promise</code> 객체는 항상 새롭게 생성된 <code class=\"language-text\">promise</code> 객체를 반환한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> p1 <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> p2 <span class=\"token operator\">=</span> p1<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> p3 <span class=\"token operator\">=</span> p1<span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>p1 <span class=\"token operator\">===</span> p2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//false</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>p1 <span class=\"token operator\">===</span> p3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//false</span></code></pre></div>\n<p><code class=\"language-text\">promise</code>는 최초 <code class=\"language-text\">pending</code> 상태에서 비동기 작업이 완료 시, <code class=\"language-text\">resolved</code> 또는 <code class=\"language-text\">rejected</code> 상태로 바뀌게 되고, <code class=\"language-text\">then</code>을 통해 걸려있는 함수가 있을 시, 해당 함수를 실행시키는 구조이다. 이러한 구조에서 만약 <code class=\"language-text\">then</code>에서 새로운 pending 상태인 <code class=\"language-text\">promise</code> 객체를 생성하지 않으면 체이닝 하여 순서를 보장하는 일을 할수가 없게된다. (만약 기존의 <code class=\"language-text\">promise</code> 객체를 반환 시 최초 <code class=\"language-text\">then</code>의 callback 함수를 제외한 모든 <code class=\"language-text\">then</code>에 걸려있는 callback 함수는 동시에 실행 될 것이다.)</p>\n<h1 id=\"4-es8-async--await\" style=\"position:relative;\"><a href=\"#4-es8-async--await\" aria-label=\"4 es8 async  await permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. es8 async &#x26; await</h1>\n<h3 id=\"41-기본-사용\" style=\"position:relative;\"><a href=\"#41-%EA%B8%B0%EB%B3%B8-%EC%82%AC%EC%9A%A9\" aria-label=\"41 기본 사용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 기본 사용</h3>\n<p>Promise는 callback hell을 완화 시킬 수 있지만 근본적으로 해결은 힘들다. 그래서 나온것이 es8의 <code class=\"language-text\">async</code>, <code class=\"language-text\">await</code>가 나와 비동기 로직일 지라도 동기적으로 처리가 가능하게 되었다.</p>\n<blockquote>\n<p>비동기 작업을 호출 시 ‘await’ 키워드를 붙여주면 해당 비동기 작업이 완료될 때까지 다음 구분 실행을 멈추게 된다. 또한 await를 사용하기 위해선 함수를 정의 할때 앞에다가 ‘async’키워드를 붙여주어야만 사용이 가능하며, 이 키워드를 붙여주게 되면 해당 함수는 비동기 함수로 처리된다.</p>\n</blockquote>\n<p>참고로 아래 소스들은 arrow function, 함수 선언식, 표현식 골고루 사용하였다. 물론 헤깔리게 할 목적은 아님!</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">promise1</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">text</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>text <span class=\"token operator\">+</span> <span class=\"token string\">\" END\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">promise2</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">text</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>text <span class=\"token operator\">+</span> <span class=\"token string\">\" END\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">after5sec</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> p1Result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">promise1</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"첫번째 결과물\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> p2Result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">promise2</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"두번째 결과물\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">//5초 후</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after5sec 전체 끝\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">after5sec</code>함수를 실행하여 <code class=\"language-text\">await</code>를 만나면 해당 비동기 작업 처리가 완료 될때까지 대기 하게 된다. 따라서 위 소스는 <code class=\"language-text\">promise1</code> 처리가 완료 후, <code class=\"language-text\">promise2</code>가 실행되므로 전체 처리하는데 약 5초가 걸리게된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">after3sec</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> resultArr <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token function\">promise1</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"첫번째 결과물\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function\">promise2</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"두번째 결과물\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"after3sec 끝...\"</span> <span class=\"token operator\">+</span> resultArr<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">Promise.all</code>을 사용 시 똑같이 <code class=\"language-text\">await</code>를 붙여주며, 반환값은 기존 <code class=\"language-text\">Promise.all</code>과 똑같이 배열 형태로 받게된다. 위 소스는 비동기 작업을 같이 처리하게 되므로 약 3초 이후에 결과값을 받게 된다.</p>\n<blockquote>\n<p>주의할 점은 비동기 함수는 기존 이벤트 루프를 배울 시, 특정 함수가 실행 중일 시 다른 함수는 절대로 실행되지 않는다고 하였다. 하지만 이 비동기 함수는 실행 중 특정 비동기 처리 완료를 대기 중이면 다른 함수가 실행이 가능하다. 얼추 어떤식으로 돌아가는지 알꺼 같지만 추측만 하는거라서 조금 더 공부가 필요할꺼 같다…</p>\n</blockquote>\n<p>참고로 <code class=\"language-text\">async</code>, <code class=\"language-text\">await</code>를 사용하여 error 처리를 할 시에는 그냥 <code class=\"language-text\">try</code>, <code class=\"language-text\">catch</code>문을 사용하여 처리하는걸 권장하고 있다. <code class=\"language-text\">promise</code>객체를 체이닝하여 <code class=\"language-text\">catch</code>문만 보다가 쓰려니까 어색하기도 하지만 애초에 비동기 코드를 동기식 코드로 사용하기 위하여 나온것이기 때문에 <code class=\"language-text\">try</code>, <code class=\"language-text\">catch</code>문을 사용하여 에러를 잡게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ERROR!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//ERROR!</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"42-callback-function-with-promise\" style=\"position:relative;\"><a href=\"#42-callback-function-with-promise\" aria-label=\"42 callback function with promise permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.2 callback function with promise</h3>\n<p>순수 <code class=\"language-text\">Promise</code> 함수를 써서 callback 함수를 사용하는 비동기 함수를 동기식으로 만들어 사용이 가능하다. 예를 들어 아래와 같은 <code class=\"language-text\">API Request</code>를 요청하고 결과값을 처리하는 callback 함수를 요구하는 함수가 있다고 가정.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//TODO : 에러 처리</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">//TODO : handle result data</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>당연히 callback 함수는 언제 실행 될지 모른다. 하지만 <code class=\"language-text\">Promise</code>로 한번 감싸고, <code class=\"language-text\">await</code>를 사용해서 결과값을 받을 때 까지 대기가 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">waitUntilRequestEnd</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">request</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">else</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//시용 시점</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">waitUntilRequestEnd</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//TODO : 에러 처리</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h1 id=\"5-주의사항\" style=\"position:relative;\"><a href=\"#5-%EC%A3%BC%EC%9D%98%EC%82%AC%ED%95%AD\" aria-label=\"5 주의사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 주의사항</h1>\n<h3 id=\"51-pending-상태-이후-resolved-또는-rejected-상태로-변경-시-다른-상태로-변경되지-않는다\" style=\"position:relative;\"><a href=\"#51-pending-%EC%83%81%ED%83%9C-%EC%9D%B4%ED%9B%84-resolved-%EB%98%90%EB%8A%94-rejected-%EC%83%81%ED%83%9C%EB%A1%9C-%EB%B3%80%EA%B2%BD-%EC%8B%9C-%EB%8B%A4%EB%A5%B8-%EC%83%81%ED%83%9C%EB%A1%9C-%EB%B3%80%EA%B2%BD%EB%90%98%EC%A7%80-%EC%95%8A%EB%8A%94%EB%8B%A4\" aria-label=\"51 pending 상태 이후 resolved 또는 rejected 상태로 변경 시 다른 상태로 변경되지 않는다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.1 pending 상태 이후, resolved 또는 rejected 상태로 변경 시 다른 상태로 변경되지 않는다.</h3>\n<p><code class=\"language-text\">promise</code>객체는 최초 생성 시 <code class=\"language-text\">pending</code> 상태이며, 비동기 작업이 완료 시 에러 발생 여부에 따라 <code class=\"language-text\">resolved</code> 또는 <code class=\"language-text\">rejected</code> 상태로 바뀌게 된다. 이후로는 다른 상태로는 절대 바뀌지 않게 된다. 따라서</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> pResolved <span class=\"token operator\">=</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"12345\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\npResolved<span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//....</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위 소스의 <code class=\"language-text\">catch</code>는 절대로 발생할 수가 없다. 이후에 어떠한 변화를 주게 된다 하더라도 <code class=\"language-text\">pResolved</code>의 상태값이 <code class=\"language-text\">resolved</code>에서 <code class=\"language-text\">rejected</code>으로 바뀔일은 절대 없기 때문이다.</p>\n<h3 id=\"52-파라미터는-단일값\" style=\"position:relative;\"><a href=\"#52-%ED%8C%8C%EB%9D%BC%EB%AF%B8%ED%84%B0%EB%8A%94-%EB%8B%A8%EC%9D%BC%EA%B0%92\" aria-label=\"52 파라미터는 단일값 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.2 파라미터는 단일값</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//[1]</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>아무리 많은 값을 넘기고 싶어도 then에서 받을수 있는 파라미터는 하나밖에 받을 수가 없다. 따라서 여러값들을 넘겨주고 싶은 경우에는 배열또는 json형태로 값을 넘겨주어야만 한다.</p>\n<h3 id=\"53-잡히지-않는-에러\" style=\"position:relative;\"><a href=\"#53-%EC%9E%A1%ED%9E%88%EC%A7%80-%EC%95%8A%EB%8A%94-%EC%97%90%EB%9F%AC\" aria-label=\"53 잡히지 않는 에러 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.3 잡히지 않는 에러</h3>\n<p><code class=\"language-text\">Promise</code>를 체이닝을 통한 에러 처리 시, 의도와는 다른 에러를 케치하지 못하는 상황이 올 수가 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">throwErr</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"ERROR!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">handleError</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//에러 처리를 handleError에서 잡지 못한다.</span>\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"start\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>throwErr<span class=\"token punctuation\">,</span> handleError<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>만약 <code class=\"language-text\">then</code>의 첫번째 콜백함수 파라미터에서 에러가 발생하게 되면 두번째 콜백함수에 잡을 수가 없다. 위 소스에서 <code class=\"language-text\">handleError</code>는 오직 상위 <code class=\"language-text\">Promise</code>의 처리 결과 중 에러가 발생하면 이에 호출되기 때문이다. (사실상 <code class=\"language-text\">Promise.resolve</code>를 호출하므로 왠만하면 에러를 낼 수도 없다.) 따라서 <code class=\"language-text\">throwErr</code>에서 발생한 에러를 처리하기 위해서는 아래와 같은 소스로 변경해야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Promise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"start\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>throwErr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>handleError<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>물론 상위 <code class=\"language-text\">Promise</code>객체의 에러를 캐치하기 위해 <code class=\"language-text\">then</code>을 아래와 같이 체이닝 하여 사용 할 수도 있지만 직관적으로 봐도 의도를 파악하기가 힘들 수도 있어서 잘 사용하지는 않는다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//에러를 handleError에서 케치 할 수 있지만 차라리 catch를 쓰는게 더 낫다</span>\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"start\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>throwErr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> handleError<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"54-thenable\" style=\"position:relative;\"><a href=\"#54-thenable\" aria-label=\"54 thenable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.4 thenable</h3>\n<p><code class=\"language-text\">Promise.resolve</code> 또는 <code class=\"language-text\">Promise.reject</code>에서 <code class=\"language-text\">then</code>을 구현하여 사용 할 수 있는 함수(말 그대로 thenable)를 넣을 시 <code class=\"language-text\">Promise</code> 객체로 변환하여 사용이 가능하다. 일종의 인터페이스 구현으로 보통 <code class=\"language-text\">Promise</code> 객체가 아닌 비동기 함수의 콜백 함수 등에서 필요에 따라 <code class=\"language-text\">Promise</code>처럼 사용 또는 callback 형태로 사용 하기 위하여 자주 사용한다고 한다(사실 필요성을 잘 못 느끼겠다).</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">fnThenAble</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">then</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data is falsely\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//resolved로 처리</span>\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">fnThenAble</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//data</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//rejected로 처리</span>\nPromise<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token function\">fnThenAble</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//data is falsely</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"55-항상-비동기-처리\" style=\"position:relative;\"><a href=\"#55-%ED%95%AD%EC%83%81-%EB%B9%84%EB%8F%99%EA%B8%B0-%EC%B2%98%EB%A6%AC\" aria-label=\"55 항상 비동기 처리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5.5 항상 비동기 처리</h3>\n<p><code class=\"language-text\">resolve</code> 또는 <code class=\"language-text\">reject</code>함수는 항상 비동기로써 처리된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> p1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"first message\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"last message\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\np1<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"second message\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//first Message</span>\n<span class=\"token comment\">//second Message</span>\n<span class=\"token comment\">//last Message</span></code></pre></div>\n<p>맨 처음 <code class=\"language-text\">Promise</code>객체를 생성 시 ‘first message’가 표출되고, 그 다음 ‘last message’가 아닌 ‘second message’가 표출된다.</p>\n<p>이는 동기적으로 실행 되어 first -> last -> second 순으로 출력될 것이라 예상할수도 있겠지만 <code class=\"language-text\">resolve</code>, <code class=\"language-text\">reject</code> 함수는 항상 비동기로 호출하고 있다. 혹시나 이게 왜 비동기 호출의 증거인지 궁금하면 event loop 참고!</p>"}},{"node":{"fields":{"slug":"/posts/js/js-prototype/","__typename":"MarkdownRemarkFields","categorySlug":"/category/javascript/"},"frontmatter":{"template":"post","title":"Prototype","date":"2020-05-12T00:44:31.650Z","tags":["js","inheritance","extends"],"socialImage":null,"draft":false,"description":"javascript에서 상속 등이나 static등을 쓰고 싶을때","category":"javascript"},"id":"ded54085-7ee4-5261-8271-2fa7949cef3a","html":"<h1 id=\"prototype\" style=\"position:relative;\"><a href=\"#prototype\" aria-label=\"prototype permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Prototype.</h1>\n<p>모든 소스 내용은 chrome 기준으로 작성되었습니다.</p>\n<h1 id=\"1-정의\" style=\"position:relative;\"><a href=\"#1-%EC%A0%95%EC%9D%98\" aria-label=\"1 정의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 정의</h1>\n<p>javascript 함수를 선언 시 생성되는 프로퍼티로 new를 사용하여 새로운 객체를 생성 시, 말그대로 prototype(원형)이 되는 객체를 정의한 프로퍼티가 되며, prototype을 통해 타 객체 지향 언어의 클래스, 상속 등에 사용이 된다.</p>\n<p>추가적으로 아래에 설명할 <code class=\"language-text\">[[Prototype]]</code>과 <code class=\"language-text\">__proto__</code>는 사실상 같은 객체를 말하고, <code class=\"language-text\">[[Prototype]]</code>와 <code class=\"language-text\">Prototype</code>은 비슷하지만 다른 목적으로 생성되어 진다(결국은 다르다!).</p>\n<h1 id=\"2-주요-내용\" style=\"position:relative;\"><a href=\"#2-%EC%A3%BC%EC%9A%94-%EB%82%B4%EC%9A%A9\" aria-label=\"2 주요 내용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 주요 내용</h1>\n<h3 id=\"21-prototype을-사용한-객체-인스턴스\" style=\"position:relative;\"><a href=\"#21-prototype%EC%9D%84-%EC%82%AC%EC%9A%A9%ED%95%9C-%EA%B0%9D%EC%B2%B4-%EC%9D%B8%EC%8A%A4%ED%84%B4%EC%8A%A4\" aria-label=\"21 prototype을 사용한 객체 인스턴스 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 Prototype을 사용한 객체 인스턴스</h3>\n<blockquote>\n<p>주의 원래 javascript에선 인스턴스라는 개념이 존재하지 않는다. 다른 객체지향 언어와 비교하여 이해하기 쉽게 하기 위해서 인스턴스라는 단어를 사용했을 뿐. 자세한건 주의사항에서 설명.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getName</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">setName</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> foo <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nfoo<span class=\"token punctuation\">.</span><span class=\"token function\">setName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>foo<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">Foo</code> 함수에서 <code class=\"language-text\">Foo.prototype</code>의 각 프로퍼티에 함수를 정의 후, 해당 함수의 new로 호출 하면 반환된 객체에 메소드가 생긴다(<code class=\"language-text\">foo.setName</code>, <code class=\"language-text\">foo.getName</code>).</p>\n<h3 id=\"22-prototype\" style=\"position:relative;\"><a href=\"#22-prototype\" aria-label=\"22 prototype permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 [[Prototype]]</h3>\n<p>prototype 링크 또는 <code class=\"language-text\">__proto__</code> 라고도 불리는 객체로, 자신의 프로토타입을 가리킨다(링크 시킨다). 원래 정식 명칭은 <code class=\"language-text\">[[Prototype]]</code> 이고, 이 프로퍼티는 객체의 내부적으로 사용 용도로 사용되지만, 크롬 기준 <code class=\"language-text\">__proto__</code> 라는 프로퍼티 로 생성되어 접근이 가능하다. 대부분 브라우저에서 지원하는것으로 알고 있긴한데, 어쨋든 <code class=\"language-text\">__proto__</code>라는 객체는 자바스크립트 비표준으로 브라우저에 따라 생성되지 않을 수 있다. <code class=\"language-text\">[[Prototype]]</code>는 객체가 생성 될 때 그 객체의 프로토타입이 되는 객체의 Prototype 객체를 링크 시킨다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> bar <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Bar</span><span class=\"token punctuation\">.</span>prototype <span class=\"token operator\">===</span> bar<span class=\"token punctuation\">.</span>__proto__<span class=\"token punctuation\">;</span> <span class=\"token comment\">// true</span></code></pre></div>\n<p>위 소스와 같이 <code class=\"language-text\">new</code>를 사용하여 객체를 생성 시, 생성된 객체의 <code class=\"language-text\">[[Prototype]]</code> 링크는 자신의 주체가 되는 Prototype을 찾아 그 객체를 연결 시킨다.</p>\n<h3 id=\"23-prototype-prototype\" style=\"position:relative;\"><a href=\"#23-prototype-prototype\" aria-label=\"23 prototype prototype permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 Prototype, [[Prototype]]</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getName</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">setName</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> foo <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nfoo<span class=\"token punctuation\">.</span>__proto__ <span class=\"token operator\">===</span> Foo<span class=\"token punctuation\">.</span>Prototype<span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span></code></pre></div>\n<p>위 소스를 보면서 2.1과 2.2 내용을 종합하고 기타 내용을 추가하여 단계별로 설명하자면</p>\n<h4 id=\"1-모든-함수는-생성-시-prototype-프로퍼티가-생성되며-prototype-프로퍼티-안에는-constructor-라는-프로퍼티가-생긴다\" style=\"position:relative;\"><a href=\"#1-%EB%AA%A8%EB%93%A0-%ED%95%A8%EC%88%98%EB%8A%94-%EC%83%9D%EC%84%B1-%EC%8B%9C-prototype-%ED%94%84%EB%A1%9C%ED%8D%BC%ED%8B%B0%EA%B0%80-%EC%83%9D%EC%84%B1%EB%90%98%EB%A9%B0-prototype-%ED%94%84%EB%A1%9C%ED%8D%BC%ED%8B%B0-%EC%95%88%EC%97%90%EB%8A%94-constructor-%EB%9D%BC%EB%8A%94-%ED%94%84%EB%A1%9C%ED%8D%BC%ED%8B%B0%EA%B0%80-%EC%83%9D%EA%B8%B4%EB%8B%A4\" aria-label=\"1 모든 함수는 생성 시 prototype 프로퍼티가 생성되며 prototype 프로퍼티 안에는 constructor 라는 프로퍼티가 생긴다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 모든 함수는 생성 시 Prototype 프로퍼티가 생성되며, Prototype 프로퍼티 안에는 constructor 라는 프로퍼티가 생긴다.</h4>\n<h4 id=\"2-생성-된-constructor는-자기-함수-원형을-담고-있다\" style=\"position:relative;\"><a href=\"#2-%EC%83%9D%EC%84%B1-%EB%90%9C-constructor%EB%8A%94-%EC%9E%90%EA%B8%B0-%ED%95%A8%EC%88%98-%EC%9B%90%ED%98%95%EC%9D%84-%EB%8B%B4%EA%B3%A0-%EC%9E%88%EB%8B%A4\" aria-label=\"2 생성 된 constructor는 자기 함수 원형을 담고 있다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 생성 된 constructor는 자기 함수 원형을 담고 있다</h4>\n<p><code class=\"language-text\">Foo.prototype.constructor === Foo</code></p>\n<h4 id=\"3-constructor와-해당-함수는-서로-환형-참조를-이루고-있다\" style=\"position:relative;\"><a href=\"#3-constructor%EC%99%80-%ED%95%B4%EB%8B%B9-%ED%95%A8%EC%88%98%EB%8A%94-%EC%84%9C%EB%A1%9C-%ED%99%98%ED%98%95-%EC%B0%B8%EC%A1%B0%EB%A5%BC-%EC%9D%B4%EB%A3%A8%EA%B3%A0-%EC%9E%88%EB%8B%A4\" aria-label=\"3 constructor와 해당 함수는 서로 환형 참조를 이루고 있다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Constructor와 해당 함수는 서로 환형 참조를 이루고 있다.</h4>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>constructor <span class=\"token operator\">===</span> Foo<span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span>\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>constructor<span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>constructor <span class=\"token operator\">===</span> Foo<span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span>\n<span class=\"token comment\">//....</span>\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype <span class=\"token operator\">===</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>constructor<span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span>\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype <span class=\"token operator\">===</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>constructor<span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>constructor<span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span>\n<span class=\"token comment\">//...</span></code></pre></div>\n<h4 id=\"4-함수를-new를-통하여-호출-시-해당-함수를-호출하여-새로운-객체를-생성한다\" style=\"position:relative;\"><a href=\"#4-%ED%95%A8%EC%88%98%EB%A5%BC-new%EB%A5%BC-%ED%86%B5%ED%95%98%EC%97%AC-%ED%98%B8%EC%B6%9C-%EC%8B%9C-%ED%95%B4%EB%8B%B9-%ED%95%A8%EC%88%98%EB%A5%BC-%ED%98%B8%EC%B6%9C%ED%95%98%EC%97%AC-%EC%83%88%EB%A1%9C%EC%9A%B4-%EA%B0%9D%EC%B2%B4%EB%A5%BC-%EC%83%9D%EC%84%B1%ED%95%9C%EB%8B%A4\" aria-label=\"4 함수를 new를 통하여 호출 시 해당 함수를 호출하여 새로운 객체를 생성한다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 함수를 new를 통하여 호출 시, 해당 함수를 호출하여 새로운 객체를 생성한다.</h4>\n<h4 id=\"5-이때-생성된-객체의-prototype-링크__proto__는-fooprototype을-가리킨다\" style=\"position:relative;\"><a href=\"#5-%EC%9D%B4%EB%95%8C-%EC%83%9D%EC%84%B1%EB%90%9C-%EA%B0%9D%EC%B2%B4%EC%9D%98-prototype-%EB%A7%81%ED%81%AC__proto__%EB%8A%94-fooprototype%EC%9D%84-%EA%B0%80%EB%A6%AC%ED%82%A8%EB%8B%A4\" aria-label=\"5 이때 생성된 객체의 prototype 링크__proto__는 fooprototype을 가리킨다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 이때 생성된 객체의 <code class=\"language-text\">[[Prototype]]</code> 링크(<code class=\"language-text\">__proto__</code>)는 <code class=\"language-text\">Foo.Prototype</code>을 가리킨다.</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">따라서 위 소스에서 foo.__proto__ === Foo.Prototype 는 true를 반환한다.</code></pre></div>\n<p>위의 과정을 거치면서 Foo.Prototype에 지정된 프로퍼티는 new로 생성 된 객체에 <code class=\"language-text\">[[Prototype]]</code> 링크를 통해 그대로 사용이 가능하다. Foo.Prototype은 <code class=\"language-text\">new</code>를 사용한 객체 생성 시에만 영향력이 있고 그 외의 상황에선 일반적으로 사용되지 않는다. 참고사항으로 모든 객체는 생성 시 <code class=\"language-text\">[[Prototype]]</code> 링크(<code class=\"language-text\">__proto__</code>)를 가지게 되는데, <code class=\"language-text\">Foo.prototype</code>도 객체이므로 <code class=\"language-text\">__proto__</code> 프로퍼티를 갖게 된다. 따라서 <code class=\"language-text\">foo.__proto__</code>는 <code class=\"language-text\">Foo.prototype</code>을 바라보게 되므로 <code class=\"language-text\">foo.__proto__.__proto__</code> 프로퍼티가 존재하게 된다.</p>\n<p>이런식으로 해당 프로퍼티의 프로퍼티를 계속하여 타고 올라가는 것을 프로토타입 체이닝 이라고 한다.</p>\n<p>위 소스는 체이닝이 짧아서 <code class=\"language-text\">Foo.prototype.__proto__</code>는 Object 함수를 링크 시키지만 상속을 통하여 체이닝을 늘려갈수 있고, 한가지 덫붙이자면 객체 리터럴 형태로 객체를 만들어도 똑같이 <code class=\"language-text\">__proto__</code> 프로퍼티가 생기며, 이는 모든 프로퍼티 체이닝의 마지막인 Object.prototype을 가리키게 된다(여기서 나온 Object도 함수인것을 잊지말자!)</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Object <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Function</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span>\n\n<span class=\"token keyword\">var</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nobj<span class=\"token punctuation\">.</span>__proto__ <span class=\"token operator\">===</span> <span class=\"token class-name\">Object</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span></code></pre></div>\n<h3 id=\"24-프로토타입-체이닝\" style=\"position:relative;\"><a href=\"#24-%ED%94%84%EB%A1%9C%ED%86%A0%ED%83%80%EC%9E%85-%EC%B2%B4%EC%9D%B4%EB%8B%9D\" aria-label=\"24 프로토타입 체이닝 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.4 프로토타입 체이닝</h3>\n<p>위에서 짤막하게 말이 나왔지만 객체에 프로퍼티가 있는지 조사하고, 있으면 그 값을, 없으면 상위 prototype의 프로퍼티를 조사하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\nFoo<span class=\"token punctuation\">.</span>apply<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 존재함</span>\nFoo<span class=\"token punctuation\">.</span>bind<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 존재함</span></code></pre></div>\n<p><code class=\"language-text\">Foo</code>에 <code class=\"language-text\">apply</code>와 <code class=\"language-text\">bind</code>가 존재하는 이유는 <code class=\"language-text\">Foo.__proto__</code> 가 <code class=\"language-text\">Function.prototype</code>을 바라보기 때문이다. (참고로 프로퍼티 접근 시 <code class=\"language-text\">__proto__</code> 는 생략 가능하다)\n이는 Foo가 컴파일 될 시, <code class=\"language-text\">Function</code>을 생성자로 한 객체가 생성 되고(<code class=\"language-text\">new Function</code>) <code class=\"language-text\">Function.prototype</code>이 <code class=\"language-text\">Foo.__proto__</code>에 링크되기 때문이다. 따라서 <code class=\"language-text\">Function.prototype</code>에 정의 된 내용를 그대로 사용 할수가 있게된다. (그렇다고 성능상 문제가 있으니, 런타임 중에 <code class=\"language-text\">new Funtion</code>을 사용하라는 말은 아니다.)</p>\n<p>아무튼 이러한 과정을 거치기 때문에 사용할 수가 있지만 추가적으로 <code class=\"language-text\">Foo.hasOwnProperty</code> 나 <code class=\"language-text\">Foo.valueOf</code> 라는 프로퍼티도 존재한다. 이러한 프로퍼티는 <code class=\"language-text\">Funtion.prototype</code>에 정의되어 있지도 않다. 하지만 사용가능한 이유는 자바스크립트의 주요 개념 중 하나가 함수도 객체라는 점이다. 또한 <code class=\"language-text\">Funtion.prototype</code>도 객체이기 때문에 이러한 이유들로 <code class=\"language-text\">Function.prototype.__proto__</code> 는 <code class=\"language-text\">Object.prototype</code> 과 연결 시켜놓았다. (<code class=\"language-text\">Function.prototype.__proto__ === Object.prototype; //true</code>)</p>\n<p>정리하면 Foo 의 prototype(원형)은 <code class=\"language-text\">Function</code>이고, <code class=\"language-text\">Function</code>의 prototype은 Object가 된다. 따라서 Foo의 ‘hasOwnProperty’ 프로퍼티 접근 시 <code class=\"language-text\">Foo.__proto__.__proto__</code> 까지 올라가서 정의된 hasOwnProperty를 호출하게 된다. (다시 한번 말하자면 프로퍼티 접근 시 <code class=\"language-text\">__proto__</code> 는 생략 가능)</p>\n<p>물론 중간에 <code class=\"language-text\">Function.prototype.hasOwnProperty = ~~</code> 로 정의 해놓지만 않았다는 가정이다.\n이런 식으로 자기 자신의 프로퍼티 부터 조사하여 자신과 링크된 원형(<code class=\"language-text\">[[Prototype]]</code> 또는 <code class=\"language-text\">__proto__</code>)을 순차적으로 방문하면서 프로퍼티를 찾는것을 프로토타입 체이닝이라고 한다.</p>\n<h3 id=\"25-상속\" style=\"position:relative;\"><a href=\"#25-%EC%83%81%EC%86%8D\" aria-label=\"25 상속 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5 상속</h3>\n<p>대표적으로 상속을 구현하기 위한 방법으로 es5에 나온 <code class=\"language-text\">Object.create</code> 함수를 이용하는 방법과 이를 직접 구현하는 방법으로 나누어진다. es5 사용환경이 가능하면 <code class=\"language-text\">Object.create</code>를 사용하는게 훨씬 편하므로 사용하는걸 추천하지만, 그렇지 않으면 직접 만들어서 상속을 구현해야한다.</p>\n<h4 id=\"251-objectcreate를-사용한-상속es5-이상\" style=\"position:relative;\"><a href=\"#251-objectcreate%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%9C-%EC%83%81%EC%86%8Des5-%EC%9D%B4%EC%83%81\" aria-label=\"251 objectcreate를 사용한 상속es5 이상 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5.1 Object.create를 사용한 상속(es5 이상)</h4>\n<p>es5에서 자바스크립트의 상속은 따로 네이티브로 존재하지 않기 때문에 위에 설명한 프로토타입 체이닝을 통하여 상속을 구현하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">myName</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Bar</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name<span class=\"token punctuation\">,</span> label</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">Foo</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>label <span class=\"token operator\">=</span> label<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">Bar</span><span class=\"token punctuation\">.</span>prototype <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//Bar.prototype = new Foo();    //Foo가 직접적으로 호출됨</span>\n<span class=\"token class-name\">Bar</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>constructor <span class=\"token operator\">=</span> Bar<span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Bar</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">myLabel</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> a <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Bar</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"obj a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span><span class=\"token function\">myName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//\"a\"</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span><span class=\"token function\">myLabel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//\"obj a\"</span></code></pre></div>\n<p>위 소스는 <code class=\"language-text\">prototype</code>을 통해서 상속을 구현하고 있다. 여기서 핵심은 <code class=\"language-text\">Bar.prototype = Object.create(Foo.prototype);</code> 라고 할수 있는데 먼저 <code class=\"language-text\">Object.create</code>는 새로운 객체를 생성하고 입력된 객체를 <code class=\"language-text\">[Prototype]]</code>으로 연결한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> createdObj <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ncreatedObj<span class=\"token punctuation\">.</span>__proto__ <span class=\"token operator\">===</span> obj<span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span></code></pre></div>\n<p>위 소스는 obj 값이 null일 때도 성립한다. 따라서 <code class=\"language-text\">new Bar()</code>로 생성되는 모든 객체는 프로토타입 체이닝을 통해 <code class=\"language-text\">Foo</code>와 연결된 객체를 프로토 타입으로 생성되게 된다.</p>\n<p>다시 정리하면 <code class=\"language-text\">Bar.prototype</code>은 결과적으로 <code class=\"language-text\">Foo.prototyp</code>e을 복사한 객체(<code class=\"language-text\">Object.create</code> 사용해서)를 집어넣고 확장(<code class=\"language-text\">Bar.prototype.myLabel = function ~</code>)해서 사용했다고 볼수 있다. 말이 조금 어려울 수도 있는데 코드로 보면</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">Bar</span><span class=\"token punctuation\">.</span>prototype <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">Bar</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">func1</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> bar <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbar<span class=\"token punctuation\">.</span>__proto__ <span class=\"token operator\">===</span> <span class=\"token class-name\">Bar</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span>\nbar<span class=\"token punctuation\">.</span>__proto__<span class=\"token punctuation\">.</span>__proto__ <span class=\"token operator\">===</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span></code></pre></div>\n<p><code class=\"language-text\">__proto__</code> 인 <code class=\"language-text\">[[Prototype]]</code>을 통해서 어느 객체에 링크 되어있는지 확인 할 수가 있다.</p>\n<p>마지막으로 <code class=\"language-text\">Bar.prototype.constructor = Bar;</code> 문장은 <code class=\"language-text\">Bar.prototype.constructor</code>를 따로 정의하지 않아서 프로토 타입 체이닝을 통해 <code class=\"language-text\">Foo.prototype.constructor</code>까지 그대로 올라가게 된다. 이러한 것을 막기 위해 정의해 놓은 것이다.</p>\n<blockquote>\n<p>참고로 위 소스에서 Bar.prototype = new Foo(); 를 사용하지 않는 이유는 생성된 객체의 <strong>proto</strong>에 의하여 프로토타입 체이닝이 이루어 지긴 하지만, 불필요한 Foo 객체가 생성되고 내부의 인스턴스의 프로퍼티까지도 prototype에 추가되기 때문이다.</p>\n</blockquote>\n<h4 id=\"252-util-상속-함수-구현\" style=\"position:relative;\"><a href=\"#252-util-%EC%83%81%EC%86%8D-%ED%95%A8%EC%88%98-%EA%B5%AC%ED%98%84\" aria-label=\"252 util 상속 함수 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5.2 Util 상속 함수 구현</h4>\n<p>2.5.1에선 <code class=\"language-text\">Object.create</code>를 사용하였지만 es5 미만에선 지원하지 않기 때문에 이 부분을 직접 구현하여 주어야 한다. 그리고 어차피 상속이 목적이니깐 +@로 상속에 맞는 기능을 추가하여 유틸성 함수인 <code class=\"language-text\">inherit</code>구현 하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> inherit <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> child</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> <span class=\"token function-variable function\">F</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">parent<span class=\"token punctuation\">,</span> child</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\">F</span><span class=\"token punctuation\">.</span>prototype <span class=\"token operator\">=</span> parent<span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">;</span>\n    child<span class=\"token punctuation\">.</span>prototype <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">F</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    child<span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>constructor <span class=\"token operator\">=</span> child<span class=\"token punctuation\">;</span>\n    child<span class=\"token punctuation\">.</span>super <span class=\"token operator\">=</span> parent<span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">myName</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Bar</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name<span class=\"token punctuation\">,</span> label</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">Foo</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> name<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>label <span class=\"token operator\">=</span> label<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">inherit</span><span class=\"token punctuation\">(</span>Foo<span class=\"token punctuation\">,</span> Bar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Bar</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">myLabel</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>label<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> a <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Bar</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"obj a\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span><span class=\"token function\">myName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//\"a\"</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">.</span><span class=\"token function\">myLabel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//\"obj a\"</span></code></pre></div>\n<p><code class=\"language-text\">inherit</code> 함수 내에서 싱글톤 함수인 <code class=\"language-text\">F</code>를 만들어서 child 함수를 만들때 마다 필요한 함수를 생성하지 않아도 되기 때문에 미리 만들어 놓았고,(다른 언어에선 이런식으로 util성 함수를 공통된 리소스를 변경하면서 까지 무분별하게 사용하면 thread-safe관련 문제가 생길 수 있지만 js는 싱글스레드 방식으로 돌아가서 상관없다) <code class=\"language-text\">child</code> 하위에 <code class=\"language-text\">super</code> 프로퍼티를 두어서 <code class=\"language-text\">Bar.super</code>를 통해 Parent 함수의 고유한 <code class=\"language-text\">prototype</code>에 접근 할 수 있게 만들어져 있다. 나머지는 2.5.1 동일하다.</p>\n<h1 id=\"3-주의사항\" style=\"position:relative;\"><a href=\"#3-%EC%A3%BC%EC%9D%98%EC%82%AC%ED%95%AD\" aria-label=\"3 주의사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 주의사항</h1>\n<h3 id=\"31-prototype-링크-또는-__proto__-는-단지-객체의-prototype에-링크-시킨다\" style=\"position:relative;\"><a href=\"#31-prototype-%EB%A7%81%ED%81%AC-%EB%98%90%EB%8A%94-__proto__-%EB%8A%94-%EB%8B%A8%EC%A7%80-%EA%B0%9D%EC%B2%B4%EC%9D%98-prototype%EC%97%90-%EB%A7%81%ED%81%AC-%EC%8B%9C%ED%82%A8%EB%8B%A4\" aria-label=\"31 prototype 링크 또는 __proto__ 는 단지 객체의 prototype에 링크 시킨다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 <code class=\"language-text\">[[Prototype]]</code> 링크 또는 <code class=\"language-text\">__proto__</code> 는 단지 객체의 prototype에 링크 시킨다.</h3>\n<p>일반 다른 클래스 언어는 클래스를 선언 후, 해당 클래스를 마구 찍어내듯 복사 하는 형식으로 인스턴스화 한다. 하지만 자바스크립트는 Prototype을 서로 연결해주는것으로 인스턴스화 한다. 엄밀히 말하면 다른 객체지향 클래스의 인스턴스와는 다른 개념이기 때문에, javascript에서 인스턴스화는 맞는 말은 아니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> beforeDef <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">show</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"show\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> afterDef <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nbeforeDef<span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//show</span>\nafterDef<span class=\"token punctuation\">.</span><span class=\"token function\">show</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//show</span></code></pre></div>\n<p><code class=\"language-text\">[[Prototype]]</code> 링크를 통해서 링크 되었다는 점은 위 소스에 보면 메소드를 정의 하기 전에 객체를 생성하거나, 정의 후 생성하거나 사용할 수 있다는 점을 통하여 확인할 수 있다.</p>\n<h3 id=\"32-bind를-통한-함수-생성-시-prototype은-생성되지-않는다\" style=\"position:relative;\"><a href=\"#32-bind%EB%A5%BC-%ED%86%B5%ED%95%9C-%ED%95%A8%EC%88%98-%EC%83%9D%EC%84%B1-%EC%8B%9C-prototype%EC%9D%80-%EC%83%9D%EC%84%B1%EB%90%98%EC%A7%80-%EC%95%8A%EB%8A%94%EB%8B%A4\" aria-label=\"32 bind를 통한 함수 생성 시 prototype은 생성되지 않는다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 <code class=\"language-text\">bind</code>를 통한 함수 생성 시, <code class=\"language-text\">prototype</code>은 생성되지 않는다.</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> Bar <span class=\"token operator\">=</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Bar</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">;</span> <span class=\"token comment\">//undefined</span>\n<span class=\"token keyword\">new</span> <span class=\"token class-name\">Bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__proto__ <span class=\"token operator\">===</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span></code></pre></div>\n<p>모든 함수는 생성 시, <code class=\"language-text\">Prototype</code> 프로퍼티가 생성되고, 그 안에 <code class=\"language-text\">constructor</code> 라는 프로퍼티가 생성된다고 하였다. 하지만 <code class=\"language-text\">Function.bind</code>를 통해서 함수를 생성 시, prototype은 생성되지 않는다. 왜 그렇게 만든지는 모르겠지만, 일단 bind 된 함수를 new를 통해 객체 생성 시, 기존 함수의 prototype으로 연결된다.</p>\n<h3 id=\"33-프로토타입-가려짐\" style=\"position:relative;\"><a href=\"#33-%ED%94%84%EB%A1%9C%ED%86%A0%ED%83%80%EC%9E%85-%EA%B0%80%EB%A0%A4%EC%A7%90\" aria-label=\"33 프로토타입 가려짐 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.3 프로토타입 가려짐</h3>\n<p>constructor를 정의하면서 잠깐 말했지만 프로퍼티를 접근 시, 가장 우선순위가 높은건 자기 자신 프로퍼티이고, 체이닝을 통해 점차 프로토타입에 있는 프로퍼티를 조사하게 되고 마지막 프로토타입(<code class=\"language-text\">Object.prototype</code>)까지 조사하고 없을 시 최종적으로 <code class=\"language-text\">undefined</code>를 반환하게 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">method1</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Foo method1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">method2</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Foo method2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">Bar</span><span class=\"token punctuation\">.</span>prototype <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Bar</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">method2</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Bar method2\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> bar <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Bar</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nbar<span class=\"token punctuation\">.</span><span class=\"token function\">method1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//Foo method1</span>\nbar<span class=\"token punctuation\">.</span><span class=\"token function\">method2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//Bar method2</span>\n\nbar<span class=\"token punctuation\">.</span>__proto__<span class=\"token punctuation\">.</span>method1 <span class=\"token operator\">===</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>method1<span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span>\nbar<span class=\"token punctuation\">.</span>__proto__<span class=\"token punctuation\">.</span>method2 <span class=\"token operator\">===</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>method2<span class=\"token punctuation\">;</span> <span class=\"token comment\">//false</span></code></pre></div>\n<p>어떻게 보면 정상적인 현상이지만 getter, setter 적용 시 혼동 될 수도 있다.</p>\n<h3 id=\"34-프로토타입-재정의-시-주의\" style=\"position:relative;\"><a href=\"#34-%ED%94%84%EB%A1%9C%ED%86%A0%ED%83%80%EC%9E%85-%EC%9E%AC%EC%A0%95%EC%9D%98-%EC%8B%9C-%EC%A3%BC%EC%9D%98\" aria-label=\"34 프로토타입 재정의 시 주의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.4 프로토타입 재정의 시 주의</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">method1</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Foo method1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> foo1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">method</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"new method\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> foo2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> foo3 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nfoo1<span class=\"token punctuation\">.</span><span class=\"token function\">method1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//Foo method1</span>\nfoo2<span class=\"token punctuation\">.</span>method1<span class=\"token punctuation\">;</span> <span class=\"token comment\">//undefined</span>\n\nfoo2<span class=\"token punctuation\">.</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//new method</span>\nfoo1<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">;</span> <span class=\"token comment\">//undefined</span>\n\nfoo1<span class=\"token punctuation\">.</span>__proto__ <span class=\"token operator\">===</span> foo2<span class=\"token punctuation\">.</span>__proto__<span class=\"token punctuation\">;</span> <span class=\"token comment\">//false</span>\nfoo2<span class=\"token punctuation\">.</span>__proto__ <span class=\"token operator\">===</span> foo3<span class=\"token punctuation\">.</span>__proto__<span class=\"token punctuation\">;</span> <span class=\"token comment\">//true</span></code></pre></div>\n<p>프로토타입에 프로퍼티를 확장하는 형태가 아니라 아예 새롭게 대입하면 그 이후에 생성된 객체들은 새로운 프로토타입 객체에 링크 되고, 기존에 생성된 객체들은 기존 프로토타입 객체를 링크시킨다.</p>\n<h3 id=\"35-this-bind\" style=\"position:relative;\"><a href=\"#35-this-bind\" aria-label=\"35 this bind permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.5 this bind</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getName</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">Foo</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">setName</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>getName <span class=\"token operator\">=</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">var</span> foo <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Foo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"name\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nfoo<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//name</span>\nfoo<span class=\"token punctuation\">.</span>__proto__<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//undefined</span></code></pre></div>\n<p><code class=\"language-text\">foo.__proto__.getName();</code>에서 this는 Foo.prototype이 된다. 프로토타입을 통하여 클래스를 구현하는건 어디까지나 자바스크립트만의 특성을 이용한 일종의 꼼수이다.</p>"}},{"node":{"fields":{"slug":"/posts/js/js-scope/","__typename":"MarkdownRemarkFields","categorySlug":"/category/javascript/"},"frontmatter":{"template":"post","title":"Scope","date":"2020-05-12T00:42:42.358Z","tags":["js","scope"],"socialImage":null,"draft":false,"description":"변수, 함수 등의 유효범위","category":"javascript"},"id":"40724cef-62c7-523c-8507-9d0b51d9e989","html":"<h1 id=\"scope\" style=\"position:relative;\"><a href=\"#scope\" aria-label=\"scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scope.</h1>\n<h1 id=\"1-정의\" style=\"position:relative;\"><a href=\"#1-%EC%A0%95%EC%9D%98\" aria-label=\"1 정의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 정의</h1>\n<p>변수의 유효 범위. 어느 스코프에서 변수를 찾아내는데 필요한 개념이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">innerScope</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> foo <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>foo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> foo <span class=\"token operator\">=</span> <span class=\"token number\">30</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>foo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//30</span>\n\n<span class=\"token function\">innerScope</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//10</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>foo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//다시 30</span></code></pre></div>\n<p>스코프는 전역 스코프와 그 외 내부 스코프로 구분된다. 각 스코프에서 변수를 호출 시, 현재 속한 스코프에서 가장 근접한 스코프에서 부터 변수를 찾는다. 위 소스를 보면 innerScope의 내부 변수 foo는 innerScope에 종속 되며(var는 함수 스코프!) foo를 호출 시 가장 가까운 스코프인 innerScope 함수에서 변수를 찾아 사용한다(내부 스코프는 계속해서 계층형 구조를 갖는다고 생각하면 된다). 그 외 전역스코프에서는 foo(소스에서 var foo = 30;)는 전역 객체에 종속 되고, 호출 시 30이라는 값이 사용된다. 해당 스코프에서 변수가 없을 시 상위 스코프에서 변수를 찾고, 없을 시 계속해서 상위 스코프로 이동하며 변수를 찾는다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">innerScope2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>bar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> bar <span class=\"token operator\">=</span> <span class=\"token number\">50</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">innerScope2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//50</span></code></pre></div>\n<p>innerScope2() 함수에서 bar는 선언되지 않았으므로, 글로벌 스코프에서 부터 bar를 찾아 사용하게 된다.</p>\n<h1 id=\"2-주요-내용\" style=\"position:relative;\"><a href=\"#2-%EC%A3%BC%EC%9A%94-%EB%82%B4%EC%9A%A9\" aria-label=\"2 주요 내용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 주요 내용</h1>\n<h3 id=\"21-스코프는-별다른-키워드eval-with를-사용하지-않는한-선언-시-결정된다\" style=\"position:relative;\"><a href=\"#21-%EC%8A%A4%EC%BD%94%ED%94%84%EB%8A%94-%EB%B3%84%EB%8B%A4%EB%A5%B8-%ED%82%A4%EC%9B%8C%EB%93%9Ceval-with%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EC%A7%80-%EC%95%8A%EB%8A%94%ED%95%9C-%EC%84%A0%EC%96%B8-%EC%8B%9C-%EA%B2%B0%EC%A0%95%EB%90%9C%EB%8B%A4\" aria-label=\"21 스코프는 별다른 키워드eval with를 사용하지 않는한 선언 시 결정된다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 스코프는 별다른 키워드(eval, with)를 사용하지 않는한 선언 시 결정된다.</h3>\n<blockquote>\n<p>매우 중요하고 기본이 되는 내용으로, 별다른 선언을 하지 않는 이상(eval, with)컴파일 시 결정 되는 것이 아니라 선언 시에 결정이 된다. 이 내용만 항상 기억하고 있으면 스코프 반은 알고 들어가는것이다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//scope</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">innerScope1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> foo <span class=\"token operator\">=</span> <span class=\"token string\">\"innerScope1\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">innerScope2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">innerScope2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//var foo = 'innerScope2';</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>foo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//globalScope!</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> foo <span class=\"token operator\">=</span> <span class=\"token string\">\"globalScope!\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">innerScope1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위 소스를 보면 함수 호출 순서는 글로벌 -> innerScope1() -> innerScope2()가 될것이다. 출력 내용을 보면 ‘globalScope!’가 될것인데, 그 이유는 스코프는 선언시에 결정되기 때문이다. 만약 스코프가 선언 시가 아니라 어떻게 사용하는지(동적 스코프. dynamic scope)에 따라 결정된다면 컴파일 시에 호출 순서에 따른 동적으로 내부 스코프 순서를 결정할 것이고, ‘innerScope1’가 출력 되었을 것이다. 확실히 선언시 결정 된다는 점은 밑에 소스를 보면 구분이 될 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">outerScope</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> foo <span class=\"token operator\">=</span> <span class=\"token string\">\"outerScope!\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">innerScope</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">innerScope</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//var foo = 'innerScope';</span>\n\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>foo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//outerScope!</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> foo <span class=\"token operator\">=</span> <span class=\"token string\">\"globalScope!\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">outerScope</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위 소스에서도 함수 호출 순서는 이름만 다르지 글로벌 -> outerScope() -> innerScope() 순서로 진행이 된다. 하지만 출력되는 내용은 ‘outerScope!’가 된다. 이는 innerScope함수가 outerScope에 선언되어 있고, innerScope 함수에서 변수 ‘foo’는 우선적으로 innerScope 스코프에서 찾고, 선언되어 있지 않을 시 전역 스코프가 아닌 자신(innerScope)이 선언된 outerScope에서 변수를 찾기 시작한다. 이렇게 상위 스코프가 연결된 구조를 스코프 체이닝(scope chaining)이라 한다.</p>\n<blockquote>\n<p>eval, with의 스코프 관련해서 짤막하게 설명하자면 두개를 사용 후 컴파일 시, 스코프를 바꿔주는 부가적은 효과가 나타난다. 바꿔말하면 컴파일 시 이미 결정된 스코프를 동적으로 바꿔주는 작업을 하기 때문에 성능적으로 좋지도 않고, 점점 사용하지 않는 방향으로 가므로 관련해서 설명은 생략!</p>\n</blockquote>\n<h3 id=\"22-렉시컬-스코프lexical-scope\" style=\"position:relative;\"><a href=\"#22-%EB%A0%89%EC%8B%9C%EC%BB%AC-%EC%8A%A4%EC%BD%94%ED%94%84lexical-scope\" aria-label=\"22 렉시컬 스코프lexical scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 렉시컬 스코프(lexical scope)</h3>\n<p>사실 렉시컬 스코프(lexical scope)관련해서 설명은 다 했다. 스코프는 ‘변수를 찾기 위한 범위’, 렉시컬 스코프는 ‘함수를 어디에 선언하는지에 따라 생기는 스코프 체이닝(scope chaining) 특성’이라고 생각하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">scope1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">function</span> scope1<span class=\"token punctuation\">.</span><span class=\"token number\">1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">scope2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">function</span> scope2<span class=\"token punctuation\">.</span><span class=\"token number\">1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n      <span class=\"token keyword\">function</span> scope2<span class=\"token punctuation\">.</span><span class=\"token number\">1.1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>함수명은 이해하기 쉽게 x.x 형태로 넘버링 했다… 변수명 관련해서 규칙은 일단 pass 위 소스에서 일부 함수의 스코프 체이닝을 살펴보면</p>\n<p>scope1.1의 스코프 체인</p>\n<blockquote>\n<p>scope1.1 -> scope1</p>\n</blockquote>\n<p>scope2.1의 스코프 체인</p>\n<blockquote>\n<p>scope2.1 -> scope2</p>\n</blockquote>\n<p>scope2.1.1의 스코프 체인</p>\n<blockquote>\n<p>scope2.1.1 -> scope2.1 -> scope2</p>\n</blockquote>\n<p>이런 식으로 구조가 잡힐 것이다. 각 함수의 스코프는 리스트 형태로 관리된다고 생각하고, 각 함수의 스코프는 단방향(scope2.1 함수에서 scope2.1.1의 스코프에 접근 할 수 없다.)이라는 점도 함께 기억하자.</p>\n<h3 id=\"23-function-scope-block-scope\" style=\"position:relative;\"><a href=\"#23-function-scope-block-scope\" aria-label=\"23 function scope block scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 function scope, block scope</h3>\n<p>각 변수 선언 키워드 마다 scope의 범위가 다르다. scope는 변수의 유효범위 라고 하였다. 그럼 scope의 범위(단위)를 알아보자.</p>\n<h4 id=\"231-function-scope\" style=\"position:relative;\"><a href=\"#231-function-scope\" aria-label=\"231 function scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3.1 function scope</h4>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">fnScope</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> foo <span class=\"token operator\">=</span> <span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> bar <span class=\"token operator\">=</span> <span class=\"token string\">\"bar\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>foo<span class=\"token punctuation\">,</span> bar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//foo bar</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 소스를 보면 스코프의 단위가 블록(block. {})과 전혀 관계가 없다는 점을 알 수가 있다. 조금 더 설명 하자면 만약 스코프의 단위를 <code class=\"language-text\">{}</code> 단위로 정하였다면 변수 <code class=\"language-text\">bar</code>는 접근 할 수가 없었을 것이다(단방향). 하지만 <code class=\"language-text\">var</code>의 키워드를 사용하여 변수를 선언 하였을 시 스코프 단위는 함수가 되어, 함수 내에서 블록과 관계없이 변수 접근이 가능하다. 이러한 점은 개발 시 생각 외의 차이를 남길 수가 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">fnScope2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//var i = 100;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 5</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>충격적이게도 i는 for문 내에 종속되는것이 아니라 for문 밖에서도 접근이 가능하다. 이는 scope 단위가 함수가 되어, for문 내에서 i를 선언 하면 함수(fnScope2)에 종속 되어 함수 내에서 선언 한것과 동일하다는 점이다. 만약 i를 다른곳에서도 사용 하고 있었다면, i값는 바뀌어서 버그가 발생 할 수도 있다.</p>\n<h4 id=\"232-block-scope\" style=\"position:relative;\"><a href=\"#232-block-scope\" aria-label=\"232 block scope permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3.2 block scope</h4>\n<p>만약 이러한 점을 예방하기 위해서는 <code class=\"language-text\">var</code>로 변수를 선언 하면 안되고, block scope 단위로 변수가 생성되는 <code class=\"language-text\">let</code>, <code class=\"language-text\">const</code>를 사용해서 변수를 선언해야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">blScope</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> foo <span class=\"token operator\">=</span> <span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> bar <span class=\"token operator\">=</span> <span class=\"token string\">\"bar\"</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>foo<span class=\"token punctuation\">,</span> bar<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//ERROR! bar is not defined</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>소스 내용은 다 똑같고, 선언 시 키워드만 <code class=\"language-text\">let</code>으로 바꾸었다. <code class=\"language-text\">let</code>으로 변수를 선언 시, scope의 범위는 <code class=\"language-text\">{}</code> 기준으로 구분 되며, 에러가 발생하는 것을 확인 할 수 있다. 물론 2.3.1에서 발생한 for문 내 i값도 함수가 아니라 for문 내 블록에 종속 되어 차후 발생할 수도 있는 버그를 예방 할 수 있다. 또한 이러한 특성이 유용한 점은 closure + garbage collection 조합에서 볼 수가 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">handleData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> foo <span class=\"token operator\">=</span> <span class=\"token string\">\"foo\"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> bigData <span class=\"token operator\">=</span> <span class=\"token function\">getBigData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//단순 결과값이 많은 데이터</span>\n    <span class=\"token comment\">//TODO handling Big Data</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">//TODO after handling Big Data</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 함수에서 만약 let이 아닌 var를 사용하여 구성하였다면, scope단위는 function이 되어 <code class=\"language-text\">bigData</code>는 사용 여부와 상관없이 handleData 함수에 종속 되어 handleData함수를 스코프로 갖는 함수들은 이 bigData를 가지고 다닐 수 밖에 없다. 하지만 위 소스처럼 let을 사용하여 bigData의 스코프를 제한 시키면, 블록 밖에서 접근 할 수 없으므로 garbage collection 대상이 될 것이다. closure 연관해서 설명은 빠져 있는데, handleData의 내부 스코프를 다른 외부 스코프에서도 접근(또는 이벤트 바인딩 등) 할 수 있다는 가정 하에 보거나, 아니면 closure를 알고 다시한번 보던가 하자.</p>\n<h3 id=\"24-즉시-실행-함수iife-immediately-invoked-function-expression\" style=\"position:relative;\"><a href=\"#24-%EC%A6%89%EC%8B%9C-%EC%8B%A4%ED%96%89-%ED%95%A8%EC%88%98iife-immediately-invoked-function-expression\" aria-label=\"24 즉시 실행 함수iife immediately invoked function expression permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.4 즉시 실행 함수(IIFE. Immediately-Invoked Function Expression)</h3>\n<p>블록 스코프든 함수 스코프든 함수는 별도의 스코프를 갖는다는 점을 알수 있다. 이러한 점을 이용하여 다른 코드에 영향을 주지 않는 별도의 스코프를 만들어 작업하는것이 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">//즉시 실행 함수를 활용한 별도의 스코프 생성</span>\n<span class=\"token keyword\">var</span> scope <span class=\"token operator\">=</span> <span class=\"token string\">\"globla scope\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> scope <span class=\"token operator\">=</span> <span class=\"token string\">\"inner scope\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>scope<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>즉시 실행 함수 사용법 관련해서 설명은 생략. 어떠한 작업을 할 때 즉시 실행 함수를 사용하여 별도의 스코프를 생성하여 작업하면, 외부의 global scope에 전혀 영향을 주지 않고 작업이 가능하다. 이러한 방식은 여러 라이브러리에서도 많이 사용하는 방식이다.</p>"}},{"node":{"fields":{"slug":"/posts/js/js-symbol/","__typename":"MarkdownRemarkFields","categorySlug":"/category/javascript/"},"frontmatter":{"template":"post","title":"Symbol","date":"2021-09-30T15:06:06.220Z","tags":["js","iterator"],"socialImage":null,"draft":false,"description":"유일한 프로퍼티 키값을 만들고 싶을때.","category":"javascript"},"id":"631f7db7-4585-5edf-a1de-e792841e70cf","html":"<h1 id=\"symbol\" style=\"position:relative;\"><a href=\"#symbol\" aria-label=\"symbol permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Symbol</h1>\n<h2 id=\"1-기본-정의\" style=\"position:relative;\"><a href=\"#1-%EA%B8%B0%EB%B3%B8-%EC%A0%95%EC%9D%98\" aria-label=\"1 기본 정의 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 기본 정의</h2>\n<p>js에서 몇 안되는 원시타입 중 하나. <code class=\"language-text\">Symbol</code>을 통해 생성되면 항상 유니크한 식별자가 보장된다(예외 경우도 있다)</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//false</span>\n\n<span class=\"token keyword\">const</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> keyA1 <span class=\"token operator\">=</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> keyA2 <span class=\"token operator\">=</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nobj<span class=\"token punctuation\">[</span>keyA1<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"A1\"</span><span class=\"token punctuation\">;</span>\nobj<span class=\"token punctuation\">[</span>keyA2<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"A2\"</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">/*\n{\n    Symbole(A): \"A1\"\n    Symbole(A): \"A2\"\n}\n*/</span></code></pre></div>\n<p>얼핏 보면 똑같은 프로퍼티 키값이 존재하는걸로 보이지만 당연히 프로퍼티 키값은 다르다. (<code class=\"language-text\">keyA1 !== keyA2</code> 이기 때문에) 심볼 생성 시 넘겨준 인자값은 단순 심볼 설명(구분)을 위한 값일 뿐, 그 이상의 역할을 하지는 않는다.</p>\n<h2 id=\"2-symbolfor\" style=\"position:relative;\"><a href=\"#2-symbolfor\" aria-label=\"2 symbolfor permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Symbol.for</h2>\n<p>심볼 인자값을 description 용도가 아닌 진짜 키의 일부분으로 쓰기 위해 만들어진 심볼 객체 생성 메소드. Symbol 은 항상 새로운 객체를 만들어내지만 <code class=\"language-text\">Symbol.for</code>는 파라미터 값에 따라 동일한 심볼이 반환 될 수도 있다.</p>\n<p><code class=\"language-text\">Symbol.for</code>를 통해 생성 된 심볼은 먼저 해당 파라미터로 전역 심볼 레지스트리(global symbol registry) 내 동일한 값이 있는지 찾는다. 만약 없다면 새로운 심볼을 생성해서 만든 후, 전역 심볼 레지스트리에 등록한다. 그 후 <code class=\"language-text\">Symbol.for</code>을 통해 동일한 파라미터로 심볼을 생성하려고 하면 기존에 생성된 심볼을 반환 해준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> keyA1 <span class=\"token operator\">=</span> Symbol<span class=\"token punctuation\">.</span><span class=\"token function\">for</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> keyA2 <span class=\"token operator\">=</span> Symbol<span class=\"token punctuation\">.</span><span class=\"token function\">for</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"A\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nobj<span class=\"token punctuation\">[</span>keyA1<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"A1\"</span><span class=\"token punctuation\">;</span>\nobj<span class=\"token punctuation\">[</span>keyA2<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"A2\"</span><span class=\"token punctuation\">;</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">/*\n{\n    Symbole(A): \"A2\"\n}\n*/</span></code></pre></div>\n<p>위에서 설명 했듯이, <code class=\"language-text\">Symbol.for(\"A\") === Symbol.for(\"A\")</code> 는 true를 반환하므로 객체엔 오직 하나의 프로퍼티만 존재하게 된다.</p>\n<h2 id=\"3-미리-정의-된-심볼-들\" style=\"position:relative;\"><a href=\"#3-%EB%AF%B8%EB%A6%AC-%EC%A0%95%EC%9D%98-%EB%90%9C-%EC%8B%AC%EB%B3%BC-%EB%93%A4\" aria-label=\"3 미리 정의 된 심볼 들 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 미리 정의 된 심볼 들</h2>\n<p>다른 키와 겹치지 않는 유일한 프로퍼티 키값으로 사용하기 위해 js 내부적으로 이미 많은 심볼들이 정의되어 있다. 주요 프로퍼티를 실수로 덮어씌우면 의도치 않는 버그가 일어날 수도 있으므로 이런 프로퍼티는 외부에서 볼 수 없게 시스템 적으로 숨겨놓고 오직 미리 정의된 심볼을 통해서만 접근 할 수 있게끔 만들어놓으면, 개발자가 필요할때 정의 된 심볼을 통해 분명한 목적을 가지고 접근 한 것이라 판단 할 수 있으므로 버그를 줄여주는데 많은 역할을 하고 있다.</p>\n<p>대표적으로 미리 정의 된 심볼들은 Symbol.match , Symbol.replace , Symbol.search, Symbol.iterator 등이 존재한다.</p>\n<h3 id=\"symboliterator\" style=\"position:relative;\"><a href=\"#symboliterator\" aria-label=\"symboliterator permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Symbol.iterator</h3>\n<p>Iterable, 그니까 순환 가능한 객체를 만들기 위해선 java 에서는 Iterator 를 구현하면 되고, javascript에선 내부 프로퍼티인 @@iterator 를 구현해주면 된다. 근데 이건 일반적으로 접근이 불가능한데, 이 객체에 접근하기 위해 사용되는 심볼이 바로 Symbol.iterator 이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">const</span> it <span class=\"token operator\">=</span> arr<span class=\"token punctuation\">[</span>Symbol<span class=\"token punctuation\">.</span>iterator<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nit<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//{value:1,done:false}</span>\nit<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//{value:2,done:false}</span>\nit<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//{value:3,done:false}</span>\nit<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//{value: undefined, done:true}</span>\nit<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//{value: undefined, done:true}</span>\nit<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">//{value: undefined, done:true}</span>\n<span class=\"token operator\">...</span>\n<span class=\"token operator\">...</span></code></pre></div>\n<p><code class=\"language-text\">Array</code>에 순환 객체(iterator)를 생성하기 위해 <code class=\"language-text\">Symbol.iterator</code>을 통해 접근하여 <code class=\"language-text\">iterator</code>를 생성하고 next를 통해 반복적으로 호출해 보면 array에 저장된 값들을 전부 순환해서 확인 할 수가 있다. (iterator에 대한 자세한 설명은 생략)</p>\n<p><code class=\"language-text\">js</code>에서 기본적으로 <code class=\"language-text\">array</code>, <code class=\"language-text\">map</code>, <code class=\"language-text\">set</code> 등은 <code class=\"language-text\">@@iterator</code> 가 구현되어 있어서 순환 가능한 객체로 분류된다. <code class=\"language-text\">js</code>에서 순환 가능한 객체라는 의미는 <code class=\"language-text\">for...of</code>나 <code class=\"language-text\">spread</code>를 사용 할 수 있다는 점이 큰 특징이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">const</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token punctuation\">[</span>Symbol<span class=\"token punctuation\">.</span>iterator<span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> val <span class=\"token keyword\">of</span> arr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">yield</span> val\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">//obj 는 실질적으로 빈 깡통인데 iterator만 구현 해줘서 외부 array값을 순환 할 수 있게 만들 수 있다.</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>obj<span class=\"token punctuation\">)</span>  <span class=\"token comment\">//1 2 3 4 5. --> spread</span>\n\n\n<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> _val <span class=\"token keyword\">of</span> obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>_val<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 1,2,3,4,5 가 순서대로 출력된다.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>generator 문법은 이미 포스트 해놓은 것이 있으니 생략하고, 이런식으로 <code class=\"language-text\">iterator</code>만 구현해서 외부객체를 마치 내가 가지고 있는것처럼 프로퍼티를 만들어 놓을 수가 있다.\n다시 말하지만 <code class=\"language-text\">spread</code>, <code class=\"language-text\">for...of</code>는 iterator(<code class=\"language-text\">@@iterator</code>)에 의존하게 된다.</p>"}},{"node":{"fields":{"slug":"/posts/js/js-virtual-scroll/","__typename":"MarkdownRemarkFields","categorySlug":"/category/javascript/"},"frontmatter":{"template":"post","title":"Virtual Scroll","date":"2022-02-15T01:04:52.214Z","tags":["js","react"],"socialImage":null,"draft":false,"description":"화면에 너무 많은 아이템이 그려져 dom 그려지는게 느려질 때","category":"javascript"},"id":"d6795788-5438-568b-9420-c27c3c238247","html":"<p>구현 된 샘플은 <a href=\"https://github.com/qweasd147/ReactStudy/tree/master/virtual-scroll\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">여기서</a> 직접 확인이 가능하다.</p>\n<h1 id=\"virtual-scroll\" style=\"position:relative;\"><a href=\"#virtual-scroll\" aria-label=\"virtual scroll permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Virtual Scroll.</h1>\n<p>무한 스크롤을 통해 화면에 많은 데이터 들을 뿌려주다보면 어느 순간 브라우저가 느려지는걸 느낄 수 있을 것이다. 단순한 데이터라도 몇만개가 넘어가면 브라우저에서 그려주는거 조차 힘들어 지면서 발생 하는 현상이다. 여기에 해당 컨텐츠 아이템들 dom 구조가 간단한거 조차도 아니라면 더욱 심해질 것이라 생각된다.</p>\n<p>이럴 때 유용한 것이 가상 스크롤이다. 딱 해당 컨텐츠 영역에 보여지는 데이터만 표출 해주고, 나머지는 dom을 따로 없애주면 무한스크롤을 구현해서 10000만개가 넘는 데이터 라도 자연스럽게 표출이 가능하다(데이터 숫자는 크게 의미가 없어지고, 적어도 dom이 너무 많아 브라우저가 느려지는 현상은 없애준다.) 물론 보여지는 컨텐츠 말고 다른영역에다 임의의 단순 컨텐츠를 채워 넣어, 스크롤 높이는 자연스럽게 표출하여 ux 상으론 똑같이 보여줘야한다(이래서 가상 스크롤이라고 한다).</p>\n<hr>\n<p>가상스크롤을 구현하기 위해선 몇가지 조건이 필요하다</p>\n<ol>\n<li>하나의 아이템 컨텐츠의 높이를 정확히 알아야 한다. grid라도 상관없지만 요점은 row 컨텐츠의 아이템 높이를 알아야 한다는거다</li>\n<li>전체 아이템 개수를 알아야한다. 그래야지만 y 스크롤 높이를 계산하여, 가상스크롤 구현이 가능하다(이 부분 관련해선 밑에서 추가로 보충함)</li>\n</ol>\n<p>구현 아이디어 자체는 간단하다. 설명한대로 컨텐츠 viewport 부분만 아이템을 채우고 그 외엔 그냥 <code class=\"language-text\">div</code> 같은거 or 패딩을 줘서 스크롤로 내가 어느정도 쯤 위치하고 있는지만 보여질수 있게 만들면 된다.</p>\n<p>예를들어 아래와 같이 <code class=\"language-text\">item</code> 들을 나열한 목록이 있다면 이 단순한 아이템들도 10개가 아닌 100000만개쯤 되면 브라우저도 버벅이기 시작한다</p>\n<p><img src=\"/blog/media/javascript/virtual-scroll01.png\" alt=\"img1\"></p>\n<p>하지만 가상 스크롤을 구현해서 보여지는 영역 외엔 그냥 div로 채워 넣어, 스크롤만 보여주면 가상 스크롤이 완성된다.</p>\n<p>몇만개가 넘는 아이템만 표출 될 수 있지만 오른쪽 실제 dom을 보면 20개 정도 만 표출되고, 그냥 높이 맞추기위한 <code class=\"language-text\">div</code> 를 위 아래로 둬서 height만 차지하게 되어있다.</p>\n<p><img src=\"/blog/media/javascript/virtual-scroll02.gif\" alt=\"virtual-scroll\"></p>\n<p>위 gif를 보면 보여지는 스크롤 높이, 아이템들은 자연스럽지만 실질적으로 <code class=\"language-text\">item div</code> 개수는 얼마 안되는 걸 확인 할 수가 있다. 참고로 진짜 딱 화면에 보여지는것만 표출하는게 아니라 위아래로 5~10개쯤 미리 그려놓아서 스크롤 시에 부드럽게 보여지도록 해놓는게 좋다.</p>\n<hr>\n<p>다 좋은데 만약 이렇게 만들면 진짜 백엔드에선 서버 터지지 않을까 걱정되긴 한다. 예를들어 그때그때 아이템 목록을 서버로 요청해야 한다면 스크롤만 위아래로 올렷다 내렷다 반복하면 진짜 서버 터질까봐 걱정된다. 따라서 진짜 가상 스크롤을 만들려면 <code class=\"language-text\">api gateway</code> 같은 걸 미리 구축해 놔서 api 자체를 캐싱하거나 그냥 한번에 미리 받아서 브라우저 상에서 처리하는게 선행되어야 할 것이다.</p>\n<p>다른곳은 어떻게 해놧나 몇군데 사이트도 돌아다녀 봣는데 정말 서버에 무리가는걸 줄일려고 그런건지 정말 모든 데이터 개수를 기반으로 가상스크롤 계산해서 구현 해 놓는게 아니라 그냥 어느 정도만 계산해서 무한스크롤 형태로 구현해놓고, 이미 불러온건 그냥 브라우저 메모리에 올리고 더 요청 안하게끔만 만들어져 잇엇다. (이미 불러와진건 정말 화면에 표출되는거 빼곤 dom을 없애버려서 가상스크롤은 구축되어 있엇다)</p>"}},{"node":{"fields":{"slug":"/posts/spring/spring-jpa/","__typename":"MarkdownRemarkFields","categorySlug":"/category/spring/"},"frontmatter":{"template":"post","title":"JPA","date":"2020-11-27T03:08:42.258Z","tags":["spring","jpa","orm"],"socialImage":null,"draft":false,"description":"Spring DATA JPA & QueryDSL를 써보면서 느낀 주의점 & 고난","category":"spring"},"id":"2728297e-7ee3-5890-addf-e8e22eb91cc8","html":"<p>여기서 설명할 내용 및 샘플은 <a href=\"https://github.com/qweasd147/springboot-jpa\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">JPA 샘플</a> 여기서 확인 가능</p>\n<p>목차</p>\n<ol>\n<li>2차 캐싱 시 주의점</li>\n<li>N + 1 문제</li>\n<li>OneToOne Lazy Loading</li>\n<li>연관 관계 없을 시 조인</li>\n<li>bulk insert</li>\n</ol>\n<h2 id=\"1-2차-캐싱-시-주의점\" style=\"position:relative;\"><a href=\"#1-2%EC%B0%A8-%EC%BA%90%EC%8B%B1-%EC%8B%9C-%EC%A3%BC%EC%9D%98%EC%A0%90\" aria-label=\"1 2차 캐싱 시 주의점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 2차 캐싱 시 주의점</h2>\n<p>1차 캐싱은 캐싱 주기가 매우 짧기도 하고 각 스레드에 종속되어 문제되는 경우는 거의 없다고 생각된다(근데 1차 캐시로 성능상 이득보기는 정말 힘들다). 하지만 2차 캐시의 경우 어플리케이션에 캐싱 해두고 사용하는것으로 종종 문제점이 발생하기도 한다.</p>\n<h4 id=\"entity\" style=\"position:relative;\"><a href=\"#entity\" aria-label=\"entity permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Entity</h4>\n<p>상황 설명을 위해 <code class=\"language-text\">JPA 샘플</code>에 <code class=\"language-text\">Entity</code>와 2개의 API를 만들어 두었다.</p>\n<p>Article.java</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span>\n<span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Article</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span>IDENTITY<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> idx<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token annotation punctuation\">@OneToMany</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span>LAZY<span class=\"token punctuation\">,</span> cascade <span class=\"token operator\">=</span> <span class=\"token class-name\">CascadeType</span><span class=\"token punctuation\">.</span>PERSIST<span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"article_idx\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@OrderBy</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"idx ASC \"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@BatchSize</span><span class=\"token punctuation\">(</span>size <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Tag</span><span class=\"token punctuation\">></span></span> tags <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Tag.java</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@NoArgsConstructor</span>\n<span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Tag</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Id</span>\n    <span class=\"token annotation punctuation\">@GeneratedValue</span><span class=\"token punctuation\">(</span>strategy <span class=\"token operator\">=</span> <span class=\"token class-name\">GenerationType</span><span class=\"token punctuation\">.</span>IDENTITY<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> idx<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@ManyToOne</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span>LAZY<span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"article_idx\"</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@BatchSize</span><span class=\"token punctuation\">(</span>size <span class=\"token operator\">=</span> <span class=\"token number\">20</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Article</span> article<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> tag<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>1 대 N 양방향 으로 맵핑된 <code class=\"language-text\">Article</code>, <code class=\"language-text\">Tag</code> entity</p>\n</blockquote>\n<h4 id=\"api소스는-샘플-참고\" style=\"position:relative;\"><a href=\"#api%EC%86%8C%EC%8A%A4%EB%8A%94-%EC%83%98%ED%94%8C-%EC%B0%B8%EA%B3%A0\" aria-label=\"api소스는 샘플 참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>API(소스는 샘플 참고)</h4>\n<ol>\n<li>\n<p>어플리케이션에 <code class=\"language-text\">Article</code>을 조회 후, 3초 동안 캐싱 해두는 API</p>\n<blockquote>\n<p>POST : <code class=\"language-text\">http://localhost:8080/api/article/cache/5</code></p>\n</blockquote>\n</li>\n<li>\n<p><code class=\"language-text\">Article</code>을 캐시에서 조회, 없으면 db에서 값을 찾고 <code class=\"language-text\">Tag</code>를 <code class=\"language-text\">Lazy Loading</code>하는 API</p>\n<blockquote>\n<p>GET : <code class=\"language-text\">http://localhost:8080/api/article/cache/5</code></p>\n</blockquote>\n</li>\n</ol>\n<p>먼저 <code class=\"language-text\">GET</code> 요청을 하면 정상적으로 결과 값이 반환된다. 하지만 <code class=\"language-text\">POST</code>로 요청 후, 3초 이내에 <code class=\"language-text\">GET</code>으로 요청하면 에러가 발생한다.</p>\n<p>에러 내용</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">- ERROR : failed to lazily initialize a collection of role: com.example.model.Article.tags, could not initialize proxy - no Session\n- WARN : Resolved [org.hibernate.LazyInitializationException: failed to lazily initialize a collection of role: com.example.model.Article.tags, could not initialize proxy - no Session]</code></pre></div>\n<p>에러 내용은 대충 ’<code class=\"language-text\">Tag</code> Entity를 지연 조회(<code class=\"language-text\">lazily initialize</code>)를 실패 했다.‘라는 내용이다. 에러 발생 과정을 나열해보면</p>\n<ol>\n<li><code class=\"language-text\">POST</code> API에서 <code class=\"language-text\">Article</code>만 조회 하고, <code class=\"language-text\">Tag</code>값은 조회 하지 않고 캐싱 해둔다.</li>\n<li><code class=\"language-text\">GET</code> API에서 캐싱 된 <code class=\"language-text\">Article</code>을 가져온다. 이때 <code class=\"language-text\">Article</code>은 <strong>준영속성 상태</strong>이다.</li>\n<li><code class=\"language-text\">Article</code>에서 <code class=\"language-text\">Tag</code>를 조회 하려고 한다. -> 에러 발생!</li>\n</ol>\n<blockquote>\n<p>간단히 말하면 캐싱 해둔 데이터를 다른 스레드에서 가져와 <code class=\"language-text\">lazy loading</code>을 시도해 발생한 문제이다. <code class=\"language-text\">EntityManager</code>와 <code class=\"language-text\">Persistence Context</code>는 각각의 스레드에 종속되어 있다. 그래서 다른 스레드에 의해 캐싱 된 데이터를 꺼내오더라도 현재 스레드에선 <code class=\"language-text\">준영속성 상태</code>가 된다.</p>\n</blockquote>\n<p>이런 문제를 막기 위해 캐싱 할 데이터는 필요한 정보를 다 초기화 시키고 저장되도록 유도하던가, 다 초기화 시키기 부담스러우면 필요 데이터를 초기화 시키고 dto 형태로 변환하여 저장 되도록 관리되어야 한다.</p>\n<h2 id=\"2-n--1-문제\" style=\"position:relative;\"><a href=\"#2-n--1-%EB%AC%B8%EC%A0%9C\" aria-label=\"2 n  1 문제 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. N + 1 문제</h2>\n<p><code class=\"language-text\">N + 1 문제</code> 설명 자체는 생략 하고 바로 해결법 부터 설명</p>\n<p><code class=\"language-text\">Entity</code>의 연관 관계들은 기본옵션으로 <code class=\"language-text\">Lazy Loading</code>이 되도록 설정 해놓고(<code class=\"language-text\">FetchType.LAZY</code>), 사용 시 필요에 맞춰 즉시 실행 or 지연실행이 되도록 유도해야한다. 적당히 <code class=\"language-text\">Entity</code> 연관 관계에 <code class=\"language-text\">@BatchSize</code>를 걸어놓고, <code class=\"language-text\">FetchJoin</code>이나 <code class=\"language-text\">Repository</code>에 <code class=\"language-text\">@EntityGraph</code>등을 쓰면 쉽게 해결이 가능하다.</p>\n<p>상당히 불친절한 설명이라고 생각할 수 있지만 사실 <code class=\"language-text\">N + 1</code>문제는 당장 해결이 어렵다기 보다는 쌓여가는 레거시 코드들을 상대로 얼마나 안전하게, 또 재사용을 높이면서 관리하는게 힘들 뿐이다. 그래서 개인적으로 <code class=\"language-text\">Service</code>클래스는 왠만하면 순수한 형태(<code class=\"language-text\">Lazy Loading</code>만 하도록)로 사용하고 <code class=\"language-text\">Facade</code>클래스를 만들어 필요에 따라 연관 <code class=\"language-text\">entity</code>들을 추가로 초기화 시키는 형태로 하는게 좋은것 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ArticleServiceFacade</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ArticleService</span> articleService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Article</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">searchAllWithInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Article</span><span class=\"token punctuation\">></span></span> articles <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>articleService<span class=\"token punctuation\">.</span><span class=\"token function\">searchAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        articles<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span><span class=\"token operator\">-></span> <span class=\"token class-name\">Hibernate</span><span class=\"token punctuation\">.</span><span class=\"token function\">initialize</span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">.</span><span class=\"token function\">getTags</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> articles<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이런식으로 사용하는게 재사용성도 높이고, 필요한 정보만 딱딱 조회 하고 처리 할 수 있어 좋은것 같다. <code class=\"language-text\">facade</code>클래스 자체가 애매하다고 생각되면 <code class=\"language-text\">service</code>에서 다 처리해도 상관은 없을꺼 같긴한데 <code class=\"language-text\">service</code>클래스가 비지니스 로직을 처리하는 부분이라 시간이 지나면 규모가 너무 커져, <code class=\"language-text\">facade</code>를 만드는것도 좋은 선택이라고 생각된다.</p>\n<h2 id=\"3-onetoone-lazy-loading\" style=\"position:relative;\"><a href=\"#3-onetoone-lazy-loading\" aria-label=\"3 onetoone lazy loading permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. OneToOne Lazy Loading</h2>\n<p><code class=\"language-text\">Entity</code>조회 시, 필요에 맞춰 즉시 실행 or 지연실행을 선택해서 쓰는게 좋다고 하였다. 하지만 <code class=\"language-text\">Lazy Loading</code>을 유도해도 안되는 케이스가 존재한다.</p>\n<p>다시 상황 설명을 위한 <code class=\"language-text\">Entity</code> 관계 설명</p>\n<p>Article.java</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span>\n<span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Article</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token annotation punctuation\">@OneToOne</span><span class=\"token punctuation\">(</span>mappedBy <span class=\"token operator\">=</span> <span class=\"token string\">\"article\"</span><span class=\"token punctuation\">,</span> fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span>LAZY<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">ArticleDetail</span> articleDetail<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ArticleDetail.java</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Entity</span>\n<span class=\"token annotation punctuation\">@NoArgsConstructor</span>\n<span class=\"token annotation punctuation\">@Getter</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ArticleDetail</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token annotation punctuation\">@OneToOne</span><span class=\"token punctuation\">(</span>fetch <span class=\"token operator\">=</span> <span class=\"token class-name\">FetchType</span><span class=\"token punctuation\">.</span>LAZY<span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@JoinColumn</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"article_idx\"</span><span class=\"token punctuation\">,</span> nullable <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Article</span> article<span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>1대1 양방향 맵핑 된 관계로, 연관관계의 주인(<code class=\"language-text\">FK</code>를 갖는 쪽)은 <code class=\"language-text\">ArticleDetail</code>이다.</p>\n<p>보이는 바와 같이 연관된 <code class=\"language-text\">Entity</code>들은 Lazy 로딩 되도록 설정을 해 놓았고, 각각 db에서 조회 시 아래와 같은 결과가 나온다.</p>\n<h4 id=\"pk를-통해-article조회-시-표출되는-log\" style=\"position:relative;\"><a href=\"#pk%EB%A5%BC-%ED%86%B5%ED%95%B4-article%EC%A1%B0%ED%9A%8C-%EC%8B%9C-%ED%91%9C%EC%B6%9C%EB%90%98%EB%8A%94-log\" aria-label=\"pk를 통해 article조회 시 표출되는 log permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>pk를 통해 <code class=\"language-text\">Article</code>조회 시 표출되는 Log</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hibernate:\n    select\n        article0_.idx as idx1_0_0_,\n        article0_.contents as contents2_0_0_,\n        article0_.count as count3_0_0_,\n        article0_.subject as subject4_0_0_\n    from\n        article article0_\n    where\n        article0_.idx=?\nHibernate:\n    select\n        articledet0_.idx as idx1_1_0_,\n        articledet0_.article_idx as article_3_1_0_,\n        articledet0_.data as data2_1_0_\n    from\n        article_detail articledet0_\n    where\n        articledet0_.article_idx=?</code></pre></div>\n<p>의도하지도 않은 <code class=\"language-text\">ArticleDetail</code>도 함께 조회되는 것을 확인 할 수 있다. 이렇게 즉시 실행되는것은 <code class=\"language-text\">N+1문제</code> 원인이 되기 때문에 막아놓는게 좋다.</p>\n<p>일단 의도한 Lazy Loading이 되지 않은 이유는 프록시 객체를 가질 수 없기 때문이다.</p>\n<blockquote>\n<p>프록시 객체가 사용되는 이유는 예를 들어 <code class=\"language-text\">OneToMany</code>관계에서 <code class=\"language-text\">Collection</code>객체는 순수 <code class=\"language-text\">Collection</code> 객체가 아니라 <code class=\"language-text\">Collection</code> 객체를 확장한 프록시 객체를 갖는다(가져오는 클래스 정보를 보면 확인할 수가 있다). 그래서 해당 <code class=\"language-text\">Collection</code>에 접근하려고 하면 초기화 여부를 판별 후 최초 접근 시, DB에 접근 하여 데이터 조회(<code class=\"language-text\">lazy loading</code>)하여 해당 <code class=\"language-text\">entity</code>들을 반환하는 형태다.</p>\n</blockquote>\n<p>하지만 <code class=\"language-text\">OneToOne</code>관계에선 조회 시점에 널값 인지 아니면 연관 entity(<code class=\"language-text\">ArticleDetail</code>)가 있는지 몰라, 일단 DB에서 조회하는 형태라 <code class=\"language-text\">Lazy Loading</code>자체를 지원 안해준다. 찾아보면 서드파티를 추가해서 <code class=\"language-text\">Optional</code>로 한번 감싸서 사용하거나 추가 셋팅하면 지원이 가능한것 같지만 개인적으로 필드값에 연관 <code class=\"language-text\">Entity</code> 자체를 없애서 단방향 연관관계로 사용한다(<code class=\"language-text\">Article</code>에 <code class=\"language-text\">ArticleDetail</code> 필드를 없애버린다.).</p>\n<p>참고 사항으로 <code class=\"language-text\">Article</code>을 조회 시, <code class=\"language-text\">ArticleDetail</code>이 즉시 실행 되는 것이고, 연관관계의 주인인 <code class=\"language-text\">ArticleDetail</code>은 정상적으로 지연실행을 지원한다.</p>\n<h4 id=\"pk를-통해-articledetail조회-시-표출되는-log\" style=\"position:relative;\"><a href=\"#pk%EB%A5%BC-%ED%86%B5%ED%95%B4-articledetail%EC%A1%B0%ED%9A%8C-%EC%8B%9C-%ED%91%9C%EC%B6%9C%EB%90%98%EB%8A%94-log\" aria-label=\"pk를 통해 articledetail조회 시 표출되는 log permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>pk를 통해 <code class=\"language-text\">ArticleDetail</code>조회 시 표출되는 Log</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Hibernate:\n    select\n        articledet0_.idx as idx1_1_0_,\n        articledet0_.article_idx as article_3_1_0_,\n        articledet0_.data as data2_1_0_\n    from\n        article_detail articledet0_\n    where\n        articledet0_.idx=?</code></pre></div>\n<p>연관관계의 주인은 <code class=\"language-text\">FK</code>값을 가지니까 이거 자체로 null 값 여부를 판별할 수 있어 지연실행이 가능하다.</p>\n<h2 id=\"4-연관-관계-없을-시-조인\" style=\"position:relative;\"><a href=\"#4-%EC%97%B0%EA%B4%80-%EA%B4%80%EA%B3%84-%EC%97%86%EC%9D%84-%EC%8B%9C-%EC%A1%B0%EC%9D%B8\" aria-label=\"4 연관 관계 없을 시 조인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 연관 관계 없을 시 조인</h2>\n<p>연관관계 정의 없이 조인할 때, 개인적으로 <code class=\"language-text\">QuerydslRepositorySupport</code>클래스를 자주 사용한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ArticleDto<span class=\"token punctuation\">.</span>WithArticleInfo</span> <span class=\"token function\">findByIdxWithArticleInfo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> articleIdx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">Map</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Article</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ArticleInfo</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> articleListMap <span class=\"token operator\">=</span> <span class=\"token function\">getQuerydsl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">createQuery</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">innerJoin</span><span class=\"token punctuation\">(</span>articleInfo<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">.</span>idx<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>articleInfo<span class=\"token punctuation\">.</span>article<span class=\"token punctuation\">.</span>idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">.</span>idx<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>articleIdx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">transform</span><span class=\"token punctuation\">(</span><span class=\"token function\">groupBy</span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">as</span><span class=\"token punctuation\">(</span><span class=\"token function\">list</span><span class=\"token punctuation\">(</span>articleInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> articleListMap<span class=\"token punctuation\">.</span><span class=\"token function\">entrySet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>entry<span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArticleDto<span class=\"token punctuation\">.</span>WithArticleInfo</span><span class=\"token punctuation\">(</span>entry<span class=\"token punctuation\">.</span><span class=\"token function\">getKey</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> entry<span class=\"token punctuation\">.</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">findFirst</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">orElse</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span></code></pre></div>\n<p>1 대 N 관계에 연관관계가 없을 시, 이런식으로 조회 후 Dto로 감싸서 관리한다. 참고로 <code class=\"language-text\">Projections.constructor</code>이나 <code class=\"language-text\">Projections.bean</code> 같은걸 써서 조회한 데이터를 내가 직접 핸들링 하지 않고 알아서 처리 할 수도 있겠지만 이런건 내부적으로 리플렉션 기반으로 하는거라 개인적으로 싫어하는 방식이라, 조회 후 직접 내가 코드로 처리하는 방법을 많이 쓴다.</p>\n<blockquote>\n<p>리플렉션을 쓰면 컴파일 레벨은 통과되도 런타임 시 버그가 발생 될 수 있어서 개인적으로 싫어한다.</p>\n</blockquote>\n<h2 id=\"5-bulk-insert\" style=\"position:relative;\"><a href=\"#5-bulk-insert\" aria-label=\"5 bulk insert permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. bulk insert</h2>\n<p>개발 하다 보면 대량의 데이터를 <code class=\"language-text\">Insert</code>하고 싶을때가 있다.</p>\n<p><code class=\"language-text\">Spring data jpa</code>를 쓰다보면 제공되는 repository에 <code class=\"language-text\">saveAll</code>이라는 메소드가 있는데 얼핏보면 이 메소드를 통해 <code class=\"language-text\">bulk insert</code>를 하면 되겠구나, 생각 할 수가 있다. 물론 그런 용도로 만들어지긴 했는데 막상 출력되는 로그를 보면 전부 하나씩 쿼리가 실행되는 것을 볼 수가 있다.</p>\n<p>원인은 PK 생성 전략을 <code class=\"language-text\">IDENTITY</code>를 써서 그런데, 영속성 하기 위해서는 <code class=\"language-text\">PK</code>값이 필수이지만 <code class=\"language-text\">PK</code>를 알고 싶으면 DB에 저장하는 방법밖에 없어서 저장 대상인 Entity들을 저장과 동시에 영속성을 지원하기 위해 <code class=\"language-text\">Bulk insert</code> 자체를 지원 안한다고 한다(시퀀스나 pk값을 자체적으로 프로그래밍 내에서 만들면 지원을 하긴 한다).</p>\n<p>지원안한다고 하니 뭐 어떻게 해결할 방법이 없고 어쩔수 없이 차선책으로 <code class=\"language-text\">bulk insert</code> 해야할 때만 JDBC template를 쓰도록 하고 있다.</p>"}},{"node":{"fields":{"slug":"/posts/spring/spring-oauth2/","__typename":"MarkdownRemarkFields","categorySlug":"/category/spring/"},"frontmatter":{"template":"post","title":"OAuth2 with spring boot","date":"2020-04-27T01:07:59.877Z","tags":["spring","oauth","oauth2","auth"],"socialImage":null,"draft":false,"description":"OAuth2 + Spring boot를 사용하여 인증 Provider 제작 및 고려 사항","category":"spring"},"id":"a52736dc-c82c-5154-86df-1e1adc20bf0d","html":"<p><code class=\"language-text\">OAuth2.0</code>을 <code class=\"language-text\">Spring Security OAuth</code>에서 제공해주는 라이브러리를 사용해 구현 및 필요한 설명 추가.\n기타 <code class=\"language-text\">grand type</code> 방식에 따른 인증 과정(<code class=\"language-text\">access token</code>발급 과정)등은 다른 document 참고</p>\n<h1 id=\"oauth-\" style=\"position:relative;\"><a href=\"#oauth-\" aria-label=\"oauth  permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>OAuth ?</h1>\n<p>인증 Provider, 외부 API 사이 인증 및 권한 부여 관리하는 일종의 프로토콜</p>\n<p>여기서 설명한 모든 샘플 코드는 <a href=\"https://github.com/qweasd147/springboot-oauth\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">oauth-sample</a> 여기서 확인 가능</p>\n<h1 id=\"oauth-20-플로우-설명\" style=\"position:relative;\"><a href=\"#oauth-20-%ED%94%8C%EB%A1%9C%EC%9A%B0-%EC%84%A4%EB%AA%85\" aria-label=\"oauth 20 플로우 설명 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>OAuth 2.0 플로우 설명</h1>\n<p>특정 리소스 사용까지 전체 플로우(grant type마다 인증 flow는 다르니까 생략)</p>\n<ol>\n<li>특정 사용자가 인증서버를 통해 인증 flow를 거쳐 성공</li>\n<li>토큰 생성 및 TokenStore에 저장</li>\n<li>토큰 발급(반환)</li>\n<li>Resource 서버로 토큰값(access_token)을 요청 api의 헤더에 담아 Resource 서버로 요청</li>\n<li>Resource 제공 서버는 토큰값 validate (JWT를 사용 안하면 인증서버로 토큰 유효성 request를 날립니다)</li>\n<li>Resource 제공</li>\n</ol>\n<h1 id=\"jwt\" style=\"position:relative;\"><a href=\"#jwt\" aria-label=\"jwt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JWT</h1>\n<p>JSON Web Token의 줄임말 이지만 OAuth 2.0에서 JWT 도입한다면 추가적으로 이해 해야할 사항이 있습니다.</p>\n<blockquote>\n<p>Resource서버에선 request의 헤더에 담긴 토큰 (access_token)을 validate 할 수 있는 방법이 없습니다. 따라서 매번 인증서버로 토큰의 유효성 검사 api를 요청해야 합니다. 하지만 이는 당연히 많은 시간이 걸릴수 밖에 없습니다. 이러한 문제를 해결하기 위해선 Resource 서버 자체적으로 토큰 유효성 검사를 할 수 있는 방법이 필요하며, 인증서버와 리소스 서버 사이에 약속을 정해놓아야합니다(sign key, pem, jks 사용하여 서로 공유가 필요)</p>\n</blockquote>\n<p><strong>참고</strong>\nresource 서버에서 <code class=\"language-text\">TokenStore</code>를 구현하면 별다른 검증 api없이 validate를 할수 있지만 이는 resource 서버에서 db 정보를 가지고 있을때만 가능합니다.</p>\n<p>JWT를 사용하면 위에서 설명한 Flow가 아래와 같이 바뀝니다.</p>\n<ol>\n<li>특정 사용자가 인증서버를 통해 인증 flow를 거쳐 성공</li>\n<li>토큰 생성 및 발급 <strong>TokenStore에 저장안함</strong></li>\n<li>Resource 서버로 토큰값(access_token)을 요청 api의 헤더에 담아 Resource 서버로 요청</li>\n<li>Resource 제공 서버는 토큰값 자체 유효성 검사</li>\n<li>Resource 제공</li>\n</ol>\n<p>주의할점은 토큰 파싱할 수 있는 정보를 각 resource 서버에 가지고 있으므로 보안상 관리포인트가 늘어나며, 만약 토큰값이 유출되게 된다면 인증서버에서도 차단할 수 있는 방법이 없습니다.</p>\n<p>또한 <code class=\"language-text\">JWT</code>의 특징으로 decode가 빨라야하고 누구나 body값을 encode, decode가 가능합니다. 따라서 토큰변조가 이루어졌는지 체크가 필수적으로 들어갑니다.</p>\n<blockquote>\n<p>JWT의 정보(body값)을 바로 믿는게 아니라 checksum값을 확인하여 변조가 이루어졌는지를 먼저 확인</p>\n</blockquote>\n<h1 id=\"grant-type\" style=\"position:relative;\"><a href=\"#grant-type\" aria-label=\"grant type permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Grant Type</h1>\n<p>grant type은 OAuth에서 인증 하는 방식? 방법? 수단 정도로 이해하시면 됩니다. oauth 구현 시 원하는 clint마다 제공해 줄 grant type을 지정해 줄수 있습니다.</p>\n<blockquote>\n<p>앞서 설명한대로 grant type에 따라 인증 flow 가 달라집니다. type에 따른 요구 정보, flow설명 등은 생략합니다. (필요 시 인터넷 참고)</p>\n</blockquote>\n<h3 id=\"1-implict\" style=\"position:relative;\"><a href=\"#1-implict\" aria-label=\"1 implict permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. implict</h3>\n<p>이건 쫌 다른 타입에 비해 관리가 힘듭니다. 문제될껀 없어도 딱히 메리트가 많지 않다고 생각됩니다.</p>\n<p>별도로 <code class=\"language-text\">was</code>를 구축하지 않고 <code class=\"language-text\">spa</code>등의 js앱에 사용 가능하지만, <code class=\"language-text\">refresh token</code>이 발급되지 않습니다.</p>\n<h3 id=\"2-authrozation-code\" style=\"position:relative;\"><a href=\"#2-authrozation-code\" aria-label=\"2 authrozation code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. authrozation code</h3>\n<p>가장 많이 쓰는 방식입니다. 하지만 인증 flow 내에 ui도 함께 구현하여 제공 되어야 합니다. 제공되는 ui를 통해서만 로그인을 진행할 수 있으므로 redirect가 많이 이루어 지는데, 아래와 같은 문제들이 발생합니다.</p>\n<ul>\n<li>인증 서버 로그인 ui로 redirect가 이루어지고, 다시 응답 redirect가 올 때 응답 parameter가 제한됨(커스터 마이징이 힘듦)</li>\n<li>웹에서 비동기 로그인 처리가 불가능</li>\n</ul>\n<p>사실 이 방식은 구현은 쉬운데 사용 측에서 귀찮은 부분이 많습니다.</p>\n<h3 id=\"3-resource-owner-password-credentials-grant-password\" style=\"position:relative;\"><a href=\"#3-resource-owner-password-credentials-grant-password\" aria-label=\"3 resource owner password credentials grant password permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Resource Owner Password Credentials Grant (password)</h3>\n<p>인증서버로 client id, client secret, 계정 ID, 계정 password를 한꺼번에 날려 인증처리를 하는 방식입니다.</p>\n<p>이 방식은 authrozation code와 반대로 따로 제공하는 ui를 사용 안하므로 사용 측에서 구현해야하는 단점이 존재합니다. 하지만 사용 측에서 로그인 전처리, 후처리 등이 쉬운게 장점입니다.</p>\n<p><strong>주의!</strong>\n해당 타입(<code class=\"language-text\">password</code>)은 계정정보가 유출되지 않도록 믿을만한 client에만 지원하도록 제한하고 있습니다.\nex)</p>\n<blockquote>\n<p>본인이 Auth서버와 Client 서버 둘다 만들고 Client서버에서 password 타입으로 인증처리를 하도록 하면 상관없지만(어차피 모든 계정정보를 알고 이쓰니까) 제3의 Client서버에 password 타입을 지원하면 중간에 계정정보가 제3의 서버를 통해 유출되어버릴수가 있습니다.</p>\n</blockquote>\n<h1 id=\"개발-시-선택사항\" style=\"position:relative;\"><a href=\"#%EA%B0%9C%EB%B0%9C-%EC%8B%9C-%EC%84%A0%ED%83%9D%EC%82%AC%ED%95%AD\" aria-label=\"개발 시 선택사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>개발 시 선택사항</h1>\n<h2 id=\"token-store\" style=\"position:relative;\"><a href=\"#token-store\" aria-label=\"token store permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Token Store</h2>\n<h3 id=\"1-in-memory-dbh2-등\" style=\"position:relative;\"><a href=\"#1-in-memory-dbh2-%EB%93%B1\" aria-label=\"1 in memory dbh2 등 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. In memory db(h2 등)</h3>\n<p>사실 이건 고민할 여지가 없습니다. 어디까지나 개발용 or 샘플용으로 사용해야 합니다.</p>\n<h3 id=\"2-rdb\" style=\"position:relative;\"><a href=\"#2-rdb\" aria-label=\"2 rdb permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. RDB</h3>\n<p>가장 무난합니다. 단점으로는 토큰 생성 시 많은 sql access가 이루어져, 최적화가 필요할 수도 있습니다. 물론 jwt 사용 시 별도로 token 정보를 DB에 저장 하지 않으므로 큰 상관은 없습니다.</p>\n<h3 id=\"3-redis\" style=\"position:relative;\"><a href=\"#3-redis\" aria-label=\"3 redis permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Redis</h3>\n<p>개인적으로 토큰 저장소로 redis를 선택하는게 꽤 좋은 방법이라고 생각하였습니다. RDB보단 처리가 빠른 redis가 낫다고 생각했는데 spring security 에 성능적으로 문제가 발생한다고 합니다. 현재는 수정 되었지만 해당 버전을 피하려면 버전 의존관계를 생각하여 도입을 고려해야합니다.</p>\n<p>참고</p>\n<ul>\n<li><a href=\"https://youtu.be/mPB2CZiAkKM?t=2975\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://youtu.be/mPB2CZiAkKM?t=2975</a></li>\n<li><a href=\"https://charsyam.wordpress.com/2018/05/11/%EC%9E%85-%EA%B0%9C%EB%B0%9C-spring-security-oauth%EC%9D%98-redistokenstore%EC%9D%98-%EC%82%AC%EC%9A%A9%EC%9D%80-%EC%84%9C%EB%B9%84%EC%8A%A4%EC%97%90-%EC%A0%81%ED%95%A9%ED%95%98%EC%A7%80-%EC%95%8A/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://charsyam.wordpress.com/2018/05/11/%EC%9E%85-%EA%B0%9C%EB%B0%9C-spring-security-oauth%EC%9D%98-redistokenstore%EC%9D%98-%EC%82%AC%EC%9A%A9%EC%9D%80-%EC%84%9C%EB%B9%84%EC%8A%A4%EC%97%90-%EC%A0%81%ED%95%A9%ED%95%98%EC%A7%80-%EC%95%8A/</a></li>\n</ul>\n<h2 id=\"jwt-1\" style=\"position:relative;\"><a href=\"#jwt-1\" aria-label=\"jwt 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JWT</h2>\n<p>앞서 설명한건 JWT가 무엇인지, 왜 사용해야하는지를 설명하였습니다. 하지만 JWT 사용은 필수가 아닌 선택사항이며 JWT를 사용할때와 안할때 access token 인증 case는 아래와 같습니다.</p>\n<h3 id=\"1-jwt-사용할-시\" style=\"position:relative;\"><a href=\"#1-jwt-%EC%82%AC%EC%9A%A9%ED%95%A0-%EC%8B%9C\" aria-label=\"1 jwt 사용할 시 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. JWT 사용할 시</h3>\n<ol>\n<li>sign key를 지정해서 auth 서버와 모든 resource 서버가 공유한다.</li>\n<li>공개키 방식으로 pem 파일(JKS)을 생성하여 auth 서버와 모든 resource 서버에 각각 셋팅한다.</li>\n</ol>\n<h3 id=\"2-jwt-사용-안할-시\" style=\"position:relative;\"><a href=\"#2-jwt-%EC%82%AC%EC%9A%A9-%EC%95%88%ED%95%A0-%EC%8B%9C\" aria-label=\"2 jwt 사용 안할 시 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. JWT 사용 안할 시</h3>\n<ol>\n<li>auth 서버로 access token값을 담아, validate api를 요청하여 토큰값을 검증한다(default)</li>\n<li>token store를 구현하여 자체적으로 token store에서 유효한 값이 존재하는지 검증한다</li>\n</ol>"}},{"node":{"fields":{"slug":"/posts/spring/spring-spring-cloud-config/","__typename":"MarkdownRemarkFields","categorySlug":"/category/spring/"},"frontmatter":{"template":"post","title":"Spring Cloud - Config Server","date":"2020-10-30T00:58:25.297Z","tags":["spring","cloud","msa","config"],"socialImage":null,"draft":false,"description":"MSA 환경에서 여러 설정값을 한곳에서 관리","category":"spring"},"id":"b0d1c879-46b5-5051-9399-04f3b2ec5516","html":"<p>여기서 설명할 내용 및 샘플은 <a href=\"https://github.com/qweasd147/spring-cloud/tree/master/config-server\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">spring-cloud MSA 샘플</a> 여기서 확인 가능</p>\n<h1 id=\"config-server\" style=\"position:relative;\"><a href=\"#config-server\" aria-label=\"config server permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Config Server</h1>\n<p><code class=\"language-text\">Config Server</code>는 이 전에 설명한 대로 어플리케이션에 적용할 설정 값들을 한곳에서 관리하기 위해 만들어졌다. <code class=\"language-text\">MSA</code> 환경에서 일정한 <code class=\"language-text\">Starter Kit</code>을 기본 베이스로 많은 어플리케이션을 만들어 내는 케이스가 많을것이라 생각되는데, 설정값들이 공통적이지만 따로 관리하다가 변경하려고 하면 귀찮기도 하고 때때로 놓친 케이스가 생길 수도 있다. <code class=\"language-text\">Config Server</code>를 사용하면 한곳에서 어플리케이션 별, 환경(ex dev,staging, prod), 버전(<code class=\"language-text\">label</code>) 별로 각각 설정값을 따로 관리할 수 있기 때문에 꽤나 유용하게 사용 할 수가 있다.</p>\n<h2 id=\"1-client-application-셋팅\" style=\"position:relative;\"><a href=\"#1-client-application-%EC%85%8B%ED%8C%85\" aria-label=\"1 client application 셋팅 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Client Application 셋팅</h2>\n<p><code class=\"language-text\">Config Server</code>에서 할 셋팅을 보기 전에 간단한 <code class=\"language-text\">Client Application</code>, 그니까 <code class=\"language-text\">Config Server</code>를 사용하는 쪽 셋팅을 보면 아래와 갔다.</p>\n<p><code class=\"language-text\">bootstrap.yml</code></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">profiles</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">active</span><span class=\"token punctuation\">:</span> docker\n  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> service<span class=\"token punctuation\">-</span>a\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">profiles</span><span class=\"token punctuation\">:</span> local\n  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">enabled</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">profiles</span><span class=\"token punctuation\">:</span> docker\n  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">uri</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>CONFIG_SERVER_URI<span class=\"token punctuation\">:</span>http<span class=\"token punctuation\">:</span>//localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8888</span><span class=\"token punctuation\">}</span>\n      <span class=\"token key atrule\">fail-fast</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> <span class=\"token comment\"># config 서버 못찾으면 서버 종료</span>\n      <span class=\"token key atrule\">profile</span><span class=\"token punctuation\">:</span> default<span class=\"token punctuation\">,</span>docker\n      <span class=\"token key atrule\">label</span><span class=\"token punctuation\">:</span> 1.0.0</code></pre></div>\n<blockquote>\n<p>참고로 <code class=\"language-text\">bootstrap.yml</code>의 파일은 일반적으로 설정파일로 사용되는 <code class=\"language-text\">application.yml</code>파일보다 먼저 실행되는 파일로, 보통 <code class=\"language-text\">Config Server</code>에 대한 정보를 적어놓는 용도로 많이 사용된다.</p>\n</blockquote>\n<p>일단 profiles가 <code class=\"language-text\">local</code>인 설정은 로컬 개발 환경에서 <code class=\"language-text\">Config server</code>를 사용 안하는 목적으로 셋팅한 것으로 일단 무시해도 상관이 없다. 중요한건 <code class=\"language-text\">application name</code>이 기본적으로 <code class=\"language-text\">service-a</code>로 되어있는 점, profiles 값이 <code class=\"language-text\">docker</code>인 설정값들을 보면 된다.</p>\n<p><code class=\"language-text\">cloud config</code> 설정값을 보면 직관적이긴 하지만 그래도 풀어 써 보자면</p>\n<ol>\n<li>uri - Config Server의 접근 주소</li>\n<li>fail-fast - true일때 Config Server를 못찾으면 서버 실행이 안된다.</li>\n<li>profile - 위 소스를 보면서 설명하면 <code class=\"language-text\">default</code>환경, <code class=\"language-text\">docker</code>환경의 설정값을 Config Server에서 가져온다.</li>\n<li>label - 설정값 버전에 맞춰 요청하기 위해 사용된다. (필수값은 아님)</li>\n</ol>\n<p>이정도만 셋팅하면 어플리케이션이 실행되면서 <code class=\"language-text\">Config Server</code>로 부터 설정값을 가져와 셋팅한다.</p>\n<h2 id=\"2-config-server-셋팅\" style=\"position:relative;\"><a href=\"#2-config-server-%EC%85%8B%ED%8C%85\" aria-label=\"2 config server 셋팅 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Config Server 셋팅</h2>\n<p><code class=\"language-text\">Config Server</code>는 사실 기본셋팅이 잘 되어있어 거의 기본으로 사용해도 훌륭한 퍼포먼스를 보여준다. 그래도 일단 선택지가 있긴한데, 설정값 통신 방법을 순수 <code class=\"language-text\">http</code>로 주고 받을지, 아니면 <code class=\"language-text\">git repository</code> 위치를 저장하고 직접 가져 갈지 선택할 수 있는데 <code class=\"language-text\">git repository</code>는 딱히 장점을 모르겠어서 그냥 <code class=\"language-text\">http</code>로 주고 받는 것으로 선택했고, 공개키 방식도 쉽게 셋팅 가능해서 보안 레벨을 올릴 수도 있겠지만 <code class=\"language-text\">Config server</code>는 <code class=\"language-text\">private network</code>에 배포되어 외부에서 접근 할 수 있는 방법이 없으므로, 딱히 사용하진 않았다.</p>\n<p><code class=\"language-text\">application.yml</code></p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">8888</span>\n\n<span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">profiles</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">active</span><span class=\"token punctuation\">:</span> native\n<span class=\"token punctuation\">---</span>\n<span class=\"token key atrule\">spring</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">profiles</span><span class=\"token punctuation\">:</span> native\n  <span class=\"token key atrule\">application</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> config<span class=\"token punctuation\">-</span>server\n  <span class=\"token key atrule\">cloud</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">config</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">native</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">search-locations</span><span class=\"token punctuation\">:</span> classpath<span class=\"token punctuation\">:</span>config/</code></pre></div>\n<p>설정값은 정말 단순하다. 사실상 설정파일 위치만 설정해 준게 전부이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">/{application}-{profile}.yml\n/{label}/{application}-{profile}.yml\n/{application}-{profile}.properties\n/{label}/{application}-{profile}.properties</code></pre></div>\n<p>위의 파일 &#x26; 디렉토리 패턴을 참고하여 설정 파일들 위치 시키고 서버를 실행 시키면 <code class=\"language-text\">Config Server</code> 셋팅은 끝이 난다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">resources/\n├── application.yml\n└── config\n    └── 1.0.0\n        ├── service-a-default.yml\n        ├── service-a-docker.yml\n        └── service-a-local.yml</code></pre></div>\n<p>위의 설정파일은 <strong><code class=\"language-text\">1. Client Application 셋팅</code></strong> 을 위해 셋팅한것으로, <code class=\"language-text\">Client Application</code>이 실행되면서 알아서 <code class=\"language-text\">service-a-default.yml</code>, <code class=\"language-text\">service-a-docker.yml</code> 설정 정보를 가져간다.</p>\n<h4 id=\"21-client-application에서-기록되는-정상적으로-가져왔다는-로그\" style=\"position:relative;\"><a href=\"#21-client-application%EC%97%90%EC%84%9C-%EA%B8%B0%EB%A1%9D%EB%90%98%EB%8A%94-%EC%A0%95%EC%83%81%EC%A0%81%EC%9C%BC%EB%A1%9C-%EA%B0%80%EC%A0%B8%EC%99%94%EB%8B%A4%EB%8A%94-%EB%A1%9C%EA%B7%B8\" aria-label=\"21 client application에서 기록되는 정상적으로 가져왔다는 로그 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 Client Application에서 기록되는 정상적으로 가져왔다는 로그</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Located environment: name=service-a, profiles=[default,docker], label=1.0.0, version=null, state=null\nLocated property source: [BootstrapPropertySource {name='bootstrapProperties-classpath:config/1.0.0/service-a-docker.yml'}, BootstrapPropertySource {name='bootstrapProperties-classpath:config/1.0.0/service-a-default.yml'}]</code></pre></div>\n<h4 id=\"22-client가-소스-파일을-가져갈때-config-server에서-감지되는-로그\" style=\"position:relative;\"><a href=\"#22-client%EA%B0%80-%EC%86%8C%EC%8A%A4-%ED%8C%8C%EC%9D%BC%EC%9D%84-%EA%B0%80%EC%A0%B8%EA%B0%88%EB%95%8C-config-server%EC%97%90%EC%84%9C-%EA%B0%90%EC%A7%80%EB%90%98%EB%8A%94-%EB%A1%9C%EA%B7%B8\" aria-label=\"22 client가 소스 파일을 가져갈때 config server에서 감지되는 로그 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 Client가 소스 파일을 가져갈때 Config Server에서 감지되는 로그</h4>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Adding property source: classpath:config/1.0.0/service-a-docker.yml\nAdding property source: classpath:config/1.0.0/service-a-default.yml\n</code></pre></div>"}},{"node":{"fields":{"slug":"/posts/spring/spring-spring-cloud-hystrix/","__typename":"MarkdownRemarkFields","categorySlug":"/category/spring/"},"frontmatter":{"template":"post","title":"Spring Cloud - Hystrix","date":"2020-10-15T01:30:21.250Z","tags":["spring","cloud","msa"],"socialImage":null,"draft":false,"description":"MSA 환경에서 에러 전파 방지. +(Feign, Ribbon, Circuit Breaker) 셋팅","category":"spring"},"id":"34335859-260f-5f9a-95be-17a374ab6e8c","html":"<p>여기서 설명할 내용 및 샘플은 <a href=\"https://github.com/qweasd147/spring-cloud/tree/master/service-a\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">spring-cloud MSA 샘플</a> 여기서 확인 가능</p>\n<h2 id=\"1-feign\" style=\"position:relative;\"><a href=\"#1-feign\" aria-label=\"1 feign permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Feign</h2>\n<p><code class=\"language-text\">Feign</code>은 기존 <code class=\"language-text\">RestTemplate</code>와 하는 역할이 비슷하다. 자바 프로그래밍 상에서 외부 api등을 호출할 때 쓰이며, 여기에 추가로 MSA에 특화된 기능이 존재한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@FeignClient</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"service-b\"</span>\n  <span class=\"token punctuation\">,</span> fallbackFactory <span class=\"token operator\">=</span> <span class=\"token class-name\">BServiceFallbackFactory</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span>\n  <span class=\"token punctuation\">,</span> configuration <span class=\"token operator\">=</span> <span class=\"token class-name\">FeignConfiguration</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">BService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/service/b\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/service/b/{idx}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token class-name\">String</span> <span class=\"token function\">getOne</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"idx\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> idx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>기본 적인 사용법은 위와 같은데 인터페이스 + 어노테이션으로 <code class=\"language-text\">Controller</code>를 구현하듯 정의해놓으면 알아서 구현체를 구현해줘서 편하게 사용이 가능하다.</p>\n<p>또한 사용해보면서 개인적으로 느낀 장점으로는 <code class=\"language-text\">Logging</code>관리가 편하다는 건데, 요청 &#x26; 응답 로그 정보를 남길려면 <code class=\"language-text\">RestTemplate</code> 경우 <code class=\"language-text\">RestTemplate</code>클래스의 로그 레벨을 변경하거나 아니면 별도의 <code class=\"language-text\">Interceptor</code>를 구현해주는 방법 밖엔 없는데 <code class=\"language-text\">Feign</code>같은 경우엔 위와 같은 인터페이스 단위로 로그 레벨 정의가 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">FeignConfiguration</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Logger<span class=\"token punctuation\">.</span>Level</span> <span class=\"token function\">feignLoggerLevel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">Logger<span class=\"token punctuation\">.</span>Level</span><span class=\"token punctuation\">.</span>FULL<span class=\"token punctuation\">;</span> <span class=\"token comment\">//NONE, BASIC, HEADERS, FULL 가능</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위와 같이 통신 간 남길 로그를 정의 하고</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">logging</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">level</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">com.service.demo.service.BService</span><span class=\"token punctuation\">:</span> DEBUG</code></pre></div>\n<p>이렇게 서비스(인터페이스 클래스) 단위로 레벨을 관리할 수가 있어서 편하게 관리가 가능했다.</p>\n<p>또한 API 통신 시, 발생 할 수 있는 에러 처리는 <code class=\"language-text\">FallbackFactory</code>를 구현하여 처리할 수가 있다. 아래와 같이 구현하면 호출 시 에러가 발생되면 <code class=\"language-text\">BServiceFallbackImpl</code>에서 매칭되는 메소드가 실행된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token annotation punctuation\">@Slf4j</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">BServiceFallbackFactory</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">FallbackFactory</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">BService</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">BService</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Throwable</span> cause<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"외부 서비스 호출 중 에러 감지\"</span><span class=\"token punctuation\">,</span> cause<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BServiceFallbackImpl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>하나의 서비스 클래스를 구현하는데 1+1으로 구현(위 소스에서 <code class=\"language-text\">BServiceFallbackImpl</code> class)해야 하는게 거부감이 들 수도 있지만, MSA 환경에서 에러 후처리 관리는 사실상 필수라서 어쩔수 없다고 생각된다.(유용할 때가 많다)</p>\n<p>추가로 외부 API를 호출할때 에러 발생 비율이 많으면 이 전에 설명한대로 <code class=\"language-text\">Circuit Breaker Open</code>이 된다.</p>\n<h2 id=\"2-ribbon\" style=\"position:relative;\"><a href=\"#2-ribbon\" aria-label=\"2 ribbon permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Ribbon</h2>\n<p><code class=\"language-text\">Ribbon</code>은 <code class=\"language-text\">L7 Load Balancing</code> 작업을 수행한다고 하였다. 로드벨런싱을 위해 호스트 서버의 물리적 접근 주소가 필요하지만 <code class=\"language-text\">Eureka</code>를 쓴것도 아니고 로드벨런싱도 <code class=\"language-text\">Docker Network</code>를 통해 처리하므로 다른 서비스에 접근 할 수 있는 정보만 입력하였다.</p>\n<h4 id=\"로컬-환경\" style=\"position:relative;\"><a href=\"#%EB%A1%9C%EC%BB%AC-%ED%99%98%EA%B2%BD\" aria-label=\"로컬 환경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>로컬 환경</h4>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">service-b</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ribbon</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">listOfServers</span><span class=\"token punctuation\">:</span> localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8081</span></code></pre></div>\n<h4 id=\"docker-container-환경\" style=\"position:relative;\"><a href=\"#docker-container-%ED%99%98%EA%B2%BD\" aria-label=\"docker container 환경 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Docker Container 환경</h4>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">service-b</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ribbon</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">listOfServers</span><span class=\"token punctuation\">:</span> serviceb<span class=\"token punctuation\">:</span><span class=\"token number\">8081</span></code></pre></div>\n<p>이런 식으로 접근 가능한 주소만 동적으로 주입 하는 정도로만 셋팅하였다.</p>\n<h2 id=\"3-hystrix\" style=\"position:relative;\"><a href=\"#3-hystrix\" aria-label=\"3 hystrix permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Hystrix</h2>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">hystrix</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">default</span><span class=\"token punctuation\">:</span> <span class=\"token comment\"># command key. use 'default' for global setting.</span>\n      <span class=\"token key atrule\">execution</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">isolation</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">thread</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">timeoutInMilliseconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3000</span>\n        <span class=\"token punctuation\">...</span>\n    <span class=\"token key atrule\">custom_command_key</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">excution</span><span class=\"token punctuation\">:</span>\n        <span class=\"token key atrule\">isolation</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">thread</span><span class=\"token punctuation\">:</span>\n            <span class=\"token key atrule\">timeoutInMilliseconds</span><span class=\"token punctuation\">:</span> <span class=\"token number\">3000</span>\n        <span class=\"token punctuation\">...</span></code></pre></div>\n<p><code class=\"language-text\">Hystrix</code>는 위와 같은 방법으로 설정값 셋팅이 가능한데 보이는 바와 같이 <code class=\"language-text\">default</code> or 다른 키값으로 셋팅값을 맞춰 놓았다가 원하는 서비스 별로 셋팅값을 매칭 시켜 적용이 가능하다. <code class=\"language-text\">Thread Pool</code>을 사용한다면 서비스 별로 공유 할지 여부도 셋팅이 가능하다. 자세한 옵션 값은 역시 문서 또는 <code class=\"language-text\">HystrixCommandProperties.class</code>파일(…)을 통해 옵션값 확인이 가능하다.</p>"}},{"node":{"fields":{"slug":"/posts/spring/spring-spring-cloud-zuul/","__typename":"MarkdownRemarkFields","categorySlug":"/category/spring/"},"frontmatter":{"template":"post","title":"Spring Cloud - Zuul","date":"2020-09-25T07:19:37.572Z","tags":["spring","cloud","msa","gateway"],"socialImage":null,"draft":false,"description":"MSA 환경에서 API-Gateway를 담당","category":"spring"},"id":"c39bf46f-f0fd-57c4-a996-6092e599922a","html":"<p>여기서 설명할 내용 및 샘플은 <a href=\"https://github.com/qweasd147/spring-cloud/tree/master/api-gateway\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">spring-cloud zuul 샘플</a> 여기서 확인 가능</p>\n<h2 id=\"프로젝트의-전체-구성도\" style=\"position:relative;\"><a href=\"#%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8%EC%9D%98-%EC%A0%84%EC%B2%B4-%EA%B5%AC%EC%84%B1%EB%8F%84\" aria-label=\"프로젝트의 전체 구성도 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>프로젝트의 전체 구성도</h2>\n<p><img src=\"/blog/media/cloud/spring-cloud.jpg\" alt=\"spring-cloud-image\"></p>\n<p><code class=\"language-text\">Zuul</code>은 Spring cloud stack에서 <code class=\"language-text\">API Gateway</code> 역할을 수행한다.</p>\n<h2 id=\"unique-entry-point\" style=\"position:relative;\"><a href=\"#unique-entry-point\" aria-label=\"unique entry point permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Unique Entry Point</h2>\n<p><code class=\"language-text\">Private Network</code>내에 여러 어플리케이션을 띄운 다음, <code class=\"language-text\">Reverse Proxy</code>를 통해 <code class=\"language-text\">Zuul</code>과 연결되어 있다. 외부에서 접근할 수 있는 방법이 없고 오직 <code class=\"language-text\">API Gateway</code>를 통해서만 접근 할 수 밖에 없는데, 이때 얻을 수 있는 장점이 강력하다.</p>\n<ol>\n<li>Load Balancing</li>\n</ol>\n<p><code class=\"language-text\">MicroService Application</code>을 띄우고, 서버 정보를 <code class=\"language-text\">Zuul</code>에만 알려주면 된다. 로드벨런싱을 위해 다른 추가 작업은 할 필요가 없어 간단하게 구현이 가능하다.</p>\n<ol start=\"2\">\n<li>인증된 Request</li>\n</ol>\n<p>인증 &#x26; 권한 관련해서 관리포인트가 확 줄어든다. 외부에선 오직 <code class=\"language-text\">Zuul</code>을 통해서만 접근 할 수 있으므로 <code class=\"language-text\">Zuul</code>에서 요청 정보를 확인하여 요청자 정보를 <code class=\"language-text\">Request Context</code>에 담아 다른 서비스로 포워딩 해주고 다른 서비스에서 <code class=\"language-text\">Request Context</code>에 담긴 정보를 확인하여 처리 해주기만 하면 된다. 이런 방식으로 구현하면 여러 <code class=\"language-text\">Micro Service</code>에서 반복되는 인증 &#x26; 권한 정보를 확인 로직을 줄일 수가 있다.</p>\n<p>인증 관련해선 밑에서 추가로 설명</p>\n<h2 id=\"셋팅\" style=\"position:relative;\"><a href=\"#%EC%85%8B%ED%8C%85\" aria-label=\"셋팅 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>셋팅</h2>\n<h3 id=\"1-reverse-proxy\" style=\"position:relative;\"><a href=\"#1-reverse-proxy\" aria-label=\"1 reverse proxy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Reverse Proxy</h3>\n<p>설정 파일(<code class=\"language-text\">properties</code> or <code class=\"language-text\">yaml</code>)을 통해 손쉽게 셋팅이 가능하다</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">zuul</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">routes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">service-a</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /service/a/<span class=\"token important\">**</span>\n      <span class=\"token key atrule\">serviceId</span><span class=\"token punctuation\">:</span> service<span class=\"token punctuation\">-</span>a\n      <span class=\"token key atrule\">stripPrefix</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n      <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8080</span>\n    <span class=\"token key atrule\">service-b</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /service/b/<span class=\"token important\">**</span>\n      <span class=\"token key atrule\">serviceId</span><span class=\"token punctuation\">:</span> service<span class=\"token punctuation\">-</span>b\n      <span class=\"token key atrule\">stripPrefix</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n      <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8081</span>\n    <span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /auth/<span class=\"token important\">**</span>\n      <span class=\"token key atrule\">serviceId</span><span class=\"token punctuation\">:</span> auth\n      <span class=\"token key atrule\">stripPrefix</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n      <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//localhost<span class=\"token punctuation\">:</span><span class=\"token number\">8082</span></code></pre></div>\n<p>이런식으로 각 <code class=\"language-text\">Reuqest</code>의 경로에 따라 어느 어플리케이션으로 포워딩 해야하는지 설정만 해주면 된다. 설정 값도 직관적이고 필요에 따라 Document를 찾아보면 되고 아님 설정 값을 담는 java 파일(<code class=\"language-text\">ZuulProperties.java</code>)을 열어 필드값을 확인해보는게 더 빠를 수도(…) 있다.</p>\n<h3 id=\"2-인증\" style=\"position:relative;\"><a href=\"#2-%EC%9D%B8%EC%A6%9D\" aria-label=\"2 인증 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 인증</h3>\n<p>설명할 내용의 샘플 실행은 <a href=\"https://github.com/qweasd147/spring-cloud\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">샘플 READ ME</a> 참고</p>\n<p>프로젝트에 구현해 놓은 것은 기본적으로 <code class=\"language-text\">Spring Security</code>를 바탕으로 <code class=\"language-text\">OAuth 2.0</code> &#x26; <code class=\"language-text\">JWT</code>를 사용하였다. 먼저 <code class=\"language-text\">Access token</code>을 얻고 요청 헤더에 담아 request를 날리면 <code class=\"language-text\">Zuul</code>에선 해당 토큰을 파싱 &#x26; 검증을 한 후, 다시 <code class=\"language-text\">Request</code>헤더에 <code class=\"language-text\">username</code>이란 key값으로 인증된 사용자 정보를 담아 포워딩 한다. 이런식으로 넘기면 다른 <code class=\"language-text\">Appication</code>에선 단순 요청 헤더에 <code class=\"language-text\">username</code>값이 있는지 없는지 여부만 판별하면 된다. 주의할 점은 외부에서 다른 <code class=\"language-text\">Application</code>으로 직접 접근 할 수 있어서는 안된다(<code class=\"language-text\">Zuul</code>이 아닌 다른곳에서 임의로 인증됬다고 속여서 해더값을 넘기면 안되니까).</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ZuulContextConfig</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ZuulFilter</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> TOKEN_HEADER <span class=\"token operator\">=</span> <span class=\"token string\">\"Bearer \"</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">filterType</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token class-name\">FilterConstants</span><span class=\"token punctuation\">.</span>PRE_TYPE<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">boolean</span> <span class=\"token function\">shouldFilter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n      <span class=\"token class-name\">HttpServletRequest</span> request <span class=\"token operator\">=</span> <span class=\"token class-name\">RequestContext</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token class-name\">String</span> token <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span><span class=\"token function\">getHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Authorization\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StringUtils</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>  <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> token<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span>TOKEN_HEADER<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token class-name\">Objects</span><span class=\"token punctuation\">.</span><span class=\"token function\">isNull</span><span class=\"token punctuation\">(</span><span class=\"token function\">getClaims</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">ZuulException</span> <span class=\"token punctuation\">{</span>\n\n      <span class=\"token class-name\">RequestContext</span><span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">addZuulRequestHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">,</span> <span class=\"token function\">getClaims</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token class-name\">OAuth2Authentication</span> <span class=\"token function\">getClaims</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">OAuth2Authentication</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">SecurityContextHolder</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">getAuthentication</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>소스의 중요한 부분만 일부 적어놓은 건데, <code class=\"language-text\">ZuulFilter</code>를 구현 한 것으로 위에서 설명한 내용을 구현한 것이다. 먼저 <code class=\"language-text\">Spring Security Filter</code>에서 <code class=\"language-text\">access token</code>을 파싱하여 <code class=\"language-text\">SecurityContextHolder</code>에 담아 놓으면 차후에 <code class=\"language-text\">ZuulFilter</code>가 실행 되는데, 사용자 정보가 <code class=\"language-text\">SecurityContextHolder</code>에 있으면 header에 <code class=\"language-text\">username</code>값을 넣어 보내주는 내용이다.</p>\n<ul>\n<li><code class=\"language-text\">shouldFilter</code> -> <code class=\"language-text\">run</code> 메소드 적용 여부</li>\n<li><code class=\"language-text\">run</code> -> 적용 할 내용</li>\n</ul>\n<p>해당 프로젝트에서 <code class=\"language-text\">JWT</code> 토큰 검증 방법으로 <code class=\"language-text\">Auth 서버</code>랑 <code class=\"language-text\">Zuul 서버</code>에 동일한 <code class=\"language-text\">Sign key</code>값을 공유하도록 셋팅해 놓았다. 공개키 방식으로 하는게 여러모로 좋긴 하겠지만 설정 상 귀찮은 부분(공개키 공유)이 있어서 Pass 하였다. 검증 방법을 대칭키(<code class=\"language-text\">Sign Key</code> 공유)가 아닌 공개키 방법으로 바꾸는건 사실 뭐 어려운건 없으므로, <a href=\"https://github.com/qweasd147/springboot-oauth/tree/jks/jwt\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">OAuth With JKS</a>를 참고해서 <code class=\"language-text\">JKS</code>를 만든 후, 공개키를 옮겨놓거나 Docker 컨테이너로 마운팅 해서 사용하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ResourceServerConfiguration</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">ResourceServerConfigurerAdapter</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">configure</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpSecurity</span> http<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n\n      http<span class=\"token punctuation\">.</span><span class=\"token function\">csrf</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">disable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">authorizeRequests</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">antMatchers</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/service/a/**\"</span><span class=\"token punctuation\">)</span>\n                  <span class=\"token punctuation\">.</span><span class=\"token function\">permitAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">antMatchers</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/service/b/**\"</span><span class=\"token punctuation\">)</span>\n                  <span class=\"token punctuation\">.</span><span class=\"token function\">authenticated</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">antMatchers</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/auth/**\"</span><span class=\"token punctuation\">)</span>\n                  <span class=\"token punctuation\">.</span><span class=\"token function\">permitAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n              <span class=\"token punctuation\">.</span><span class=\"token function\">anyRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                  <span class=\"token punctuation\">.</span><span class=\"token function\">denyAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>한가지 고민인건 현재 프로젝트에서 모든 접근 경로의 필요 권한을 체크하는 것을 <code class=\"language-text\">Zuul</code>에서 하고 있다. 이런 식이다 보니 <code class=\"language-text\">Zuul</code>에 모든 어플리케이션의 <code class=\"language-text\">Request URL</code>마다 필요한 인증 &#x26; 인가 정보를 넣아야 하니 나중에 너무 복잡해지는게 아닐까 싶다. 그래서 차후에 <code class=\"language-text\">Zuul</code>의 역할을 조금 더 단순하게 바꿔 토큰값을 파싱해여 단순 <code class=\"language-text\">uername</code>값만 넘기고, 세부 차단은 각 어플리케이션마다 구현할까 고민중이다(<code class=\"language-text\">Spring Security</code> 다 걷어내고 <code class=\"language-text\">TokenService</code>만 구현).</p>\n<h3 id=\"3-was\" style=\"position:relative;\"><a href=\"#3-was\" aria-label=\"3 was permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. WAS</h3>\n<p><code class=\"language-text\">Spring Cloud - 기본 설명</code> 게시물에 올려놓은 내용 대로, WAS는 그래도 바꾸는게 좋을꺼 같아 <code class=\"language-text\">Tomcat</code> -> <code class=\"language-text\">undertow</code>로 바꾸었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"gradle\"><pre class=\"language-gradle\"><code class=\"language-gradle\">  dependencies {\n\n    implementation (&#39;org.springframework.cloud:spring-cloud-starter-netflix-zuul&#39;) {\n        exclude module: &quot;spring-boot-starter-tomcat&quot;\n    }\n    implementation(&#39;org.springframework.boot:spring-boot-starter-undertow&#39;)\n  }</code></pre></div>\n<p><a href=\"https://mvnrepository.com/artifact/org.springframework.cloud/spring-cloud-starter-netflix-zuul/2.2.5.RELEASE\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Zuul Dependencies</a>를 보니 <code class=\"language-text\">zuul-core</code>만 2.x로 버전업 해서 사용해도 상관없다고 한다(2.x는 기본 netty 사용).</p>\n<h2 id=\"todo\" style=\"position:relative;\"><a href=\"#todo\" aria-label=\"todo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TODO</h2>\n<p>aws에서 <code class=\"language-text\">X-Ray</code>를 써보니까 분산 트레이싱이 확실히 중요하다고 느껴졌다. <code class=\"language-text\">Spring Cloud</code>에서 적용 할만한것(<code class=\"language-text\">x-ray</code>는 빼고)을 찾아보니까 있긴 있는거 같은데 공부가 필요하다.</p>\n<ul>\n<li>Zipkin</li>\n<li>Sleuth</li>\n<li>Pinpoint</li>\n</ul>"}},{"node":{"fields":{"slug":"/posts/spring/spring-spring-cloud/","__typename":"MarkdownRemarkFields","categorySlug":"/category/spring/"},"frontmatter":{"template":"post","title":"Spring Cloud - 기본 설명","date":"2020-09-03T00:55:55.498Z","tags":["spring","cloud","msa"],"socialImage":null,"draft":false,"description":"MSA 환경에서 여러 어플리케이션을 효과적으로 개발 및 관리","category":"spring"},"id":"75cec594-124e-57ea-8e65-f1c06a1d2ec7","html":"<p>여기서 설명할 내용 및 샘플은 <a href=\"https://github.com/qweasd147/spring-cloud\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">spring-cloud 샘플</a> 여기서 확인 가능</p>\n<p>샘플을 실행시키기 위해 필요한거</p>\n<ul>\n<li>git</li>\n<li>docker</li>\n<li>docker compose</li>\n</ul>\n<p>실행 방법</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">$ git clone https://github.com/qweasd147/spring-cloud.git\n$ ls ./spring-cloud\n$ docker-compose up</code></pre></div>\n<h1 id=\"1-msa\" style=\"position:relative;\"><a href=\"#1-msa\" aria-label=\"1 msa permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. MSA</h1>\n<p>각각의 용도에 맞게 하나의 큰 어플리케이션이 아닌, 여러개의 작은 어플리케이션으로 쪼개어 변경 및 조합을 쉽게 만든 아키텍쳐</p>\n<h2 id=\"장점\" style=\"position:relative;\"><a href=\"#%EC%9E%A5%EC%A0%90\" aria-label=\"장점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>장점</h2>\n<h3 id=\"확장성이-좋다\" style=\"position:relative;\"><a href=\"#%ED%99%95%EC%9E%A5%EC%84%B1%EC%9D%B4-%EC%A2%8B%EB%8B%A4\" aria-label=\"확장성이 좋다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>확장성이 좋다</h3>\n<p>하나의 큰 어플리케이션으로 만들었다고 가정하면 특정 구간 병목현상을 발견하여 어플리케이션을 이중화 하면 많은 리소스를 사용하게 된다. 하지만 여러 어플리케이션으로 나눈 상태에서 특정 어플리케이션만 인스턴스를 늘리는 작업은 상대적으로 적은 리소스만 필요하게 된다.</p>\n<h3 id=\"신기술-적용이-좋다\" style=\"position:relative;\"><a href=\"#%EC%8B%A0%EA%B8%B0%EC%88%A0-%EC%A0%81%EC%9A%A9%EC%9D%B4-%EC%A2%8B%EB%8B%A4\" aria-label=\"신기술 적용이 좋다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>신기술 적용이 좋다</h3>\n<p>기존 레거시 프로그램을 만지다 보면 괜찮다고 생각되는 패턴, 라이브러리 등을 적용을 하고 싶어도 전혀 예상하지 못한곳에 악영양을 줄 수가 있어 고민하게 된다.\n이럴때 차라리 여러개의 작은 어플리케이션 형태라면 이러한 부분을 검토하는 시간도 빠르고, 기존 레거시와 일관성 때문에 생길 수 있는 문제들을 고려하지 않아도 된다.</p>\n<h2 id=\"단점\" style=\"position:relative;\"><a href=\"#%EB%8B%A8%EC%A0%90\" aria-label=\"단점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>단점</h2>\n<h3 id=\"성능\" style=\"position:relative;\"><a href=\"#%EC%84%B1%EB%8A%A5\" aria-label=\"성능 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>성능</h3>\n<p>MSA는 성능까진 크게 고려하지 않는다. 물론 어느정도 고려 대상이긴 하지만 <code class=\"language-text\">Monolithic Architecture</code>보단 느려질 가능성이 높다.</p>\n<h3 id=\"transaction-처리\" style=\"position:relative;\"><a href=\"#transaction-%EC%B2%98%EB%A6%AC\" aria-label=\"transaction 처리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Transaction 처리</h3>\n<p>트랜잭션이 보장되어야 하는 작업의 경우, 여러 어플리케이션을 걸쳐 요청한 request를 다시 되돌리기는 힘들다. 이런건 전략적으로 잘 구성해놔야 하는데(<code class=\"language-text\">보상 트랜잭션</code> 등) 이러한 요소 자체가 많은 리스크를 가질수 밖에 없다.</p>\n<h1 id=\"2-spring-cloud\" style=\"position:relative;\"><a href=\"#2-spring-cloud\" aria-label=\"2 spring cloud permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Spring Cloud</h1>\n<p><code class=\"language-text\">Spring Cloud</code>는 이런 MSA 환경에서 각 서비스 간의 통신과 공통 부분 등을 쉽게 구축 및 운영을 도와주는 도구이다. 자주 쓰는 도구로는 아래와 같은 것들이 있다.</p>\n<ol>\n<li>Zuul (API Gateway)</li>\n<li>Eureka (Discovery Server)</li>\n<li>Ribbon (L7 Load Balancing)</li>\n<li>Hystrix (Circuit Breaker)</li>\n<li>Config Server</li>\n<li>Spring Cloud Bus(notify configuration)</li>\n</ol>\n<h2 id=\"21-zuul-api-gateway\" style=\"position:relative;\"><a href=\"#21-zuul-api-gateway\" aria-label=\"21 zuul api gateway permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 Zuul (API Gateway)</h2>\n<p>AWS의 <code class=\"language-text\">API Gateway</code>를 사용 해봤다면 바로 그 용도를 짐작 할 수가 있다. <code class=\"language-text\">entry point</code>로 지정하여 request를 분석하여 특정 어플리케이션으로 라우팅이 가능하고(웹서버의 <code class=\"language-text\">reverse proxy</code>), 인증 기능을 추가 해 줄 수가 있다. 또한 <code class=\"language-text\">AWS API Gateway</code> 이러한 기능이 있는지 모르겠는데 아래와 같이 <code class=\"language-text\">stripPrefix</code>옵션을 주면 <code class=\"language-text\">path</code>값은 대상 어플리케이션에서 제외 하고 보내주는 기능이 있는데 이 기능이 은근 유용할때가 많다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">zuul:\n  routes:\n    auth:\n      path: /auth/**\n      serviceId: auth\n      stripPrefix: true\n      url: http://localhost:8082</code></pre></div>\n<p>예를 들어 위의 설정 처럼 걸어놓으면 클라이언트가 <code class=\"language-text\">https://domain/auth/find/me</code>로 요청을 하면 <code class=\"language-text\">auth</code> 어플리케이션(<code class=\"language-text\">serviceId</code>)의 <code class=\"language-text\">https://localhost:8082/find/me</code>로 연결시켜준다. 물론 <code class=\"language-text\">false</code>면 요청 url 그대로 포워딩 해준다.</p>\n<p>또한 이러한 기능들을 추가로 커스터마이징 할 수 있어 자바 개발자는 정말 친숙하게 사용할 수가 있다.</p>\n<p>(<code class=\"language-text\">AWS</code>의 <code class=\"language-text\">API Gateway</code>가 좋은 점은 생략!)</p>\n<p>한가지 아쉬운 점은 현재 최신 버전 <code class=\"language-text\">spring-cloud-starter-netflix-zuul</code>을 쓰면 기본 <code class=\"language-text\">WAS</code>로 <code class=\"language-text\">Tomcat</code>을 사용하고 있다. 아무래도 <code class=\"language-text\">API Gateway</code>는 성능적으로 민감 할 수가 있어서 <code class=\"language-text\">Tomcat</code> 보다는 그래도 <code class=\"language-text\">Netty</code>(<code class=\"language-text\">undertow</code>)를 쓰는게 어떨까 싶다.</p>\n<p><code class=\"language-text\">Spring cloud Zuul</code>의 연관 모듈인 <code class=\"language-text\">zuul core</code>라는 녀석이 있는데 이게 <code class=\"language-text\">1.x</code> 버전에선 <code class=\"language-text\">Tomcat</code>을 쓰고, <code class=\"language-text\">2.x</code> 버전에선 <code class=\"language-text\">Undertow</code>를 쓰도록 바뀌어서 WAS를 <code class=\"language-text\">Undertow</code>로 바꾸고 싶으면 <code class=\"language-text\">zuul core</code> 버전을 바꾸던가 아니면 <code class=\"language-text\">Tomcat</code>을 제외 시키고 <code class=\"language-text\">Undertow</code>를 추가하던가 선택하면 된다.</p>\n<h2 id=\"22-eureka-discovery-server\" style=\"position:relative;\"><a href=\"#22-eureka-discovery-server\" aria-label=\"22 eureka discovery server permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.2 Eureka (Discovery Server)</h2>\n<p>라이브 환경에선 어느정도 트래픽이 많으면 서버 이중화는 흔한 일이다. 단순 서버 인스턴스를 늘리고 해당 서버를 사용하는 다른 서버에 인스턴스 정보를 넘겨주고, 사용하는 쪽에서 적당히 라운드 로빈(로드벨런싱) 해주면 부하 분산을 위한 서버 다중화 작업은 끝나게 된다. 하지만 말은 쉽게 했지만 이러한 작업은 고려할께 많고 각 서버마다 인스턴스가 늘어가면서 모니터링 및 관리가 힘들어 질 수 밖에 없다. 이러한 귀찮은 작업을 Spring Cloud에서 <code class=\"language-text\">Discovery Server</code>역할을 담당하는 Eureka가 하게 된다. 유레카 서버를 올리고 다른 어플리케이션(<code class=\"language-text\">Eureka Client</code>가 된다)에 Eureka 정보를 넣어주면 어플리케이션이 실행 되면서 Eureka로 어플리케이션 정보 및 상태를 넘겨준다. 이런식으로 모인 각 어플리케이션의 인스턴스 정보를 필요한 어플리케이션에 각각 넣어주고(IP 정보 포함) 종료되면 다시 인스턴스 정보를 갱신한다(기본 적으로 30초 마다 인스턴스에 Ping을 날려 상태 점검도 한다).</p>\n<p>하지만 이번 공부하면서 유레카는 쓰지 않았다. 이유는 딱히 메리트를 못느껴서 그런데 유레카의 역할은 <code class=\"language-text\">Scale in/out</code>시 인스턴스의 정보, 상태를 모니터링 및 관리를 하는데 내가 <code class=\"language-text\">Spring Cloud</code>를 사용하게 된다면 최종적으로 <code class=\"language-text\">Docker</code> + <code class=\"language-text\">Spring Cloud</code> 조합으로 사용할 것이다.</p>\n<p>근데 Docker 생태계(<code class=\"language-text\">Docker Swarm</code>, <code class=\"language-text\">Kubernates</code>) 중엔 이러한 역할을 하는 얘들이 이미 있는데 구지 필요할까 의문이 들었고, 그렇다고 <code class=\"language-text\">Docker</code>를 포기하기엔 잃는게 더 많을꺼라 판단 하였다. <code class=\"language-text\">Docker Swarm</code>이나 <code class=\"language-text\">Kubernates</code>를 사용안하고 순수 <code class=\"language-text\">Docker</code>만 사용한다면 사용하는것도 괜찮을꺼 같긴하다(기술은 필요에 맞춰 도입하면 된다!).</p>\n<p>또한 <code class=\"language-text\">Eureka client</code>들, 그니까 다른 서버들은 Eureka 관련 Library에 종속성이 생기게 된다. 만약 다른 어플리케이션을 <code class=\"language-text\">Node.js</code>나 <code class=\"language-text\">Django</code>같은 걸로 만들었을 경우 <code class=\"language-text\">Eureka client</code>로 등록 하려면 외부 라이브러리를 사용해야 하지만 이러한 라이브러리를 제공해주지 않으면 어떻게 해야할지 감도 안잡힌다. 물론 방법이 있을 수도 있지만 그런거 하나하나 알아보는데 시간을 사용하니, 그냥 안쓰고 <code class=\"language-text\">Docker</code> 쓸꺼 같다.</p>\n<h2 id=\"23-ribbon-l7-load-balancing\" style=\"position:relative;\"><a href=\"#23-ribbon-l7-load-balancing\" aria-label=\"23 ribbon l7 load balancing permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.3 Ribbon (L7 Load Balancing)</h2>\n<blockquote>\n<p><code class=\"language-text\">Load Balancer</code>는 대표적으로 2가지 종류가 있는데 <code class=\"language-text\">L4 Switch</code>, <code class=\"language-text\">L7 Switch</code> 2 종류가 있다. L4는 <code class=\"language-text\">OSI 7Layer</code>에서 L4 계층, 쉽게 말하면 네트워크 장비로 로드 벨런싱을 하는 것이고, L7은 <code class=\"language-text\">Application</code> 계층으로 로드 벨런싱을 하는 것을 말한다. <code class=\"language-text\">L4 Switch</code>는 가격이 엄청나게 비싸므로 돈없으면 사용하지도 못하거나 아니면 AWS의 <code class=\"language-text\">NLB</code>를 알아보면 되고, 여건이 안되면 결국에 사용해야 할 것은 <code class=\"language-text\">L7 Load Balancer</code> 이다</p>\n</blockquote>\n<p>우선 <code class=\"language-text\">Load Balancing</code>을 하고 싶으면 최소 2개 이상의 서버 인스턴스가 필요하고, 해당 인스턴스의 물리적 접근 주소(IP, Port 번호)를 <code class=\"language-text\">Load Balancer</code>에 제공해야 한다. 이때 <code class=\"language-text\">Eureka</code>와 궁합이 잘 맞는데 위에서 잠깐 설명 하였지만 Eureka는 필요한 곳에 물리적인 서버 목록을 제공해 준다.</p>\n<h4 id=\"ribbon\" style=\"position:relative;\"><a href=\"#ribbon\" aria-label=\"ribbon permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Ribbon</h4>\n<p>Load balancing 관련 작업을 관리한다. <code class=\"language-text\">timeout</code>, <code class=\"language-text\">retry 정책</code>등을 설정 가능하고 필요한 서버 목록은 직접 물리적 주소를 적는 방법도 있으나, 그렇게 하면 탄력적으로 주소값을 확보 할 수 없으므로 <code class=\"language-text\">Eureka</code>한테 필요한 서버 목록 리스트를 요청하도록 셋팅도 가능하다.</p>\n<h4 id=\"eureka\" style=\"position:relative;\"><a href=\"#eureka\" aria-label=\"eureka permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Eureka</h4>\n<p>주기적으로 헬스 체크를 하여, 현재 활성화 된 서버 인스턴스 목록을 Ribbon에 제공해준다.</p>\n<hr>\n<p>Ribbon이 좋긴 하지만 이번 공부엔 절반 정도의 기능만 사용하였다. <code class=\"language-text\">timeout</code>, <code class=\"language-text\">retry</code> 정책 정도만 사용하고 <code class=\"language-text\">Load Balancing</code>작업은 Ribbon이 아닌 docker를 통해서 할 생각이기 때문이다.</p>\n<h2 id=\"24-hystrix-circuit-breaker\" style=\"position:relative;\"><a href=\"#24-hystrix-circuit-breaker\" aria-label=\"24 hystrix circuit breaker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.4 Hystrix (Circuit Breaker)</h2>\n<p><code class=\"language-text\">Hystix</code>에서 제공해주는 기능은 대표적으로 <code class=\"language-text\">Request Caching</code>, <code class=\"language-text\">장애 전파 방지</code> 기능이 있다. 이 중 <code class=\"language-text\">Request Caching</code>은 딱히 어려운 내용도 아니고 다른 쪽에서도 많이 사용 할 수 있으니까 Pass하고 추가로 기능은 아니지만 관리 정책으로 request 격리 방식을 지정 할 수가 있다.</p>\n<h3 id=\"circuit-breaker요청-차단\" style=\"position:relative;\"><a href=\"#circuit-breaker%EC%9A%94%EC%B2%AD-%EC%B0%A8%EB%8B%A8\" aria-label=\"circuit breaker요청 차단 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Circuit Breaker(요청 차단)</h3>\n<p><code class=\"language-text\">Circuit Breaker</code>는 간단히 말해 특정 조건이 만족하면 요청 자체를 실행하지 않고 내부적으로 <code class=\"language-text\">fallback</code>을 실행하는 방식이다.</p>\n<p><code class=\"language-text\">Circuit Breaker</code>를 사용하는 이유는 만약 특정 서비스 <code class=\"language-text\">A</code> -> <code class=\"language-text\">B</code> -> <code class=\"language-text\">C</code> 순서로 호출한다고 가정 할 때, <code class=\"language-text\">C</code>측에서 처리량이 적거나 DB에 LOCK이 걸려 무한 대기가 발생 할 경우 <code class=\"language-text\">A</code>, <code class=\"language-text\">B</code>, <code class=\"language-text\">C</code> 모두가 무한 대기가 걸리게 된다. 물론 <code class=\"language-text\">Timeout</code>이 걸려 있을테니 진짜 무한대기는 아니겠지만 적어도 <code class=\"language-text\">A</code>, <code class=\"language-text\">B</code>만큼은 빠른 응답, 또 <code class=\"language-text\">C</code>한테 불필요한 트래픽(어차피 실패할꺼)을 줄이기 위해 <code class=\"language-text\">B</code>는 <code class=\"language-text\">C</code>를 호출하는 대신 자체 <code class=\"language-text\">fallback</code>을 실행 시킨다(<code class=\"language-text\">Circuit Breaker open</code> 상태) 그러다가 일정 시간이 지나면 다시 확인 해보고 이상이 없으면 다시 정상적으로 처리한다(<code class=\"language-text\">Circuit Breaker close</code> 상태).</p>\n<h3 id=\"isolation-방법\" style=\"position:relative;\"><a href=\"#isolation-%EB%B0%A9%EB%B2%95\" aria-label=\"isolation 방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Isolation 방법</h3>\n<p><code class=\"language-text\">Micro Service</code>는 하나의 어플리케이션에서 모든 일을 하는게 아닌, 필요에 따라 내부적으로 다른 어플리케이션을 호출하여 처리하는 방식이 많다. 이때 중요한건 다른 서비스를 호출해야 한다는 점인데 이때 호출을 관리하는 방법은 <code class=\"language-text\">Thread Pools</code> 방식과 <code class=\"language-text\">Semaphore</code> 방식 두가지를 사용한다.</p>\n<p>참고사항으로 <code class=\"language-text\">Thread Pools</code> &#x26; <code class=\"language-text\">Semaphore</code> 개념은 <code class=\"language-text\">Spring cloud</code>에서 시작한 개념은 아니니까 다른곳에서 검색해보면(…) 더 자세한 정보를 얻을 수 있다.</p>\n<h4 id=\"semaphore\" style=\"position:relative;\"><a href=\"#semaphore\" aria-label=\"semaphore permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Semaphore</h4>\n<p>사실 <code class=\"language-text\">Semaphore</code>는 격리라고 보기에는 애매하다. 외부 어플리케이션 호출을 별도의 <code class=\"language-text\">Thread</code>를 할당 받는게 아닌 현재 사용중인 <code class=\"language-text\">Thread</code>를 그대로 사용하는 방식이다. 단순 동시 호출(<code class=\"language-text\">Concurrency</code>) 개수를 지정해 놨다가 사용하는 방식이라 장점은 <code class=\"language-text\">Thread Pools</code> 방식에 비해 빠르다는 점이 있지만 의미있는 값은 아니고, 단점으로는 별도의 <code class=\"language-text\">Thread</code>를 사용하지 않아 지연문제 발생 시 다른곳에 영향을 미칠수 있다는 점이다(이 부분은 추가로 확인 해봐야함).</p>\n<h4 id=\"thread-pool\" style=\"position:relative;\"><a href=\"#thread-pool\" aria-label=\"thread pool permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Thread-Pool</h4>\n<p>Hystrix에서 관리하는 별도의 <code class=\"language-text\">Thread Pool</code>을 사용해서 외부 어플리케이션을 호출하는 방식이다. 따라서 동시 호출 개수는 <code class=\"language-text\">Thread Pool</code>에서 확보한 Thread 만큼 가능하고, 장점으로는 별도의 <code class=\"language-text\">Thread</code>로 사용하니 외부 시스템과 완전히 격리된다는 점이다. 단점으로는 별도의 <code class=\"language-text\">Thread Pool</code>을 관리하는데 오는 리소스, 오버헤드 등이 있지만 이러한 비용은 크게 신경쓰지 않고 거의 모든 케이스에서 <code class=\"language-text\">Thread Pool</code> 방식을 권장하고 있다.</p>\n<h2 id=\"25-config-server\" style=\"position:relative;\"><a href=\"#25-config-server\" aria-label=\"25 config server permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.5 Config Server</h2>\n<p>하나의 어플리케이션만 사용할때는 잘 느껴지지 않지만 여러 어플리케이션으로 나누어 관리하다 보면 프로퍼티 설정값들 관리가 힘들어 질 때가 있다. 비슷한 설정값들을 다른 어플리케이션에 각각 관리되어야 하고, 한 두개만 바꾸고 싶어도 다 수정하고 빌드 배포까지 해야한다는 점이 귀찮은 요소이다. 물론 프로퍼티 파일은 컴파일 대상도 아닌데 무슨 다 다시 빌드하냐고 생각 할 수 있지만 역시 기준은 <code class=\"language-text\">docker</code> 환경이기 때문이기도 하고 빌드 배포 시스템이 자동으로 갖추어져 있으면 결국 다시 빌드 배포하게 된다.</p>\n<p><code class=\"language-text\">Config Server</code>는 이러한 설정 값들을 한 곳에서 관리하고 있다가 필요한 어플리케이션에서 요청이 오면 값을 넘겨주는 형태로 제공하는 서버이다. <code class=\"language-text\">Application Name</code>, <code class=\"language-text\">Profile</code> 조합으로 값을 요청 할 수가 있고 공통적으로 제공해주는 값도 일괄적으로 관리 할 수가 있어 편하다. 문제는 특정 비밀번호 등의 예민한 값들 관리가 귀찮다는 건데, <code class=\"language-text\">Vault</code>같은 걸 써야 되지만 이게 꽤 귀찮은게 많고 결국 파일 시스템으로 관리되는데 차라리 <code class=\"language-text\">Docker</code>쪽에서 비슷한 역할을 하는것을 찾아서 쓰는게 어떨까 싶다(<code class=\"language-text\">Kubernates Secret</code> 등).</p>\n<h2 id=\"26-spring-cloud-busnotify-configuration\" style=\"position:relative;\"><a href=\"#26-spring-cloud-busnotify-configuration\" aria-label=\"26 spring cloud busnotify configuration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.6 Spring Cloud Bus(notify configuration)</h2>\n<p><code class=\"language-text\">Config Server</code>를 사용하여 설정 파일과 소스파일을 완전히 분리해서 관리하다 설정 파일을 바꾸고 어플리케이션에 적용하려면 어플리케이션을 다시 시작하거나 아니면 인스턴스에서 특정 api를 호출하여 최신 설정값을 셋팅하도록 유도하는 수 밖에 없다. 인스턴스가 한두개 있다는 보장도 없고 외부에서 호출하기도 까다로워 불편한 점이 있는데 <code class=\"language-text\">Spring Cloud Bus</code>는 설정값이 바뀌면 <code class=\"language-text\">Message Queue</code>를 통해 알려주고, 해당 <code class=\"language-text\">Message Queue</code>에 연결된 인스턴스는 서버 재시작 없이 설정값을 갱신하게 된다.</p>\n<p>좋은것 같지만 아무래도 처리중인 데이터가 존재할 수도 있는데 설정값을 갱신한다는건 부담이 있는거 같아 이것 역시 관련 이슈가 있는지 검토를 해보고 적용여부를 다시 검토 해보는게 좋을것 같다.</p>"}},{"node":{"fields":{"slug":"/posts/etc/db/isolation/","__typename":"MarkdownRemarkFields","categorySlug":"/category/etc/"},"frontmatter":{"template":"post","title":"Mysql - Isolation","date":"2022-08-26T09:08:34.903Z","tags":["rds","db","mysql"],"socialImage":null,"draft":false,"description":"RDB(Mysql)에서 Transaction의 Isolation 종류 및 설명","category":"etc"},"id":"72c74c08-b3d3-59c3-9962-12781b2fe0c9","html":"<h2 id=\"isolation\" style=\"position:relative;\"><a href=\"#isolation\" aria-label=\"isolation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Isolation</h2>\n<p><code class=\"language-text\">isolation</code>은 트랜잭션 간의 격리 수준을 말한다. <code class=\"language-text\">lock</code>이랑 많이 헤깔릴 수도 있는데 <code class=\"language-text\">lock</code>은 특정 데이터를 대상으로 <code class=\"language-text\">lock</code>을 걸어 읽기 또는 쓰기 동시접근을 막는거지만 <code class=\"language-text\">isolation</code>은 트랜잭션 간 데이터 접근 수준을 정의하는걸 말한다(트랜잭션 그 자체 집중 -> 비지니스 로직과 연관된다).</p>\n<p>쉽게 말해 일반적으로 말하는 <code class=\"language-text\">Lock</code>은 대상이 데이터, <code class=\"language-text\">isolation</code>은 대상이 트랜잭션이 되고, <code class=\"language-text\">isolation</code>의 레벨을 높게 잡으면 Lock과 동일하게 처리량이 떨어지게 된다.</p>\n<h2 id=\"1-read-uncommitted\" style=\"position:relative;\"><a href=\"#1-read-uncommitted\" aria-label=\"1 read uncommitted permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. READ UNCOMMITTED</h2>\n<p>커밋 안 된 것을 다른 트랜잭션에서 읽을 수 있다. 사실상 <code class=\"language-text\">Isolation</code>가 없는 상태이다.</p>\n<p>먼저</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SET</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token keyword\">ISOLATION</span> <span class=\"token keyword\">LEVEL</span> <span class=\"token keyword\">READ</span> <span class=\"token keyword\">UNCOMMITTED</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> @<span class=\"token variable\">@session.transaction_isolation</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>를 통해 세션의 <code class=\"language-text\">transaction isolation</code>를 바꿀 수 있다.</p>\n<h3 id=\"11-문제점---dirty-read\" style=\"position:relative;\"><a href=\"#11-%EB%AC%B8%EC%A0%9C%EC%A0%90---dirty-read\" aria-label=\"11 문제점   dirty read permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 문제점 - Dirty Read</h3>\n<p>커밋 안된 것을 읽을 수 있다보니, <code class=\"language-text\">rollback</code> 되어버리면 해당 데이터는 정합성 문제가 발생 될 수 있다. 이런 상황을 <code class=\"language-text\">Dirty Read</code>라고 한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 950px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/e0d47f49efef57e0654aa29eaedeb271/c9a4d/img_read-uncommited.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.57983193277311%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtklEQVQoz32R2W7bMBBF9SXWQoqkRFrUZjmuEzeuHXhR49o10P7/l5xCSpwgAdKHgwsOBpczcwMzdeRNiW1rdK5JhEAI8a5SIIVA5zl5XeG6FttWpDpFCImQcuy7EZiyIW8bjC8RSpHEMUmSIF4Jw/Dtg3ggkcRRQjSZEIUhYRgRRRFxHI8apNaTOUeWGZRKUVKiU0mmUjKtiOJ4NJZaoytHmhsSaxA2JzUZWkuSJGYymYyfB64ssX6KcRpjB1P1gXHaYWWd0d0taNqWumtp5x2zeUfb1njn8VOPs46gWjwyrRq0UWij0Uqhh2n0iw5mUgpya/l1vvJ8unA4njj2Jw79if75zH7Q02/Wmy1BFL/c6Y0o/PgOQ6SUpELQfj8y3/1ltrnQ/Lgw215Z7P9QPPSU6wt6WhPErwf9isHQWYstHKZ06MKRZjkqd6jMokyGMoZUG5Q2BLd0PhvdakOKw8q+anhYbbmb3zP/tmKxXLNcPLLsFsybjlk1oyzK/xve6kOC3pecL1cOh5/sdseR/aFnd+hZb5542vUs71dfG34mEQlFMaXwnsIXY0hVXVMUBTKVb33/ACoWK/3eOHhSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/e0d47f49efef57e0654aa29eaedeb271/24599/img_read-uncommited.webp 238w,\n/blog/static/e0d47f49efef57e0654aa29eaedeb271/69f92/img_read-uncommited.webp 475w,\n/blog/static/e0d47f49efef57e0654aa29eaedeb271/cebde/img_read-uncommited.webp 950w,\n/blog/static/e0d47f49efef57e0654aa29eaedeb271/db205/img_read-uncommited.webp 1143w\"\n              sizes=\"(max-width: 950px) 100vw, 950px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/e0d47f49efef57e0654aa29eaedeb271/da2e6/img_read-uncommited.png 238w,\n/blog/static/e0d47f49efef57e0654aa29eaedeb271/abae4/img_read-uncommited.png 475w,\n/blog/static/e0d47f49efef57e0654aa29eaedeb271/68327/img_read-uncommited.png 950w,\n/blog/static/e0d47f49efef57e0654aa29eaedeb271/c9a4d/img_read-uncommited.png 1143w\"\n            sizes=\"(max-width: 950px) 100vw, 950px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/e0d47f49efef57e0654aa29eaedeb271/68327/img_read-uncommited.png\"\n            alt=\"read-uncommited-img\"\n            title=\"read-uncommited-img\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<ul>\n<li>#1, #2 <code class=\"language-text\">트랜잭션1</code>, <code class=\"language-text\">트랜잭션2</code> 시작</li>\n<li>#3 <code class=\"language-text\">트랜잭션1</code>에서 데이터 입력</li>\n<li>#4 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터를 읽을 수 있음 -> 비지니스 로직에 관여 될 수 있음(이 데이터를 2차, 3차 가공해서 다른곳에 저장한다면?)</li>\n<li>#5 <code class=\"language-text\">트랜잭션1</code>에서 rollback -> 기존 insert 된 데이터 없어짐</li>\n<li>#6 <code class=\"language-text\">트랜잭션2</code>에서 데이터가 다시 사라짐 -> 기존 비지니스 로직에 정합성이 깨질 수도 있음</li>\n</ul>\n<h2 id=\"2-read-committed\" style=\"position:relative;\"><a href=\"#2-read-committed\" aria-label=\"2 read committed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. READ COMMITTED</h2>\n<p>커밋이 된 것은 읽을 수 있다. 적어도 이것만으로도 크리티컬한 문제는 해결된다(Dirty Read는 꽤나 크리티컬 할 수가 있다).</p>\n<blockquote>\n<p><code class=\"language-text\">Dirty Read</code>는 커밋이 안된 것도 읽을 수 있어서 문제가 발생하는데, <code class=\"language-text\">READ COMMITTED</code>로 설정하면 커밋 된 것만 읽으니까 이 문제는 해결 된다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SET</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token keyword\">ISOLATION</span> <span class=\"token keyword\">LEVEL</span> <span class=\"token keyword\">READ</span> <span class=\"token keyword\">COMMITTED</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"21-문제점---non-repeatable-read\" style=\"position:relative;\"><a href=\"#21-%EB%AC%B8%EC%A0%9C%EC%A0%90---non-repeatable-read\" aria-label=\"21 문제점   non repeatable read permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 문제점 - Non Repeatable Read</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 950px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/bc18d9b33745f17ac812a2c7ba0082be/1ea01/img_read-commited.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.08403361344538%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/0lEQVQoz32SW3LiMBBFvY9QWLZkSbb8CkwIjxAYSGxjcDL738yZkiE1TD7ycatVKul09+0OdO6wjwXprEZpSRiGCCEIhbjGUBDFMcZaVJKgC0c6r0hnJTKJELf3IoqIoojAFBW2fiTJC1TqsK7AaEVmNFopnDUoKcdPSZJgqxpbl5hZhakKTOowRhNHHi4IfPZYSuJEEmuFVAoZxygZE49RjplFJLDW0p0G+n6gPZ15b3uatuftrRnjYrH0FZboTKNMPErcWr2Xt8HDk0SzXq85HI687vasVmt+Hw68vO54Wq5wzvkKFUJEhNPwqvB/eeB0OkVKiVIKkQiEFEzDcJT3WIiQycMDk8mEQGuFMclVVmOswaQGY/7Je+eB2hg2uyOr9Su/VhueX3Ysl1uWiyVP8wWP9Ywgnz9RPj9TrZZkdUFWZrg6G+EepLUeK/NAD2/ajuHjk8vwyak/c7mdj003th6ksw06nyMzh0wdiU7ROhnX4HvLHu6VWktVVrjMURQFZVmOg/Xvg0iEiHB6Uzj64SHRba+iG9hXmTmHLXOyOsfWDls50tJh03TcBp80uP/4XV9gH/2U8zyn7T9ouoHmPNBe/vDeXjgeGrbbPZvN9gr8XtFP0LbrRt/Olw/a9sR5+KTtevaHd7a7/c/Ae9jXnR/U/fR9u34zfDLv4V8H52Y8d2s2GQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/bc18d9b33745f17ac812a2c7ba0082be/24599/img_read-commited.webp 238w,\n/blog/static/bc18d9b33745f17ac812a2c7ba0082be/69f92/img_read-commited.webp 475w,\n/blog/static/bc18d9b33745f17ac812a2c7ba0082be/cebde/img_read-commited.webp 950w,\n/blog/static/bc18d9b33745f17ac812a2c7ba0082be/dbf17/img_read-commited.webp 1204w\"\n              sizes=\"(max-width: 950px) 100vw, 950px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/bc18d9b33745f17ac812a2c7ba0082be/da2e6/img_read-commited.png 238w,\n/blog/static/bc18d9b33745f17ac812a2c7ba0082be/abae4/img_read-commited.png 475w,\n/blog/static/bc18d9b33745f17ac812a2c7ba0082be/68327/img_read-commited.png 950w,\n/blog/static/bc18d9b33745f17ac812a2c7ba0082be/1ea01/img_read-commited.png 1204w\"\n            sizes=\"(max-width: 950px) 100vw, 950px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/bc18d9b33745f17ac812a2c7ba0082be/68327/img_read-commited.png\"\n            alt=\"img_read-commited\"\n            title=\"img_read-commited\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<ul>\n<li>#1, #2 <code class=\"language-text\">트랜잭션1</code>, <code class=\"language-text\">트랜잭션2</code> 시작</li>\n<li>#3 <code class=\"language-text\">트랜잭션1</code>에서 데이터 입력</li>\n<li>#4 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터를 못읽음 -> <code class=\"language-text\">dirty read</code> x</li>\n<li>#5 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">commit</code></li>\n<li>#6 <code class=\"language-text\">트랜잭션2</code>에서 출력됨</li>\n<li>#7 <code class=\"language-text\">트랜잭션1</code>을 열어서 데이터 삭제 후, <code class=\"language-text\">commit</code></li>\n<li>#8 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터가 사라진다.</li>\n</ul>\n<blockquote>\n<p><code class=\"language-text\">Dirty Read</code>는 해결 되었지만, 하나의 트랜잭션(<code class=\"language-text\">트랜잭션2</code>)에서 외부 요인에 따라 다른 select 결과가 나온다는 점에서 데이터 정합성이 깨질 수가 있다. 이런 문제를 <code class=\"language-text\">Non Repeatable Read</code>라고 한다.</p>\n</blockquote>\n<h2 id=\"3-repeatable-read\" style=\"position:relative;\"><a href=\"#3-repeatable-read\" aria-label=\"3 repeatable read permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. REPEATABLE READ</h2>\n<p>트랜잭션 단위로 동일한 select 조건이라면 동일한 결과가 나올 수 있게 보장 해준다. 자연스럽게 <code class=\"language-text\">Non Repeatable Read</code>문제가 해결 되지만 DB 내부적으로 <code class=\"language-text\">트랜잭션 ID</code>에 따른 <code class=\"language-text\">snapshot</code>을 떠서 관리하고, 이 버전보다 높은 결과는 반영하지 않게 된다(조회 불가). 이에 따라 DB 부하가 있을 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SET</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token keyword\">ISOLATION</span> <span class=\"token keyword\">LEVEL</span> <span class=\"token keyword\">REPEATABLE</span> <span class=\"token keyword\">READ</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"31-문제점---phantom-read\" style=\"position:relative;\"><a href=\"#31-%EB%AC%B8%EC%A0%9C%EC%A0%90---phantom-read\" aria-label=\"31 문제점   phantom read permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 문제점 - Phantom Read</h3>\n<p>먼저 데이터 구조</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">| idx | title           | contents           |\n| --- | --------------- | ------------------ |\n| 4   | article title 4 | article contents 4 |\n| 5   | article title 5 | article contents 5 |\n| 8   | article title 8 | article contents 8 |\n| 9   | article title 9 | article contents 9 |</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 950px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/d166f696c042decde3067c8bcdfa020d/faa7d/img_phantom-read.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.66386554621849%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB90lEQVQoz4WT65KiMBSEfRAFQu5B5KIYFJ2LqLPv/0LfFqmaqZkfu/Oj63CSrj5Jd1iJUiC9R9cVpm2QTpNla7Iso5QlhSiQzqHrLbZv0cGSZ5u0n33V7KtflWWJMBVCB4QLFNoilEUpSVEUCcI4pHfIukLWllxqSqkSr5AaIRW5kBTKsRJCkAtBIQX5AlVSLORlTRTkeU53ODKeJ46nE+1woB8iwxDpDpGm29PtD7T9IfVJsAwVpqmx3RZdG0SZk2cZm80mCff7A4+PP7zPd+b7k/N0IZ7OvN1m7s8PTtMlDRyOkZXWGtMc8G1DFRzOGqxSaKXIiwKlFKEKyc+u7znGI8Mw4L2n73tijIzjSFUFfKhYLeS6j4S6Tr4tAz5hzFINRmuKvMAai3ee4ANKKqy1SXi73SbO0q+Wa23WazbrTbridyz+hRAwweF3HpvgcDuPrz3GOrSxXzDWs/oZ+88nkGc5SivGlzeut5lpnjnN7xxf3zm/vDJMb+zHC8P5wuF0Ybjc/i24nHCpUirieEqh3OYH9/uTabqmIG73B4/nB9PlynR9IY7j74KLl1W1RUpJjGMKoaoqtDEcY6RtW3a7XQrPh/B/wcXDZLxzyeeu65JA0zRpULPbJbH9fp9ehbXud8HlTypthVCGLJ06T+ufvOX7e/8XC05g7nBNyEYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/d166f696c042decde3067c8bcdfa020d/24599/img_phantom-read.webp 238w,\n/blog/static/d166f696c042decde3067c8bcdfa020d/69f92/img_phantom-read.webp 475w,\n/blog/static/d166f696c042decde3067c8bcdfa020d/cebde/img_phantom-read.webp 950w,\n/blog/static/d166f696c042decde3067c8bcdfa020d/77a69/img_phantom-read.webp 1087w\"\n              sizes=\"(max-width: 950px) 100vw, 950px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/d166f696c042decde3067c8bcdfa020d/da2e6/img_phantom-read.png 238w,\n/blog/static/d166f696c042decde3067c8bcdfa020d/abae4/img_phantom-read.png 475w,\n/blog/static/d166f696c042decde3067c8bcdfa020d/68327/img_phantom-read.png 950w,\n/blog/static/d166f696c042decde3067c8bcdfa020d/faa7d/img_phantom-read.png 1087w\"\n            sizes=\"(max-width: 950px) 100vw, 950px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/d166f696c042decde3067c8bcdfa020d/68327/img_phantom-read.png\"\n            alt=\"img_phantom-read\"\n            title=\"img_phantom-read\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>위의 설명해서 <code class=\"language-text\">snapshot</code>을 통해 <code class=\"language-text\">Repeatable Read</code>을 서포트 한다고 하였다. 문제는 update를 하려고 하면 해당 <code class=\"language-text\">snapshot</code>의 대상 row를 갱신 시켜 버린다. 따라서 동일한 트랜잭션(위 이미지에서 <code class=\"language-text\">transaction2</code>)이라고 하더라도 update를 목적으로 하는 <code class=\"language-text\">for update</code> 를 통해 조회하면 가장 최신의 row가 조회 된다. 이런식으로 하나의 트랜잭션 내에서 <strong>똑같은 쿼리</strong>로 조회해도 결과적으로 <code class=\"language-text\">Non Repeatable Read</code>가 일어나는 현상을 <code class=\"language-text\">Phantom Read</code> 라고 한다.</p>\n<ul>\n<li>#1, #2 <code class=\"language-text\">트랜잭션1</code>, <code class=\"language-text\">트랜잭션2</code> 시작</li>\n<li>#3 <code class=\"language-text\">트랜잭션2</code>에서 5~9를 <code class=\"language-text\">select ... for update</code>을 통한 조회(5,8,9 조회 됨)</li>\n<li>#4, #5 <code class=\"language-text\">트랜잭션1</code>에서 5~9 사이에 있는 6의 값을 입력 및 <code class=\"language-text\">commit</code></li>\n<li>#6 <code class=\"language-text\">트랜잭션2</code>에서 <strong>똑같은 쿼리</strong>로 조회 시 <code class=\"language-text\">6</code>의 값이 추가되어 조회됨 -> <code class=\"language-text\">Phantom Read</code></li>\n</ul>\n<h3 id=\"312-phantom-read-발생-조건\" style=\"position:relative;\"><a href=\"#312-phantom-read-%EB%B0%9C%EC%83%9D-%EC%A1%B0%EA%B1%B4\" aria-label=\"312 phantom read 발생 조건 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1.2 Phantom Read 발생 조건</h3>\n<p><code class=\"language-text\">mysql</code>에선 <code class=\"language-text\">REPEATABLE READ</code>라고 <code class=\"language-text\">Phantom Read</code>가 발생하지 않는다. 이유는 <code class=\"language-text\">gap-lock &amp; next-key-lock</code>을 통해 <code class=\"language-text\">Phantom Read</code>를 방지하고 있다(차후 다른 포스트 or 현재 포스트를 업데이트 하여 설명 할 예정) 위의 현상은 <code class=\"language-text\">mysql</code> 설정값을 변경하여 <code class=\"language-text\">next-key-lock</code> 옵션을 꺼서 재현 해보았다.</p>\n<p><strong>설정파일 옵션</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[mysqld]\ninnodb_locks_unsafe_for_binlog=1</code></pre></div>\n<p><code class=\"language-text\">innodb_locks_unsafe_for_binlog=1</code> 설정을 통해 <code class=\"language-text\">next-key-lock</code>을 끌 수가 있고, 이 옵션은 실행 중에 바꿀 수는 없고 바꿀려면 설정값을 바꾼 후, DB를 재시작해야 한다.</p>\n<blockquote>\n<p>사소한 문제로 이 <code class=\"language-text\">innodb_locks_unsafe_for_binlog</code>옵션은 <code class=\"language-text\">mysql 5.6.3</code> 부터 <code class=\"language-text\">deprecated</code> 되었다. 그 이후 <code class=\"language-text\">mysql 8.0</code>부터 코드 상에서 제거되어 작동되지도 않으므로, 이 옵션을 적용하고 싶으면 그 보다 낮은 버전에서 테스트 해봐야한다.</p>\n</blockquote>\n<h3 id=\"32-문제점---공유되지-않는-snapshot\" style=\"position:relative;\"><a href=\"#32-%EB%AC%B8%EC%A0%9C%EC%A0%90---%EA%B3%B5%EC%9C%A0%EB%90%98%EC%A7%80-%EC%95%8A%EB%8A%94-snapshot\" aria-label=\"32 문제점   공유되지 않는 snapshot permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 문제점 - 공유되지 않는 <code class=\"language-text\">snapshot</code></h3>\n<p><code class=\"language-text\">Phantom Read</code>에서 동일한 쿼리를 실행 했을때, 조건에 따라 다른 결과값이 나올 수 있다고 하였다. <code class=\"language-text\">mysql</code>에선 <code class=\"language-text\">next-key-lock</code>을 통해 <code class=\"language-text\">Phantom Read</code>를 방지한다고 하였지만 이것도 결국 <code class=\"language-text\">lock</code>이 걸어서 방지하는 방법이라 <code class=\"language-text\">lock</code>이 풀리면 <code class=\"language-text\">snapshot</code>이 새롭게 생성되어 관리된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 950px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/9d76a6b62ab9fa90619941fa608a0c39/f5df9/img_repeatable-read.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.36974789915966%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACVklEQVQ4y42T646bOhSF50EawHfAEHI9M9M5bUIICWSaRH3/h/mO7DQzOVJV9ccSWGx/Xl578+TqmmLe4J9X5E2JVAIhbpJaorVGW4NrphTLGdXLmmLm/1f3qCdTFtjaI22BtI4syz6UJAlKqSghNUIYpLIIoeJ3EesEIhMfe56qf/6leX6hmjfM1nOcs5TOUpdFPDECtSJTGdIJpBFkIiMT4pc+DUSHUmqkkMgsQ4VrSolSEq0UaZpGoLGW6eqFZrGgXq2plkv8bEVdr5j6mrIob04DMEm+kGZJPClJ0whJkl+a3K5cVTXDcGEcznS7I113ZN+PtG1P1w30+wFjbNz79LzpWLyumS4qfOXx/qaqqjDGRGCe53zfbDgOA7t9z6bdsW07htOJ7nDk69tbvFnM0OUeoy1KqltHHxQKjDbxPc0myJCjFggZMkyQMjQjZTKZfGaYpkm0+tjdxy4HoHWOollQTmvK5Rz/OsevlxR+RpmX5Db/BP5ulu4KwODOl57D4cJwuDAerxyPZ7ruRLsdaDcHhsOZsvSxPgLv9Lvu6+jQGPK8YNNuOV8vDKd3juMYs/xxudCPJ9p9j8vzW1P+BhgUMlMhPxEGOiVLE5S8rZPJF9JkEvP8I/DeFFc4TNVgK49yFary6HKKcTXWWLQt0MUMU1S/Bz6Ctb6NzX5/oe/OfPt2YLsbaXcnttuRzfee3e49rpU2f3YYMgmwppmx3bWcr2fG9x8xu67vuf78yfl6ZdPteX37Sp67v3GoKcsSZ218D39NXdfxoPCsvP8YMecc/wHgPb3cfVRXNwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/9d76a6b62ab9fa90619941fa608a0c39/24599/img_repeatable-read.webp 238w,\n/blog/static/9d76a6b62ab9fa90619941fa608a0c39/69f92/img_repeatable-read.webp 475w,\n/blog/static/9d76a6b62ab9fa90619941fa608a0c39/cebde/img_repeatable-read.webp 950w,\n/blog/static/9d76a6b62ab9fa90619941fa608a0c39/ae3a3/img_repeatable-read.webp 1019w\"\n              sizes=\"(max-width: 950px) 100vw, 950px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/9d76a6b62ab9fa90619941fa608a0c39/da2e6/img_repeatable-read.png 238w,\n/blog/static/9d76a6b62ab9fa90619941fa608a0c39/abae4/img_repeatable-read.png 475w,\n/blog/static/9d76a6b62ab9fa90619941fa608a0c39/68327/img_repeatable-read.png 950w,\n/blog/static/9d76a6b62ab9fa90619941fa608a0c39/f5df9/img_repeatable-read.png 1019w\"\n            sizes=\"(max-width: 950px) 100vw, 950px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/9d76a6b62ab9fa90619941fa608a0c39/68327/img_repeatable-read.png\"\n            alt=\"img_repeatable-read\"\n            title=\"img_repeatable-read\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<ul>\n<li>#1, #2 <code class=\"language-text\">트랜잭션1</code>, <code class=\"language-text\">트랜잭션2</code> 시작</li>\n<li>#3 <code class=\"language-text\">트랜잭션1</code>에서 데이터 입력</li>\n<li>#4 <code class=\"language-text\">트랜잭션2</code>에서 일반 <code class=\"language-text\">select</code>를 통해 데이터 조회 -> 출력되지 않음</li>\n<li>#5 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">commit</code></li>\n<li>#6 <code class=\"language-text\">트랜잭션2</code>에서 일반 <code class=\"language-text\">select</code>를 통해 데이터 조회 -> 출력되지 않음 (<code class=\"language-text\">repeatable read</code>)</li>\n<li>#7 <code class=\"language-text\">트랜잭션2</code>에서 <code class=\"language-text\">select ... for update</code>를 통해 데이터 조회 -> 출력됨</li>\n</ul>\n<p><code class=\"language-text\">#5</code> 전후로 <code class=\"language-text\">트랜잭션2</code>에서 <code class=\"language-text\">select</code>와 <code class=\"language-text\">select ... for update</code> 쿼리는 동일한 레코드 11을 바라보지만 결과값이 달라지는걸 확인할수 있다.</p>\n<blockquote>\n<p>이걸 <code class=\"language-text\">Phantom Read</code>라고 설명하는곳도 있지만 그럼 mysql <code class=\"language-text\">REPEATABLE READ</code>에선 발생하면 안된다. 하지만 <code class=\"language-text\">isolation</code> 레벨과 무관하게 발생되기도 하고 발생 조건도 조금 다르다. <code class=\"language-text\">Phantom Read</code>는 <strong>동일한 쿼리</strong>를 실행해도 결과가 달라지는점, 이건 <code class=\"language-text\">snapshot</code>이 공유되지 않아 별도로 발생하므로 다르게 생각하는게 맞지 않을까 생각된다.</p>\n</blockquote>\n<h2 id=\"4-serializable\" style=\"position:relative;\"><a href=\"#4-serializable\" aria-label=\"4 serializable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. SERIALIZABLE</h2>\n<p>모든 <code class=\"language-text\">select</code> 쿼리에 최소 <code class=\"language-text\">shared lock</code>을 걸어버린다. 즉 <code class=\"language-text\">transaction 1</code>에서 쓰기 작업 중(<code class=\"language-text\">insert</code>, <code class=\"language-text\">delete</code>, <code class=\"language-text\">for update</code>)이라면 다른 트랜잭션에선 해당 데이터 조회가 불가능하다(<code class=\"language-text\">locking</code>)</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SET</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token keyword\">ISOLATION</span> <span class=\"token keyword\">LEVEL</span> <span class=\"token keyword\">SERIALIZABLE</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 949px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/44e31/img_serializable.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.73109243697479%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABD0lEQVQY002PbW7jMAxEfY9iLYmkSFmxXcf92N0Evf+xXhG7LfrjYQByMOQMfb+y3t9Z73+5vMxoFUQUEcGi4u6ICmZG9Ebfdy5vV9aPf6y3d2I59w//g8GmQFujWCMXJaVEyvnUX5gpqoZYIOqINbQ2ci7knH8Ylv835pedaVuZ33ZqNdyU8IrXepjOQENFSOMf0jj+aE7pJKczcFpfiWhMEVymhpsxudPDCXdy+gpUpUal9gm/BO3asR6IO1oDq/U4OuT8hHpBaiFLPrRYQexrVjJpTNTHx1Pg84b3Tiwb9Xk5mTdaX+h9Yni+3embEbNhTfHZ8K60WfHFKFqOwNYaKnpUfVQ86n6TRtJB4hN1ZqvofQCoywAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/24599/img_serializable.webp 238w,\n/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/69f92/img_serializable.webp 475w,\n/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/d22a1/img_serializable.webp 949w\"\n              sizes=\"(max-width: 949px) 100vw, 949px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/da2e6/img_serializable.png 238w,\n/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/abae4/img_serializable.png 475w,\n/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/44e31/img_serializable.png 949w\"\n            sizes=\"(max-width: 949px) 100vw, 949px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/44e31/img_serializable.png\"\n            alt=\"img_serializable\"\n            title=\"img_serializable\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">transaction 1</code>에서 <code class=\"language-text\">#1</code>, <code class=\"language-text\">#3</code> 쓰기 작업 중이라면 <code class=\"language-text\">transaction 2</code>에선 <code class=\"language-text\">for update</code>가 아닌데도 <code class=\"language-text\">lock</code> 대기가 걸려버린다(<code class=\"language-text\">#4</code>). <code class=\"language-text\">transaction 1</code>에서 commit을 해야 비로소 <code class=\"language-text\">wait</code>가 끝나고 데이터 조회가 가능하다.</p>\n<blockquote>\n<p><code class=\"language-text\">select ... for update</code> 단계는 도전도 안했다. 똑같이 lock이 풀릴때 까지(commit 될 때 까지) waiting 상태가 된다.</p>\n</blockquote>\n<h3 id=\"41-문제점---동시성\" style=\"position:relative;\"><a href=\"#41-%EB%AC%B8%EC%A0%9C%EC%A0%90---%EB%8F%99%EC%8B%9C%EC%84%B1\" aria-label=\"41 문제점   동시성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 문제점 - 동시성</h3>\n<p>모든 select 쿼리에 최소 <code class=\"language-text\">shared lock</code>이 걸리다보니까 동시성이 떨어져 병목현상이 심하게 발생 할 수가 있다.</p>\n<blockquote>\n<p><code class=\"language-text\">shared lock</code>과 <code class=\"language-text\">exclusive lock</code>을 알아야 <code class=\"language-text\">SERIALIZABLE</code>의 정확한 이해가 가능하다. 추후 lock 관련해서 따로 포스트 예정</p>\n</blockquote>"}},{"node":{"fields":{"slug":"/posts/etc/db/perssimistic-lock/","__typename":"MarkdownRemarkFields","categorySlug":"/category/etc/"},"frontmatter":{"template":"post","title":"Mysql - 비관적 락","date":"2022-09-23T01:49:22.280Z","tags":["rds","db","mysql"],"socialImage":null,"draft":false,"description":"Mysql에서 데이터 충돌을 대비하여 직접적인 Lock을 걸고 싶을 때(Perssimistic Lock)","category":"etc"},"id":"8b4a4a22-8318-58d6-974e-2bc911df252f","html":"<h2 id=\"1-lock\" style=\"position:relative;\"><a href=\"#1-lock\" aria-label=\"1 lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Lock</h2>\n<p>Lock이란 같은 데이터를 동시에 필요로 할때 미리 데이터를 선점하여 동시에 읽기/쓰기를 방지하기 위해 사용된다. <code class=\"language-text\">Mysql</code>에서 Lock은 크게 <code class=\"language-text\">Mysql 엔진 레벨</code>과 <code class=\"language-text\">스토리지 엔진 레벨</code>로 나눌 수 있고, 이런 Lock 들은 목적에 따라 <code class=\"language-text\">Shared Lock</code> 또는 <code class=\"language-text\">Exclusive Lock</code> 이라고 하는 추가적인 특성을 가질 수 있다. 이러한 <code class=\"language-text\">Shared Lock</code>과 <code class=\"language-text\">Exclusive Lock</code> 두 Lock은 <code class=\"language-text\">비관적 락 (Perssimistic Lock)</code> 이라고도 한다.</p>\n<blockquote>\n<p>Perssimistic Lock은 물리적으로 리소스가 충돌이 이루어 질 경우가 많을 것이라 생각되어, 이에 대비해서 특정 리소스(일반적으로 테이블의 레코드라 생각하면 된다)에 정말 물리적인 Lock을 거는것을 말한다.</p>\n</blockquote>\n<p>Lock 전체를 나열한건 아니지만 대략적으로 Lock 종류는 아래와 같이 나눠진다. <code class=\"language-text\">Perssimistic Lock</code>은 이러한 Lock 종류 중에 Lock 거는 속성 정도 라고 생각하면 된다.</p>\n<h3 id=\"11-스토리지-엔진-레벨innodb\" style=\"position:relative;\"><a href=\"#11-%EC%8A%A4%ED%86%A0%EB%A6%AC%EC%A7%80-%EC%97%94%EC%A7%84-%EB%A0%88%EB%B2%A8innodb\" aria-label=\"11 스토리지 엔진 레벨innodb permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 스토리지 엔진 레벨(InnoDB)</h3>\n<ul>\n<li>레코드 락(Record Lock)</li>\n<li>갭락(Gap Lock)</li>\n</ul>\n<h3 id=\"12-mysql-엔진-레벨\" style=\"position:relative;\"><a href=\"#12-mysql-%EC%97%94%EC%A7%84-%EB%A0%88%EB%B2%A8\" aria-label=\"12 mysql 엔진 레벨 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 Mysql 엔진 레벨</h3>\n<ul>\n<li>글로벌 락(Global Lock)</li>\n<li>테이블 락(Table Lock)</li>\n<li>네임드 락(Named Lock)</li>\n<li>메타데이터 락(Metadata Lock)</li>\n</ul>\n<p>이름만 봐도 Lock을 거는 대상이 어느것인지 예측이 가능할꺼라 생각 된다. 기억해야 할 사항으로는 <code class=\"language-text\">Mysql엔진 레벨</code>의 Lock은 모든 <code class=\"language-text\">스토리지 엔진 레벨</code>의 Lock에 영향을 주고, <code class=\"language-text\">스토리지 엔진 레벨</code>의 Lock은 다른 스토리지 엔진에 영향이 없다는 점이다.</p>\n<blockquote>\n<p>레코드 락은 <code class=\"language-text\">Shared/Exclusive Lock</code> 둘 다 사용 가능하지만 Gap Lock 같은 경우엔 항상 <code class=\"language-text\">Shared Lock</code>이 걸린다. 여기서 하고 싶은 말은 위에서 나열한 Lock과 <code class=\"language-text\">Perssimistic Lock</code>은 다르게 생각해야 한다는 점이다.</p>\n</blockquote>\n<p>개발자가 어플리케이션을 개발할 땐 레코드 락을 자주 사용하게 된다. 그래서 아래 나올 설명/예시 들은 항상 레코드를 대상으로 거는 레코드 락이 대부분이다.</p>\n<h2 id=\"2-exclusive-lock\" style=\"position:relative;\"><a href=\"#2-exclusive-lock\" aria-label=\"2 exclusive lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Exclusive Lock</h2>\n<p><code class=\"language-text\">쓰기 락</code>이라고도 하는데 동일한 자원에서 읽기/쓰기 행위를 막는데 사용된다. 아래 이미지는 <code class=\"language-text\">for update</code>를 써서 <code class=\"language-text\">Perssimistic Lock</code>걸었을 때 상황을 설명한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 950px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/736561bb6115c026ea9b74bfd0b37481/95b97/img_perssimistic-lock-insert.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.050420168067223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAzUlEQVQY01WQSw7DIAxEc48abPMxBBK1idT7H20qSFWliydYDGb8FlWFWEbYGmKrYHHw7CfOjTtPmBmSM7Q1hG2DxABHNDN3FlFF2A/YviMeB8K+QZThxcPRFSIizI9FwF+E/cyJyh9LjBGaMmJKUDNoqRBh8I0xNOeE+nyhnwfW84X6PlF6gTWDVYOtF0vrK/rxRN0LrKaLEWrfULPZTkezaAjJZgEuHZ4F9CAQXVsMFu+HL8U4fy7o3ws5hzCGpgIOEY4e058fjsf7Gx8jXotpcG+IrQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/736561bb6115c026ea9b74bfd0b37481/24599/img_perssimistic-lock-insert.webp 238w,\n/blog/static/736561bb6115c026ea9b74bfd0b37481/69f92/img_perssimistic-lock-insert.webp 475w,\n/blog/static/736561bb6115c026ea9b74bfd0b37481/cebde/img_perssimistic-lock-insert.webp 950w,\n/blog/static/736561bb6115c026ea9b74bfd0b37481/e017b/img_perssimistic-lock-insert.webp 1283w\"\n              sizes=\"(max-width: 950px) 100vw, 950px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/736561bb6115c026ea9b74bfd0b37481/da2e6/img_perssimistic-lock-insert.png 238w,\n/blog/static/736561bb6115c026ea9b74bfd0b37481/abae4/img_perssimistic-lock-insert.png 475w,\n/blog/static/736561bb6115c026ea9b74bfd0b37481/68327/img_perssimistic-lock-insert.png 950w,\n/blog/static/736561bb6115c026ea9b74bfd0b37481/95b97/img_perssimistic-lock-insert.png 1283w\"\n            sizes=\"(max-width: 950px) 100vw, 950px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/736561bb6115c026ea9b74bfd0b37481/68327/img_perssimistic-lock-insert.png\"\n            alt=\"perssimistic-lock\"\n            title=\"perssimistic-lock\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<ul>\n<li>#1, #2 <code class=\"language-text\">트랜잭션1</code>, <code class=\"language-text\">트랜잭션2</code> 시작</li>\n<li>#3 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">idx=1</code>인 데이터 <code class=\"language-text\">Perssimistic Lock</code> 걸고 조회</li>\n<li>#4 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터를 <code class=\"language-text\">Perssimistic Lock</code> 걸고 시도 -> waiting</li>\n<li>#5 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">commit</code>을 해야 <code class=\"language-text\">트랜잭션2</code>에서 waiting이 풀리고 출력</li>\n</ul>\n<p>참고로 <code class=\"language-text\">트랜잭션2</code>에서 밑에서 설명할 Shared Lock으로 시도해도 <code class=\"language-text\">트랜잭션1</code>이 종료 될 때까지 대기가 걸린다.</p>\n<blockquote>\n<p>위의 예제로써 <code class=\"language-text\">for update</code>를 쓰긴 했지만 update, delete도 똑같이 쓰기 행위이므로 다 <code class=\"language-text\">Exclusive Lock</code>이 걸린다</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 950px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/678f5333e153eecd63617866d2b8bceb/95b97/img_perssimistic-lock-update.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.050420168067223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAyUlEQVQY012QW27DMAwEfRCLpCRSgtPETv2T+59sCtlGk/ZjsADB1+7UeqetG23faduGd8ebU2s9cHfMDFPFaqCxYO2GqpHmREp/mXwMPb65v158bXd6OLlksmVyPhGRY6lmvRC0Glb04LdelGk0ziIUD2otqCkiiSQJ0VPnlDBT8u1xuPF1JT+faDHERp8gdjJVr+RlofaMlnFZMTdsfHDpsNJbp7VOuBMRRDTC44jkk2nYETtt/c/jk1oy8dipyx2VdOZqeumbH1kMi2nZ5wl9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/678f5333e153eecd63617866d2b8bceb/24599/img_perssimistic-lock-update.webp 238w,\n/blog/static/678f5333e153eecd63617866d2b8bceb/69f92/img_perssimistic-lock-update.webp 475w,\n/blog/static/678f5333e153eecd63617866d2b8bceb/cebde/img_perssimistic-lock-update.webp 950w,\n/blog/static/678f5333e153eecd63617866d2b8bceb/e017b/img_perssimistic-lock-update.webp 1283w\"\n              sizes=\"(max-width: 950px) 100vw, 950px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/678f5333e153eecd63617866d2b8bceb/da2e6/img_perssimistic-lock-update.png 238w,\n/blog/static/678f5333e153eecd63617866d2b8bceb/abae4/img_perssimistic-lock-update.png 475w,\n/blog/static/678f5333e153eecd63617866d2b8bceb/68327/img_perssimistic-lock-update.png 950w,\n/blog/static/678f5333e153eecd63617866d2b8bceb/95b97/img_perssimistic-lock-update.png 1283w\"\n            sizes=\"(max-width: 950px) 100vw, 950px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/678f5333e153eecd63617866d2b8bceb/68327/img_perssimistic-lock-update.png\"\n            alt=\"perssimistic-lock\"\n            title=\"perssimistic-lock\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"3-shared-lock\" style=\"position:relative;\"><a href=\"#3-shared-lock\" aria-label=\"3 shared lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Shared Lock</h2>\n<p><code class=\"language-text\">읽기 락</code> 이라고도 하는데, 동일한 자원을 여러 곳에서 읽는 행위는 허용하는 Lock이다. Lock이라고 무조건 모든 행위를 막아버리면 병목이 심해 질 수 있으므로, 이러한 상황을 방지하기 위해 <code class=\"language-text\">Shared Lock</code>을 쓰면 다른곳에서 동일한 리소스를 읽기는 허용 되어도, 쓰기는 불가능하도록 막기 위해 사용된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 950px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/4423c/img_shared-lock01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.49579831932773%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABU0lEQVQoz12SSZLDIAxFfZKYSUzGhjixk9z/YK8L3Fl0L159ppK+JCbvhbCu5HujvA6WR0OCw2iDdRbnBREhlIW8N8r7YH09CIvHGIu1f5mcs9jgkSUhZUFKxAYz0FYz32acc2ht0UbQpgcS1Kwu1F9GwHg/qeeH9bGTXif5/cY6g9LXo+5QGz0SGPfFYMUM1Uqj9cU0Hmsz7Jtx2NduXH4diDgkJWLdiK0Q9pXwWEl7Y6kZHwSl5sHkved2uzHP84W6tAf6aggBSZnUGrGuhL0Sj0psO6UV0pZxaUVCZso5jx6Jk6H/6U774Hqffcmjx7IlpPaeZ0IJxBrw24LkxNRaI+fIUhJlK78sQ3syYwy1bdR9pz0O2vOgvV+0z8n99eF5PNmfO+18cz8/TD44ZKvEe8OIwkaDCXrQJ9xLjiHg00qqT4xWGKUvtBoV9C9m9LX/Af+z6F1jvkoSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/24599/img_shared-lock01.webp 238w,\n/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/69f92/img_shared-lock01.webp 475w,\n/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/cebde/img_shared-lock01.webp 950w,\n/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/57ca4/img_shared-lock01.webp 1036w\"\n              sizes=\"(max-width: 950px) 100vw, 950px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/da2e6/img_shared-lock01.png 238w,\n/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/abae4/img_shared-lock01.png 475w,\n/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/68327/img_shared-lock01.png 950w,\n/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/4423c/img_shared-lock01.png 1036w\"\n            sizes=\"(max-width: 950px) 100vw, 950px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/68327/img_shared-lock01.png\"\n            alt=\"perssimistic-lock\"\n            title=\"perssimistic-lock\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<ul>\n<li>#1, #2 <code class=\"language-text\">트랜잭션1</code>, <code class=\"language-text\">트랜잭션2</code> 시작</li>\n<li>#3 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">idx=1</code>인 데이터 <code class=\"language-text\">Shared Lock</code> 걸고 조회</li>\n<li>#4 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터를 <code class=\"language-text\">Lock</code> 없이 조회 시도 -> 바로 출력</li>\n<li>#5 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터를 <code class=\"language-text\">Shared Lock</code>으로 조회 시도 -> 바로 출력</li>\n<li>#6 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터를 <code class=\"language-text\">Exclusive Lock</code>으로 조회 시도 -> waiting</li>\n<li>#7 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">commit</code>을 해야 <code class=\"language-text\">트랜잭션2</code>에서 <code class=\"language-text\">Exclusive Lock</code> waiting이 종료 되고 출력</li>\n</ul>\n<blockquote>\n<p>Shared Lock은 일단 Lock을 걸어도 다른곳에서 <code class=\"language-text\">Shared Lock</code>을 사용해도 읽기는 가능하다는 점에서 Exclusive Lock 보다 병목 현상이 줄어든다</p>\n</blockquote>\n<p>추가로 아래 표는 <code class=\"language-text\">Shared Lock</code> 과 <code class=\"language-text\">Exclusive Lock</code> 관계를 보여주는데 동일한 리소스에 어떤 Lock에 걸려있는지에 따라 <code class=\"language-text\">Conflict</code>가 나는지, <code class=\"language-text\">Compatible</code>가 되는지 보여준다.</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>X</th>\n<th>S</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>X</td>\n<td>Conflict</td>\n<td>Conflict</td>\n</tr>\n<tr>\n<td>S</td>\n<td>Conflict</td>\n<td>Compatible</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p><code class=\"language-text\">Exclusive Lock</code>은 <code class=\"language-text\">X</code>, <code class=\"language-text\">Shared Lock</code>은 <code class=\"language-text\">S</code>로 표현하였는데 mysql 8.0 이상을 기준으로 <code class=\"language-text\">performance_schema.data_locks</code>테이블을 살펴보면 해당 락을 이렇게 표현한다. 이 테이블은 나중에 추가로 분석 예정</p>\n</blockquote>\n<h2 id=\"4-gap-lock-next-key-lock\" style=\"position:relative;\"><a href=\"#4-gap-lock-next-key-lock\" aria-label=\"4 gap lock next key lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Gap Lock, Next Key Lock</h2>\n<p>트랜잭션 <code class=\"language-text\">Isolation</code>을 쓸 때 잠깐 설명한 적이 있는데 <code class=\"language-text\">Mysql</code>에선 이런 <code class=\"language-text\">Next Key Lock</code>을 통해 <code class=\"language-text\">Phantom Read</code>를 방지한다고 하였다. <code class=\"language-text\">Gap Lock</code>은 단독으로 사용되지 않고 <code class=\"language-text\">Next Key Lock</code>과 함께 사용되는 것인데 <code class=\"language-text\">Gap Lock</code>은 범위를 통한 <code class=\"language-text\">Lock</code>을 걸었을 때 레코드에 빈 데이터가 있으면 중간 <code class=\"language-text\">Gap</code>에 Lock을 걸어버리는걸 의미한다. <code class=\"language-text\">Next Key Lock</code>은 <code class=\"language-text\">Gap Lock</code> + 레코드 락이 합쳐진 락이라고 이해하면 된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 950px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/e7189a27b29834ec01b6e3527c882902/e5cc9/img_gap-lock.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.016806722689076%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABRUlEQVQoz43R62rjMBCGYd9HHJ/lyDrZ8jnNJmkbkqXt373/W3mXqEtpKQv98TCDQMMMX1RIidCauvWUsiZJtiRJ8iHLc9IsI88ySqmojKXu+vAnzRLSNP0ialqP6Hp2TiF1TVkKsiz7Js9zkm3C9ovtN1F7fEVe/iDnJ7Rtsd1IVZZUVfWhKIrg8+b/Ex2OZw6nC+vyQN9PrOsD4zjRth3OOXznQ38fGMebd5tP4g2bOCb+JzqeH3l5e+P5+pvL9cbhdObX6ZHn643byyvnp0t4E1XFTlv0MKBHj5o6zDRgfIvzNlBaERljkFIyzQvruqfve5RSzPPMfr8PdV4Wmqah0Q5lO5RrUe2992jrsMZg9bvIWoMQgnEcg/sAay3ee4ZxZFkWhnEKCf7o5J1zKG8QSgS1FtSmDkQjyPMipPyTQO6h/AVPv+sJWTdGxAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/e7189a27b29834ec01b6e3527c882902/24599/img_gap-lock.webp 238w,\n/blog/static/e7189a27b29834ec01b6e3527c882902/69f92/img_gap-lock.webp 475w,\n/blog/static/e7189a27b29834ec01b6e3527c882902/cebde/img_gap-lock.webp 950w,\n/blog/static/e7189a27b29834ec01b6e3527c882902/1de89/img_gap-lock.webp 1058w\"\n              sizes=\"(max-width: 950px) 100vw, 950px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/e7189a27b29834ec01b6e3527c882902/da2e6/img_gap-lock.png 238w,\n/blog/static/e7189a27b29834ec01b6e3527c882902/abae4/img_gap-lock.png 475w,\n/blog/static/e7189a27b29834ec01b6e3527c882902/68327/img_gap-lock.png 950w,\n/blog/static/e7189a27b29834ec01b6e3527c882902/e5cc9/img_gap-lock.png 1058w\"\n            sizes=\"(max-width: 950px) 100vw, 950px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/e7189a27b29834ec01b6e3527c882902/68327/img_gap-lock.png\"\n            alt=\"perssimistic-lock\"\n            title=\"perssimistic-lock\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<ul>\n<li>#1, #2 <code class=\"language-text\">트랜잭션1</code>, <code class=\"language-text\">트랜잭션2</code> 시작</li>\n<li>#3 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">idx</code>값이 4~8인 레코드들을 <code class=\"language-text\">select ... for update</code>를 통한 조회</li>\n<li>#4 <code class=\"language-text\">트랜잭션2</code>에서 <code class=\"language-text\">idx</code> 값이 5인 레코드 입력을 시도하지만 바로 처리가 안되고 대기 상태가 된다\n<blockquote>\n<p>물리적으로 진짜 존재하는 4,6,8은 <code class=\"language-text\">record lock</code>, 중간중간 값이 없는 5,7은 <code class=\"language-text\">gap lock</code>이 걸린다.</p>\n</blockquote>\n</li>\n<li>#5 <code class=\"language-text\">트랜잭션1</code>에서 commit을 해야 <code class=\"language-text\">#4</code>의 대기상태가 풀리고 처리된다.</li>\n</ul>\n<p>추가로 <code class=\"language-text\">gap lock</code>은 <code class=\"language-text\">쓰기 lock</code>이라고 이해 해야한다. <code class=\"language-text\">select ... for update</code>을 통해 5,7인 가상의 값들은 <code class=\"language-text\">gap lock</code>이 걸렸지만 <code class=\"language-text\">select</code>는 가능하다(출력되는건 당연히 없지만). <code class=\"language-text\">gap lock</code>은 insert를 방지하여 하나의 transaction내에서 동일한 결과, 즉 <code class=\"language-text\">Repeatable Read</code>를 보장한다.</p>\n<h2 id=\"6-lock-주의사항\" style=\"position:relative;\"><a href=\"#6-lock-%EC%A3%BC%EC%9D%98%EC%82%AC%ED%95%AD\" aria-label=\"6 lock 주의사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. Lock 주의사항</h2>\n<p>굉장히 중요한 얘기를 짧게 설명하자면 <code class=\"language-text\">Lock</code>은 항상 <code class=\"language-text\">index</code>를 대상으로 Lock이 걸린다는 점이다.</p>\n<p>현재 테스트 대상으로 위와 같이 셋팅 된 <code class=\"language-text\">article</code> 테이블이 있고 <code class=\"language-text\">idx</code>만 PK로 지정되어 있다고 가정</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">| idx | title           | contents           |\n| --- | --------------- | ------------------ |\n| 2   | article 2 title | article 2 contents |\n| 3   | article 3 title | article 3 contents |\n| 4   | article 4 title | article 4 contents |\n| 6   | article 6       | article content 6  |\n| 7   | article 7       | article content 7  |\n| 10  | article 10      | article10          |\n| 12  | article 6       | article content 6  |</code></pre></div>\n<p>이런 상태에서 <code class=\"language-text\">title</code> 컬럼을 기준으로 Lock을 걸고, <code class=\"language-text\">performance_schema.data_locks</code>테이블을 조회하면 아래와 같이 나온다</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># 1. title로 특정 row Locking</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> article\n<span class=\"token keyword\">where</span> title <span class=\"token operator\">=</span> <span class=\"token string\">'article 3 title'</span> <span class=\"token keyword\">for</span> <span class=\"token keyword\">update</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\"># 2. 현재 Lock Data 확인</span>\n<span class=\"token keyword\">select</span> OBJECT_NAME<span class=\"token punctuation\">,</span> INDEX_NAME<span class=\"token punctuation\">,</span> LOCK_TYPE<span class=\"token punctuation\">,</span> LOCK_DATA <span class=\"token keyword\">from</span> performance_schema<span class=\"token punctuation\">.</span>data_locks<span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"출력된-lock-data\" style=\"position:relative;\"><a href=\"#%EC%B6%9C%EB%A0%A5%EB%90%9C-lock-data\" aria-label=\"출력된 lock data permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>출력된 Lock Data</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">| OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_DATA              |\n| ----------- | ---------- | --------- | ---------------------- |\n| article     | &lt;null>     | TABLE     | &lt;null>                 |\n| article     | PRIMARY    | RECORD    | supremum pseudo-record |\n| article     | PRIMARY    | RECORD    | 2                      |\n| article     | PRIMARY    | RECORD    | 3                      |\n| article     | PRIMARY    | RECORD    | 4                      |\n| article     | PRIMARY    | RECORD    | 12                     |\n| article     | PRIMARY    | RECORD    | 6                      |\n| article     | PRIMARY    | RECORD    | 7                      |\n| article     | PRIMARY    | RECORD    | 10                     |</code></pre></div>\n<p>결과를 보면 idx값이 2~14인 모든 레코드 들이 Lock이 걸린것을 확인 할수 있다.</p>\n<blockquote>\n<p><code class=\"language-text\">INDEX_NAME</code>이 <code class=\"language-text\">PRIMARY</code> -> PK기반으로 Lock이 걸림 -> LOCK_DATA가 PK값을 의미한다.</p>\n</blockquote>\n<blockquote>\n<p><code class=\"language-text\">LOCK_TYPE</code>이 <code class=\"language-text\">Table</code>인 <code class=\"language-text\">Lock</code>은 <code class=\"language-text\">Intention Locks</code>이라고 하여 <code class=\"language-text\">Table</code> 레벨에 Lock을 걸어버린다. 다른 트랜잭션에서 Lock을 확인하기 위해 사용되는데 일단 성능 최적화 정도로 이해하면 된다</p>\n</blockquote>\n<blockquote>\n<p><code class=\"language-text\">LOCK_DATA</code>가 <code class=\"language-text\">supremum pseudo-record</code>인 Lock은 이것으로 인해 Mysql에서 <code class=\"language-text\">Phantom Read</code>를 방지한다.</p>\n</blockquote>\n<p>이런이유로 Index가 걸리지 않은 컬럼을 Lock을 거는건 지양해야하고, Index가 걸린 컬럼이라도 <code class=\"language-text\">Unique Index</code>가 아니라면 또는 <code class=\"language-text\">Where</code> 조건에 따라 <code class=\"language-text\">Gap Lock</code>이 걸릴수도 있다는걸 같이 기억 해야한다. 혹시나마 lock을 걸고 싶으면 차라리 검색 후, pk(또는 unique index)기반으로 lock을 걸어야 원하는 record만 lock이 걸리도록 유도해야한다.</p>"}}]}}}