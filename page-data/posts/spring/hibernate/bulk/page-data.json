{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/spring/hibernate/bulk/","result":{"data":{"markdownRemark":{"id":"4773285c-2702-5642-8ac5-1d4e58c3a214","html":"<h3 id=\"사전-지식\" style=\"position:relative;\"><a href=\"#%EC%82%AC%EC%A0%84-%EC%A7%80%EC%8B%9D\" aria-label=\"사전 지식 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>사전 지식</h3>\n<h4 id=\"1-벌크연산-주의점\" style=\"position:relative;\"><a href=\"#1-%EB%B2%8C%ED%81%AC%EC%97%B0%EC%82%B0-%EC%A3%BC%EC%9D%98%EC%A0%90\" aria-label=\"1 벌크연산 주의점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 벌크연산 주의점</h4>\n<p><code class=\"language-text\">Hibernate</code>에서 벌크연산(<code class=\"language-text\">update</code> or <code class=\"language-text\">delete</code>)을 하게 되면 해당 entity의 영속성 컨텍스트는 깨지게 된다. 이유는 지금 영속성 컨텍스트에서 관리되는 객체가 해당 벌크연산에 영향을 받았는지, 안받았는지 정확히 알 수 없고, 괜히 나중에 <code class=\"language-text\">flush</code>(DB 동기화) 했다가 버그만 만들어 질 수가 있어 그렇게 만들어졌다.</p>\n<h4 id=\"2-영속성-컨텍스트-flush\" style=\"position:relative;\"><a href=\"#2-%EC%98%81%EC%86%8D%EC%84%B1-%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8-flush\" aria-label=\"2 영속성 컨텍스트 flush permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 영속성 컨텍스트 flush</h4>\n<p>영속성 컨텍스트의 변경 내용을 DB와 동기화 하는 것을 말한다. JPA에서 지원해주는 모드는 2가지가 있다.</p>\n<ol>\n<li><code class=\"language-text\">FlushModeType.AUTO</code> - 커밋이나 쿼리를 실행 할 떄 <code class=\"language-text\">flush</code>가 이루어진다(default)</li>\n<li><code class=\"language-text\">FlushModeType.COMMIT</code> - 커밋 할 때만 <code class=\"language-text\">flush</code>가 실행</li>\n</ol>\n<p>두 개 모두 장단점이 있지만 1번은 <code class=\"language-text\">flush</code>가 2번보다 상대적으로 많이 이뤄질 수 있다는 점, 2번은 잘못하다간 영속성 컨텍스트가 다 꼬여 원하는 시점에 id(auto generate. pk)값을 알 수 없을 수도 있다는 단점이 있다. 일반적으로 2번은 크리티컬하고 귀찮은 문제가 발생 할 수 잇어서 1번을 디폴트로 쓰고, 혹시나마 오버헤드로 인한 성능 이슈가 있을 때만 2번을 사용하기도 한다.</p>\n<h4 id=\"3-영속성-컨텍스트-clear\" style=\"position:relative;\"><a href=\"#3-%EC%98%81%EC%86%8D%EC%84%B1-%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8-clear\" aria-label=\"3 영속성 컨텍스트 clear permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 영속성 컨텍스트 clear</h4>\n<p>영속성 컨텍스트를 비워주는것을 말한다. 영속성 컨텍스트는 영속성 컨텍스트는 <code class=\"language-text\">id(pk)</code>으로 조회 한 후, 나중에 똑같은 id로 조회 하면 DB에 직접 조회하는게 아닌 1차 캐시에서 가져다 반환한다. 하지만 clear를 통해 영속성 컨텍스트를 초기화 하면 1차 캐시가 비워지니 DB에 직접 조회하게 된다\n주의할 점은 clear이후엔 이미 불러와</p>\n<p>진 데이터는 전부 <strong>준영속성 상태</strong>가 된다는 점을 기억 해야한다(읽기 용으로만 사용)</p>\n<h4 id=\"4-영속성-컨텍스트-범위\" style=\"position:relative;\"><a href=\"#4-%EC%98%81%EC%86%8D%EC%84%B1-%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8-%EB%B2%94%EC%9C%84\" aria-label=\"4 영속성 컨텍스트 범위 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 영속성 컨텍스트 범위</h4>\n<p>이 글에 직접적인 연관은 없지만 보다보면 그럼 영속성 컨텍스트는 언제 생성되고 없어지는지 궁금 할 수가 있다. 영속성 컨텍스트는 기본적으로 <code class=\"language-text\">reuqest</code>가 들어오고 <code class=\"language-text\">Spring Interceptor</code>에서 만들어진다고 보면 되고, <code class=\"language-text\">dirty check</code>는 <code class=\"language-text\">Transaction</code> 영역 내에서만, osiv 옵션이 켜져있다면 view까지 영속성 컨텍스트가 살아있게 된다.</p>\n<blockquote>\n<p><code class=\"language-text\">OSVI</code> 옵션을 키면 view 영역에선 데이터는 조회만 가능하며 <code class=\"language-text\">nonTransactional Reads</code>로 처리된다.</p>\n</blockquote>\n<hr>\n<p>이번에 분석할 것은 정확히 따지면 <code class=\"language-text\">@Modifying</code>이다. 이 어노테이션은 <code class=\"language-text\">@Query</code>중, 벌크 연산을 사용하는걸 명시적으로 나타낸다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ArticleRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Article</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token annotation punctuation\">@Modifying</span>\n  <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"UPDATE Article article SET article.subject = :subject, article.contents = :contents WHERE article.idx = :idx\"</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">void</span> <span class=\"token function\">updateArticle</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"idx\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Long</span> idx<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"subject\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> subject<span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"contents\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> contents<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이런식으로 사용되며, 쉽게 <code class=\"language-text\">update</code>쿼리를 실행 시킬 수가 있다. 근데 이런 update/delete 연산은 영속성 컨텍스트를 깨뜨린다고 하였는데, 이 메소드 실행 전후에 <code class=\"language-text\">flush/clear</code>를 실행 해야만 안전하게 프로그래밍이 가능하다. 그걸 간편하게 하기 위해 <code class=\"language-text\">@Modifying</code>어노테이션에 2가지 attribute를 제공 해주고 있다.</p>\n<h3 id=\"flushautomaticallyboolean\" style=\"position:relative;\"><a href=\"#flushautomaticallyboolean\" aria-label=\"flushautomaticallyboolean permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>flushAutomatically(Boolean)</h3>\n<p>쿼리문 실행 직전에 <code class=\"language-text\">flush</code>를 실행 할지 여부를 지정한다. 일단 용도는 true값이면 해당 메소드(<code class=\"language-text\">update</code> 쿼리)가 실행 직전에 <code class=\"language-text\">flush</code>를 실행하고 false라면 별도로 실행 시키지 않는다.</p>\n<p>그런데 false 값이라도 flush가 호출 될 수도 있다(높은 확률로 그냥 flush 된다) 이유는 밑에서 후술함</p>\n<h3 id=\"clearautomaticallyboolean\" style=\"position:relative;\"><a href=\"#clearautomaticallyboolean\" aria-label=\"clearautomaticallyboolean permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>clearAutomatically(Boolean)</h3>\n<p>해당 메소드(<code class=\"language-text\">update</code> 쿼리)실행 직후에 영속성 컨텍스트를 <code class=\"language-text\">clear</code> 여부를 지정한다.</p>\n<p>예제</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ArticleRepository</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaRepository</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Article</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Long</span><span class=\"token punctuation\">></span></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Modifying</span>\n    <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"UPDATE Article article SET article.subject = :subject, article.contents = :contents WHERE article.idx = :idx\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">updateByQuery</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"idx\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Long</span> idx\n                        <span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"subject\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> subject\n                        <span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"contents\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> contents<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Modifying</span><span class=\"token punctuation\">(</span>flushAutomatically <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span> clearAutomatically <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"UPDATE Article article SET article.subject = :subject, article.contents = :contents WHERE article.idx = :idx\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">updateByQueryAndAutoClear</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"idx\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">Long</span> idx\n            <span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"subject\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> subject\n            <span class=\"token punctuation\">,</span> <span class=\"token annotation punctuation\">@Param</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"contents\"</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> contents<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이런 repository가 있어서 테스트를 돌려보면</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"벌크 연산 후, clear를 안하고 조회하면 기존 영속성 컨텍스트는 실제랑 안맞음\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">contextTest1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">//1차 캐싱 유도</span>\n    articleRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token number\">6L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//벌크 연산을 통해 영속성 컨텍스트를 깨트림</span>\n    articleRepository<span class=\"token punctuation\">.</span><span class=\"token function\">updateByQuery</span><span class=\"token punctuation\">(</span><span class=\"token number\">6L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"update subject\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"update contents\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//실제 db가 아닌 영속성 컨텍스트에서 값조회(정확하지가 않음)</span>\n    <span class=\"token class-name\">Article</span> afterBulk <span class=\"token operator\">=</span> articleRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token number\">6L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//잘못된 영속성 컨텍스트에서 조회해서 값이 정확하지가 않다.</span>\n    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span>afterBulk<span class=\"token punctuation\">.</span><span class=\"token function\">getSubject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">isNotEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"update subject\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span>afterBulk<span class=\"token punctuation\">.</span><span class=\"token function\">getContents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">isNotEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"update contents\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token annotation punctuation\">@DisplayName</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"벌크 연산 후, clear하고 재조회 하면 정확한 값을 얻을 수가 있다.\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">contextTest2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">//1차 캐싱 유도</span>\n    articleRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token number\">7L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//벌크 연산을 통해 영속성 컨텍스트를 깨뜨리고 clear한다.</span>\n    articleRepository<span class=\"token punctuation\">.</span><span class=\"token function\">updateByQueryAndAutoClear</span><span class=\"token punctuation\">(</span><span class=\"token number\">7L</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"update subject\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"update contents\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//실제 db에서 재조회 한다.</span>\n    <span class=\"token class-name\">Article</span> afterBulkAndClear <span class=\"token operator\">=</span> articleRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span><span class=\"token number\">7L</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//최신 데이터를 조회하므로 값이 정확하다</span>\n    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span>afterBulkAndClear<span class=\"token punctuation\">.</span><span class=\"token function\">getSubject</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"update subject\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">then</span><span class=\"token punctuation\">(</span>afterBulkAndClear<span class=\"token punctuation\">.</span><span class=\"token function\">getContents</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"update contents\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>주의 점은 앞서 말한데로 clear는 기존 불러온 데이터는 전부 준영속성 상태로 바꾼다고 하였다. 그니까 트랜잭션이 종료되도 <code class=\"language-text\">dirty check &amp; save</code>대상이 아니라는 말이다.</p>\n<h3 id=\"tip1\" style=\"position:relative;\"><a href=\"#tip1\" aria-label=\"tip1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tip.1</h3>\n<p><code class=\"language-text\">JpaQueryExecution</code>클래스 안에 <code class=\"language-text\">ModifyingExecution</code>이라는 inner class가 있고, 여기 코드를 보면 <code class=\"language-text\">modifying</code>쿼리 실행 직후에 <code class=\"language-text\">flush &amp; clear</code> 실행 되는 로직을 확인 할 수가 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ModifyingExecution</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">JpaQueryExecution</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">ModifyingExecution</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">JpaQueryMethod</span> method<span class=\"token punctuation\">,</span> <span class=\"token class-name\">EntityManager</span> em<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//불필요한거 생략</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>em <span class=\"token operator\">=</span> em<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>flush <span class=\"token operator\">=</span> method<span class=\"token punctuation\">.</span><span class=\"token function\">getFlushAutomatically</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>clear <span class=\"token operator\">=</span> method<span class=\"token punctuation\">.</span><span class=\"token function\">getClearAutomatically</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token annotation punctuation\">@Override</span>\n  <span class=\"token keyword\">protected</span> <span class=\"token class-name\">Object</span> <span class=\"token function\">doExecute</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">AbstractJpaQuery</span> query<span class=\"token punctuation\">,</span> <span class=\"token class-name\">JpaParametersParameterAccessor</span> accessor<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>flush<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      em<span class=\"token punctuation\">.</span><span class=\"token function\">flush</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">int</span> result <span class=\"token operator\">=</span> query<span class=\"token punctuation\">.</span><span class=\"token function\">createQuery</span><span class=\"token punctuation\">(</span>accessor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>clear<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      em<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> result<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이런식으로 아주 명확하게 구현된걸 볼 수 있다.</p>\n<h3 id=\"tip2\" style=\"position:relative;\"><a href=\"#tip2\" aria-label=\"tip2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Tip.2</h3>\n<p>자신이 jpa(hibernate)를 공부하는 과정에 여러가지 테스트 해보고 있는 중이라면</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">logging</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">level</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">org.hibernate.event</span><span class=\"token punctuation\">:</span> trace</code></pre></div>\n<p>이 옵션을 키고 보면 공부하는데 많은 도움이 된다. flush 실행 log나 지연실행, 캐시에서 꺼내오는 log를 직접 확인이 가능하다(단순 로그긴 하지만)</p>\n<hr>\n<p>위에서 <code class=\"language-text\">flushAutomatically</code>를 설명하면서, 이 옵션 <code class=\"language-text\">true/false</code> 여부에 상관없이 <code class=\"language-text\">flush</code>되는 것을 확인 될 수도(…?) 있다. 그건 애초에 영속성 컨텍스트에 <code class=\"language-text\">FlushModeType</code> 또는 <code class=\"language-text\">FlushMode</code>에 의해 <code class=\"language-text\">flush</code> 조건이 고정되어 있어서 더 높은 우선순위를 가지기 때문이다. 이 값을 바꿔서 테스트 해보겠다면 <code class=\"language-text\">setFlushMode</code>를 통해 모드 값을 바꾸고 테스트 해보면 된다.</p>\n<p>또한 참고할 점으로 맨 위에서 <code class=\"language-text\">jpa</code>에선 2가지 <code class=\"language-text\">FlushModeType</code>을 제공 해준다고 하였다. 근데 <code class=\"language-text\">hibernate</code>는 여기서 더 확장하여 총 4가지 모드를 지원 해주고 있다.</p>\n<h3 id=\"flushmode\" style=\"position:relative;\"><a href=\"#flushmode\" aria-label=\"flushmode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>FlushMode</h3>\n<ul>\n<li><code class=\"language-text\">AUTO(default)</code> - 쿼리가 실행되면 쿼리 결과가 영속성 컨텍스트에 영향을 미칠때 or 커밋이나 <code class=\"language-text\">flush</code> 호출 할때</li>\n<li><code class=\"language-text\">ALWAYS</code> - 모든 쿼리 실행 직전에 flush 호출\n<blockquote>\n<p>The Session is flushed before every query. This is almost always unnecessary and inefficient. 대놓고 비효율 적이라고 말하고 있다.</p>\n</blockquote>\n</li>\n<li><code class=\"language-text\">MANUAL</code> - 명시적으로 <code class=\"language-text\">flush</code> 호출 할 때만 <code class=\"language-text\">flush</code> 호출</li>\n<li><code class=\"language-text\">COMMIT</code> - 트랜잭션에서 커밋 호출 직전에 <code class=\"language-text\">flush</code></li>\n</ul>\n<p><code class=\"language-text\">AUTO</code>, <code class=\"language-text\">ALWAYS</code>는 그래도 flush 모드를 잘 몰라도 얼추 의도한대로 실행 되지만 다른 두가지는 조심해서 사용해야 한다.</p>","fields":{"slug":"/posts/spring/hibernate/bulk/","tagSlugs":["/tag/jpa/","/tag/hibernate/"]},"frontmatter":{"date":"2024-01-10T09:00:24.113Z","description":"hibernate에서 벌크연산 시 주의할 점, flush와 FlushMode","tags":["jpa","hibernate"],"title":"Hibernate - 벌크연산과 flush","socialImage":null}}},"pageContext":{"slug":"/posts/spring/hibernate/bulk/"}},"staticQueryHashes":["251939775","2839666046","2891173899","401334301"]}