{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/spring/spring-r2dbc-coroutine/","result":{"data":{"markdownRemark":{"id":"4bc2f26e-94f8-5446-8705-d15d6b1f7a02","html":"<p>최근 <code class=\"language-text\">Coroutine</code>을 사용하면 기존 <code class=\"language-text\">Webflux</code> + <code class=\"language-text\">R2DBC</code> 조합의 복잡한 코드 들도 단순하게 구현이 가능하다는걸 알게 되어, 이참에 다시한번 <code class=\"language-text\">R2DBC</code> 복습 좀 하고 여러가지 테스트를 해보면서 알게 된 기록들을 남겨본다.</p>\n<h4 id=\"사전지식-1\" style=\"position:relative;\"><a href=\"#%EC%82%AC%EC%A0%84%EC%A7%80%EC%8B%9D-1\" aria-label=\"사전지식 1 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>사전지식 1.</h4>\n<p>최소한의 <code class=\"language-text\">webflux</code> 기본 동작방식을 알아야 한다. <code class=\"language-text\">webflux</code>는 적은 스레드로 많은 <code class=\"language-text\">request</code>를 처리하도록 설계되어 있다. <code class=\"language-text\">javascript</code>에서 이벤트 루프와 비슷한데, 오래 걸리는 작업이나 무거운 작업을 별도의 <code class=\"language-text\">event loop</code>로 넘겨 처리하고 완료되면 메인스레드에서 처리하는 방식이 비슷하다. <code class=\"language-text\">webflux</code>도 일단 reuqest 가 들어오면 스레드를 할당 받지만 이 <code class=\"language-text\">thread pool</code>은 tomcat과 비교하면 적은 개수로 운영하게 된다. 그래서 이 적은 스레드를 효과적으로 사용해야만 하고 request를 <code class=\"language-text\">blocking</code> 방식으로 처리하면 전체 시스템 퍼포먼스가 떨어질 수 도 있으니(<code class=\"language-text\">request</code>를 받아야할 스레드가 전부 blocking 상태가 될 수 있다) 항상 <code class=\"language-text\">non-blocking</code> 방식을 염두하고 개발해야한다.</p>\n<h4 id=\"사전지식-2\" style=\"position:relative;\"><a href=\"#%EC%82%AC%EC%A0%84%EC%A7%80%EC%8B%9D-2\" aria-label=\"사전지식 2 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>사전지식 2.</h4>\n<p>‘동시성’과 ‘병렬성’의 차이를 알아야 한다. 아래 설명할 내용들은 대부분 ‘동시성’과 관련 된 내용이지만 필요하면 ‘병렬’로 처리하여 퍼포먼스를 극대화 할 수도 있다.</p>\n<h4 id=\"사전지식-3\" style=\"position:relative;\"><a href=\"#%EC%82%AC%EC%A0%84%EC%A7%80%EC%8B%9D-3\" aria-label=\"사전지식 3 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>사전지식 3.</h4>\n<p><code class=\"language-text\">R2DBC</code>도 당연히 <code class=\"language-text\">Connection Pool</code> 개수를 조절 할 수 있다. 괜히 <code class=\"language-text\">CP</code>적게 잡아놓고 <code class=\"language-text\">R2DBC</code> 성능 안나온다고 삽질하면 안된다…</p>\n<blockquote>\n<p>R2DBC와 coroutine을 다루는 글이지만 개념적인 부분은 일부 설명 하더라도 자세한 설명이나 사용법 등은 여기서 설명 하진 않을 예정. 추후 다른글에서 webflux, coroutine에 대해 자세히 알아 볼 생각이다.</p>\n</blockquote>\n<p>아래에서 설명할 샘플 코드는 <a href=\"https://github.com/qweasd147/StudyNote/tree/master/springboot/coroutine-r2dbc\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">r2dbc 예제</a> 여기서 확인이 가능하다</p>\n<h2 id=\"r2dbc\" style=\"position:relative;\"><a href=\"#r2dbc\" aria-label=\"r2dbc permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>R2DBC</h2>\n<p><code class=\"language-text\">Reactive Relational Database Connectivity</code>의 약자로 요즘 핫한 <code class=\"language-text\">chat gpt</code>로 검색하면 아래와 같은 답을 얻을 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 807px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/1137c0ba74b4d70ffad6084be4581ad7/45d60/r2dbc01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80.67226890756302%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACPklEQVQ4y4VU2XLaQBDkm2wSQyqVuABdiFMHuoUkMKePSuX/q1092hUmL3lodmaPUU/PDL3+wMD3nw5Mcw3bCWDbPtxZhNF4gYfHX3jsP/8XD4+/MRga6H97Rm/4w4LGYGh2eBIYeBoo0NZnnX+DjtGbVC8wLlds/B2y8ookOyMtLkjzM9L8IsiKK6L0iDg9yZrkZyTZCXF2EpvrdJbBcVP0Rm6E0TxGnBzhhzusvEqwDmosvS3W/hd/vRWb92jzjPvcM+0NxkaA3mTig1j5Fdx5BsuJYU9jWNN2ddxE9iwnEr9FImx4pmFYoQpoBhhNfMyXBYrtq6SVFRdJn6lTgkxJUFRvYjPNsn4Xv6zeEKdHmHaEseHrgB78sEHVfGBbvyMvr/Kg2f+Ry9RN7/FDUXJElByEAH1KwGCM1TFcehVyYXgUwVkIslqsS8wWOWbLQiQRW4E+MyMY5y5lasgUdIUZPFFpkvXu8Beb+KCKUXfF8IJGinOnIekuVqXoQUjqzYe0DDXlHv1cpdcF9Wt5R7BYXzT05bDtvbM8pPjUaEOtFEvRLz3CCxthSHZhtJf1nyp78hUG0SyDaI8wfhGGZMWHLAR9aiyNnZ5Ec4JtdWNoqKKUrx1LL7ilQ1B4aXCVJouiC8L9u4A0eCHO2h7klzlKuqpc3Xne+dPZfVO7ixyGpSaFPxMzlCrzy7qCFJ6jx7YhxF6Voh/v8h6ZyV5Q3xq7DRgg2OzboVd/CrzI+ZQxVKPHlYz0+OkzriRFhp+XO3czNPjLTgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/1137c0ba74b4d70ffad6084be4581ad7/24599/r2dbc01.webp 238w,\n/blog/static/1137c0ba74b4d70ffad6084be4581ad7/69f92/r2dbc01.webp 475w,\n/blog/static/1137c0ba74b4d70ffad6084be4581ad7/a400a/r2dbc01.webp 807w\"\n              sizes=\"(max-width: 807px) 100vw, 807px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/1137c0ba74b4d70ffad6084be4581ad7/da2e6/r2dbc01.png 238w,\n/blog/static/1137c0ba74b4d70ffad6084be4581ad7/abae4/r2dbc01.png 475w,\n/blog/static/1137c0ba74b4d70ffad6084be4581ad7/45d60/r2dbc01.png 807w\"\n            sizes=\"(max-width: 807px) 100vw, 807px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/1137c0ba74b4d70ffad6084be4581ad7/45d60/r2dbc01.png\"\n            alt=\"장점\"\n            title=\"장점\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>기존 <code class=\"language-text\">JDBC</code>를 사용하면 블로킹 방식이라 하나의 쿼리가 실행 중이라면 해당 <code class=\"language-text\">request</code>를 처리하는 스레드는 똑같이 블록킹이 걸리게 된다. <code class=\"language-text\">R2DBC</code>없이 <code class=\"language-text\">webflux</code>만 단독으로 사용하여도 이와 같은 이유 때문에 DB레벨에서 다 병목 현상이 발생하므로 <code class=\"language-text\">Webflux</code> 장점을 살릴 수 없게 된다.</p>\n<p>또한 <code class=\"language-text\">R2DBC</code> 장점이 확실 하지만 반대로 단점도 너무나 확실하게 있다. 개발하면서 <code class=\"language-text\">Mono</code>, <code class=\"language-text\">Flux</code>를 계속하여 사용해야하는데 이걸 계속 쓰자니 많이 헤깔리고(물론 익숙하지 않아서 그런것도 있다), 가독성 문제가 가장 크다고 생각한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">  <span class=\"token keyword\">public</span> <span class=\"token class-name\">Mono</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">ServerResponse</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ServerRequest</span> request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token class-name\">Mono</span><span class=\"token punctuation\">.</span><span class=\"token function\">just</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">pathVariable</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"articleIdx\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span><span class=\"token operator\">::</span><span class=\"token function\">parseLong</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span><span class=\"token punctuation\">(</span>articleIdx <span class=\"token operator\">-></span> articleRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findByIdx</span><span class=\"token punctuation\">(</span>articleIdx<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">flatMap</span><span class=\"token punctuation\">(</span>article<span class=\"token operator\">-></span> <span class=\"token class-name\">ServerResponse</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">body</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Mono</span><span class=\"token punctuation\">.</span><span class=\"token function\">just</span><span class=\"token punctuation\">(</span>article<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">Article</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">switchIfEmpty</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ServerResponse</span><span class=\"token punctuation\">.</span><span class=\"token function\">notFound</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>이건 예전에 사용하던 코드 이긴하지만 이런식으로 메소드 체이닝하여 계속 사용하게 되고, 그렇다고 안쓰자니 <code class=\"language-text\">non blocking</code> 코드를 구현 할 수가 없다(<code class=\"language-text\">Webflux</code> 쓰는 장점이 없다).</p>\n<p>또 다른 문제로 <code class=\"language-text\">R2DBC</code>는 <code class=\"language-text\">ORM</code>이 아니다. <code class=\"language-text\">Hibernate</code> 같은 <code class=\"language-text\">ORM</code>에 익숙한 사람이라면 사용하다보면 <code class=\"language-text\">Hibernate</code>와 비교하여 하나씩 하나씩 지원 안해주는 <code class=\"language-text\">R2DBC</code>가 꽤나 불편하게 느껴질 수 있다.</p>\n<h2 id=\"coroutine\" style=\"position:relative;\"><a href=\"#coroutine\" aria-label=\"coroutine permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Coroutine</h2>\n<p>기본적인 여러 작업들을 동시에 처리가 가능하다. 기존에도 <code class=\"language-text\">future(CompletableFuture 같은거)</code>를 쓰거나 멀티 스레드를 사용하면 기본적인 <code class=\"language-text\">non-blocking</code> 프로그래밍이 가능하지만 내부적으로 별도의 스레드 풀을 구성하여 리소스 문제나 막상 코드를 보면 어쩔수 없는 callback 등을 남발하기도 하고, 이런 코드들을 기존의 다른 코드와 연결 지으며 코딩하다보면 가독성이 매우매우 떨어지게 된다. 하지만 코루틴을 사용하면 기존 코딩 스타일로도 <code class=\"language-text\">non-blocking</code>하게 개발이 가능하며, 이는 내부적으로 하나의 스레드로 동작(일반적으로)하지만 <code class=\"language-text\">continuation</code>이라는 처리 후 복귀 지점을 내부적으로 관리하여 각 <code class=\"language-text\">suspend</code> 함수는 종료 후 어디로 복귀하여 처리하는지를 알고 있다.</p>\n<blockquote>\n<p>즉 하나의 스레드로 여러 작업을 처리 하고 <code class=\"language-text\">continuation</code>을 통해 절차지향 적인 코드로도 비동기 처리가 가능하게 된다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\">\n<span class=\"token keyword\">fun</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span>args<span class=\"token operator\">:</span> Array<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token function\">callWithDelay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">fun</span> <span class=\"token function\">callWithDelay</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> runBlocking <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">val</span> runningSeconds <span class=\"token operator\">=</span> measureTimeMillis <span class=\"token punctuation\">{</span>\n\n        <span class=\"token comment\">//1초 + 1초 + 1초 -> 1.x초</span>\n        <span class=\"token keyword\">val</span> deffer1 <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span> <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">val</span> deffer2 <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span> <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">val</span> deffer3 <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span> <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">awaitAll</span><span class=\"token punctuation\">(</span>deffer1<span class=\"token punctuation\">,</span> deffer2<span class=\"token punctuation\">,</span> deffer3<span class=\"token punctuation\">)</span>\n\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">toDuration</span><span class=\"token punctuation\">(</span>DurationUnit<span class=\"token punctuation\">.</span>MILLISECONDS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toDouble</span><span class=\"token punctuation\">(</span>DurationUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">println</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"delay 걸린 시간 </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">runningSeconds</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">//delay 걸린 시간 1.017</span></code></pre></div>\n<p>이런방식으로 <code class=\"language-text\">R2DBC</code> + <code class=\"language-text\">Coroutine</code>조합을 사용하여 쿼리들을 요청하면 결과적으로 <strong>실행 시간 단축. 즉, 전체 처리 시간이 빨라 질 것</strong>이라 기대했다.</p>\n<h2 id=\"r2dbc--coroutine\" style=\"position:relative;\"><a href=\"#r2dbc--coroutine\" aria-label=\"r2dbc  coroutine permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>R2DBC + Coroutine</h2>\n<p>여러 쿼리를 병렬로 실행하여 시간단축이 가능한지를 테스트 해보려고 일단 쿼리 수준에서 강제로 <code class=\"language-text\">slow query</code>를 만들어 여러번 요청 하도록 만들었다. <code class=\"language-text\">slow query</code>는 아래와 같이 대략적인 걸린 시간 값을 예상 할 수 있게 만들었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">FROM</span> article <span class=\"token keyword\">LIMIT</span> <span class=\"token number\">5</span></code></pre></div>\n<blockquote>\n<p>그냥 <code class=\"language-text\">SELECT sleep(5)</code> 로도 충분하지만 혹시 내가 모르는 상황이 있을까 table을 끼고 조회하였다.</p>\n</blockquote>\n<p><strong>kotlin 코드</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Repository</span>\n<span class=\"token keyword\">interface</span> ArticleRepository <span class=\"token operator\">:</span> CoroutineCrudRepository<span class=\"token operator\">&lt;</span>Article<span class=\"token punctuation\">,</span> Long<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation builtin\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"SELECT sleep(1) FROM Article article LIMIT 5\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">blockingFor5Sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> List<span class=\"token operator\">&lt;</span>Int<span class=\"token operator\">></span>\n\n    <span class=\"token annotation builtin\">@Query</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"SELECT sleep(1) FROM Article article LIMIT :seconds\"</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">blockingFor</span><span class=\"token punctuation\">(</span>seconds<span class=\"token operator\">:</span> Int<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> List<span class=\"token operator\">&lt;</span>Int<span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Service</span>\n<span class=\"token annotation builtin\">@Transactional</span><span class=\"token punctuation\">(</span>readOnly <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token function\">ArticleService</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> articleRepository<span class=\"token operator\">:</span> ArticleRepository<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">val</span> log <span class=\"token operator\">=</span> KotlinLogging<span class=\"token punctuation\">.</span><span class=\"token function\">logger</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">callQueries</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> coroutineScope <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">val</span> runningSeconds <span class=\"token operator\">=</span> measureTimeMillis <span class=\"token punctuation\">{</span>\n\n            <span class=\"token keyword\">val</span> deffer1 <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span> articleRepository<span class=\"token punctuation\">.</span><span class=\"token function\">blockingFor5Sec</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">val</span> deffer2 <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span> articleRepository<span class=\"token punctuation\">.</span><span class=\"token function\">blockingFor</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\n            <span class=\"token function\">awaitAll</span><span class=\"token punctuation\">(</span>deffer1<span class=\"token punctuation\">,</span> deffer2<span class=\"token punctuation\">)</span>\n\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">toDuration</span><span class=\"token punctuation\">(</span>DurationUnit<span class=\"token punctuation\">.</span>MILLISECONDS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toDouble</span><span class=\"token punctuation\">(</span>DurationUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">)</span>\n\n        log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"running time </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">runningSeconds</span></span><span class=\"token string\"> 초\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//약 8초???</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>해당 함수를 호출하면 아와 같은 에러가 발생한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">org.springframework.r2dbc.UncategorizedR2dbcException: executeMany; SQL [SELECT sleep(1) FROM Article article LIMIT ?]; Unknown exception\n\tat org.springframework.r2dbc.connection.ConnectionFactoryUtils.convertR2dbcException(ConnectionFactoryUtils.java:246) ~[spring-r2dbc-6.0.4.jar:6.0.4]\n\tSuppressed: reactor.core.publisher.FluxOnAssembly$OnAssemblyException:\n...\n...\n...</code></pre></div>\n<h4 id=\"발생-이유\" style=\"position:relative;\"><a href=\"#%EB%B0%9C%EC%83%9D-%EC%9D%B4%EC%9C%A0\" aria-label=\"발생 이유 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>발생 이유</h4>\n<p>에러메세지 첫 줄에서도 볼 수 있듯이, ‘executeMany’ 때문에 에러가 발생 한 것이다. 기존 쿼리가 종료 되기 전, 다른 쿼리를 요청하여 발생한 것인데 하나의 트랜잭션 내에서 여러 쿼리를 요청 할 수가 없다.</p>\n<p>조금 더 풀어서 설명하자면 같은 트랜잭션에서 여러 <code class=\"language-text\">connection</code>을 사용 한다던지, 아님 하나의 <code class=\"language-text\">connection</code>으로 여러 쿼리를 요청 한다던지 하는 것은 불가능 하다. 그게 <code class=\"language-text\">read only</code>트랜잭션 일지라도 똑같이 적용 된다.</p>\n<blockquote>\n<p>사실 가능하긴 하지만 트랜잭션 처리 속도가 떨어져서 일반적으로 사용을 안하게 된다.</p>\n</blockquote>\n<p><code class=\"language-text\">R2DBC</code>는 이런 한계를 개선 한 기술은 아닌것이다. <code class=\"language-text\">R2DBC</code>는 <code class=\"language-text\">pub/sub</code> 기반으로 구현되어, 비동기로 DB와 통신하고 결과를 응답 받을 수 있게 만들어 놓은걸로, DB에서 결과를 받을 때 까지 어플리케이션에서 스레드를 다른곳에서 사용할 수 있도록 만들어 놓은 정도로 이해하면 된다. 감이 잘 안잡힌다면 동시성과 병렬성의 차이를 이해하고 <code class=\"language-text\">R2DBC</code>는 동시성에 집중 되어 있다고 생각하면 된다.</p>\n<blockquote>\n<p><code class=\"language-text\">R2DBC</code>를 공부하다보면 동시성과 연관지어 설명하는 글은 많아도 병렬성에 대한 말은 없다. 이는 <code class=\"language-text\">R2DBC</code>는 동시성에 초점을 두었기 때문이다.</p>\n</blockquote>\n<p>또한 DB 물리적인 트랜잭션이 나누어 있거나 적용 되어있지 않은거(외부 api통신 등)라면 <code class=\"language-text\">coroutine</code>의 <code class=\"language-text\">async</code>등을 사용하여 동시에 처리가 가능하다</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">maybe8Seconds</span><span class=\"token punctuation\">(</span>request<span class=\"token operator\">:</span> ServerRequest<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ServerResponse <span class=\"token operator\">=</span> coroutineScope <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">val</span> runningSeconds <span class=\"token operator\">=</span> measureTimeMillis <span class=\"token punctuation\">{</span>\n\n        <span class=\"token keyword\">val</span> deffer1 <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span> articleService<span class=\"token punctuation\">.</span><span class=\"token function\">maybe5Seconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">val</span> deffer2 <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span> articleService<span class=\"token punctuation\">.</span><span class=\"token function\">maybe8Seconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">awaitAll</span><span class=\"token punctuation\">(</span>deffer1<span class=\"token punctuation\">,</span> deffer2<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">toDuration</span><span class=\"token punctuation\">(</span>DurationUnit<span class=\"token punctuation\">.</span>MILLISECONDS<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toDouble</span><span class=\"token punctuation\">(</span>DurationUnit<span class=\"token punctuation\">.</span>SECONDS<span class=\"token punctuation\">)</span>\n\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"running time </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">runningSeconds</span></span><span class=\"token string\"> 초\"</span></span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//전체 걸린 시간 8.x초</span>\n\n    ServerResponse<span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">buildAndAwait</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>분리 된 트랜잭션으로 처리해도 괜찮다면 이런식으로 사용이 가능하다. 물론 하나의 트랜잭션 내에선 <code class=\"language-text\">R2DBC</code>를 사용 하더라도 쿼리 요청 관련해선 순차적으로 잘 실행 되니까 문제 될 것은 없다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@Transactional</span><span class=\"token punctuation\">(</span>readOnly <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">maybe8Seconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> coroutineScope<span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">val</span> queryDeffer <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//아래 쿼리 2개는 순서대로 잘 처리 된다.</span>\n        articleRepository<span class=\"token punctuation\">.</span><span class=\"token function\">blockingFor</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n        articleRepository<span class=\"token punctuation\">.</span><span class=\"token function\">blockingFor</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">val</span> delayDeffer <span class=\"token operator\">=</span> async <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span>\n        <span class=\"token function\">delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000L</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token function\">awaitAll</span><span class=\"token punctuation\">(</span>queryDeffer<span class=\"token punctuation\">,</span> delayDeffer<span class=\"token punctuation\">)</span> <span class=\"token comment\">//약 8.x초가 걸린다.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>대략적으로 10초가 아닌 8초가 걸리는 이유는 <code class=\"language-text\">queryDeffer</code>가 실행 되면서 다른 작업(<code class=\"language-text\">delayDeffer</code>)도 처리가 가능하여 8초가 걸리게 된다.</p>\n<hr>\n<p><code class=\"language-text\">Webflux</code> + <code class=\"language-text\">Coroutine</code>을 사용하다보면 <code class=\"language-text\">non-blocking</code>을 지원해주는 라이브러리만 쓰면 사용하는데 큰 무리가 없지만 막상 개발하다보면 그렇지 않은 케이스가 너무나 많다. 무조건 <code class=\"language-text\">Coroutine</code>만 사용한다고 항상 최고의 퍼포먼스를 보여주는것도 아니고, 똑같이 <code class=\"language-text\">blocking</code> 되는 상황을 피해야 그 효과가 좋다. 문제는 <code class=\"language-text\">Reactive</code>형태로 지원하지 않는 코드를 가져다 쓸 때 <code class=\"language-text\">blocking</code>되는 상황이 만들어지면 별도의 <code class=\"language-text\">Coroutine Scope</code>를 만들어야 할 수도 있고, 작업에따라 어떠한 <code class=\"language-text\">Dispatcher</code>를 사용해야 할지 고민이 될 수도 있다. 또한 이런 <code class=\"language-text\">scope</code>를 만들다 보면 에러 발생 시 처리 정책(<code class=\"language-text\">SupervisorJob</code> 같은거) 등도 고민 해봐야 할 것이다.</p>\n<p>하고 싶은 말은 코드만 봐선 쉬워보이는데 개발하다 보면 이것 또한 쉽지는 않다는 생각이 많이 들었다.</p>","fields":{"slug":"/posts/spring/spring-r2dbc-coroutine/","tagSlugs":["/tag/spring/","/tag/coroutine/","/tag/r2dbc/","/tag/webflux/"]},"frontmatter":{"date":"2023-04-27T00:41:44.806Z","description":"R2DBC & Coroutine 조합의 기본 소개 및 장점, 주의사항","tags":["spring","coroutine","r2dbc","webflux"],"title":"R2DBC 좋은 이유 및 주의 사항","socialImage":null}}},"pageContext":{"slug":"/posts/spring/spring-r2dbc-coroutine/"}},"staticQueryHashes":["251939775","2839666046","2891173899","401334301"]}