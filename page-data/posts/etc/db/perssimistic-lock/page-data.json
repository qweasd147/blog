{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/etc/db/perssimistic-lock/","result":{"data":{"markdownRemark":{"id":"8b4a4a22-8318-58d6-974e-2bc911df252f","html":"<h2 id=\"1-lock\" style=\"position:relative;\"><a href=\"#1-lock\" aria-label=\"1 lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Lock</h2>\n<p>Lock이란 같은 데이터를 동시에 필요로 할때 미리 데이터를 선점하여 동시에 읽기/쓰기를 방지하기 위해 사용된다. <code class=\"language-text\">Mysql</code>에서 Lock은 크게 <code class=\"language-text\">Mysql 엔진 레벨</code>과 <code class=\"language-text\">스토리지 엔진 레벨</code>로 나눌 수 있고, 이런 Lock 들은 목적에 따라 <code class=\"language-text\">Shared Lock</code> 또는 <code class=\"language-text\">Exclusive Lock</code> 이라고 하는 추가적인 특성을 가질 수 있다. 이러한 <code class=\"language-text\">Shared Lock</code>과 <code class=\"language-text\">Exclusive Lock</code> 두 Lock은 <code class=\"language-text\">비관적 락 (Perssimistic Lock)</code> 이라고도 한다.</p>\n<blockquote>\n<p>Perssimistic Lock은 물리적으로 리소스가 충돌이 이루어 질 경우가 많을 것이라 생각되어, 이에 대비해서 특정 리소스(일반적으로 테이블의 레코드라 생각하면 된다)에 정말 물리적인 Lock을 거는것을 말한다.</p>\n</blockquote>\n<p>Lock 전체를 나열한건 아니지만 대략적으로 Lock 종류는 아래와 같이 나눠진다. <code class=\"language-text\">Perssimistic Lock</code>은 이러한 Lock 종류 중에 Lock 거는 속성 정도 라고 생각하면 된다.</p>\n<h3 id=\"11-스토리지-엔진-레벨innodb\" style=\"position:relative;\"><a href=\"#11-%EC%8A%A4%ED%86%A0%EB%A6%AC%EC%A7%80-%EC%97%94%EC%A7%84-%EB%A0%88%EB%B2%A8innodb\" aria-label=\"11 스토리지 엔진 레벨innodb permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 스토리지 엔진 레벨(InnoDB)</h3>\n<ul>\n<li>레코드 락(Record Lock)</li>\n<li>갭락(Gap Lock)</li>\n</ul>\n<h3 id=\"12-mysql-엔진-레벨\" style=\"position:relative;\"><a href=\"#12-mysql-%EC%97%94%EC%A7%84-%EB%A0%88%EB%B2%A8\" aria-label=\"12 mysql 엔진 레벨 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.2 Mysql 엔진 레벨</h3>\n<ul>\n<li>글로벌 락(Global Lock)</li>\n<li>테이블 락(Table Lock)</li>\n<li>네임드 락(Named Lock)</li>\n<li>메타데이터 락(Metadata Lock)</li>\n</ul>\n<p>이름만 봐도 Lock을 거는 대상이 어느것인지 예측이 가능할꺼라 생각 된다. 기억해야 할 사항으로는 <code class=\"language-text\">Mysql엔진 레벨</code>의 Lock은 모든 <code class=\"language-text\">스토리지 엔진 레벨</code>의 Lock에 영향을 주고, <code class=\"language-text\">스토리지 엔진 레벨</code>의 Lock은 다른 스토리지 엔진에 영향이 없다는 점이다.</p>\n<blockquote>\n<p>레코드 락은 <code class=\"language-text\">Shared/Exclusive Lock</code> 둘 다 사용 가능하지만 Gap Lock 같은 경우엔 항상 <code class=\"language-text\">Shared Lock</code>이 걸린다. 여기서 하고 싶은 말은 위에서 나열한 Lock과 <code class=\"language-text\">Perssimistic Lock</code>은 다르게 생각해야 한다는 점이다.</p>\n</blockquote>\n<p>개발자가 어플리케이션을 개발할 땐 레코드 락을 자주 사용하게 된다. 그래서 아래 나올 설명/예시 들은 항상 레코드를 대상으로 거는 레코드 락이 대부분이다.</p>\n<h2 id=\"2-exclusive-lock\" style=\"position:relative;\"><a href=\"#2-exclusive-lock\" aria-label=\"2 exclusive lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Exclusive Lock</h2>\n<p><code class=\"language-text\">쓰기 락</code>이라고도 하는데 동일한 자원에서 읽기/쓰기 행위를 막는데 사용된다. 아래 이미지는 <code class=\"language-text\">for update</code>를 써서 <code class=\"language-text\">Perssimistic Lock</code>걸었을 때 상황을 설명한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 950px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/736561bb6115c026ea9b74bfd0b37481/95b97/img_perssimistic-lock-insert.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.050420168067223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAzUlEQVQY01WQSw7DIAxEc48abPMxBBK1idT7H20qSFWliydYDGb8FlWFWEbYGmKrYHHw7CfOjTtPmBmSM7Q1hG2DxABHNDN3FlFF2A/YviMeB8K+QZThxcPRFSIizI9FwF+E/cyJyh9LjBGaMmJKUDNoqRBh8I0xNOeE+nyhnwfW84X6PlF6gTWDVYOtF0vrK/rxRN0LrKaLEWrfULPZTkezaAjJZgEuHZ4F9CAQXVsMFu+HL8U4fy7o3ws5hzCGpgIOEY4e058fjsf7Gx8jXotpcG+IrQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/736561bb6115c026ea9b74bfd0b37481/24599/img_perssimistic-lock-insert.webp 238w,\n/blog/static/736561bb6115c026ea9b74bfd0b37481/69f92/img_perssimistic-lock-insert.webp 475w,\n/blog/static/736561bb6115c026ea9b74bfd0b37481/cebde/img_perssimistic-lock-insert.webp 950w,\n/blog/static/736561bb6115c026ea9b74bfd0b37481/e017b/img_perssimistic-lock-insert.webp 1283w\"\n              sizes=\"(max-width: 950px) 100vw, 950px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/736561bb6115c026ea9b74bfd0b37481/da2e6/img_perssimistic-lock-insert.png 238w,\n/blog/static/736561bb6115c026ea9b74bfd0b37481/abae4/img_perssimistic-lock-insert.png 475w,\n/blog/static/736561bb6115c026ea9b74bfd0b37481/68327/img_perssimistic-lock-insert.png 950w,\n/blog/static/736561bb6115c026ea9b74bfd0b37481/95b97/img_perssimistic-lock-insert.png 1283w\"\n            sizes=\"(max-width: 950px) 100vw, 950px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/736561bb6115c026ea9b74bfd0b37481/68327/img_perssimistic-lock-insert.png\"\n            alt=\"perssimistic-lock\"\n            title=\"perssimistic-lock\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<ul>\n<li>#1, #2 <code class=\"language-text\">트랜잭션1</code>, <code class=\"language-text\">트랜잭션2</code> 시작</li>\n<li>#3 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">idx=1</code>인 데이터 <code class=\"language-text\">Perssimistic Lock</code> 걸고 조회</li>\n<li>#4 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터를 <code class=\"language-text\">Perssimistic Lock</code> 걸고 시도 -> waiting</li>\n<li>#5 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">commit</code>을 해야 <code class=\"language-text\">트랜잭션2</code>에서 waiting이 풀리고 출력</li>\n</ul>\n<p>참고로 <code class=\"language-text\">트랜잭션2</code>에서 밑에서 설명할 Shared Lock으로 시도해도 <code class=\"language-text\">트랜잭션1</code>이 종료 될 때까지 대기가 걸린다.</p>\n<blockquote>\n<p>위의 예제로써 <code class=\"language-text\">for update</code>를 쓰긴 했지만 update, delete도 똑같이 쓰기 행위이므로 다 <code class=\"language-text\">Exclusive Lock</code>이 걸린다</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 950px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/678f5333e153eecd63617866d2b8bceb/95b97/img_perssimistic-lock-update.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.050420168067223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAyUlEQVQY012QW27DMAwEfRCLpCRSgtPETv2T+59sCtlGk/ZjsADB1+7UeqetG23faduGd8ebU2s9cHfMDFPFaqCxYO2GqpHmREp/mXwMPb65v158bXd6OLlksmVyPhGRY6lmvRC0Glb04LdelGk0ziIUD2otqCkiiSQJ0VPnlDBT8u1xuPF1JT+faDHERp8gdjJVr+RlofaMlnFZMTdsfHDpsNJbp7VOuBMRRDTC44jkk2nYETtt/c/jk1oy8dipyx2VdOZqeumbH1kMi2nZ5wl9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/678f5333e153eecd63617866d2b8bceb/24599/img_perssimistic-lock-update.webp 238w,\n/blog/static/678f5333e153eecd63617866d2b8bceb/69f92/img_perssimistic-lock-update.webp 475w,\n/blog/static/678f5333e153eecd63617866d2b8bceb/cebde/img_perssimistic-lock-update.webp 950w,\n/blog/static/678f5333e153eecd63617866d2b8bceb/e017b/img_perssimistic-lock-update.webp 1283w\"\n              sizes=\"(max-width: 950px) 100vw, 950px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/678f5333e153eecd63617866d2b8bceb/da2e6/img_perssimistic-lock-update.png 238w,\n/blog/static/678f5333e153eecd63617866d2b8bceb/abae4/img_perssimistic-lock-update.png 475w,\n/blog/static/678f5333e153eecd63617866d2b8bceb/68327/img_perssimistic-lock-update.png 950w,\n/blog/static/678f5333e153eecd63617866d2b8bceb/95b97/img_perssimistic-lock-update.png 1283w\"\n            sizes=\"(max-width: 950px) 100vw, 950px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/678f5333e153eecd63617866d2b8bceb/68327/img_perssimistic-lock-update.png\"\n            alt=\"perssimistic-lock\"\n            title=\"perssimistic-lock\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2 id=\"3-shared-lock\" style=\"position:relative;\"><a href=\"#3-shared-lock\" aria-label=\"3 shared lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. Shared Lock</h2>\n<p><code class=\"language-text\">읽기 락</code> 이라고도 하는데, 동일한 자원을 여러 곳에서 읽는 행위는 허용하는 Lock이다. Lock이라고 무조건 모든 행위를 막아버리면 병목이 심해 질 수 있으므로, 이러한 상황을 방지하기 위해 <code class=\"language-text\">Shared Lock</code>을 쓰면 다른곳에서 동일한 리소스를 읽기는 허용 되어도, 쓰기는 불가능하도록 막기 위해 사용된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 950px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/4423c/img_shared-lock01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.49579831932773%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABU0lEQVQoz12SSZLDIAxFfZKYSUzGhjixk9z/YK8L3Fl0L159ppK+JCbvhbCu5HujvA6WR0OCw2iDdRbnBREhlIW8N8r7YH09CIvHGIu1f5mcs9jgkSUhZUFKxAYz0FYz32acc2ht0UbQpgcS1Kwu1F9GwHg/qeeH9bGTXif5/cY6g9LXo+5QGz0SGPfFYMUM1Uqj9cU0Hmsz7Jtx2NduXH4diDgkJWLdiK0Q9pXwWEl7Y6kZHwSl5sHkved2uzHP84W6tAf6aggBSZnUGrGuhL0Sj0psO6UV0pZxaUVCZso5jx6Jk6H/6U774Hqffcmjx7IlpPaeZ0IJxBrw24LkxNRaI+fIUhJlK78sQ3syYwy1bdR9pz0O2vOgvV+0z8n99eF5PNmfO+18cz8/TD44ZKvEe8OIwkaDCXrQJ9xLjiHg00qqT4xWGKUvtBoV9C9m9LX/Af+z6F1jvkoSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/24599/img_shared-lock01.webp 238w,\n/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/69f92/img_shared-lock01.webp 475w,\n/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/cebde/img_shared-lock01.webp 950w,\n/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/57ca4/img_shared-lock01.webp 1036w\"\n              sizes=\"(max-width: 950px) 100vw, 950px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/da2e6/img_shared-lock01.png 238w,\n/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/abae4/img_shared-lock01.png 475w,\n/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/68327/img_shared-lock01.png 950w,\n/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/4423c/img_shared-lock01.png 1036w\"\n            sizes=\"(max-width: 950px) 100vw, 950px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/6678b0ca9abae5bebfbaa3999e0cb551/68327/img_shared-lock01.png\"\n            alt=\"perssimistic-lock\"\n            title=\"perssimistic-lock\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<ul>\n<li>#1, #2 <code class=\"language-text\">트랜잭션1</code>, <code class=\"language-text\">트랜잭션2</code> 시작</li>\n<li>#3 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">idx=1</code>인 데이터 <code class=\"language-text\">Shared Lock</code> 걸고 조회</li>\n<li>#4 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터를 <code class=\"language-text\">Lock</code> 없이 조회 시도 -> 바로 출력</li>\n<li>#5 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터를 <code class=\"language-text\">Shared Lock</code>으로 조회 시도 -> 바로 출력</li>\n<li>#6 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터를 <code class=\"language-text\">Exclusive Lock</code>으로 조회 시도 -> waiting</li>\n<li>#7 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">commit</code>을 해야 <code class=\"language-text\">트랜잭션2</code>에서 <code class=\"language-text\">Exclusive Lock</code> waiting이 종료 되고 출력</li>\n</ul>\n<blockquote>\n<p>Shared Lock은 일단 Lock을 걸어도 다른곳에서 <code class=\"language-text\">Shared Lock</code>을 사용해도 읽기는 가능하다는 점에서 Exclusive Lock 보다 병목 현상이 줄어든다</p>\n</blockquote>\n<p>추가로 아래 표는 <code class=\"language-text\">Shared Lock</code> 과 <code class=\"language-text\">Exclusive Lock</code> 관계를 보여주는데 동일한 리소스에 어떤 Lock에 걸려있는지에 따라 <code class=\"language-text\">Conflict</code>가 나는지, <code class=\"language-text\">Compatible</code>가 되는지 보여준다.</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>X</th>\n<th>S</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>X</td>\n<td>Conflict</td>\n<td>Conflict</td>\n</tr>\n<tr>\n<td>S</td>\n<td>Conflict</td>\n<td>Compatible</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p><code class=\"language-text\">Exclusive Lock</code>은 <code class=\"language-text\">X</code>, <code class=\"language-text\">Shared Lock</code>은 <code class=\"language-text\">S</code>로 표현하였는데 mysql 8.0 이상을 기준으로 <code class=\"language-text\">performance_schema.data_locks</code>테이블을 살펴보면 해당 락을 이렇게 표현한다. 이 테이블은 나중에 추가로 분석 예정</p>\n</blockquote>\n<h2 id=\"4-gap-lock-next-key-lock\" style=\"position:relative;\"><a href=\"#4-gap-lock-next-key-lock\" aria-label=\"4 gap lock next key lock permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. Gap Lock, Next Key Lock</h2>\n<p>트랜잭션 <code class=\"language-text\">Isolation</code>을 쓸 때 잠깐 설명한 적이 있는데 <code class=\"language-text\">Mysql</code>에선 이런 <code class=\"language-text\">Next Key Lock</code>을 통해 <code class=\"language-text\">Phantom Read</code>를 방지한다고 하였다. <code class=\"language-text\">Gap Lock</code>은 단독으로 사용되지 않고 <code class=\"language-text\">Next Key Lock</code>과 함께 사용되는 것인데 <code class=\"language-text\">Gap Lock</code>은 범위를 통한 <code class=\"language-text\">Lock</code>을 걸었을 때 레코드에 빈 데이터가 있으면 중간 <code class=\"language-text\">Gap</code>에 Lock을 걸어버리는걸 의미한다. <code class=\"language-text\">Next Key Lock</code>은 <code class=\"language-text\">Gap Lock</code> + 레코드 락이 합쳐진 락이라고 이해하면 된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 950px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/e7189a27b29834ec01b6e3527c882902/e5cc9/img_gap-lock.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.016806722689076%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABRUlEQVQoz43R62rjMBCGYd9HHJ/lyDrZ8jnNJmkbkqXt373/W3mXqEtpKQv98TCDQMMMX1RIidCauvWUsiZJtiRJ8iHLc9IsI88ySqmojKXu+vAnzRLSNP0ialqP6Hp2TiF1TVkKsiz7Js9zkm3C9ovtN1F7fEVe/iDnJ7Rtsd1IVZZUVfWhKIrg8+b/Ex2OZw6nC+vyQN9PrOsD4zjRth3OOXznQ38fGMebd5tP4g2bOCb+JzqeH3l5e+P5+pvL9cbhdObX6ZHn643byyvnp0t4E1XFTlv0MKBHj5o6zDRgfIvzNlBaERljkFIyzQvruqfve5RSzPPMfr8PdV4Wmqah0Q5lO5RrUe2992jrsMZg9bvIWoMQgnEcg/sAay3ee4ZxZFkWhnEKCf7o5J1zKG8QSgS1FtSmDkQjyPMipPyTQO6h/AVPv+sJWTdGxAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/e7189a27b29834ec01b6e3527c882902/24599/img_gap-lock.webp 238w,\n/blog/static/e7189a27b29834ec01b6e3527c882902/69f92/img_gap-lock.webp 475w,\n/blog/static/e7189a27b29834ec01b6e3527c882902/cebde/img_gap-lock.webp 950w,\n/blog/static/e7189a27b29834ec01b6e3527c882902/1de89/img_gap-lock.webp 1058w\"\n              sizes=\"(max-width: 950px) 100vw, 950px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/e7189a27b29834ec01b6e3527c882902/da2e6/img_gap-lock.png 238w,\n/blog/static/e7189a27b29834ec01b6e3527c882902/abae4/img_gap-lock.png 475w,\n/blog/static/e7189a27b29834ec01b6e3527c882902/68327/img_gap-lock.png 950w,\n/blog/static/e7189a27b29834ec01b6e3527c882902/e5cc9/img_gap-lock.png 1058w\"\n            sizes=\"(max-width: 950px) 100vw, 950px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/e7189a27b29834ec01b6e3527c882902/68327/img_gap-lock.png\"\n            alt=\"perssimistic-lock\"\n            title=\"perssimistic-lock\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<ul>\n<li>#1, #2 <code class=\"language-text\">트랜잭션1</code>, <code class=\"language-text\">트랜잭션2</code> 시작</li>\n<li>#3 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">idx</code>값이 4~8인 레코드들을 <code class=\"language-text\">select ... for update</code>를 통한 조회</li>\n<li>#4 <code class=\"language-text\">트랜잭션2</code>에서 <code class=\"language-text\">idx</code> 값이 5인 레코드 입력을 시도하지만 바로 처리가 안되고 대기 상태가 된다\n<blockquote>\n<p>물리적으로 진짜 존재하는 4,6,8은 <code class=\"language-text\">record lock</code>, 중간중간 값이 없는 5,7은 <code class=\"language-text\">gap lock</code>이 걸린다.</p>\n</blockquote>\n</li>\n<li>#5 <code class=\"language-text\">트랜잭션1</code>에서 commit을 해야 <code class=\"language-text\">#4</code>의 대기상태가 풀리고 처리된다.</li>\n</ul>\n<p>추가로 <code class=\"language-text\">gap lock</code>은 <code class=\"language-text\">쓰기 lock</code>이라고 이해 해야한다. <code class=\"language-text\">select ... for update</code>을 통해 5,7인 가상의 값들은 <code class=\"language-text\">gap lock</code>이 걸렸지만 <code class=\"language-text\">select</code>는 가능하다(출력되는건 당연히 없지만). <code class=\"language-text\">gap lock</code>은 insert를 방지하여 하나의 transaction내에서 동일한 결과, 즉 <code class=\"language-text\">Repeatable Read</code>를 보장한다.</p>\n<h2 id=\"6-lock-주의사항\" style=\"position:relative;\"><a href=\"#6-lock-%EC%A3%BC%EC%9D%98%EC%82%AC%ED%95%AD\" aria-label=\"6 lock 주의사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>6. Lock 주의사항</h2>\n<p>굉장히 중요한 얘기를 짧게 설명하자면 <code class=\"language-text\">Lock</code>은 항상 <code class=\"language-text\">index</code>를 대상으로 Lock이 걸린다는 점이다.</p>\n<p>현재 테스트 대상으로 위와 같이 셋팅 된 <code class=\"language-text\">article</code> 테이블이 있고 <code class=\"language-text\">idx</code>만 PK로 지정되어 있다고 가정</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">| idx | title           | contents           |\n| --- | --------------- | ------------------ |\n| 2   | article 2 title | article 2 contents |\n| 3   | article 3 title | article 3 contents |\n| 4   | article 4 title | article 4 contents |\n| 6   | article 6       | article content 6  |\n| 7   | article 7       | article content 7  |\n| 10  | article 10      | article10          |\n| 12  | article 6       | article content 6  |</code></pre></div>\n<p>이런 상태에서 <code class=\"language-text\">title</code> 컬럼을 기준으로 Lock을 걸고, <code class=\"language-text\">performance_schema.data_locks</code>테이블을 조회하면 아래와 같이 나온다</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\"># 1. title로 특정 row Locking</span>\n<span class=\"token keyword\">select</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">from</span> article\n<span class=\"token keyword\">where</span> title <span class=\"token operator\">=</span> <span class=\"token string\">'article 3 title'</span> <span class=\"token keyword\">for</span> <span class=\"token keyword\">update</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\"># 2. 현재 Lock Data 확인</span>\n<span class=\"token keyword\">select</span> OBJECT_NAME<span class=\"token punctuation\">,</span> INDEX_NAME<span class=\"token punctuation\">,</span> LOCK_TYPE<span class=\"token punctuation\">,</span> LOCK_DATA <span class=\"token keyword\">from</span> performance_schema<span class=\"token punctuation\">.</span>data_locks<span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"출력된-lock-data\" style=\"position:relative;\"><a href=\"#%EC%B6%9C%EB%A0%A5%EB%90%9C-lock-data\" aria-label=\"출력된 lock data permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>출력된 Lock Data</h3>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">| OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_DATA              |\n| ----------- | ---------- | --------- | ---------------------- |\n| article     | &lt;null>     | TABLE     | &lt;null>                 |\n| article     | PRIMARY    | RECORD    | supremum pseudo-record |\n| article     | PRIMARY    | RECORD    | 2                      |\n| article     | PRIMARY    | RECORD    | 3                      |\n| article     | PRIMARY    | RECORD    | 4                      |\n| article     | PRIMARY    | RECORD    | 12                     |\n| article     | PRIMARY    | RECORD    | 6                      |\n| article     | PRIMARY    | RECORD    | 7                      |\n| article     | PRIMARY    | RECORD    | 10                     |</code></pre></div>\n<p>결과를 보면 idx값이 2~14인 모든 레코드 들이 Lock이 걸린것을 확인 할수 있다.</p>\n<blockquote>\n<p><code class=\"language-text\">INDEX_NAME</code>이 <code class=\"language-text\">PRIMARY</code> -> PK기반으로 Lock이 걸림 -> LOCK_DATA가 PK값을 의미한다.</p>\n</blockquote>\n<blockquote>\n<p><code class=\"language-text\">LOCK_TYPE</code>이 <code class=\"language-text\">Table</code>인 <code class=\"language-text\">Lock</code>은 <code class=\"language-text\">Intention Locks</code>이라고 하여 <code class=\"language-text\">Table</code> 레벨에 Lock을 걸어버린다. 다른 트랜잭션에서 Lock을 확인하기 위해 사용되는데 일단 성능 최적화 정도로 이해하면 된다</p>\n</blockquote>\n<blockquote>\n<p><code class=\"language-text\">LOCK_DATA</code>가 <code class=\"language-text\">supremum pseudo-record</code>인 Lock은 이것으로 인해 Mysql에서 <code class=\"language-text\">Phantom Read</code>를 방지한다.</p>\n</blockquote>\n<p>이런이유로 Index가 걸리지 않은 컬럼을 Lock을 거는건 지양해야하고, Index가 걸린 컬럼이라도 <code class=\"language-text\">Unique Index</code>가 아니라면 또는 <code class=\"language-text\">Where</code> 조건에 따라 <code class=\"language-text\">Gap Lock</code>이 걸릴수도 있다는걸 같이 기억 해야한다. 혹시나마 lock을 걸고 싶으면 차라리 검색 후, pk(또는 unique index)기반으로 lock을 걸어야 원하는 record만 lock이 걸리도록 유도해야한다.</p>","fields":{"slug":"/posts/etc/db/perssimistic-lock/","tagSlugs":["/tag/rds/","/tag/db/","/tag/mysql/"]},"frontmatter":{"date":"2022-09-23T01:49:22.280Z","description":"Mysql에서 데이터 충돌을 대비하여 직접적인 Lock을 걸고 싶을 때(Perssimistic Lock)","tags":["rds","db","mysql"],"title":"Mysql - 비관적 락","socialImage":null}}},"pageContext":{"slug":"/posts/etc/db/perssimistic-lock/"}},"staticQueryHashes":["1828819329","251939775","401334301"]}