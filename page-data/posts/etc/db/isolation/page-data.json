{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/etc/db/isolation/","result":{"data":{"markdownRemark":{"id":"72c74c08-b3d3-59c3-9962-12781b2fe0c9","html":"<h2 id=\"isolation\" style=\"position:relative;\"><a href=\"#isolation\" aria-label=\"isolation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Isolation</h2>\n<p><code class=\"language-text\">isolation</code>은 트랜잭션 간의 격리 수준을 말한다. <code class=\"language-text\">lock</code>이랑 많이 헤깔릴 수도 있는데 <code class=\"language-text\">lock</code>은 특정 데이터를 대상으로 <code class=\"language-text\">lock</code>을 걸어 읽기 or 쓰기 동시접근을 막는거지만 <code class=\"language-text\">isolation</code>은 트랜잭션 간의 데이터 접근 수준을 정의하는걸 말한다(트랜잭션 그 자체 집중 -> 비지니스 로직과 연관된다).</p>\n<p>쉽게 말해 일반적으로 말하는 <code class=\"language-text\">Lock</code>은 대상이 데이터, <code class=\"language-text\">isolation</code>은 대상이 트랜잭션이 되고, <code class=\"language-text\">isolation</code>의 레벨을 높게 잡으면 Lock과 동일하게 처리량이 떨어지게 된다.</p>\n<h2 id=\"1-read-uncommitted\" style=\"position:relative;\"><a href=\"#1-read-uncommitted\" aria-label=\"1 read uncommitted permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. READ UNCOMMITTED</h2>\n<p>커밋 안 된 것을 다른 트랜잭션에서 읽을 수 있다. 사실상 <code class=\"language-text\">Isolation</code>가 없는 상태이다.</p>\n<p>먼저</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SET</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token keyword\">ISOLATION</span> <span class=\"token keyword\">LEVEL</span> <span class=\"token keyword\">READ</span> <span class=\"token keyword\">UNCOMMITTED</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> @<span class=\"token variable\">@session.transaction_isolation</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>를 통해 세션의 <code class=\"language-text\">transaction isolation</code>를 바꿀 수 있다.</p>\n<h3 id=\"11-문제점---dirty-read\" style=\"position:relative;\"><a href=\"#11-%EB%AC%B8%EC%A0%9C%EC%A0%90---dirty-read\" aria-label=\"11 문제점   dirty read permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1.1 문제점 - Dirty Read</h3>\n<p>커밋 안된 것을 읽을 수 있다보니, <code class=\"language-text\">rollback</code> 되어버리면 해당 데이터는 정합성 문제가 발생 될 수 있다. 이런 상황을 <code class=\"language-text\">Dirty Read</code>라고 한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/e0d47f49efef57e0654aa29eaedeb271/22c86/img_read-uncommited.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.583333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtklEQVQoz32R2W7bMBBF9SXWQoqkRFrUZjmuEzeuHXhR49o10P7/l5xCSpwgAdKHgwsOBpczcwMzdeRNiW1rdK5JhEAI8a5SIIVA5zl5XeG6FttWpDpFCImQcuy7EZiyIW8bjC8RSpHEMUmSIF4Jw/Dtg3ggkcRRQjSZEIUhYRgRRRFxHI8apNaTOUeWGZRKUVKiU0mmUjKtiOJ4NJZaoytHmhsSaxA2JzUZWkuSJGYymYyfB64ssX6KcRpjB1P1gXHaYWWd0d0taNqWumtp5x2zeUfb1njn8VOPs46gWjwyrRq0UWij0Uqhh2n0iw5mUgpya/l1vvJ8unA4njj2Jw79if75zH7Q02/Wmy1BFL/c6Y0o/PgOQ6SUpELQfj8y3/1ltrnQ/Lgw215Z7P9QPPSU6wt6WhPErwf9isHQWYstHKZ06MKRZjkqd6jMokyGMoZUG5Q2BLd0PhvdakOKw8q+anhYbbmb3zP/tmKxXLNcPLLsFsybjlk1oyzK/xve6kOC3pecL1cOh5/sdseR/aFnd+hZb5542vUs71dfG34mEQlFMaXwnsIXY0hVXVMUBTKVb33/ACoWK/3eOHhSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/e0d47f49efef57e0654aa29eaedeb271/8ac56/img_read-uncommited.webp 240w,\n/blog/static/e0d47f49efef57e0654aa29eaedeb271/d3be9/img_read-uncommited.webp 480w,\n/blog/static/e0d47f49efef57e0654aa29eaedeb271/e46b2/img_read-uncommited.webp 960w,\n/blog/static/e0d47f49efef57e0654aa29eaedeb271/7e370/img_read-uncommited.webp 1143w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/e0d47f49efef57e0654aa29eaedeb271/8ff5a/img_read-uncommited.png 240w,\n/blog/static/e0d47f49efef57e0654aa29eaedeb271/e85cb/img_read-uncommited.png 480w,\n/blog/static/e0d47f49efef57e0654aa29eaedeb271/d9199/img_read-uncommited.png 960w,\n/blog/static/e0d47f49efef57e0654aa29eaedeb271/22c86/img_read-uncommited.png 1143w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/e0d47f49efef57e0654aa29eaedeb271/d9199/img_read-uncommited.png\"\n            alt=\"read-uncommited-img\"\n            title=\"read-uncommited-img\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<ul>\n<li>#1, #2 <code class=\"language-text\">트랜잭션1</code>, <code class=\"language-text\">트랜잭션2</code> 시작</li>\n<li>#3 <code class=\"language-text\">트랜잭션1</code>에서 데이터 입력</li>\n<li>#4 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터를 읽을 수 있음 -> 비지니스 로직에 관여 될 수 있음(이 데이터를 2차, 3차 가공해서 다른곳에 저장한다면?)</li>\n<li>#5 <code class=\"language-text\">트랜잭션1</code>에서 rollback -> 기존 insert 된 데이터 없어짐</li>\n<li>#6 <code class=\"language-text\">트랜잭션2</code>에서 데이터가 다시 사라짐 -> 기존 비지니스 로직에 정합성이 깨질 수도 있음</li>\n</ul>\n<h2 id=\"2-read-committed\" style=\"position:relative;\"><a href=\"#2-read-committed\" aria-label=\"2 read committed permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. READ COMMITTED</h2>\n<p>커밋이 된 것은 읽을 수 있다. 적어도 이것만으로도 크리티컬한 문제는 해결된다(Dirty Read는 꽤나 크리티컬 할 수가 있다).</p>\n<blockquote>\n<p><code class=\"language-text\">Dirty Read</code>는 커밋이 안된 것도 읽을 수 있어서 문제가 발생하는데, <code class=\"language-text\">READ COMMITTED</code>로 설정하면 커밋 된 것만 읽으니까 이 문제는 해결 된다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SET</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token keyword\">ISOLATION</span> <span class=\"token keyword\">LEVEL</span> <span class=\"token keyword\">READ</span> <span class=\"token keyword\">COMMITTED</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"21-문제점---non-repeatable-read\" style=\"position:relative;\"><a href=\"#21-%EB%AC%B8%EC%A0%9C%EC%A0%90---non-repeatable-read\" aria-label=\"21 문제점   non repeatable read permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2.1 문제점 - Non Repeatable Read</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/bc18d9b33745f17ac812a2c7ba0082be/35252/img_read-commited.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/0lEQVQoz32SW3LiMBBFvY9QWLZkSbb8CkwIjxAYSGxjcDL738yZkiE1TD7ycatVKul09+0OdO6wjwXprEZpSRiGCCEIhbjGUBDFMcZaVJKgC0c6r0hnJTKJELf3IoqIoojAFBW2fiTJC1TqsK7AaEVmNFopnDUoKcdPSZJgqxpbl5hZhakKTOowRhNHHi4IfPZYSuJEEmuFVAoZxygZE49RjplFJLDW0p0G+n6gPZ15b3uatuftrRnjYrH0FZboTKNMPErcWr2Xt8HDk0SzXq85HI687vasVmt+Hw68vO54Wq5wzvkKFUJEhNPwqvB/eeB0OkVKiVIKkQiEFEzDcJT3WIiQycMDk8mEQGuFMclVVmOswaQGY/7Je+eB2hg2uyOr9Su/VhueX3Ysl1uWiyVP8wWP9Ywgnz9RPj9TrZZkdUFWZrg6G+EepLUeK/NAD2/ajuHjk8vwyak/c7mdj003th6ksw06nyMzh0wdiU7ROhnX4HvLHu6VWktVVrjMURQFZVmOg/Xvg0iEiHB6Uzj64SHRba+iG9hXmTmHLXOyOsfWDls50tJh03TcBp80uP/4XV9gH/2U8zyn7T9ouoHmPNBe/vDeXjgeGrbbPZvN9gr8XtFP0LbrRt/Olw/a9sR5+KTtevaHd7a7/c/Ae9jXnR/U/fR9u34zfDLv4V8H52Y8d2s2GQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/bc18d9b33745f17ac812a2c7ba0082be/8ac56/img_read-commited.webp 240w,\n/blog/static/bc18d9b33745f17ac812a2c7ba0082be/d3be9/img_read-commited.webp 480w,\n/blog/static/bc18d9b33745f17ac812a2c7ba0082be/e46b2/img_read-commited.webp 960w,\n/blog/static/bc18d9b33745f17ac812a2c7ba0082be/01875/img_read-commited.webp 1204w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/bc18d9b33745f17ac812a2c7ba0082be/8ff5a/img_read-commited.png 240w,\n/blog/static/bc18d9b33745f17ac812a2c7ba0082be/e85cb/img_read-commited.png 480w,\n/blog/static/bc18d9b33745f17ac812a2c7ba0082be/d9199/img_read-commited.png 960w,\n/blog/static/bc18d9b33745f17ac812a2c7ba0082be/35252/img_read-commited.png 1204w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/bc18d9b33745f17ac812a2c7ba0082be/d9199/img_read-commited.png\"\n            alt=\"img_read-commited\"\n            title=\"img_read-commited\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<ul>\n<li>#1, #2 <code class=\"language-text\">트랜잭션1</code>, <code class=\"language-text\">트랜잭션2</code> 시작</li>\n<li>#3 <code class=\"language-text\">트랜잭션1</code>에서 데이터 입력</li>\n<li>#4 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터를 못읽음 -> <code class=\"language-text\">dirty read</code> x</li>\n<li>#5 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">commit</code></li>\n<li>#6 <code class=\"language-text\">트랜잭션2</code>에서 출력됨</li>\n<li>#7 <code class=\"language-text\">트랜잭션1</code>을 열어서 데이터 삭제 후, <code class=\"language-text\">commit</code></li>\n<li>#8 <code class=\"language-text\">트랜잭션2</code>에서 해당 데이터가 사라진다.</li>\n</ul>\n<blockquote>\n<p><code class=\"language-text\">Dirty Read</code>는 해결 되었지만, 하나의 트랜잭션(<code class=\"language-text\">트랜잭션2</code>)에서 외부 요인에 따라 다른 select 결과가 나온다는 점에서 데이터 정합성이 깨질 수가 있다. 이런 문제를 <code class=\"language-text\">Non Repeatable Read</code>라고 한다.</p>\n</blockquote>\n<h2 id=\"3-repeatable-read\" style=\"position:relative;\"><a href=\"#3-repeatable-read\" aria-label=\"3 repeatable read permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. REPEATABLE READ</h2>\n<p>트랜잭션 단위로 동일한 select 조건이라면 동일한 결과가 나올 수 있게 보장 해준다. 자연스럽게 <code class=\"language-text\">Non Repeatable Read</code>문제가 해결 되지만 DB 내부적으로 <code class=\"language-text\">트랜잭션 ID</code>에 따른 <code class=\"language-text\">snapshot</code>을 떠서 관리하고, 이 버전보다 높은 결과는 반영하지 않게 된다(조회 불가). 이에 따라 DB 부하가 있을 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SET</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token keyword\">ISOLATION</span> <span class=\"token keyword\">LEVEL</span> <span class=\"token keyword\">REPEATABLE</span> <span class=\"token keyword\">READ</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"31-문제점---phantom-read\" style=\"position:relative;\"><a href=\"#31-%EB%AC%B8%EC%A0%9C%EC%A0%90---phantom-read\" aria-label=\"31 문제점   phantom read permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.1 문제점 - Phantom Read</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/9d76a6b62ab9fa90619941fa608a0c39/159fb/img_repeatable-read.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.16666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACVklEQVQ4y42T646bOhSF50EawHfAEHI9M9M5bUIICWSaRH3/h/mO7DQzOVJV9ccSWGx/Xl578+TqmmLe4J9X5E2JVAIhbpJaorVGW4NrphTLGdXLmmLm/1f3qCdTFtjaI22BtI4syz6UJAlKqSghNUIYpLIIoeJ3EesEIhMfe56qf/6leX6hmjfM1nOcs5TOUpdFPDECtSJTGdIJpBFkIiMT4pc+DUSHUmqkkMgsQ4VrSolSEq0UaZpGoLGW6eqFZrGgXq2plkv8bEVdr5j6mrIob04DMEm+kGZJPClJ0whJkl+a3K5cVTXDcGEcznS7I113ZN+PtG1P1w30+wFjbNz79LzpWLyumS4qfOXx/qaqqjDGRGCe53zfbDgOA7t9z6bdsW07htOJ7nDk69tbvFnM0OUeoy1KqltHHxQKjDbxPc0myJCjFggZMkyQMjQjZTKZfGaYpkm0+tjdxy4HoHWOollQTmvK5Rz/OsevlxR+RpmX5Db/BP5ulu4KwODOl57D4cJwuDAerxyPZ7ruRLsdaDcHhsOZsvSxPgLv9Lvu6+jQGPK8YNNuOV8vDKd3juMYs/xxudCPJ9p9j8vzW1P+BhgUMlMhPxEGOiVLE5S8rZPJF9JkEvP8I/DeFFc4TNVgK49yFary6HKKcTXWWLQt0MUMU1S/Bz6Ctb6NzX5/oe/OfPt2YLsbaXcnttuRzfee3e49rpU2f3YYMgmwppmx3bWcr2fG9x8xu67vuf78yfl6ZdPteX37Sp67v3GoKcsSZ218D39NXdfxoPCsvP8YMecc/wHgPb3cfVRXNwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/9d76a6b62ab9fa90619941fa608a0c39/8ac56/img_repeatable-read.webp 240w,\n/blog/static/9d76a6b62ab9fa90619941fa608a0c39/d3be9/img_repeatable-read.webp 480w,\n/blog/static/9d76a6b62ab9fa90619941fa608a0c39/e46b2/img_repeatable-read.webp 960w,\n/blog/static/9d76a6b62ab9fa90619941fa608a0c39/6b83e/img_repeatable-read.webp 1019w\"\n              sizes=\"(max-width: 960px) 100vw, 960px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/9d76a6b62ab9fa90619941fa608a0c39/8ff5a/img_repeatable-read.png 240w,\n/blog/static/9d76a6b62ab9fa90619941fa608a0c39/e85cb/img_repeatable-read.png 480w,\n/blog/static/9d76a6b62ab9fa90619941fa608a0c39/d9199/img_repeatable-read.png 960w,\n/blog/static/9d76a6b62ab9fa90619941fa608a0c39/159fb/img_repeatable-read.png 1019w\"\n            sizes=\"(max-width: 960px) 100vw, 960px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/9d76a6b62ab9fa90619941fa608a0c39/d9199/img_repeatable-read.png\"\n            alt=\"img_repeatable-read\"\n            title=\"img_repeatable-read\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>위의 설명해서 <code class=\"language-text\">snapshot</code>을 통해 <code class=\"language-text\">Repeatable Read</code>을 서포트 한다고 하였다. 문제는 update를 하려고 하면 해당 <code class=\"language-text\">snapshot</code>의 대상 row를 갱신 시켜 버린다. 따라서 동일한 트랜잭션(위 이미지에서 <code class=\"language-text\">transaction2</code>)이라고 하더라도 update를 목적으로 하는 <code class=\"language-text\">for update</code> 를 통해 조회하면 가장 최신의 row가 조회 된다. 이런 현상을 <code class=\"language-text\">Phantom Read</code> 라고 한다.</p>\n<ul>\n<li>#1, #2 <code class=\"language-text\">트랜잭션1</code>, <code class=\"language-text\">트랜잭션2</code> 시작</li>\n<li>#3 <code class=\"language-text\">트랜잭션1</code>에서 데이터 입력</li>\n<li>#4 <code class=\"language-text\">트랜잭션2</code>에서 일반 <code class=\"language-text\">select</code>를 통해 데이터 조회 -> 출력되지 않음</li>\n<li>#5 <code class=\"language-text\">트랜잭션1</code>에서 <code class=\"language-text\">commit</code></li>\n<li>#6 <code class=\"language-text\">트랜잭션2</code>에서 일반 <code class=\"language-text\">select</code>를 통해 데이터 조회 -> 출력되지 않음 (<code class=\"language-text\">repeatable read</code>)</li>\n<li>#7 <code class=\"language-text\">트랜잭션2</code>에서 <code class=\"language-text\">select ... for update</code>를 통해 데이터 조회 -> 출력됨</li>\n</ul>\n<p><code class=\"language-text\">#7</code> 과정에서 snapshot이 갱신되면서 <code class=\"language-text\">Phantom Read</code>가 발생된다.</p>\n<h3 id=\"32-phantom-read-발생-조건\" style=\"position:relative;\"><a href=\"#32-phantom-read-%EB%B0%9C%EC%83%9D-%EC%A1%B0%EA%B1%B4\" aria-label=\"32 phantom read 발생 조건 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3.2 Phantom Read 발생 조건</h3>\n<p><code class=\"language-text\">mysql</code>에선 <code class=\"language-text\">REPEATABLE READ</code>라고 <code class=\"language-text\">Phantom Read</code>가 발생하지 않는다. 이유는 <code class=\"language-text\">gap-lock &amp; next-key-lock</code>을 통해 <code class=\"language-text\">Phantom Read</code>를 방지하고 있다(차후 다른 포스트 or 현재 포스트를 업데이트 하여 설명 할 예정) 위의 현상은 <code class=\"language-text\">mysql</code> 설정값을 변경하여 <code class=\"language-text\">next-key-lock</code> 옵션을 꺼서 재현 해보았다.</p>\n<p><strong>설정파일 옵션</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[mysqld]\ninnodb_locks_unsafe_for_binlog=1</code></pre></div>\n<p><code class=\"language-text\">innodb_locks_unsafe_for_binlog=1</code> 설정을 통해 <code class=\"language-text\">next-key-lock</code>을 끌 수가 있고, 이 옵션은 실행 중에 바꿀 수는 없고 바꿀려면 설정값을 바꾼 후, DB를 재시작해야 한다.</p>\n<blockquote>\n<p>혹시나 그냥 <code class=\"language-text\">default</code> 설정으로 테스트 해보면 그냥 lock이 걸린다</p>\n</blockquote>\n<h2 id=\"4-serializable\" style=\"position:relative;\"><a href=\"#4-serializable\" aria-label=\"4 serializable permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. SERIALIZABLE</h2>\n<p>모든 <code class=\"language-text\">select</code> 쿼리에 최소 <code class=\"language-text\">shared lock</code>을 걸어버린다. 즉 <code class=\"language-text\">transaction 1</code>에서 쓰기 작업 중(<code class=\"language-text\">insert</code>, <code class=\"language-text\">delete</code>, <code class=\"language-text\">for update</code>)이라면 다른 트랜잭션에선 해당 데이터 조회가 불가능하다(<code class=\"language-text\">locking</code>)</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SET</span> <span class=\"token keyword\">SESSION</span> <span class=\"token keyword\">TRANSACTION</span> <span class=\"token keyword\">ISOLATION</span> <span class=\"token keyword\">LEVEL</span> <span class=\"token keyword\">SERIALIZABLE</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 949px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/14060/img_serializable.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.500000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABD0lEQVQY002PbW7jMAxEfY9iLYmkSFmxXcf92N0Evf+xXhG7LfrjYQByMOQMfb+y3t9Z73+5vMxoFUQUEcGi4u6ICmZG9Ebfdy5vV9aPf6y3d2I59w//g8GmQFujWCMXJaVEyvnUX5gpqoZYIOqINbQ2ci7knH8Ylv835pedaVuZ33ZqNdyU8IrXepjOQENFSOMf0jj+aE7pJKczcFpfiWhMEVymhpsxudPDCXdy+gpUpUal9gm/BO3asR6IO1oDq/U4OuT8hHpBaiFLPrRYQexrVjJpTNTHx1Pg84b3Tiwb9Xk5mTdaX+h9Yni+3embEbNhTfHZ8K60WfHFKFqOwNYaKnpUfVQ86n6TRtJB4hN1ZqvofQCoywAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/8ac56/img_serializable.webp 240w,\n/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/d3be9/img_serializable.webp 480w,\n/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/108af/img_serializable.webp 949w\"\n              sizes=\"(max-width: 949px) 100vw, 949px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/8ff5a/img_serializable.png 240w,\n/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/e85cb/img_serializable.png 480w,\n/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/14060/img_serializable.png 949w\"\n            sizes=\"(max-width: 949px) 100vw, 949px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/blog/static/d7d6f4af1d6c6fafb315ff3bf2f7aba8/14060/img_serializable.png\"\n            alt=\"img_serializable\"\n            title=\"img_serializable\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">transaction 1</code>에서 <code class=\"language-text\">#1</code>, <code class=\"language-text\">#3</code> 쓰기 작업 중이라면 <code class=\"language-text\">transaction 2</code>에선 <code class=\"language-text\">for update</code>가 아닌데도 <code class=\"language-text\">lock</code> 대기가 걸려버린다(<code class=\"language-text\">#4</code>). <code class=\"language-text\">transaction 1</code>에서 commit을 해야 비로소 <code class=\"language-text\">wait</code>가 끝나고 데이터 조회가 가능하다.</p>\n<blockquote>\n<p><code class=\"language-text\">select ... for update</code> 단계는 도전도 안했다. 똑같이 lock이 풀릴때 까지(commit 될 때 까지) waiting 상태가 된다.</p>\n</blockquote>\n<h3 id=\"41-문제점---동시성\" style=\"position:relative;\"><a href=\"#41-%EB%AC%B8%EC%A0%9C%EC%A0%90---%EB%8F%99%EC%8B%9C%EC%84%B1\" aria-label=\"41 문제점   동시성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4.1 문제점 - 동시성</h3>\n<p>모든 select 쿼리에 최소 <code class=\"language-text\">shared lock</code>이 걸리다보니까 동시성이 떨어져 병목현상이 심하게 발생 할 수가 있다.</p>\n<blockquote>\n<p><code class=\"language-text\">shared lock</code>과 <code class=\"language-text\">exclusive lock</code>을 알아야 <code class=\"language-text\">SERIALIZABLE</code>의 정확한 이해가 가능하다. 추후 lock 관련해서 따로 포스트 예정</p>\n</blockquote>","fields":{"slug":"/posts/etc/db/isolation/","tagSlugs":["/tag/rds/","/tag/db/","/tag/mysql/"]},"frontmatter":{"date":"2022-08-26T09:08:34.903Z","description":"RDB(Mysql)에서 Transaction의 Isolation 종류 및 설명","tags":["rds","db","mysql"],"title":"Mysql - Isolation","socialImage":null}}},"pageContext":{"slug":"/posts/etc/db/isolation/"}},"staticQueryHashes":["251939775","357378587","401334301"]}